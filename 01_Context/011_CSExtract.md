# CS/PH/Table 데이터 추출 전략 컨텍스트

> **문서 목적:** 이 문서는 변환된 마크다운 문서들에서 PSUR 보고서 생성을 위한 CS, PH, Table 데이터를 추출하기 위한 전략과 방법론을 정의합니다.
> **적용 대상:** `/04_MainProcess/02_RawData_MD/` 폴더 내 모든 마크다운 문서
> **관련 정의 문서:** `0111_CSData_Definition.md`, `0112_PHData_Definition.md`, `0113_TableData_Definition.md`

---

## ⚠️ 필수 준수 사항 (CRITICAL)

> **이 섹션의 내용은 모든 데이터 추출 작업에서 반드시 준수해야 합니다.**

### 🚫 절대 금지: 데이터 임의 생성

```
┌─────────────────────────────────────────────────────────────────────┐
│  ❌ 데이터가 없는 경우, 절대로 임의로 작성하지 마십시오!              │
│                                                                     │
│  ✅ 올바른 처리 방법:                                                │
│     1. 해당 데이터가 누락되었음을 사용자에게 명확히 알림              │
│     2. 어떤 문서에서 해당 데이터를 찾으려 했는지 설명                 │
│     3. 사용자에게 데이터 제공을 요청                                 │
│     4. 사용자가 제공한 데이터만 사용                                 │
└─────────────────────────────────────────────────────────────────────┘
```

**예시:**
```
[잘못된 예]
CS28_원시총환자수를 찾을 수 없어 "약 1,000명"으로 추정하여 입력함

[올바른 예]
"CS28_원시총환자수 데이터를 Raw14_원시자료LineListing에서 찾을 수 없습니다.
해당 데이터를 제공해 주시거나, 다른 소스 문서가 있다면 알려주세요."
```

### ⚠️ 필수 확인: 데이터 불일치 처리

```
┌─────────────────────────────────────────────────────────────────────┐
│  ⚠️ 동일 데이터가 서로 다른 값을 가지는 경우                         │
│     (특히 서로 다른 문서에 상이한 데이터가 있는 경우)                 │
│                                                                     │
│  ✅ 올바른 처리 방법:                                                │
│     1. 불일치가 발견된 모든 문서와 해당 값을 나열                    │
│     2. 각 문서의 날짜/버전 정보 제공                                 │
│     3. 사용자에게 어떤 값을 사용할지 질의                            │
│     4. 사용자가 확정한 값만 사용                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**예시:**
```
[잘못된 예]
효능효과가 두 문서에서 다르게 나타나 최신 버전을 임의로 선택함

[올바른 예]
"효능효과 데이터 불일치가 발견되었습니다:

| 문서명 | 날짜 | 효능효과 내용 |
|--------|------|---------------|
| 효능효과20210305.md | 2021-03-05 | 16세 이상에서 코로나19 예방 |
| 효능효과20210716.md | 2021-07-16 | 12세 이상에서 코로나19 예방 |

어떤 값을 사용해야 할까요? (일반적으로 최신 날짜를 사용하지만 확인이 필요합니다)"
```

### 📋 데이터 추출 체크리스트

모든 데이터 추출 시 다음을 확인하십시오:

- [ ] 데이터가 실제로 소스 문서에 존재하는가?
- [ ] 동일 데이터가 여러 문서에 있는 경우, 값이 일치하는가?
- [ ] 값이 불일치하는 경우, 사용자에게 확인을 받았는가?
- [ ] 데이터가 없는 경우, 임의로 생성하지 않고 사용자에게 질문했는가?

---

## 1. 데이터 유형 개요

### 1.1 CS 데이터 (Context-Specific)

| 특성 | 설명 |
|------|------|
| **정의** | 단일 값 데이터 (텍스트, 날짜, 숫자) |
| **용도** | 보고서 내 특정 위치에 삽입되는 개별 정보 |
| **예시** | CS0_성분명, CS1_브랜드명, CS5_국내허가일자, CS15_효능효과, CS16_용법용량 |
| **총 항목 수** | 약 50개 이상 |

### 1.2 PH 데이터 (Paragraph/Phrase)

| 특성 | 설명 |
|------|------|
| **정의** | 서술형 텍스트 (문장/단락) |
| **용도** | 보고서 본문에 삽입되는 서술 문구 |
| **예시** | PH4_원시자료서술문, PH6_개별증례분석문, PH11_총괄평가문, PH12_결론 |
| **총 항목 수** | 약 10개 |

### 1.3 Table 데이터

| 특성 | 설명 |
|------|------|
| **정의** | 구조화된 표 데이터 |
| **용도** | 보고서 내 각종 표 생성 |
| **예시** | 표2_연도별판매량, 표5_신속보고내역, 표9_SOC별건수 |
| **총 항목 수** | 약 8개 |

---

## 1.4 추출 테스트 결과 요약

> **테스트 일자**: 2025-12-21
> **테스트 결과**: 전체 성공률 100%

| 데이터 유형 | 테스트 항목 | 결과 |
|-------------|-------------|------|
| CS 데이터 | CS0~CS17 (8개 항목) | ✓ 100% 성공 |
| Table 데이터 | 표2~표9, 허가현황 (5개 항목) | ✓ 100% 성공 |
| PH 데이터 | 소스 매핑 확인 | ✓ 소스 확인 완료 |
| 변경 이력 | 하이라이트 문서 2개 | ✓ 100% 성공 |

---

## 2. 소스 문서 → 데이터 매핑

### 2.1 기본정보 (기본정보updated.md)

**추출 가능 데이터:**

| Variable ID | Variable Name | 추출 위치 | 추출 방법 |
|-------------|---------------|-----------|-----------|
| CS0 | 성분명 | "토지나메란,사스코로나바이러스-2 mRNA 백신" | 콤마 앞부분 추출 |
| CS1 | 브랜드명 | "코미나티주" | 첫 번째 줄 추출 |
| CS2 | 회사명 | "회사명: 한국화이자제약" | "회사명:" 뒤 텍스트 추출 |
| CS5 | 국내허가일자 | "허가일 \| 2021-03-05" | 테이블에서 추출 |
| CS4 | 보고종료날짜 | "Data Lock Point (DLP) \| 2025-01-15" | DLP 테이블에서 추출 |

**추출 패턴:**
```
# 브랜드명: 파일 첫 번째 단독 텍스트 라인
pattern_brand = r'^([^\n]+)$' (첫 번째 매칭)

# 회사명: "회사명:" 뒤의 텍스트
pattern_company = r'회사명:\s*(.+)'

# 허가일: 테이블 형식
pattern_approval_date = r'\|\s*허가일\s*\|\s*(\d{4}-\d{2}-\d{2})\s*\|'

# DLP: 테이블 형식
pattern_dlp = r'\|\s*Data Lock Point \(DLP\)\s*\|\s*(\d{4}-\d{2}-\d{2})\s*\|'
```

---

### 2.2 효능효과 (안전성정보변경/효능효과*.md)

**추출 가능 데이터:**

| Variable ID | Variable Name | 추출 위치 | 추출 방법 |
|-------------|---------------|-----------|-----------|
| CS15 | 효능효과 | "## 효능효과" 섹션 | 섹션 내용 전체 추출 |

**파일별 데이터:**

| 파일명 | 내용 | 날짜 |
|--------|------|------|
| 효능효과20210305.md | "16세 이상에서 SARS-CoV-2 바이러스에 의한 코로나19의 예방" | 2021-03-05 |
| 효능효과20210716.md | "12세 이상에서 SARS-CoV-2 바이러스에 의한 코로나19의 예방" | 2021-07-16 |

**추출 패턴:**
```
# 효능효과 섹션 내용 추출
pattern_efficacy = r'##\s*효능효과\s*\n+(.+?)(?=\n##|\Z)'
```

**추출 지침:**
- 가장 최신 날짜의 파일에서 추출
- 파일명의 날짜(YYYYMMDD)를 비교하여 최신 버전 선택

---

### 2.3 용법용량 (안전성정보변경/용법용량*.md)

**추출 가능 데이터:**

| Variable ID | Variable Name | 추출 위치 | 추출 방법 |
|-------------|---------------|-----------|-----------|
| CS16 | 용법용량 | "## 용법용량" 섹션 전체 | 섹션 내용 추출 |

**구조 분석:**
```markdown
## 용법용량
### 1. 투여일정 및 용량
#### 1) 기초접종
#### 2) 추가접종(3차 투여)
#### 3) 12세 이상의 중증 면역저하자
### 2. 투여방법
```

**추출 패턴:**
```
# 용법용량 전체 섹션 추출
pattern_dosage = r'##\s*용법용량\s*\n(.+?)(?=\n#[^#]|\Z)'
```

**추출 지침:**
- 내용이 긴 경우 핵심 내용 위주로 요약 필요
- 투여일정, 용량, 투여방법의 핵심 정보 포함

---

### 2.4 사용상의주의사항 (안전성정보변경/사용상의주의사항*.md)

**추출 가능 데이터:**

| Variable ID | 섹션 | 추출 내용 |
|-------------|------|-----------|
| - | 1. 다음 환자에는 투여하지 말 것 | 금기사항 목록 |
| - | 2. 다음 환자에는 신중히 투여할 것 | 주의사항 목록 |
| - | 3. 약물이상반응 | 이상반응 표, 안전성 데이터 |
| - | 4. 일반적 주의 | 과민증, 심근염 등 경고 |
| - | 11. 보관 및 취급상의 주의사항 | 보관 조건 |

**하이라이트 비교 문서 활용:**

| 파일명 | 용도 |
|--------|------|
| 사용상의주의사항변경하이라이트20210716.md | 2021.03.05 → 2021.07.16 변경 사항 추적 |
| 사용상의주의사항변경하이라이트20231017.md | 2021.07.16 → 2023.10.30 변경 사항 추적 |

---

### 2.5 판매량 데이터 (Distribution_Tracker_2015-2025_Vial_NewFormat.md)

**추출 가능 데이터:**

| Variable ID | Variable Name | 추출 방법 |
|-------------|---------------|-----------|
| 표2 | 연도별판매량 | 연도별 섹션의 테이블 데이터 집계 |
| 표3 | 연평균환자노출 | 판매량 데이터 + 용법용량 기반 계산 |

**테이블 구조:**
```markdown
## 2021
| Date | Korea | Japan | Taiwan | Malaysia | USA | Canada | India | Total_Vials |
| 2021-01 | 17561 | 36962 | 13324 | 12219 | 66856 | 21609 |  |  |
...
```

**추출 패턴:**
```python
# 연도별 섹션 추출 (수정됨)
pattern_year_section = r'##\s+(\d{4})\s*\n([\s\S]+?)(?=##\s+\d{4}|$)'

# 월별 데이터 행 추출 (국가별)
pattern_monthly_data = r'\|\s*(\d{4}-\d{2})\s*\|\s*(\d+)\s*\|'

# Year Total 행 확인
pattern_year_total = r'\|\s*Year Total\s*\|'
```

**테스트 결과 (2025-12-21):**
| 연도 | 월수 | 한국 판매량 |
|------|------|-------------|
| 2021 | 12 | 242,165 |
| 2022 | 12 | 554,206 |
| 2023 | 12 | 311,352 |
| 2024 | 12 | 184,686 |
| 2025 | 12 | 139,707 |

**계산 로직:**
1. 보고기간(CS19~CS19.1) 내 월별 판매량 합계
2. 국가별/연도별 집계
3. 연평균 환자 노출 = 연평균 판매량 / (1일 사용량 × 365)

---

### 2.6 Line Listing 데이터 (Raw*_LineListing*.md)

**소스 파일 목록:**

| 파일명 | 용도 | 추출 데이터 |
|--------|------|-------------|
| Raw12_국외신속보고LineListing_예시1.md | 국외 신속보고 | 표5 일부 |
| Raw13_국내신속보고LineListing_예시1.md | 국내 신속보고 | 표5 일부 |
| Raw14_원시자료LineListing_예시1.md | 원시자료 | 표7, CS28~CS31 |
| Raw15_정기보고LineListing_예시1.md | 정기보고 | 표6 |

**추출 가능 데이터:**

| Variable ID | Variable Name | 소스 |
|-------------|---------------|------|
| 표5 | 신속보고내역 | Raw12 + Raw13 |
| 표6 | 정기보고내역 | Raw15 |
| 표7 | 원시자료내역 | Raw14 |
| 표8 | 모든이상사례건수 | Raw12 + Raw13 + Raw14 + Raw15 |
| 표9 | SOC별건수 | Raw12 + Raw13 + Raw14 + Raw15 |
| CS28 | 원시총환자수 | Raw14 집계 |
| CS29 | 원시총사례수 | Raw14 집계 |
| CS30 | 원시중대한사례수 | Raw14 필터링 집계 |

**Line Listing 파싱 규칙:**
1. 시트(섹션) 구조 파악
2. 이벤트(이상사례) 시트 식별
3. MedDRA PT term 기준 추출
4. Seriousness 기준 분류 (중대함/중대하지않음)

**테스트 결과 (2025-12-21):**
| 섹션 | 추출 행 수 |
|------|-----------|
| 기본정보+환자정보 | 16행 |
| 이상사례 | 13행 |
| 인과성평가 | 16행 |

---

### 2.7 허가현황 데이터 (Regulatory_*.md)

**소스 파일:**

| 파일명 | 추출 데이터 |
|--------|-------------|
| Regulatory_Status_Tracker.md | CS17_전세계허가현황표, CS17.1~CS17.6 |
| Regulatory_Actions_Taken_Safety_Label_Linked.md | 규제조치 이력 |

**테스트 결과 (2025-12-21):**
- 추출된 국가: 14개
- 승인 완료: 10개
- 심사 진행중: 2개
- 철회: 1개

---

## 3. 추출 방법론

### 3.1 섹션 기반 추출

```python
def extract_section(content: str, section_header: str) -> str:
    """
    마크다운 섹션 헤더 기준으로 내용 추출
    """
    pattern = rf'#{1,3}\s*{section_header}\s*\n([\s\S]+?)(?=\n#{1,3}\s|\Z)'
    match = re.search(pattern, content)
    return match.group(1).strip() if match else ""
```

### 3.2 테이블 파싱

```python
def parse_markdown_table(content: str) -> List[Dict]:
    """
    마크다운 테이블을 딕셔너리 리스트로 변환
    """
    lines = content.strip().split('\n')
    headers = [h.strip() for h in lines[0].split('|')[1:-1]]
    data = []
    for line in lines[2:]:  # 헤더와 구분선 스킵
        if line.strip() and '|' in line:
            values = [v.strip() for v in line.split('|')[1:-1]]
            data.append(dict(zip(headers, values)))
    return data
```

### 3.3 키-값 추출

```python
def extract_key_value(content: str, key: str) -> str:
    """
    "키: 값" 또는 "| 키 | 값 |" 형식에서 값 추출
    """
    # 일반 텍스트 형식
    pattern1 = rf'{key}:\s*(.+)'
    # 테이블 형식
    pattern2 = rf'\|\s*{key}\s*\|\s*(.+?)\s*\|'

    for pattern in [pattern1, pattern2]:
        match = re.search(pattern, content)
        if match:
            return match.group(1).strip()
    return ""
```

---

## 4. 데이터 검증 체크리스트

> ⚠️ **중요**: 검증 전 반드시 "필수 준수 사항 (CRITICAL)" 섹션을 확인하십시오.
> 데이터 누락 시 임의 생성 금지, 데이터 불일치 시 사용자 확인 필수!

### 4.0 추출 전 필수 확인 (MANDATORY)

| 확인 항목 | 조치 |
|-----------|------|
| 🚫 데이터 누락 | **임의 생성 절대 금지** → 사용자에게 질문하여 데이터 수령 |
| ⚠️ 데이터 불일치 | **임의 선택 금지** → 관련 문서 목록 제시 후 사용자에게 확인 |
| ✅ 데이터 정상 | 추출 진행 |

### 4.1 필수 필드 검증

| 검증 항목 | 검증 방법 |
|-----------|-----------|
| CS0_성분명 | 비어있지 않음 확인 |
| CS1_브랜드명 | 비어있지 않음 확인 |
| CS5_국내허가일자 | YYYY-MM-DD 형식 확인 |
| CS15_효능효과 | 최소 10자 이상 |
| CS16_용법용량 | 최소 50자 이상 |

### 4.2 데이터 형식 검증

| 데이터 타입 | 검증 패턴 |
|-------------|-----------|
| Date | `^\d{4}-\d{2}-\d{2}$` |
| Number | `^\d+(\.\d+)?$` |
| Text | 비어있지 않음 |
| Table | 최소 1행 이상 |

### 4.3 크로스 레퍼런스 검증

| 검증 항목 | 검증 내용 |
|-----------|-----------|
| 보고기간 | CS3 < CS4 확인 |
| 허가일 | CS5 < CS4 확인 |
| 판매량 합계 | 국가별 합계 = 연도별 합계 |
| 이상사례 건수 | 중대함 + 중대하지않음 = 전체 |

---

## 5. 추출 우선순위

### Phase 1: 기본 정보 (필수)
1. CS0_성분명
2. CS1_브랜드명
3. CS2_회사명
4. CS5_국내허가일자
5. CS4_보고종료날짜

### Phase 2: 허가 정보 (필수)
1. CS15_효능효과
2. CS16_용법용량
3. CS17_전세계허가현황표

### Phase 3: 판매/노출 데이터
1. 표2_연도별판매량
2. 표3_연평균환자노출

### Phase 4: 안전성 데이터
1. 표5_신속보고내역
2. 표6_정기보고내역
3. 표7_원시자료내역
4. 표8_모든이상사례건수
5. 표9_SOC별건수

### Phase 5: 서술문 (PH 데이터)
1. PH4_원시자료서술문
2. PH11_총괄평가문
3. PH12_결론

---

## 6. 주의사항

### 6.0 최우선 규칙 (CRITICAL - 반드시 준수)

```
╔═══════════════════════════════════════════════════════════════════════╗
║  🚨 데이터 추출 시 최우선 규칙                                          ║
╠═══════════════════════════════════════════════════════════════════════╣
║                                                                       ║
║  1. 🚫 데이터 누락 시: 절대 임의 생성 금지                              ║
║     → 사용자에게 질문하여 데이터를 받을 것                              ║
║                                                                       ║
║  2. ⚠️ 데이터 불일치 시: 절대 임의 선택 금지                            ║
║     → 관련 문서 목록을 제시하고 사용자에게 확인받을 것                   ║
║                                                                       ║
║  이 규칙을 위반하면 PSUR 보고서의 정확성과 신뢰성이 손상됩니다.          ║
║  규제 당국 제출 문서이므로 데이터 정확성은 매우 중요합니다.              ║
║                                                                       ║
╚═══════════════════════════════════════════════════════════════════════╝
```

### 6.1 버전 관리
- 동일 데이터의 여러 버전이 있을 경우, 일반적으로 **가장 최신 날짜** 파일 참조
- 파일명의 날짜(YYYYMMDD) 기준으로 판단
- ⚠️ **단, 버전 간 데이터가 다를 경우 반드시 사용자에게 확인 필요**

### 6.2 데이터 정합성
- 하이라이트 비교 문서를 활용하여 변경 이력 추적
- 최신 사용상의주의사항과 이전 버전 간 차이 확인
- ⚠️ **불일치 발견 시 임의 판단하지 않고 사용자에게 보고**

### 6.3 계산 검증
- 판매량, 환자노출, 이상사례 건수 등 수치 데이터는 **2중 검증** 필수
- 합계와 개별 항목의 일치 여부 확인
- ⚠️ **계산 결과가 기존 자료와 다를 경우 사용자에게 확인**

---

## 7. 관련 문서

| 문서명 | 경로 | 용도 |
|--------|------|------|
| CS Data Definition | `/01_Context/01_CSData_Definition.md` | CS 데이터 상세 정의 |
| PH Data Definition | `/01_Context/02_PHData_Definition.md` | PH 데이터 상세 정의 |
| Table Data Definition | `/01_Context/03_TableData_Definition.md` | Table 데이터 상세 정의 |
| 변환된 RawData | `/04_MainProcess/02_RawData_MD/` | 추출 소스 문서 |

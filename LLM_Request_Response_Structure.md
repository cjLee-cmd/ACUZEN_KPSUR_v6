# LLM 요청/응답 구조화 문서

## 개요

PSUR 보고서 자동 생성을 위한 LLM API 요청/응답 데이터 구조를 정의합니다.

---

## 1. API 설정

### 1.1 모델 설정

```json
{
  "model": "gemini-2.5-flash",
  "generationConfig": {
    "temperature": 0.3,
    "maxOutputTokens": 65536,
    "topP": 0.95
  }
}
```

**주요 설정**:
- `temperature`: 0.3 (일관성과 정확성 우선)
- `maxOutputTokens`: 65536 (충분한 출력 길이 확보)

---

## 2. 요청 구조 (Request Structure)

### 2.1 전체 구조

```
[역할 정의]
↓
[출력 구조 정의]
↓
[데이터 정의서]
↓
[템플릿]
↓
[예시]
↓
[원시 데이터]
↓
[제약 사항 및 지침]
```

### 2.2 섹션별 상세

#### A. 역할 정의 (Role Definition)

```markdown
# PSUR 전체 보고서 생성 요청

## 역할
당신은 제약사 약물감시팀 팀장입니다. 한국 식약처에 제출하는 PSUR(Periodic Safety Update Report) 문서를 작성하는 전문가입니다.
```

#### B. 출력 구조 정의 (Output Structure Definition)

```markdown
## 출력 구조

당신은 다음 두 가지 형식의 보고서를 생성해야 합니다:

### 1. 섹션별 보고서 (Individual Section Reports)

각 섹션(00~14)을 개별적으로 생성하되, 다음 구조를 준수하십시오:

```
## [섹션 ID]. [섹션명]

[섹션 내용]

---
```

**제약사항**:
- 각 섹션은 제공된 예시 파일의 문구와 길이를 참고하여 작성
- 예시 파일과 비교하여 길이가 ±30% 이상 벗어나지 않도록 작성
- 예시 파일의 구조(헤딩, 표, 목록 등)를 최대한 유지
- 섹션 구분자 `---`를 섹션 끝에 반드시 포함

### 2. 전체 통합 보고서 (Complete Merged Report)

15개 섹션을 순서대로 병합한 최종 보고서:

```
# PSUR 최종 보고서

**생성일시**: [YYYY-MM-DD HH:mm:ss]
**제품명**: [CS1_브랜드명]([CS0_성분명])
**보고기간**: [CS3_보고시작날짜] ~ [CS4_보고종료날짜]

---

[섹션 00 내용]

---

[섹션 01 내용]

---

...

[섹션 14 내용]

---
```

**제약사항**:
- 각 섹션 사이에 `---` 구분자 포함
- 섹션 순서 엄수 (00 → 01 → 02 → ... → 14)
- 표지에 메타데이터 포함
```

#### C. 데이터 정의서 (Data Definition)

```markdown
## 데이터 정의서 (변수 정의)

# CS 데이터 정의 (CS Data Definition)

> 문서 목적: 이 문서는 한국 PSUR 보고서 생성을 위한 CS(Context-Specific) 데이터 추출 컨텍스트를 정의합니다.
> LLM이 각 데이터 필드를 정확히 이해하고 추출할 수 있도록 상세한 지침을 제공합니다.

### 문서 구조 설명

각 데이터 항목은 다음 정보를 포함합니다:

- **Variable ID**: 템플릿에서 사용되는 변수 식별자
- **Variable Name**: 변수의 한글 명칭
- **Data Source**: 데이터 출처
- **Input Type**: 입력 유형
- **Generation Timing**: 생성 시점
- **Data Type**: 데이터 타입
- **데이터 추출 방법**: 상세 설명
- **추가 지침**: 처리 지침
- **예시**: 실제 데이터 예시

---

### CS 데이터 목록

#### 1. [CS0_성분명]

**Variable ID**: `[CS0]`
**Variable Name**: 성분명
**Data Source**: 사용자입력
**Input Type**: 설정
**Generation Timing**: 초기 1회
**Data Type**: `text`

##### 데이터 추출 방법

> [지침] [UI 입력] 브랜드명(성분명)의 드롭다운에서 선택한 값이 [CS1_브랜드명], [CS0_성분명]이 된다.

##### 예시

## Example 1
`infliximab`

## Example 2
`메만틴염산염`

---

[... 나머지 CS 변수들 ...]
```

**변경사항**:
- 이전: `1. \`infliximab\` 2. \`메만틴염산염\``
- 이후: `## Example 1`, `## Example 2` 형식

#### D. 템플릿 (Templates)

```markdown
## 템플릿

### 섹션별 템플릿 (Section Templates)

각 섹션의 기본 구조와 변수 위치를 정의합니다.

#### 섹션 00: 표지

```
# "[CS1_브랜드명]([CS0_성분명])"

**[CS2_회사명]**

---

**보고기간:** [CS3_보고시작날짜] ~ [CS4_보고종료날짜]
**국내허가일자:** [CS5_국내허가일자]
**보고서제출일:** [CS6_보고서제출일]
**버전(작성일):** v.[CS7_버전넘버] ([CS8_버전날짜])

---
```

#### 섹션 01: 목차

[... 템플릿 내용 ...]

[... 섹션 02~14 템플릿 ...]
```

#### E. 예시 (Examples)

```markdown
## 예시

### 섹션별 예시 (Section Examples)

각 섹션의 실제 작성 예시를 제공합니다.

#### 섹션 00 예시: 표지

## Example 1

```
# "글리빅사(메만틴염산염)"

**주식회사 아큐젠**

---

**보고기간:** 2019년 12월 31일 ~ 2024년 12월 31일
**국내허가일자:** 2018년 11월 10일
**보고서제출일:** 2025년 01월 31일
**버전(작성일):** v.1.0 (2024.12.31)

---
```

## Example 2

[... 다른 제품 예시 ...]

#### 섹션 01 예시: 목차

[... 예시 내용 ...]

[... 섹션 02~14 예시 ...]
```

**변경사항**:
- 각 섹션마다 여러 예시가 있을 경우 `## Example 1`, `## Example 2` 형식으로 구분

#### F. 원시 데이터 (Raw Data)

```markdown
## 원시 데이터

아래는 보고서 생성에 사용할 실제 데이터입니다.

### 통합 원시자료 (Combined Raw Data)

생성 시간: [타임스탬프]
파일 수: [파일 개수]

---

#### [RAW1] RAW1.1_최신첨부문서_예시1.pdf

[마크다운 변환 내용]

---

#### [RAW2.1] RAW2.1_용법용량_예시1.pdf

[마크다운 변환 내용]

---

[... 나머지 RAW 파일들 ...]
```

#### G. 제약 사항 및 지침 (Constraints and Guidelines)

```markdown
## 제약 사항 및 지침

### 1. 섹션별 보고서 작성 규칙

1. **길이 제약**
   - 각 섹션은 제공된 예시 파일의 길이를 참고
   - 예시 대비 ±30% 범위 내에서 작성
   - 과도하게 짧거나 길게 작성하지 않음

2. **구조 유지**
   - 예시 파일의 헤딩 구조 유지
   - 표 형식이 있는 경우 동일한 컬럼 구조 사용
   - 목록 형식 유지

3. **문구 스타일**
   - 예시 파일의 문체와 어투를 최대한 유사하게 작성
   - 전문 용어 사용 방식 유지
   - 문장 길이와 복잡도 유사하게 유지

4. **변수 치환**
   - 모든 [CS*] 변수는 원시 데이터에서 추출한 값으로 정확히 치환
   - 변수가 없는 경우 해당 부분 생략하지 말고 적절한 기본값 사용

### 2. 전체 통합 보고서 작성 규칙

1. **섹션 순서**
   - 반드시 00 → 01 → 02 → ... → 14 순서로 병합
   - 섹션 누락 금지

2. **구분자**
   - 각 섹션 사이에 `---` 구분자 삽입
   - 표지에 메타데이터 포함

3. **일관성**
   - 동일한 변수는 전체 보고서에서 동일한 값 사용
   - 날짜 형식, 숫자 표기 등 일관성 유지

### 3. 출력 금지 사항

- 이모티콘 사용 금지
- 불필요한 설명이나 주석 추가 금지
- 예시에 없는 섹션 추가 금지
- 변수 치환 실패 시 "[변수명]" 그대로 출력하지 말고 적절한 대체 텍스트 사용

### 4. 품질 기준

- 문법 오류 없음
- 맞춤법 정확
- 전문 용어 정확한 사용
- 표 정렬 정확
- 마크다운 구문 정확
```

---

## 3. 응답 구조 (Response Structure)

### 3.1 요청 형식

LLM에게 다음과 같이 구조화된 응답을 요청합니다:

```markdown
## 응답 구조 요청

당신의 응답은 다음 구조를 정확히 따라야 합니다:

### 응답 형식

```json
{
  "metadata": {
    "generatedAt": "ISO 8601 타임스탬프",
    "model": "모델명",
    "totalSections": 15,
    "dataSource": {
      "fileCount": 파일개수,
      "rawDataTypes": ["RAW1", "RAW2.1", ...]
    }
  },
  "sections": {
    "00": {
      "id": "00",
      "title": "표지",
      "content": "섹션 00의 마크다운 내용",
      "wordCount": 단어수,
      "status": "completed"
    },
    "01": {
      "id": "01",
      "title": "목차",
      "content": "섹션 01의 마크다운 내용",
      "wordCount": 단어수,
      "status": "completed"
    },
    ... (섹션 02~14 동일 구조)
  },
  "mergedReport": {
    "content": "전체 통합 보고서의 마크다운 내용",
    "totalWordCount": 전체단어수,
    "sectionOrder": ["00", "01", "02", ..., "14"]
  },
  "validation": {
    "allSectionsComplete": true/false,
    "variablesReplaced": {
      "CS0_성분명": true/false,
      "CS1_브랜드명": true/false,
      ... (모든 CS 변수)
    },
    "warnings": ["경고 메시지 배열"],
    "errors": ["오류 메시지 배열"]
  }
}
```

### 필드 설명

#### metadata
- `generatedAt`: 보고서 생성 시각 (ISO 8601 형식)
- `model`: 사용된 LLM 모델명
- `totalSections`: 생성된 섹션 개수 (항상 15)
- `dataSource`: 사용된 원시 데이터 정보

#### sections
- 각 섹션(00~14)의 개별 데이터
- `id`: 섹션 ID (00~14)
- `title`: 섹션 제목
- `content`: 섹션의 전체 마크다운 내용
- `wordCount`: 섹션의 단어 수
- `status`: 생성 상태 (completed, partial, failed)

#### mergedReport
- `content`: 15개 섹션이 병합된 최종 보고서
- `totalWordCount`: 전체 보고서의 단어 수
- `sectionOrder`: 섹션 병합 순서 확인용

#### validation
- `allSectionsComplete`: 모든 섹션이 성공적으로 생성되었는지 여부
- `variablesReplaced`: 각 변수가 정상적으로 치환되었는지 여부
- `warnings`: 경고 메시지 (예: 예시 대비 길이 차이 30% 초과)
- `errors`: 오류 메시지 (예: 변수 치환 실패)

### 3.2 응답 예시

```json
{
  "metadata": {
    "generatedAt": "2026-01-01T10:34:53.466Z",
    "model": "gemini-2.5-flash",
    "totalSections": 15,
    "dataSource": {
      "fileCount": 25,
      "rawDataTypes": ["RAW1", "RAW2.1", "RAW2.2", "RAW2.3", "RAW3", "RAW4", "RAW5.1", "RAW7.1", "RAW8", "RAW9", "RAW12", "RAW13", "RAW14", "RAW15"]
    }
  },
  "sections": {
    "00": {
      "id": "00",
      "title": "표지",
      "content": "# \"글리빅사(메만틴염산염)\"\n\n**주식회사 아큐젠**\n\n---\n\n**보고기간:** 2019년 12월 31일 ~ 2024년 12월 31일\n**국내허가일자:** 2018년 11월 10일\n**보고서제출일:** 2025년 01월 31일\n**버전(작성일):** v.1.0 (2024.12.31)\n\n---",
      "wordCount": 45,
      "status": "completed"
    },
    "01": {
      "id": "01",
      "title": "목차",
      "content": "## 목차\n\n- [1. 서론](#1-서론)\n- [2. 전세계 판매 허가 현황](#2-전세계-판매-허가-현황)\n...",
      "wordCount": 120,
      "status": "completed"
    }
  },
  "mergedReport": {
    "content": "# PSUR 최종 보고서\n\n**생성일시**: 2026-01-01 10:34:53\n**제품명**: 글리빅사(메만틴염산염)\n**보고기간**: 2019년 12월 31일 ~ 2024년 12월 31일\n\n---\n\n# \"글리빅사(메만틴염산염)\"\n\n**주식회사 아큐젠**\n\n---\n\n...",
    "totalWordCount": 8500,
    "sectionOrder": ["00", "01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12", "13", "14"]
  },
  "validation": {
    "allSectionsComplete": true,
    "variablesReplaced": {
      "CS0_성분명": true,
      "CS1_브랜드명": true,
      "CS2_회사명": true,
      "CS3_보고시작날짜": true,
      "CS4_보고종료날짜": true
    },
    "warnings": [
      "섹션 06: 예시 대비 길이 35% 초과 (예시: 800자, 생성: 1080자)"
    ],
    "errors": []
  }
}
```

---

## 4. 처리 흐름 (Processing Flow)

### 4.1 요청 단계

```
1. 역할 및 출력 구조 정의 제공
   ↓
2. 데이터 정의서 제공
   ↓
3. 템플릿 제공
   ↓
4. 예시 제공
   ↓
5. 원시 데이터 제공
   ↓
6. 제약사항 및 지침 제공
   ↓
7. 구조화된 JSON 응답 요청
```

### 4.2 LLM 처리 단계

```
1. 원시 데이터에서 CS 변수 추출
   ↓
2. 각 섹션(00~14) 개별 생성
   - 템플릿 참조
   - 예시 참조 (길이, 문구, 구조)
   - 변수 치환
   ↓
3. 15개 섹션 병합
   ↓
4. 검증
   - 섹션 완성도 확인
   - 변수 치환 확인
   - 길이 비교
   ↓
5. JSON 응답 생성
```

### 4.3 응답 검증 단계

```
1. JSON 파싱 성공 여부 확인
   ↓
2. metadata 필드 확인
   ↓
3. sections 객체 확인 (15개 섹션 존재)
   ↓
4. mergedReport 확인
   ↓
5. validation 결과 확인
   ↓
6. warnings/errors 처리
```

---

## 5. 구현 고려사항

### 5.1 요청 최적화

1. **토큰 사용 최적화**
   - 불필요한 설명 제거
   - 예시는 대표적인 것만 포함
   - 중복 내용 최소화

2. **명확성 향상**
   - 구조화된 마크다운 헤딩 사용
   - 번호 매기기로 순서 명확화
   - 코드 블록으로 형식 예시 제공

3. **검증 가능성**
   - JSON 구조로 프로그래밍적 검증 가능
   - 각 섹션별 상태 추적 가능
   - 오류/경고 메시지로 문제 파악 용이

### 5.2 응답 처리

1. **파싱**
   ```javascript
   const response = JSON.parse(llmResponse);

   // 메타데이터 확인
   console.log(response.metadata);

   // 각 섹션 접근
   const section00 = response.sections["00"];
   console.log(section00.content);

   // 전체 보고서 접근
   const fullReport = response.mergedReport.content;
   ```

2. **검증**
   ```javascript
   // 모든 섹션 생성 확인
   if (!response.validation.allSectionsComplete) {
     console.error("일부 섹션 생성 실패");
   }

   // 경고 확인
   if (response.validation.warnings.length > 0) {
     console.warn("경고:", response.validation.warnings);
   }

   // 오류 확인
   if (response.validation.errors.length > 0) {
     console.error("오류:", response.validation.errors);
   }
   ```

3. **저장**
   ```javascript
   // 섹션별 저장
   for (const [id, section] of Object.entries(response.sections)) {
     localStorage.setItem(`section_${id}`, section.content);
   }

   // 전체 보고서 저장
   localStorage.setItem('mergedReport', response.mergedReport.content);
   ```

---

## 6. 변경 사항 요약

### 6.1 요청 구조 변경

| 항목 | 이전 | 이후 |
|------|------|------|
| 예시 형식 | `1. 예시1\n2. 예시2` | `## Example 1\n예시1\n\n## Example 2\n예시2` |
| 이모티콘 | 사용 (예: 📤, 📥) | 미사용 |
| 출력 구조 명시 | 없음 | 명시적 정의 |
| 섹션별/전체 구분 | 암묵적 | 명시적 요청 |
| 길이 제약 | 없음 | 예시 대비 ±30% |
| Temperature | 0.7 | 0.3 |

### 6.2 응답 구조 변경

| 항목 | 이전 | 이후 |
|------|------|------|
| 응답 형식 | 단순 텍스트 | 구조화된 JSON |
| 섹션 구분 | 마크다운 헤딩만 | JSON 객체로 분리 |
| 검증 정보 | 없음 | validation 필드 포함 |
| 메타데이터 | 없음 | metadata 필드 포함 |
| 오류 처리 | 없음 | errors/warnings 배열 |

---

## 7. 다음 단계

1. **검토**: 이 구조화 문서 검토 및 피드백
2. **프롬프트 작성**: 실제 LLM 요청에 사용할 프롬프트 작성
3. **응답 파서 구현**: JSON 응답을 처리할 JavaScript 코드 작성
4. **테스트**: 실제 데이터로 테스트 및 검증
5. **통합**: 기존 P14_UnifiedProcessing.html에 통합

---

## 부록: 프롬프트 템플릿 구조

```
┌─────────────────────────────────────┐
│ 1. 역할 정의                         │
│    - 제약사 약물감시팀 팀장          │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│ 2. 출력 구조 정의                    │
│    - 섹션별 보고서 구조              │
│    - 전체 통합 보고서 구조           │
│    - JSON 응답 구조                  │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│ 3. 데이터 정의서                     │
│    - CS 변수 정의                    │
│    - 추출 방법                       │
│    - 예시 (Example 1, 2, ...)       │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│ 4. 템플릿                            │
│    - 섹션별 템플릿                   │
│    - 변수 위치 표시                  │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│ 5. 예시                              │
│    - 섹션별 예시                     │
│    - Example 1, Example 2, ...      │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│ 6. 원시 데이터                       │
│    - 통합 마크다운                   │
│    - RAW 파일별 내용                 │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│ 7. 제약사항 및 지침                  │
│    - 길이 제약 (±30%)               │
│    - 구조 유지                       │
│    - 품질 기준                       │
└─────────────────────────────────────┘
```

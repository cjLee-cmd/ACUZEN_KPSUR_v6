# KSUR 시스템 제작 사양서

## 문서 정보

| 항목 | 내용 |
|------|------|
| 문서명 | KSUR (Korean Safety Update Report) 시스템 제작 사양서 |
| 문서 버전 | 1.0 |
| 작성일 | 2025-12-29 |
| 프로젝트명 | KSUR v6 - 제약 안전성 보고서 자동화 시스템 |
| 목적 | 소프트웨어 개발을 위한 상세 기능 및 기술 사양 정의 |

---

## 목차

1. [프로젝트 개요](#1-프로젝트-개요)
2. [시스템 아키텍처](#2-시스템-아키텍처)
3. [기능 요구사항](#3-기능-요구사항)
4. [화면 설계](#4-화면-설계)
5. [데이터베이스 설계](#5-데이터베이스-설계)
6. [API 설계](#6-api-설계)
7. [비기능 요구사항](#7-비기능-요구사항)
8. [개발 계획](#8-개발-계획)
9. [테스트 계획](#9-테스트-계획)
10. [배포 계획](#10-배포-계획)
11. [부록](#11-부록)

---

# 1. 프로젝트 개요

## 1.1 프로젝트 배경

### 문제 정의
현재 제약회사는 의약품 품목 갱신 시 식품의약품안전처(MFDS)에 제출하는 PSUR(Periodic Safety Update Report) 문서를 수작업으로 작성합니다. 이 과정은:
- 다양한 형식의 소스 문서 (PDF, Excel, Word) 수집
- 문서에서 데이터 수동 추출
- 템플릿에 데이터 수동 입력
- 반복적인 검토 및 QC 과정
- 평균 작성 시간: 40-80시간 소요

### 해결 방안
LLM 기반 자동화 시스템을 통해:
- 소스 문서 자동 분류 및 파싱
- AI 기반 데이터 추출
- 템플릿 자동 작성
- AI 기반 QC 검증
- 예상 작성 시간: 4-8시간으로 단축 (90% 시간 절감)

## 1.2 프로젝트 목표

### 주요 목표
1. **자동화 수준 80% 이상**: 전체 워크플로우의 80% 자동화
2. **품질 향상**: AI 기반 QC로 오류율 50% 감소
3. **사용자 경험**: 직관적인 웹 인터페이스
4. **확장성**: 다양한 의약품 및 보고서 유형 지원

### 성공 기준
- [ ] 보고서 작성 시간 40시간 → 8시간 이내
- [ ] 데이터 추출 정확도 95% 이상
- [ ] QC 통과율 1차 90% 이상
- [ ] 사용자 만족도 4.0/5.0 이상
- [ ] 시스템 가동률 99% 이상

## 1.3 프로젝트 범위

### 포함 (In Scope)
- ✅ 9단계 워크플로우 전체 구현
- ✅ 웹 기반 SPA (Single Page Application)
- ✅ Supabase 기반 백엔드
- ✅ Google Gemini API 연동
- ✅ 역할 기반 접근 제어 (Master/Author/Reviewer/Viewer)
- ✅ Word 문서 자동 생성
- ✅ 한글 지원

### 제외 (Out of Scope)
- ❌ 모바일 앱
- ❌ 오프라인 작업
- ❌ 다국어 지원 (한글 전용)
- ❌ 기존 시스템 통합
- ❌ 전자서명 기능

## 1.4 이해관계자

| 역할 | 설명 | 권한 |
|------|------|------|
| **Master** | 시스템 관리자 | 모든 기능 + 사용자 관리 |
| **Author** | 보고서 작성자 | 보고서 생성, 수정, 삭제 |
| **Reviewer** | 검토자 | 보고서 조회, 리뷰, 코멘트 |
| **Viewer** | 열람자 | 보고서 조회만 |

---

# 2. 시스템 아키텍처

## 2.1 전체 아키텍처

```
┌─────────────────────────────────────────────────────────────────┐
│                        사용자 (브라우저)                          │
│                   Chrome, Edge, Safari                          │
└────────────────────┬────────────────────────────────────────────┘
                     │ HTTPS
                     ↓
┌─────────────────────────────────────────────────────────────────┐
│                      GitHub Pages                                │
│              (정적 사이트 호스팅 - 무료)                          │
│  ┌──────────────────────────────────────────────────┐           │
│  │  React SPA (TypeScript)                          │           │
│  │  - React 18.x + TypeScript 5.x                   │           │
│  │  - Vite (빌드 도구)                              │           │
│  │  - Tailwind CSS + shadcn/ui                      │           │
│  │  - React Router (클라이언트 라우팅)               │           │
│  │  - React Query (서버 상태 관리)                   │           │
│  │  - Zustand (전역 상태 관리)                       │           │
│  └──────────────────────────────────────────────────┘           │
└────────────────────┬────────────────────────────────────────────┘
                     │ Supabase Client SDK
                     ↓
┌─────────────────────────────────────────────────────────────────┐
│                         Supabase                                 │
│            (Backend as a Service - $0~$25/월)                    │
│  ┌──────────────────┬──────────────────┬──────────────────┐     │
│  │  Auth            │  PostgreSQL      │  Storage         │     │
│  │  - JWT 기반      │  - 15.x         │  - 파일 저장소   │     │
│  │  - RLS 정책     │  - RLS 보안      │  - RLS 정책      │     │
│  └──────────────────┴──────────────────┴──────────────────┘     │
│  ┌────────────────────────────────────────────────────────┐     │
│  │  Edge Functions (Deno)                                 │     │
│  │  - classify-raw-id: RAW ID 자동 분류                   │     │
│  │  - convert-to-markdown: 파일 → 마크다운 변환           │     │
│  │  - extract-data: CS/PH/Table 데이터 추출               │     │
│  │  - qc-validation: QC 검증                              │     │
│  └────────────────────────────────────────────────────────┘     │
└────────────────────┬────────────────────────────────────────────┘
                     │ API 호출
                     ↓
┌─────────────────────────────────────────────────────────────────┐
│                   Google Gemini API                              │
│                 (LLM 서비스 - $0~$50/월)                         │
│  - Gemini 2.0 Flash (기본 작업)                                 │
│  - Gemini 2.0 Flash-Thinking (QC 검증)                          │
└─────────────────────────────────────────────────────────────────┘
```

## 2.2 기술 스택

### 프론트엔드

| 계층 | 기술 | 버전 | 용도 |
|------|------|------|------|
| **프레임워크** | React | 18.x | UI 라이브러리 |
| **언어** | TypeScript | 5.x | 타입 안전성 |
| **빌드** | Vite | 5.x | 빌드 도구 |
| **라우팅** | React Router | 6.x | SPA 라우팅 |
| **상태관리** | Zustand | 4.x | 전역 상태 |
| **서버상태** | React Query | 5.x | 서버 데이터 캐싱 |
| **폼** | React Hook Form | 7.x | 폼 상태 관리 |
| **검증** | Zod | 3.x | 스키마 검증 |
| **스타일** | Tailwind CSS | 3.x | CSS 프레임워크 |
| **UI 컴포넌트** | shadcn/ui | - | 재사용 컴포넌트 |
| **아이콘** | Lucide React | - | 아이콘 라이브러리 |

### 백엔드

| 계층 | 기술 | 용도 |
|------|------|------|
| **BaaS** | Supabase | 백엔드 서비스 |
| **인증** | Supabase Auth | JWT 기반 인증 |
| **데이터베이스** | PostgreSQL 15.x | RDBMS |
| **저장소** | Supabase Storage | 파일 저장소 |
| **서버리스** | Supabase Edge Functions (Deno) | API 엔드포인트 |

### LLM

| 모델 | 용도 | RPM | TPM |
|------|------|-----|-----|
| **Gemini 2.0 Flash** | 분류, 변환, 추출 | 15 | 1M |
| **Gemini 2.0 Flash-Thinking** | QC 검증 | 15 | 1M |

### 파일 처리

| 라이브러리 | 용도 |
|-----------|------|
| **xlsx** | Excel 파일 읽기/쓰기 |
| **mammoth.js** | Word 파일 읽기 |
| **docxtemplater** | Word 파일 생성 |
| **pizzip** | docxtemplater 의존성 |
| **pdf.js** | PDF 미리보기 (선택) |

### 마크다운

| 라이브러리 | 용도 |
|-----------|------|
| **react-markdown** | 마크다운 렌더링 |
| **remark-gfm** | GitHub Flavored Markdown |
| **rehype-sanitize** | XSS 방지 |

## 2.3 배포 아키텍처

```
개발자 로컬 환경
    ↓ git push
GitHub Repository (Private)
    ↓ GitHub Actions (자동 트리거)
    ↓ npm run build
빌드 완료 (dist/)
    ↓ actions/deploy-pages@v4
GitHub Pages
    ↓ 사용자 접속
https://username.github.io/ksur-v6/
```

## 2.4 데이터 흐름

### 파일 업로드 흐름
```
사용자 → 파일 선택 → Supabase Storage 직접 업로드
    → file_path 획득
    → Edge Function: classify-raw-id 호출
    → RAW ID 분류 결과 → DB 저장
```

### 마크다운 변환 흐름
```
사용자 → "변환" 버튼 클릭
    → Edge Function: convert-to-markdown 호출
    → Supabase Storage에서 파일 다운로드
    → Gemini API로 파일 전달
    → 마크다운 변환 결과 → DB 저장
```

### 데이터 추출 흐름
```
사용자 → "데이터 추출" 버튼 클릭
    → Edge Function: extract-data 호출
    → DB에서 마크다운 조회
    → Gemini API로 데이터 추출 요청
    → 추출 결과 → DB 저장
```

### QC 검증 흐름
```
사용자 → "QC 검증" 버튼 클릭
    → Edge Function: qc-validation 호출
    → DB에서 원본 + 작성된 보고서 조회
    → Gemini API로 검증 요청
    → 검증 결과 → 사용자에게 표시
```

---

# 3. 기능 요구사항

## 3.1 워크플로우 개요

KSUR 시스템은 9단계 워크플로우를 따릅니다:

```
1. 로그인 → 2. 보고서 상태 → 3. 소스문서 입력 → 4. 마크다운 변환
    ↓
5. 데이터 추출 → 6. 템플릿 작성 → 7. 리뷰 → 8. QC → 9. 출력
```

각 단계는 순차적으로 진행되며, 이전 단계 완료 시 다음 단계로 자동 이동합니다.

---

## 3.2 [Stage 1] 로그인

### 3.2.1 기능 설명
사용자 인증 및 권한 확인을 수행합니다.

### 3.2.2 화면 흐름
```
로그인 화면 → 인증 성공 → 대시보드
           ↓ 인증 실패
        에러 메시지 표시
```

### 3.2.3 상세 요구사항

**FR-1.1: 이메일/비밀번호 로그인**
- **입력 필드**:
  - 이메일 (이메일 형식 검증)
  - 비밀번호 (최소 8자, 대소문자+숫자+특수문자 포함)
- **버튼**: "로그인"
- **링크**: "비밀번호 찾기" (향후 구현)

**FR-1.2: 비밀번호 정책**
- 최소 8자 이상
- 대문자 1개 이상
- 소문자 1개 이상
- 숫자 1개 이상
- 특수문자 1개 이상 (@$!%*?&)

**FR-1.3: 로그인 유지**
- JWT 토큰 기반 세션
- 유효기간: 1시간
- 자동 갱신: 활성 사용 시
- "로그인 상태 유지" 체크박스 (선택)

**FR-1.4: 로그인 실패 처리**
- 3회 실패 시 5분간 계정 잠금
- 에러 메시지:
  - "이메일 또는 비밀번호가 올바르지 않습니다"
  - "계정이 잠겼습니다. 5분 후 다시 시도하세요"

**FR-1.5: 역할 확인**
- 로그인 성공 시 사용자 역할 조회
- 역할에 따른 메뉴 접근 제어

### 3.2.4 데이터베이스

**테이블**: `users`

**쿼리**:
```sql
-- 로그인
SELECT id, email, name, role, created_at
FROM users
WHERE email = $1 AND password_hash = crypt($2, password_hash);

-- 로그인 실패 기록
INSERT INTO auth_attempts (email, success, ip_address, timestamp)
VALUES ($1, false, $2, now());
```

### 3.2.5 API

**Supabase Auth SDK**:
```typescript
const { data, error } = await supabase.auth.signInWithPassword({
  email,
  password,
})
```

### 3.2.6 보안 요구사항

- ✅ HTTPS 강제
- ✅ 비밀번호 해싱 (bcrypt)
- ✅ CSRF 토큰 (Supabase 자동)
- ✅ Rate Limiting (분당 5회)
- ✅ IP 기반 차단 (선택)

---

## 3.3 [Stage 2] 보고서 상태

### 3.3.1 기능 설명
사용자가 새 보고서를 생성하거나 기존 보고서를 계속 작성할지 선택합니다.

### 3.3.2 화면 흐름
```
대시보드
  ↓ "새 보고서" 클릭
사용자 입력 폼 → 보고서 생성 → Stage 3
  ↓ "계속 작성" 클릭
Draft 보고서 목록 → 보고서 선택 → 저장된 단계로 이동
```

### 3.3.3 상세 요구사항

**FR-2.1: 새 보고서 생성**

**입력 폼**:
| 필드 | 타입 | 필수 | 검증 |
|------|------|------|------|
| CS0_성분명 | text | ✅ | 1-100자 |
| CS1_브랜드명 | text | ✅ | 1-100자 |
| CS2_회사명 | text | ✅ | 1-100자 |
| CS4_보고종료날짜 | date | ✅ | YYYY-MM-DD |
| CS5_국내허가일자 | date | ✅ | YYYY-MM-DD, CS4 이전 |
| CS6_보고서제출일 | date | ✅ | YYYY-MM-DD, CS4 이후 |
| CS7_버전넘버 | text | ✅ | 예: 1.0 |
| CS13_유효기간 | date | ✅ | YYYY-MM-DD, CS6 이후 |
| CS20_1일사용량 | number | ✅ | 양수 |
| CS21_환자1명당사용량 | number | ✅ | 양수 |
| CS24_MedDRA버전넘버 | text | ✅ | 예: 26.0 |

**자동 계산**:
- CS3 = CS4 - 5년
- CS8 = CS4 (동일값)
- CS14 = CS13 - 6개월
- 보고서명 = `{CS1_브랜드명}_PSUR_{CS6_보고서제출일}_{CS7_버전넘버}`

**FR-2.2: 보고서 생성**
- 버튼 클릭 시 DB에 `reports` 레코드 생성
- 초기 상태: `status = 'Draft'`, `current_stage = 1`
- `user_inputs` JSONB에 사용자 입력 저장

**FR-2.3: 기존 보고서 계속 작성**

**Draft 보고서 목록 테이블**:
| 컬럼 | 내용 |
|------|------|
| 보고서명 | 클릭 가능 링크 |
| 성분명 | CS0 |
| 작성자 | created_by 사용자명 |
| 현재 단계 | current_stage (1-9) |
| 최종 수정일 | updated_at |
| 액션 | "계속하기", "삭제" 버튼 |

**정렬**: `updated_at DESC` (최근 수정 순)

**필터**:
- 내가 작성한 보고서만 (Author)
- 모든 보고서 (Master, Reviewer)

**FR-2.4: 보고서 선택**
- 보고서 클릭 시 `current_stage`로 이동
- 예: `current_stage = 3` → Stage 3 (소스문서 입력)

### 3.3.4 데이터베이스

**테이블**: `reports`

**생성 쿼리**:
```sql
INSERT INTO reports (
  report_name,
  created_by,
  status,
  current_stage,
  user_inputs
) VALUES (
  'Brand_PSUR_2025-06-30_1.0',
  auth.uid(),
  'Draft',
  1,
  '{"CS0": "성분명", "CS1": "브랜드명", ...}'::jsonb
)
RETURNING id;
```

**조회 쿼리**:
```sql
SELECT
  r.id,
  r.report_name,
  r.user_inputs->>'CS0' as ingredient,
  u.name as author_name,
  r.current_stage,
  r.updated_at
FROM reports r
JOIN users u ON r.created_by = u.id
WHERE r.status = 'Draft'
  AND (r.created_by = auth.uid() OR EXISTS (
    SELECT 1 FROM users
    WHERE id = auth.uid() AND role IN ('Master', 'Reviewer')
  ))
ORDER BY r.updated_at DESC;
```

### 3.3.5 UI 컴포넌트

```typescript
// 새 보고서 폼
<ReportCreateForm
  onSubmit={handleCreateReport}
  isLoading={isCreating}
/>

// Draft 보고서 목록
<DraftReportList
  reports={draftReports}
  onContinue={handleContinue}
  onDelete={handleDelete}
/>
```

---

## 3.4 [Stage 3] 소스문서 입력

### 3.4.1 기능 설명
사용자가 보고서 작성에 필요한 소스 문서(PDF, Excel, Word)를 업로드하고 RAW ID를 자동 분류합니다.

### 3.4.2 화면 흐름
```
파일 업로드 영역
  ↓ 파일 드래그 앤 드롭 또는 선택
업로드 중 (진행률 표시)
  ↓ 업로드 완료
RAW ID 자동 분류 (LLM)
  ↓ 분류 완료
파일 목록 표시 (RAW ID 태그 포함)
  ↓ 모든 필수 파일 업로드 완료
"다음 단계" 버튼 활성화
```

### 3.4.3 상세 요구사항

**FR-3.1: 파일 업로드**

**지원 형식**:
- PDF (.pdf)
- Excel (.xlsx, .xls)
- Word (.docx, .doc)

**파일 크기 제한**:
- 최대 50MB/파일
- 총 500MB/보고서

**업로드 방식**:
- 드래그 앤 드롭
- 파일 선택 다이얼로그
- 다중 파일 선택 가능

**진행률 표시**:
- 개별 파일 업로드 진행률
- 전체 업로드 진행률
- "취소" 버튼

**FR-3.2: RAW ID 자동 분류**

**분류 대상**:
| RAW ID | 설명 | 필수 |
|--------|------|------|
| RAW1 | 최신첨부문서 | ✅ |
| RAW2.1 | 용법용량 | ✅ |
| RAW2.2 | 효능효과 | ✅ |
| RAW2.3 | 사용상의주의사항 | ✅ |
| RAW3 | 시판후sales데이터 | ✅ |
| RAW4 | 허가현황 | ✅ |
| RAW5.1 | 안전성조치허가메일 | |
| RAW12 | 국외신속보고LineListing | |
| RAW13 | 국내신속보고LineListing | |
| RAW14 | 원시자료LineListing | |
| RAW15 | 정기보고LineListing | |

**분류 프로세스**:
1. 파일 업로드 완료
2. Edge Function `classify-raw-id` 호출
3. LLM이 파일 내용 분석
4. RAW ID + 신뢰도 점수 반환
5. 신뢰도 < 0.7 시 사용자 확인 요청

**FR-3.3: 파일 목록 표시**

**테이블 컬럼**:
| 컬럼 | 내용 |
|------|------|
| 파일명 | 원본 파일명 |
| RAW ID | 자동 분류 결과 (수정 가능) |
| 신뢰도 | 0.0 - 1.0 (색상 코드: 빨강<0.7, 노랑<0.9, 초록≥0.9) |
| 크기 | 파일 크기 (MB) |
| 업로드일 | 업로드 타임스탬프 |
| 액션 | "미리보기", "삭제" 버튼 |

**FR-3.4: RAW ID 수동 수정**
- RAW ID 셀 클릭 시 드롭다운 표시
- RAW ID 목록에서 선택
- 수정 시 `confidence_score = 1.0` (수동 확정)

**FR-3.5: 파일 매칭 테이블 저장**
- "저장" 버튼 클릭 시 매칭 테이블 생성
- 파일명: `{보고서명}_파일매칭테이블_{YYMMDD_hhmmss}.md`
- 저장 위치: Supabase Storage `markdown` 버킷

**매칭 테이블 형식**:
```markdown
| 원본파일명 | 태그파일명 |
|-----------|-----------|
| 첨부문서_2024.pdf | RAW1 |
| 판매데이터.xlsx | RAW3 |
```

**FR-3.6: 필수 파일 확인**
- RAW1, RAW2.1, RAW2.2, RAW2.3, RAW3, RAW4가 모두 있어야 다음 단계 진행 가능
- 누락 시 경고 메시지 표시
- "다음 단계" 버튼 비활성화

### 3.4.4 데이터베이스

**테이블**: `source_documents`, `file_matching_table`

**업로드 저장**:
```sql
INSERT INTO source_documents (
  report_id,
  original_filename,
  raw_id,
  file_type,
  file_path,
  file_size,
  uploaded_by
) VALUES (
  $1, $2, $3, $4, $5, $6, auth.uid()
);
```

**매칭 테이블 저장**:
```sql
INSERT INTO file_matching_table (
  report_id,
  original_filename,
  assigned_raw_id,
  confidence_score,
  classified_by
) VALUES (
  $1, $2, $3, $4, 'Gemini-2.0-Flash'
);
```

### 3.4.5 Edge Function

**엔드포인트**: `POST /functions/v1/classify-raw-id`

**요청**:
```json
{
  "reportId": "uuid",
  "documentId": "uuid",
  "fileName": "첨부문서.pdf",
  "fileUrl": "https://..."
}
```

**응답**:
```json
{
  "success": true,
  "data": {
    "rawId": "RAW1",
    "confidence": 0.95,
    "reasoning": "문서에 '첨부문서', '허가사항' 포함"
  }
}
```

### 3.4.6 UI 컴포넌트

```typescript
<FileUploadZone
  onUpload={handleUpload}
  acceptedTypes={['.pdf', '.xlsx', '.docx']}
  maxSize={50 * 1024 * 1024}
  multiple
/>

<FileMatchingTable
  files={uploadedFiles}
  onRawIdChange={handleRawIdChange}
  onDelete={handleDelete}
/>
```

---

## 3.5 [Stage 4] 마크다운 변환

### 3.5.1 기능 설명
업로드된 모든 소스 문서를 마크다운 형식으로 변환합니다.

### 3.5.2 화면 흐름
```
파일 목록 표시
  ↓ "모두 변환" 버튼 클릭
변환 작업 시작 (진행률 표시)
  ↓ 각 파일별 변환
Edge Function 호출 → Gemini API
  ↓ 변환 완료
마크다운 미리보기
  ↓ 검증 및 수정
"다음 단계" 버튼 활성화
```

### 3.5.3 상세 요구사항

**FR-4.1: 일괄 변환**

**버튼**:
- "모두 변환": 모든 파일 일괄 변환
- "개별 변환": 선택한 파일만 변환

**진행률 표시**:
- 전체 진행률 (X/N 파일)
- 현재 파일명
- 예상 남은 시간
- "취소" 버튼

**FR-4.2: 변환 규칙**

**⚠️ 매우 중요**:
```
1. 내용을 절대 추가하거나 삭제하지 마세요
2. 원본 텍스트를 그대로 보존하세요
3. 표는 마크다운 테이블 형식으로 변환하세요
4. 제목은 # 헤더로 변환하세요
5. 번호 매김 리스트는 그대로 유지하세요
```

**FR-4.3: 변환 결과 저장**

**저장 위치**:
- DB: `markdown_documents` 테이블
- Storage: `markdown` 버킷 (백업)

**파일명**: `{RAW_ID}_{원본파일명}.md`
예: `RAW1_첨부문서.md`

**FR-4.4: 마크다운 미리보기**

**화면 구성**:
```
┌─────────────┬─────────────┐
│  파일 목록   │ 미리보기     │
│             │             │
│  RAW1 ✓     │ # 첨부문서   │
│  RAW2.1 ✓   │             │
│  RAW2.2 ○   │ ## 효능효과  │
│  ...        │ ...         │
└─────────────┴─────────────┘
```

**미리보기 기능**:
- 렌더링된 마크다운 (react-markdown)
- 원본 마크다운 보기 (토글)
- 다운로드 버튼
- 재변환 버튼

**FR-4.5: 수동 수정**

**수정 모드**:
- "수정" 버튼 클릭 시 에디터 표시
- Monaco Editor 또는 CodeMirror 사용
- 실시간 미리보기
- "저장" / "취소" 버튼

**수정 이력**:
- 수정 전/후 내용 저장
- 수정자, 수정일시 기록
- `review_changes` 테이블 활용

**FR-4.6: 변환 실패 처리**

**에러 유형**:
- 파일 읽기 실패
- API 호출 실패
- 타임아웃 (150초)

**에러 처리**:
- 에러 메시지 표시
- "재시도" 버튼
- 로그 저장 (`llm_dialogs` 테이블)

### 3.5.4 데이터베이스

**테이블**: `markdown_documents`

**저장 쿼리**:
```sql
INSERT INTO markdown_documents (
  source_document_id,
  report_id,
  raw_id,
  markdown_content,
  converted_by,
  file_path
) VALUES (
  $1, $2, $3, $4, 'Gemini-2.0-Flash', $5
);
```

### 3.5.5 Edge Function

**엔드포인트**: `POST /functions/v1/convert-to-markdown`

**요청**:
```json
{
  "reportId": "uuid",
  "sourceDocumentId": "uuid",
  "rawId": "RAW1",
  "fileUrl": "https://...",
  "fileName": "첨부문서.pdf"
}
```

**응답**:
```json
{
  "success": true,
  "data": {
    "markdownContent": "# 첨부문서\n\n...",
    "documentId": "uuid"
  }
}
```

### 3.5.6 UI 컴포넌트

```typescript
<ConversionProgress
  total={totalFiles}
  completed={completedFiles}
  currentFile={currentFileName}
  onCancel={handleCancel}
/>

<MarkdownPreview
  content={markdownContent}
  onEdit={handleEdit}
  onReconvert={handleReconvert}
/>
```

---

## 3.6 [Stage 5] 데이터 추출

### 3.6.1 기능 설명
변환된 마크다운 문서에서 CS/PH/Table 데이터를 추출합니다.

### 3.6.2 화면 흐름
```
마크다운 문서 목록
  ↓ "데이터 추출" 버튼 클릭
추출 대상 변수 선택 (자동/수동)
  ↓ 추출 시작
Edge Function 호출 → Gemini API
  ↓ 추출 완료
추출 결과 표시 (성공/실패/충돌)
  ↓ 충돌 해결
"다음 단계" 버튼 활성화
```

### 3.6.3 상세 요구사항

**FR-5.1: 추출 대상 선택**

**자동 모드** (기본):
- `0114_CS_from_Source.md` 매핑 테이블 기반
- RAW ID별 추출 가능 변수 자동 선택
- 예: RAW1 → CS15, CS16, CS20, CS21 추출

**수동 모드**:
- 변수 목록 체크박스 표시
- 사용자가 추출할 변수 선택
- "모두 선택" / "모두 해제" 버튼

**FR-5.2: 데이터 추출 프로세스**

**단계**:
1. RAW ID별로 마크다운 문서 조회
2. 추출 대상 변수 목록 생성
3. Edge Function `extract-data` 호출
4. LLM이 데이터 추출
5. 결과 검증 및 DB 저장

**FR-5.3: 추출 결과 분류**

**성공**:
- 데이터 정상 추출
- `validation_status = 'Validated'`
- 초록색 체크 표시

**실패 (누락)**:
- 데이터를 찾을 수 없음
- `validation_status = 'Conflict'`
- 빨간색 X 표시
- 사용자에게 수동 입력 요청

**충돌**:
- 동일 변수에 여러 값 발견
- `validation_status = 'Conflict'`
- 노란색 경고 표시
- 사용자에게 값 선택 요청

**FR-5.4: 추출 결과 표시**

**테이블 컬럼**:
| 컬럼 | 내용 |
|------|------|
| Variable ID | CS0, PH4, 표2 등 |
| Variable Name | 성분명, 원시자료서술문 등 |
| 추출 값 | 데이터 값 (미리보기) |
| 소스 | RAW ID |
| 상태 | 성공/실패/충돌 |
| 액션 | "보기", "수정" 버튼 |

**FR-5.5: 충돌 해결**

**충돌 유형 1: 데이터 누락**
```
문제: CS15_효능효과를 RAW2.2에서 찾을 수 없음
해결: 사용자에게 수동 입력 요청

UI:
┌────────────────────────────────────────┐
│ CS15_효능효과 데이터를 찾을 수 없습니다  │
│ 수동으로 입력해주세요:                  │
│ [텍스트 입력 영역]                      │
│                                        │
│ [저장]  [RAW2.2 문서 보기]             │
└────────────────────────────────────────┘
```

**충돌 유형 2: 값 불일치**
```
문제: CS15가 두 문서에서 다른 값

UI:
┌────────────────────────────────────────┐
│ CS15_효능효과 불일치 발견               │
│                                        │
│ ○ 값 1 (RAW2.2, 2021-03-05):           │
│   "16세 이상 코로나19 예방"             │
│                                        │
│ ○ 값 2 (RAW1, 2021-07-16):             │
│   "12세 이상 코로나19 예방"             │
│                                        │
│ [확정]  [두 문서 비교]                  │
└────────────────────────────────────────┘
```

**FR-5.6: LLM 대화 로그 저장**

**저장 위치**:
- DB: `llm_dialogs` 테이블
- 파일: `02_Context/05_DialogWithLLM/{보고서명}_YYMMDD_hhmmss.md`

**로그 형식**:
```markdown
# 데이터 추출 로그

**보고서:** testPill_1
**일시:** 2025-12-29 15:30:00
**모델:** Gemini-2.0-Flash

## [User Msg.]
다음 마크다운 문서에서 CS0_성분명, CS1_브랜드명을 추출하세요.
...

## [Resp. Msg]
{
  "extractedData": [
    {"variableId": "CS0", "dataValue": "토지나메란"}
  ]
}
```

**FR-5.7: 추출 데이터 저장**

**저장 위치**:
- DB: `extracted_data` 테이블
- 파일: `04_TestProcess/03_CSData_MD/CS_Data_List_YYMMDD_hhmmss.md`

**파일 형식**:
```markdown
| Variable ID | Variable Name | Data | Source |
|-------------|---------------|------|--------|
| CS0 | 성분명 | 토지나메란 | RAW1 |
| CS1 | 브랜드명 | 코미나티주 | RAW1 |
...
```

### 3.6.4 데이터베이스

**테이블**: `extracted_data`

**저장 쿼리**:
```sql
INSERT INTO extracted_data (
  report_id,
  data_type,
  variable_id,
  variable_name,
  data_value,
  source_raw_id,
  extracted_from,
  extracted_by,
  validation_status
) VALUES (
  $1, $2, $3, $4, $5, $6, $7, $8, $9
);
```

### 3.6.5 Edge Function

**엔드포인트**: `POST /functions/v1/extract-data`

**요청**:
```json
{
  "reportId": "uuid",
  "markdownDocumentId": "uuid",
  "rawId": "RAW1",
  "dataType": "CS",
  "targetVariables": ["CS0_성분명", "CS1_브랜드명"]
}
```

**응답**:
```json
{
  "success": true,
  "data": {
    "extractedData": [
      {
        "variableId": "CS0",
        "variableName": "성분명",
        "dataValue": "토지나메란"
      }
    ],
    "conflicts": [
      {
        "variableId": "CS1",
        "reason": "데이터를 찾을 수 없음"
      }
    ]
  }
}
```

### 3.6.6 UI 컴포넌트

```typescript
<DataExtractionTable
  extractedData={extractedData}
  conflicts={conflicts}
  onResolveConflict={handleResolveConflict}
  onManualInput={handleManualInput}
/>

<ConflictResolutionModal
  conflict={selectedConflict}
  onSelect={handleSelectValue}
  onManualInput={handleManualInput}
/>
```

---

_(문서가 매우 길어지고 있으므로 나머지 Stage 6-9는 다음 섹션에서 계속됩니다)_

---

## 3.7 [Stage 6] 템플릿 작성

### 3.7.1 기능 설명
추출된 데이터를 템플릿에 자동으로 삽입하여 보고서 섹션을 생성합니다.

### 3.7.2 화면 흐름
```
추출 데이터 확인
  ↓ "템플릿 작성" 버튼 클릭
섹션별 템플릿 로딩 (00-14)
  ↓ 데이터 자동 삽입
생성된 섹션 미리보기
  ↓ 검증
"다음 단계" 버튼 활성화
```

### 3.7.3 상세 요구사항

**FR-6.1: 템플릿 로딩**

**템플릿 소스**:
- 경로: `03_Template/02_Sections/`
- 파일: `00_표지.md` ~ `14_별첨.md`

**데이터 매핑**:
- `0115_CS_to_Sections.md` 기반
- 섹션별 필요 변수 자동 매핑

**FR-6.2: 데이터 삽입 규칙**

**비서술문 (CS 데이터)**:
```markdown
템플릿: "본 보고서는 [CS3_보고시작날짜]부터 [CS4_보고종료날짜]까지..."
↓ 데이터 삽입
결과: "본 보고서는 2020-01-15부터 2025-01-15까지..."
```

**서술문 (PH 데이터)**:
```markdown
템플릿: "[PH4_원시자료서술문]"
↓ LLM 생성 서술문 삽입
결과: "본 보고기간 동안 KIDS로부터 제공받은 원시자료는 총 XX건으로..."
```

**표 데이터**:
```markdown
템플릿:
| 연도 | [CS19.1_시판후판매연도] | ... |
|------|------------------------|-----|
| 판매량 | [CS19.2_시판후판매연도별판매량] | ... |

↓ 데이터 삽입
결과:
| 연도 | 2021년 | 2022년 | 2023년 |
|------|--------|--------|--------|
| 판매량 | 242,165 | 554,206 | 311,352 |
```

**FR-6.3: 서술문 생성**

**PH 데이터 생성 규칙**:
- 템플릿 구조 및 길이 유지
- 추가 설명 금지
- 추출된 데이터 기반
- 예시 템플릿 참조

**생성 방법**:
1. 관련 CS 데이터 조회
2. LLM에게 템플릿 + 데이터 전달
3. 서술문 생성 요청
4. 생성 결과 검증

**FR-6.4: 섹션별 생성 순서**

**의존성 기반 순서**:
1. Phase 1: 00_표지, 03_서론
2. Phase 2: 04_전세계판매허가현황, 05_안전성조치, 06_안전성정보참고정보변경
3. Phase 3: 07_환자노출
4. Phase 4: 08_개별증례병력
5. Phase 5: 09_시험, 10_기타정보, 11_종합적인안전성평가, 12_결론
6. Phase 6: 13_참고문헌, 14_별첨
7. Phase 7: 01_목차, 02_약어설명 (문서 완성 후 자동 생성)

**FR-6.5: 생성 결과 저장**

**저장 위치**:
- DB: `report_sections` 테이블
- 각 섹션별 레코드 생성

**저장 내용**:
- `content_markdown`: 생성된 마크다운
- `section_number`: 00-14
- `section_name`: 표지, 서론 등
- `version`: 1 (초기 버전)

**FR-6.6: 진행률 표시**

**진행률 UI**:
```
섹션 생성 중...
━━━━━━━━━━━━━━━━ 8/15

현재: 08_개별증례병력
완료: 00_표지, 03_서론, 04_전세계판매허가현황, ...
남은 섹션: 7개
```

### 3.7.4 데이터베이스

**테이블**: `report_sections`

**저장 쿼리**:
```sql
INSERT INTO report_sections (
  report_id,
  section_number,
  section_name,
  content_markdown,
  version
) VALUES (
  $1, $2, $3, $4, 1
)
ON CONFLICT (report_id, section_number)
DO UPDATE SET
  content_markdown = EXCLUDED.content_markdown,
  version = report_sections.version + 1,
  updated_at = now();
```

### 3.7.5 UI 컴포넌트

```typescript
<SectionGenerationProgress
  total={15}
  completed={completedSections}
  currentSection={currentSectionName}
/>

<GeneratedSectionPreview
  sections={generatedSections}
  onEdit={handleEditSection}
/>
```

---

## 3.8 [Stage 7] 리뷰

### 3.8.1 기능 설명
생성된 섹션별 문서를 검토하고 수정합니다.

### 3.8.2 화면 흐름
```
섹션 목록 (사이드바)
  ↓ 섹션 선택
좌측: 원본 마크다운 미리보기
우측: 편집 가능 문서
  ↓ 수정
"저장" 버튼 → 변경사항 저장
  ↓ 모든 섹션 검토 완료
"머지" 버튼 → 전체 문서 통합
  ↓
"Draft 출력" 버튼 → Word 파일 생성
```

### 3.8.3 상세 요구사항

**FR-7.1: 화면 레이아웃**

```
┌──────────┬────────────────┬────────────────┐
│ 섹션목록  │  원본 (읽기전용) │  수정본 (편집)  │
│          │                │                │
│ 00_표지 ✓ │  # 표지         │  # 표지         │
│ 03_서론 ○ │                │                │
│ 04_전세계 │  브랜드명...    │  브랜드명...    │
│ ...      │                │                │
│          │                │  [저장] [초기화]│
└──────────┴────────────────┴────────────────┘
```

**FR-7.2: 섹션 목록 (사이드바)**

**목록 표시**:
- 섹션 번호 + 섹션명
- 체크 아이콘 (저장 여부)
- 클릭 시 해당 섹션 로딩

**진행률 표시**:
```
리뷰 진행률: 5/15 (33%)
━━━━━━━━━━━━━━━━
```

**FR-7.3: 원본 미리보기 (좌측)**

**표시 방식**:
- 렌더링된 마크다운 (읽기 전용)
- 스크롤 동기화 (우측과 연동)

**FR-7.4: 수정본 편집 (우측)**

**에디터**:
- 리치 텍스트 에디터 (예: TipTap, Lexical)
- 또는 마크다운 에디터 (Monaco Editor)

**기능**:
- 텍스트 편집
- 표 편집
- 이미지 삽입 (선택)
- 되돌리기/다시하기
- 검색/바꾸기

**자동 저장**:
- 5분마다 자동 저장 (선택)
- 저장 상태 표시 ("저장됨", "저장 중...")

**FR-7.5: 변경사항 저장**

**저장 버튼 클릭 시**:
1. 수정 전/후 내용 비교
2. `review_changes` 테이블에 변경 이력 저장
3. `report_sections` 테이블 업데이트
4. 버전 번호 증가
5. 사용자 알림: "저장되었습니다"

**FR-7.6: 머지 (전체 문서 통합)**

**머지 버튼**:
- 모든 섹션이 저장된 경우에만 활성화
- 클릭 시 섹션 순서대로 통합

**통합 순서**:
```
00_표지
01_목차 (자동 생성)
02_약어설명 (자동 생성)
03_서론
04_전세계판매허가현황
...
14_별첨
```

**목차 자동 생성**:
- 모든 섹션의 헤더 추출
- 목차 및 표목차 생성
- 페이지 번호는 Word 출력 시 자동 생성

**약어설명 자동 생성**:
- 전체 문서에서 약어 추출
- 기준 약어표 (`02_약어설명.md`)와 매칭
- 사용된 약어만 표시

**FR-7.7: Draft 출력**

**Word 파일 생성**:
- 라이브러리: `docxtemplater`
- 템플릿: 사전 정의된 .docx 템플릿
- 파일명: `{보고서명}_Draft_{YYMMDD}.docx`

**저장 위치**:
- Supabase Storage `outputs` 버킷
- 사용자 로컬 다운로드

**파일 내용**:
- 모든 섹션 통합
- 표지 정보
- 목차 (페이지 번호 자동)
- 표목차
- 본문
- 참고문헌
- 별첨

### 3.8.4 데이터베이스

**테이블**: `report_sections`, `review_changes`

**섹션 업데이트**:
```sql
UPDATE report_sections
SET
  content_final = $2,
  version = version + 1,
  updated_at = now()
WHERE id = $1;
```

**변경 이력 저장**:
```sql
INSERT INTO review_changes (
  report_id,
  section_id,
  changed_by,
  content_before,
  content_after,
  change_type,
  comment
) VALUES (
  $1, $2, auth.uid(), $3, $4, 'Edit', $5
);
```

### 3.8.5 UI 컴포넌트

```typescript
<ReviewLayout>
  <SectionSidebar
    sections={sections}
    onSelect={handleSelectSection}
  />
  <OriginalPreview
    content={originalContent}
  />
  <EditableEditor
    content={editableContent}
    onChange={handleContentChange}
    onSave={handleSave}
  />
</ReviewLayout>

<MergeButton
  disabled={!allSectionsSaved}
  onClick={handleMerge}
/>

<ExportDraftButton
  onClick={handleExportDraft}
/>
```

---

## 3.9 [Stage 8] QC

### 3.9.1 기능 설명
AI 기반 품질 검증을 수행하여 작성된 보고서와 원본 소스 문서 간 불일치를 검출합니다.

### 3.9.2 화면 흐름
```
Draft 문서 확인
  ↓ "QC 검증" 버튼 클릭
Edge Function 호출 → Gemini API (Thinking 모델)
  ↓ 검증 수행
검증 결과 표시
  ↓ 이슈 있음
이슈 목록 → 수정 → 재검증
  ↓ 이슈 없음
Draft 상태 해제 → 완료
```

### 3.9.3 상세 요구사항

**FR-8.1: QC 검증 항목**

**검증 항목**:
1. **데이터 일치성**: 작성된 보고서의 CS/PH/Table 데이터가 원본과 일치하는지
2. **누락 확인**: 필수 섹션 및 데이터가 모두 포함되었는지
3. **표 번호 순서**: 표1, 표2, ... 표9가 순차적인지
4. **계산 정확성**: CS22, CS23 등 계산 데이터가 정확한지
5. **서술문 일관성**: PH 데이터가 원본 내용과 일치하는지

**FR-8.2: QC 프로세스**

**검증 단계**:
1. DB에서 원본 마크다운 조회
2. DB에서 추출된 데이터 조회
3. DB에서 작성된 보고서 섹션 조회
4. Edge Function `qc-validation` 호출
5. LLM이 교차 검증 수행 (Gemini 2.0 Flash-Thinking)
6. 검증 결과 분석

**FR-8.3: 검증 결과 분류**

**통과 (Passed)**:
- 모든 검증 항목 통과
- `validation_result = 'passed'`
- 녹색 체크 표시
- "Draft 상태 해제" 버튼 활성화

**실패 (Failed)**:
- 1개 이상 이슈 발견
- `validation_result = 'failed'`
- 빨간색 X 표시
- 이슈 목록 표시

**FR-8.4: 이슈 목록 표시**

**테이블 컬럼**:
| 컬럼 | 내용 |
|------|------|
| 번호 | 1, 2, 3... |
| 섹션 | 이슈가 발견된 섹션 |
| 유형 | data_conflict, missing_data, table_numbering |
| 설명 | 상세 설명 |
| 예상값 | 원본 데이터 |
| 실제값 | 보고서 데이터 |
| 액션 | "수정" 버튼 |

**FR-8.5: 이슈 수정**

**수정 UI**:
```
┌─────────────────────────────────────────┐
│ 이슈 #1: 데이터 불일치                   │
│                                         │
│ 섹션: 03_서론                            │
│ 변수: CS15_효능효과                      │
│                                         │
│ 예상: "16세 이상 코로나19 예방"          │
│ 실제: "12세 이상 코로나19 예방"          │
│                                         │
│ 수정 방법:                               │
│ ○ 예상값으로 변경                        │
│ ○ 실제값 유지 (원본 데이터 수정 필요)     │
│ ○ 수동 수정                              │
│                                         │
│ [적용]  [건너뛰기]                       │
└─────────────────────────────────────────┘
```

**수정 후 처리**:
- 수정 내용 `review_changes` 저장
- 섹션 업데이트
- "재검증" 버튼 표시

**FR-8.6: 재검증**

**재검증 버튼**:
- 이슈 수정 후 활성화
- 클릭 시 QC 재실행
- 수정된 이슈만 재검증 (선택)

**FR-8.7: Draft 상태 해제**

**조건**:
- QC 검증 통과
- 사용자 확인

**처리**:
```sql
UPDATE reports
SET status = 'Completed'
WHERE id = $1;
```

### 3.9.4 Edge Function

**엔드포인트**: `POST /functions/v1/qc-validation`

**요청**:
```json
{
  "reportId": "uuid",
  "sections": [
    {
      "sectionId": "uuid",
      "sectionName": "서론",
      "content": "..."
    }
  ]
}
```

**응답**:
```json
{
  "success": true,
  "data": {
    "validationResult": "failed",
    "issues": [
      {
        "section": "서론",
        "type": "data_conflict",
        "description": "CS15_효능효과가 원본과 다릅니다",
        "expected": "16세 이상",
        "actual": "12세 이상"
      }
    ],
    "summary": "1개 이슈 발견"
  }
}
```

### 3.9.5 UI 컴포넌트

```typescript
<QCValidation
  onStartValidation={handleStartValidation}
  isValidating={isValidating}
/>

<QCIssueList
  issues={qcIssues}
  onResolve={handleResolveIssue}
  onRevalidate={handleRevalidate}
/>

<IssueResolutionModal
  issue={selectedIssue}
  onApply={handleApplyFix}
  onSkip={handleSkipIssue}
/>
```

---

## 3.10 [Stage 9] 출력

### 3.10.1 기능 설명
최종 승인된 보고서를 Word 형식으로 출력합니다.

### 3.10.2 화면 흐름
```
QC 통과 확인
  ↓ "최종 출력" 버튼 클릭
출력 옵션 선택
  ↓ 출력 실행
Word 파일 생성 (docxtemplater)
  ↓ 생성 완료
파일 다운로드 + Storage 저장
```

### 3.10.3 상세 요구사항

**FR-9.1: 출력 옵션**

**선택 사항**:
- [ ] 표지 포함
- [ ] 목차 포함
- [ ] 페이지 번호 포함
- [ ] 워터마크 (Draft / Final)
- [ ] 전자서명 영역 (선택)

**파일명 형식**:
- Draft: `{보고서명}_Draft_{YYMMDD}.docx`
- Final: `{보고서명}_Final_{YYMMDD}.docx`

**FR-9.2: Word 파일 생성**

**템플릿 사용**:
- 사전 정의된 `.docx` 템플릿
- 스타일 (제목, 본문, 표) 사전 설정
- 헤더/푸터 설정

**docxtemplater 활용**:
```typescript
const doc = new Docxtemplater(templateBuffer, {
  paragraphLoop: true,
  linebreaks: true,
})

doc.render({
  CS0_성분명: '토지나메란',
  CS1_브랜드명: '코미나티주',
  // ... 모든 데이터
})

const outputBuffer = doc.getZip().generate({ type: 'blob' })
```

**FR-9.3: 페이지 구성**

**페이지 설정**:
- 용지: A4
- 여백: 상하좌우 20mm
- 글꼴: 맑은 고딕 10pt
- 줄 간격: 1.5

**헤더**:
```
─────────────────────────────────────
{브랜드명} PSUR 보고서
─────────────────────────────────────
```

**푸터**:
```
─────────────────────────────────────
페이지 {현재페이지} / {전체페이지}
─────────────────────────────────────
```

**FR-9.4: 표 스타일**

**표 기본 스타일**:
- 테두리: 검정 실선 1pt
- 헤더: 회색 배경 (#F0F0F0)
- 헤더 글꼴: 굵게
- 셀 여백: 5pt

**FR-9.5: 파일 저장 및 다운로드**

**저장 위치**:
1. Supabase Storage `outputs` 버킷
2. 사용자 로컬 다운로드

**다운로드**:
- 브라우저 자동 다운로드
- 다운로드 완료 알림

### 3.10.4 UI 컴포넌트

```typescript
<ExportOptions
  onExport={handleExport}
  defaultOptions={{
    includeCover: true,
    includeTOC: true,
    includePageNumbers: true,
    watermark: 'Final',
  }}
/>

<ExportProgress
  isExporting={isExporting}
  progress={exportProgress}
/>
```

---

# 4. 화면 설계

## 4.1 화면 구조

### 4.1.1 전체 레이아웃

```
┌─────────────────────────────────────────────────────────────┐
│ Header: 로고 | 보고서명 | 사용자 정보 | 로그아웃           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ ┌───────────┬───────────────────────────────────────────┐   │
│ │           │                                           │   │
│ │ Sidebar   │       Main Content Area                   │   │
│ │           │                                           │   │
│ │ - 대시보드 │                                           │   │
│ │ - 보고서   │                                           │   │
│ │ - 설정     │                                           │   │
│ │           │                                           │   │
│ └───────────┴───────────────────────────────────────────┘   │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│ Footer: © 2025 KSUR v6 | 문의: support@... | 버전: 1.0     │
└─────────────────────────────────────────────────────────────┘
```

### 4.1.2 색상 팔레트

| 용도 | 색상 | Hex Code |
|------|------|----------|
| Primary | 파란색 | #3B82F6 |
| Secondary | 회색 | #6B7280 |
| Success | 초록색 | #10B981 |
| Warning | 노란색 | #F59E0B |
| Error | 빨간색 | #EF4444 |
| Background | 흰색/회색 | #FFFFFF / #F9FAFB |

### 4.1.3 타이포그래피

| 요소 | 폰트 | 크기 | 굵기 |
|------|------|------|------|
| H1 | 맑은 고딕 | 32px | Bold |
| H2 | 맑은 고딕 | 24px | Bold |
| H3 | 맑은 고딕 | 20px | Semibold |
| Body | 맑은 고딕 | 16px | Regular |
| Small | 맑은 고딕 | 14px | Regular |

## 4.2 주요 화면 설계

### 4.2.1 로그인 화면

**경로**: `/login`

**레이아웃**:
```
┌─────────────────────────────────────┐
│                                     │
│         [로고]                       │
│                                     │
│      KSUR 시스템 로그인               │
│                                     │
│  ┌─────────────────────────────┐   │
│  │ 이메일                       │   │
│  │ [_____________________]     │   │
│  │                             │   │
│  │ 비밀번호                     │   │
│  │ [_____________________]     │   │
│  │                             │   │
│  │ □ 로그인 상태 유지            │   │
│  │                             │   │
│  │    [  로그인  ]              │   │
│  │                             │   │
│  │    비밀번호 찾기 →            │   │
│  └─────────────────────────────┘   │
│                                     │
└─────────────────────────────────────┘
```

**UI 요소**:
- 이메일 입력 필드 (placeholder: "user@example.com")
- 비밀번호 입력 필드 (type="password", 눈 아이콘으로 표시/숨김)
- "로그인 상태 유지" 체크박스
- "로그인" 버튼 (Primary)
- "비밀번호 찾기" 링크

**상태**:
- 로딩 중: 로그인 버튼 비활성화 + 스피너 표시
- 에러: 입력 필드 빨간 테두리 + 에러 메시지

### 4.2.2 대시보드

**경로**: `/dashboard`

**레이아웃**:
```
┌─────────────────────────────────────────────────┐
│ 대시보드                                         │
├─────────────────────────────────────────────────┤
│                                                 │
│ 환영합니다, {사용자명}님!                         │
│                                                 │
│ ┌───────────┬───────────┬───────────┬────────┐  │
│ │ 총 보고서 │ Draft     │ 완료      │ 리뷰중  │  │
│ │    15     │    3      │   10      │    2   │  │
│ └───────────┴───────────┴───────────┴────────┘  │
│                                                 │
│ 최근 보고서                        [새 보고서 +]  │
│ ┌─────────────────────────────────────────────┐ │
│ │ 보고서명 | 단계 | 작성자 | 수정일 | 액션     │ │
│ ├─────────────────────────────────────────────┤ │
│ │ Brand_A  |  7   | 홍길동 | 1시간전| [계속]  │ │
│ │ Brand_B  |  3   | 김철수 | 1일전  | [계속]  │ │
│ └─────────────────────────────────────────────┘ │
│                                                 │
└─────────────────────────────────────────────────┘
```

**UI 요소**:
- 통계 카드 4개 (총 보고서, Draft, 완료, 리뷰중)
- "새 보고서" 버튼 (Primary, 우측 상단)
- 최근 보고서 테이블
- "계속" 버튼 (보고서 행마다)

### 4.2.3 Stage 2: 보고서 생성 폼

**경로**: `/reports/new`

**레이아웃**:
```
┌─────────────────────────────────────────────────┐
│ 새 보고서 생성                          [X 닫기]  │
├─────────────────────────────────────────────────┤
│                                                 │
│ 기본 정보                                        │
│ ┌─────────────────────────────────────────────┐ │
│ │ 성분명 *                                    │ │
│ │ [_______________________________________]   │ │
│ │                                             │ │
│ │ 브랜드명 *                                   │ │
│ │ [_______________________________________]   │ │
│ │                                             │ │
│ │ 회사명 *                                     │ │
│ │ [_______________________________________]   │ │
│ │                                             │ │
│ │ 보고종료날짜 *         국내허가일자 *         │ │
│ │ [______________]      [______________]     │ │
│ │                                             │ │
│ │ 보고서제출일 *         버전넘버 *             │ │
│ │ [______________]      [______________]     │ │
│ │                                             │ │
│ │ 유효기간 *             MedDRA버전 *          │ │
│ │ [______________]      [______________]     │ │
│ │                                             │ │
│ │ 1일사용량 *            환자1명당사용량 *       │ │
│ │ [______________]      [______________]     │ │
│ └─────────────────────────────────────────────┘ │
│                                                 │
│          [취소]              [보고서 생성 →]     │
│                                                 │
└─────────────────────────────────────────────────┘
```

**UI 요소**:
- 텍스트 입력 필드 (성분명, 브랜드명, 회사명)
- 날짜 선택기 (보고종료날짜, 국내허가일자, 보고서제출일, 유효기간)
- 숫자 입력 필드 (1일사용량, 환자1명당사용량)
- 텍스트 입력 (버전넘버, MedDRA버전)
- 필수 필드 표시 (*)
- "취소" 버튼 (Secondary)
- "보고서 생성" 버튼 (Primary)

**검증**:
- 실시간 검증 (입력 시)
- 제출 시 전체 검증
- 에러 메시지 입력 필드 하단 표시

### 4.2.4 Stage 3: 파일 업로드

**경로**: `/reports/{id}/upload`

**레이아웃**:
```
┌─────────────────────────────────────────────────┐
│ 소스문서 업로드                    Step 3/9      │
├─────────────────────────────────────────────────┤
│                                                 │
│ ┌─────────────────────────────────────────────┐ │
│ │                                             │ │
│ │         드래그 앤 드롭으로 파일 업로드        │ │
│ │                                             │ │
│ │          또는 [파일 선택] 클릭               │ │
│ │                                             │ │
│ │     지원 형식: PDF, Excel, Word             │ │
│ │     최대 크기: 50MB/파일                    │ │
│ └─────────────────────────────────────────────┘ │
│                                                 │
│ 업로드된 파일                                    │
│ ┌─────────────────────────────────────────────┐ │
│ │ 파일명     | RAW ID | 신뢰도 | 크기 | 액션   │ │
│ ├─────────────────────────────────────────────┤ │
│ │ 첨부문서.pdf| RAW1  | ●95%  | 5MB | [삭제] │ │
│ │ 판매.xlsx  | RAW3  | ●92%  | 2MB | [삭제] │ │
│ │ 용법.docx  | RAW2.1| ●88%  | 1MB | [삭제] │ │
│ └─────────────────────────────────────────────┘ │
│                                                 │
│ 필수 파일: RAW1 ✓ RAW2.1 ✓ RAW2.2 ○ ...         │
│                                                 │
│          [← 이전]              [다음 →]         │
│                                                 │
└─────────────────────────────────────────────────┘
```

**UI 요소**:
- 파일 드롭존 (점선 테두리)
- "파일 선택" 버튼
- 파일 목록 테이블
- RAW ID 드롭다운 (수정 가능)
- 신뢰도 색상 코드 (●)
- 필수 파일 체크리스트
- "이전" / "다음" 버튼

### 4.2.5 Stage 4: 마크다운 변환

**경로**: `/reports/{id}/convert`

**레이아웃**:
```
┌─────────────────────────────────────────────────┐
│ 마크다운 변환                      Step 4/9      │
├─────────────────────────────────────────────────┤
│                                                 │
│ [모두 변환]         진행률: 3/10 (30%)          │
│                                                 │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│                                                 │
│ 현재: RAW3_판매데이터.xlsx 변환 중...            │
│                                                 │
│ ┌──────────┬──────────────────────────────────┐ │
│ │ RAW ID   │ 미리보기                         │ │
│ ├──────────┼──────────────────────────────────┤ │
│ │ RAW1  ✓  │ # 첨부문서                       │ │
│ │ RAW2.1✓  │                                  │ │
│ │ RAW2.2○  │ ## 효능효과                      │ │
│ │ RAW3  ⏳  │ ...                              │ │
│ │          │                                  │ │
│ │          │ [수정] [재변환] [다운로드]       │ │
│ └──────────┴──────────────────────────────────┘ │
│                                                 │
│          [← 이전]              [다음 →]         │
│                                                 │
└─────────────────────────────────────────────────┘
```

**UI 요소**:
- "모두 변환" 버튼 (Primary)
- 진행률 바
- 현재 처리 중 파일 표시
- 좌측: RAW ID 목록 (체크/로딩 아이콘)
- 우측: 마크다운 미리보기
- "수정" / "재변환" / "다운로드" 버튼

### 4.2.6 Stage 5: 데이터 추출

**경로**: `/reports/{id}/extract`

**레이아웃**:
```
┌─────────────────────────────────────────────────┐
│ 데이터 추출                        Step 5/9      │
├─────────────────────────────────────────────────┤
│                                                 │
│ [데이터 추출 시작]       진행률: 45/76 (59%)     │
│                                                 │
│ 추출 결과                                        │
│ ┌─────────────────────────────────────────────┐ │
│ │ ID   | Name     | 값       | 소스  | 상태   │ │
│ ├─────────────────────────────────────────────┤ │
│ │ CS0  | 성분명   | 토지...  | RAW1  | ✓성공 │ │
│ │ CS1  | 브랜드명 | 코미...  | RAW1  | ✓성공 │ │
│ │ CS15 | 효능효과 | (충돌)   | -     | ⚠충돌 │ │
│ │ CS16 | 용법용량 | (누락)   | -     | ✗실패 │ │
│ └─────────────────────────────────────────────┘ │
│                                                 │
│ 충돌/누락: 2건                  [해결하기 →]     │
│                                                 │
│          [← 이전]              [다음 →]         │
│                                                 │
└─────────────────────────────────────────────────┘
```

**UI 요소**:
- "데이터 추출 시작" 버튼 (Primary)
- 진행률 표시
- 추출 결과 테이블
- 상태 아이콘 (✓ ⚠ ✗)
- "해결하기" 버튼 (충돌/누락 있을 때)

### 4.2.7 Stage 7: 리뷰

**경로**: `/reports/{id}/review`

**레이아웃**:
```
┌───┬─────────────┬────────────────┬────────────────┐
│   │ 섹션 목록    │ 원본 (읽기전용) │ 수정 (편집)     │
├───┼─────────────┼────────────────┼────────────────┤
│ S │ ✓ 00_표지   │ # 표지          │ # 표지          │
│ i │ ✓ 03_서론   │                │                │
│ d │ ○ 04_전세계 │ 브랜드명...     │ 브랜드명...     │
│ e │ ○ 05_안전성 │                │                │
│ b │ ○ 07_환자   │                │                │
│ a │ ...        │                │                │
│ r │            │                │  [저장] [초기화]│
│   │            │                │                │
│   │ 진행률:     │                │                │
│   │ 5/15(33%)  │                │                │
├───┼─────────────┴────────────────┴────────────────┤
│   │          [머지] [Draft 출력]                  │
└───┴──────────────────────────────────────────────┘
```

**UI 요소**:
- 좌측 사이드바: 섹션 목록 (체크 아이콘)
- 중앙: 원본 마크다운 렌더링
- 우측: 편집 가능 에디터
- "저장" / "초기화" 버튼
- "머지" / "Draft 출력" 버튼 (하단)

### 4.2.8 Stage 8: QC

**경로**: `/reports/{id}/qc`

**레이아웃**:
```
┌─────────────────────────────────────────────────┐
│ QC 검증                            Step 8/9      │
├─────────────────────────────────────────────────┤
│                                                 │
│ [QC 검증 시작]                                   │
│                                                 │
│ 검증 결과:  ✗ 실패                               │
│             3개 이슈 발견                         │
│                                                 │
│ ┌─────────────────────────────────────────────┐ │
│ │ # | 섹션  | 유형       | 설명       | 액션   │ │
│ ├─────────────────────────────────────────────┤ │
│ │ 1 | 03_서론| 데이터충돌 | CS15 불일치| [수정]│ │
│ │ 2 | 07_환자| 누락       | 표2 없음   | [수정]│ │
│ │ 3 | 08_개별| 표번호     | 표8 중복   | [수정]│ │
│ └─────────────────────────────────────────────┘ │
│                                                 │
│          [← 이전]              [재검증]         │
│                                                 │
└─────────────────────────────────────────────────┘
```

**UI 요소**:
- "QC 검증 시작" 버튼 (Primary)
- 검증 결과 표시 (성공 ✓ / 실패 ✗)
- 이슈 목록 테이블
- "수정" 버튼 (각 이슈)
- "재검증" 버튼

## 4.3 반응형 디자인

### 4.3.1 중단점 (Breakpoints)

| 기기 | 중단점 | 레이아웃 |
|------|--------|----------|
| Mobile | < 640px | 단일 컬럼, 사이드바 숨김 |
| Tablet | 640px - 1024px | 2 컬럼, 축소된 사이드바 |
| Desktop | > 1024px | 3 컬럼, 전체 레이아웃 |

### 4.3.2 모바일 최적화

**네비게이션**:
- 햄버거 메뉴 (☰)
- 하단 탭 바 (선택)

**테이블**:
- 가로 스크롤
- 카드 뷰 전환 (선택)

**폼**:
- 세로 배치
- 큰 터치 영역 (최소 44px)

---

# 5. 데이터베이스 설계

## 5.1 ER 다이어그램

```
users (1) ──< (N) reports (1) ──< (N) source_documents
                  │                         │
                  │                         ↓
                  │              markdown_documents (N)
                  │                         │
                  ↓                         ↓
           report_sections (N)    extracted_data (N)
                  │
                  ↓
           review_changes (N)
```

## 5.2 테이블 상세 설계

_(이미 `01_DataBaseStructure.md`에 상세히 정의되어 있으므로 생략)_

**참조**: `09_relateDocs/01_DataBaseStructure.md`

## 5.3 인덱스 전략

### 5.3.1 필수 인덱스

```sql
-- reports 테이블
CREATE INDEX idx_reports_created_by ON reports(created_by);
CREATE INDEX idx_reports_status ON reports(status);
CREATE INDEX idx_reports_created_at ON reports(created_at DESC);

-- extracted_data 테이블
CREATE INDEX idx_extracted_data_report_variable
ON extracted_data(report_id, variable_id);

-- review_changes 테이블
CREATE INDEX idx_review_changes_report ON review_changes(report_id);
CREATE INDEX idx_review_changes_created_at ON review_changes(created_at DESC);
```

### 5.3.2 복합 인덱스

```sql
-- 보고서 조회 성능 향상
CREATE INDEX idx_reports_lookup
ON reports(status, created_by, updated_at DESC);
```

## 5.4 데이터 무결성

### 5.4.1 Foreign Key 제약

모든 FK에 `ON DELETE CASCADE` 또는 `ON DELETE RESTRICT` 설정

### 5.4.2 Check 제약

```sql
-- 역할 제한
CHECK (role IN ('Master', 'Author', 'Reviewer', 'Viewer'))

-- 상태 제한
CHECK (status IN ('Draft', 'InReview', 'QC', 'Completed'))
```

---

# 6. API 설계

## 6.1 Supabase Edge Functions

_(이미 `03_SupabaseEdgeFunctions.md`에 상세히 정의되어 있으므로 생략)_

**참조**: `09_relateDocs/03_SupabaseEdgeFunctions.md`

## 6.2 Supabase Client API

### 6.2.1 인증 API

```typescript
// 로그인
supabase.auth.signInWithPassword({ email, password })

// 로그아웃
supabase.auth.signOut()

// 세션 확인
supabase.auth.getSession()
```

### 6.2.2 데이터베이스 API

```typescript
// 보고서 조회
supabase
  .from('reports')
  .select('*')
  .eq('status', 'Draft')
  .order('updated_at', { ascending: false })

// 보고서 생성
supabase
  .from('reports')
  .insert({ report_name, created_by, user_inputs })

// 보고서 업데이트
supabase
  .from('reports')
  .update({ current_stage: 5 })
  .eq('id', reportId)
```

### 6.2.3 Storage API

```typescript
// 파일 업로드
supabase.storage
  .from('reports')
  .upload(`${reportId}/source/${fileName}`, file)

// 파일 다운로드
supabase.storage
  .from('reports')
  .download(`${reportId}/source/${fileName}`)
```

---

# 7. 비기능 요구사항

## 7.1 성능 요구사항

| 항목 | 목표 |
|------|------|
| 페이지 로딩 시간 | < 2초 |
| API 응답 시간 | < 500ms (Edge Functions 제외) |
| Edge Function 실행 시간 | < 60초 |
| 동시 접속 사용자 | 100명 |
| 파일 업로드 속도 | 5MB/초 이상 |

## 7.2 보안 요구사항

_(이미 `05_SecurityBestPractices.md`에 상세히 정의되어 있으므로 생략)_

**참조**: `09_relateDocs/05_SecurityBestPractices.md`

## 7.3 가용성 요구사항

| 항목 | 목표 |
|------|------|
| 시스템 가동률 | 99% (연간 다운타임 < 87시간) |
| 백업 주기 | 일 1회 |
| 백업 보관 기간 | 30일 |
| 재해 복구 시간 (RTO) | 24시간 |
| 데이터 손실 허용 시간 (RPO) | 24시간 |

## 7.4 확장성 요구사항

| 항목 | 현재 | 1년 후 |
|------|------|--------|
| 사용자 수 | 10명 | 50명 |
| 보고서 수 | 100건 | 1,000건 |
| 저장 용량 | 10GB | 100GB |
| 월간 API 호출 | 10K | 100K |

## 7.5 호환성 요구사항

### 7.5.1 브라우저 지원

| 브라우저 | 최소 버전 |
|---------|----------|
| Chrome | 90+ |
| Edge | 90+ |
| Safari | 14+ |
| Firefox | 88+ |

### 7.5.2 파일 형식 지원

| 형식 | 읽기 | 쓰기 |
|------|------|------|
| PDF | ✅ | ❌ |
| Word (.docx) | ✅ | ✅ |
| Excel (.xlsx) | ✅ | ❌ |
| Markdown (.md) | ✅ | ✅ |

---

# 8. 개발 계획

## 8.1 개발 방법론

**Agile (Scrum)** 적용

- Sprint 기간: 2주
- 일일 스탠드업
- Sprint 리뷰 및 회고

## 8.2 개발 단계 및 일정

### Phase 1: 기본 인프라 (2주)

**Sprint 1-2**:
- [ ] GitHub Repository 생성
- [ ] Vite + React + TypeScript 프로젝트 초기화
- [ ] Tailwind CSS + shadcn/ui 설정
- [ ] Supabase 프로젝트 생성
- [ ] DB 스키마 적용
- [ ] RLS 정책 설정
- [ ] Storage 버킷 생성
- [ ] GitHub Actions 워크플로우 작성

**산출물**:
- 배포 가능한 기본 프로젝트
- 로그인 화면
- 대시보드 (빈 화면)

### Phase 2: 인증 및 보고서 관리 (2주)

**Sprint 3-4**:
- [ ] Supabase Auth 연동
- [ ] 로그인/로그아웃 기능
- [ ] 보고서 생성 폼
- [ ] 보고서 목록 조회
- [ ] 보고서 상태 관리

**산출물**:
- 완전한 인증 시스템
- 보고서 CRUD 기능

### Phase 3: 파일 업로드 및 분류 (2주)

**Sprint 5-6**:
- [ ] 파일 업로드 UI
- [ ] Supabase Storage 연동
- [ ] Edge Function: classify-raw-id
- [ ] RAW ID 자동 분류
- [ ] 파일 매칭 테이블 생성

**산출물**:
- Stage 3 완성
- RAW ID 분류 기능

### Phase 4: 마크다운 변환 (3주)

**Sprint 7-9**:
- [ ] Edge Function: convert-to-markdown
- [ ] Gemini API 연동
- [ ] PDF/Word/Excel 파싱
- [ ] 마크다운 미리보기
- [ ] 수동 수정 기능

**산출물**:
- Stage 4 완성
- 마크다운 변환 기능

### Phase 5: 데이터 추출 (3주)

**Sprint 10-12**:
- [ ] Edge Function: extract-data
- [ ] CS/PH/Table 데이터 추출
- [ ] 충돌 해결 UI
- [ ] LLM 대화 로그 저장

**산출물**:
- Stage 5 완성
- 데이터 추출 기능

### Phase 6: 템플릿 작성 (2주)

**Sprint 13-14**:
- [ ] 템플릿 로딩
- [ ] 데이터 자동 삽입
- [ ] 서술문 생성 (LLM)
- [ ] 섹션별 저장

**산출물**:
- Stage 6 완성
- 자동 보고서 생성 기능

### Phase 7: 리뷰 및 QC (3주)

**Sprint 15-17**:
- [ ] 리뷰 화면 (3-column 레이아웃)
- [ ] 텍스트 에디터 연동
- [ ] 변경 이력 저장
- [ ] 머지 기능
- [ ] Edge Function: qc-validation
- [ ] QC 이슈 표시 및 해결

**산출물**:
- Stage 7-8 완성
- 리뷰 및 QC 기능

### Phase 8: 출력 및 최적화 (2주)

**Sprint 18-19**:
- [ ] Word 파일 생성 (docxtemplater)
- [ ] Draft/Final 출력
- [ ] 성능 최적화
- [ ] 버그 수정

**산출물**:
- Stage 9 완성
- 전체 시스템 완성

### Phase 9: 테스트 및 배포 (2주)

**Sprint 20-21**:
- [ ] 통합 테스트
- [ ] E2E 테스트
- [ ] 사용자 인수 테스트 (UAT)
- [ ] 프로덕션 배포
- [ ] 문서 작성

**산출물**:
- 프로덕션 배포
- 사용자 매뉴얼

**총 개발 기간**: **21주 (약 5개월)**

## 8.3 팀 구성

| 역할 | 인원 | 역할 |
|------|------|------|
| 프론트엔드 개발자 | 2명 | React, UI/UX |
| 백엔드 개발자 | 1명 | Supabase, Edge Functions |
| LLM 엔지니어 | 1명 | Gemini API, 프롬프트 엔지니어링 |
| QA 엔지니어 | 1명 | 테스트 |
| PM | 1명 | 프로젝트 관리 |

**총 인원**: 6명

## 8.4 마일스톤

| 마일스톤 | 일정 | 산출물 |
|---------|------|--------|
| M1: 기본 인프라 | Week 2 | 배포 가능한 기본 프로젝트 |
| M2: 인증 및 보고서 관리 | Week 4 | 보고서 CRUD |
| M3: 파일 처리 | Week 6 | 파일 업로드 및 분류 |
| M4: 데이터 변환 | Week 9 | 마크다운 변환 |
| M5: 데이터 추출 | Week 12 | CS/PH/Table 추출 |
| M6: 보고서 생성 | Week 14 | 자동 보고서 생성 |
| M7: 리뷰 및 QC | Week 17 | 리뷰 및 검증 |
| M8: 최종 출력 | Week 19 | Word 출력 |
| M9: 프로덕션 출시 | Week 21 | 프로덕션 배포 |

---

# 9. 테스트 계획

## 9.1 테스트 전략

### 9.1.1 테스트 레벨

| 레벨 | 목적 | 도구 |
|------|------|------|
| **단위 테스트** | 개별 함수/컴포넌트 | Vitest |
| **통합 테스트** | 컴포넌트 간 상호작용 | React Testing Library |
| **E2E 테스트** | 전체 사용자 플로우 | Playwright (선택) |
| **성능 테스트** | 로딩 속도, 반응성 | Lighthouse |
| **보안 테스트** | 취약점 검사 | npm audit |

### 9.1.2 테스트 범위

**목표 커버리지**:
- 단위 테스트: 80% 이상
- 통합 테스트: 주요 플로우 100%
- E2E 테스트: 핵심 시나리오 100%

## 9.2 테스트 케이스

### 9.2.1 기능 테스트

**Stage 1: 로그인**
- [ ] 정상 로그인 성공
- [ ] 잘못된 비밀번호 입력 시 에러
- [ ] 존재하지 않는 이메일 입력 시 에러
- [ ] 로그인 상태 유지 기능
- [ ] 로그아웃 기능

**Stage 2: 보고서 생성**
- [ ] 필수 필드 누락 시 에러
- [ ] 날짜 검증 (허가일 < 보고종료일)
- [ ] 보고서명 자동 생성
- [ ] DB 저장 확인

**Stage 3: 파일 업로드**
- [ ] 파일 업로드 성공
- [ ] 허용되지 않은 파일 형식 차단
- [ ] 파일 크기 초과 차단
- [ ] RAW ID 자동 분류 (신뢰도 > 0.9)
- [ ] RAW ID 수동 수정
- [ ] 필수 파일 확인

**Stage 4: 마크다운 변환**
- [ ] PDF 변환 성공
- [ ] Excel 변환 성공
- [ ] Word 변환 성공
- [ ] 변환 실패 처리
- [ ] 수동 수정 기능

**Stage 5: 데이터 추출**
- [ ] CS 데이터 추출 성공
- [ ] PH 데이터 추출 성공
- [ ] Table 데이터 추출 성공
- [ ] 누락 데이터 감지
- [ ] 충돌 데이터 감지 및 해결

**Stage 6: 템플릿 작성**
- [ ] 모든 섹션 생성 성공
- [ ] 데이터 정확히 삽입
- [ ] 서술문 생성 (LLM)

**Stage 7: 리뷰**
- [ ] 섹션별 수정 및 저장
- [ ] 변경 이력 기록
- [ ] 머지 기능
- [ ] Draft Word 출력

**Stage 8: QC**
- [ ] QC 검증 실행
- [ ] 이슈 감지
- [ ] 이슈 수정 및 재검증
- [ ] Draft 상태 해제

**Stage 9: 출력**
- [ ] Final Word 파일 생성
- [ ] 파일 다운로드
- [ ] Storage 저장

### 9.2.2 성능 테스트

| 테스트 | 목표 | 측정 방법 |
|--------|------|-----------|
| 페이지 로딩 | < 2초 | Lighthouse |
| 파일 업로드 (10MB) | < 5초 | 실측 |
| 마크다운 변환 (1파일) | < 30초 | Edge Function 로그 |
| 데이터 추출 (10변수) | < 10초 | Edge Function 로그 |
| QC 검증 | < 60초 | Edge Function 로그 |

### 9.2.3 보안 테스트

- [ ] RLS 정책 검증 (권한별)
- [ ] XSS 공격 방어
- [ ] SQL Injection 방어
- [ ] API 키 노출 확인
- [ ] HTTPS 강제 확인

## 9.3 테스트 자동화

### 9.3.1 CI/CD 파이프라인

```yaml
# .github/workflows/test.yml
name: Test

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
      - run: npm ci
      - run: npm run test
      - run: npm run lint
```

### 9.3.2 테스트 실행 명령

```bash
# 단위 테스트
npm run test

# 커버리지 리포트
npm run test:coverage

# E2E 테스트
npm run test:e2e

# 린트 검사
npm run lint
```

---

# 10. 배포 계획

_(이미 `04_DeploymentGuide.md`에 상세히 정의되어 있으므로 생략)_

**참조**: `09_relateDocs/04_DeploymentGuide.md`

## 10.1 배포 환경

| 환경 | 목적 | URL |
|------|------|-----|
| Development | 개발 | `localhost:5173` |
| Staging | 테스트 | `staging.github.io` (선택) |
| Production | 프로덕션 | `username.github.io/ksur-v6` |

## 10.2 배포 전 체크리스트

- [ ] 모든 테스트 통과
- [ ] 린트 에러 없음
- [ ] TypeScript 컴파일 성공
- [ ] 환경변수 설정 완료
- [ ] RLS 정책 적용
- [ ] Edge Functions 배포
- [ ] 백업 완료
- [ ] 롤백 계획 수립

---

# 11. 부록

## 11.1 용어 정의

| 용어 | 설명 |
|------|------|
| **PSUR** | Periodic Safety Update Report (정기 안전성 최신 보고서) |
| **KSUR** | Korean Safety Update Report (한국형 안전성 보고서) |
| **MFDS** | Ministry of Food and Drug Safety (식품의약품안전처) |
| **RAW ID** | 소스 문서 분류 태그 (RAW1, RAW2.1 등) |
| **CS 데이터** | Context-Specific Data (단일 값 데이터) |
| **PH 데이터** | Paragraph/Phrase Data (서술형 데이터) |
| **Table 데이터** | 구조화된 표 데이터 |
| **MedDRA** | Medical Dictionary for Regulatory Activities |
| **SOC** | System Organ Class (기관계분류) |
| **PT** | Preferred Term (우선용어) |
| **RLS** | Row Level Security (행 수준 보안) |
| **Edge Functions** | Supabase 서버리스 함수 (Deno 기반) |
| **LLM** | Large Language Model (대규모 언어 모델) |

## 11.2 참조 문서

| 문서명 | 경로 | 설명 |
|--------|------|------|
| 워크플로우 | `01_Context/01_Workfolw.md` | 9단계 워크플로우 상세 |
| CS 데이터 정의 | `01_Context/0111_CSData_Definition.md` | CS 변수 60개 정의 |
| PH 데이터 정의 | `01_Context/0112_PHData_Definition.md` | PH 변수 9개 정의 |
| Table 데이터 정의 | `01_Context/0113_TableData_Definition.md` | Table 변수 7개 정의 |
| 소스 매핑 | `01_Context/0114_CS_from_Source.md` | RAW ID → CS 매핑 |
| 섹션 매핑 | `01_Context/0115_CS_to_Sections.md` | CS → 섹션 매핑 |
| 통합 매핑 | `01_Context/0116_Source_CS_Sections.md` | 전체 데이터 흐름 |
| DB 구조 | `09_relateDocs/01_DataBaseStructure.md` | 데이터베이스 스키마 |
| 기술 스택 | `09_relateDocs/02_TechStack.md` | 기술 스택 상세 |
| Edge Functions | `09_relateDocs/03_SupabaseEdgeFunctions.md` | API 명세 |
| 배포 가이드 | `09_relateDocs/04_DeploymentGuide.md` | 배포 절차 |
| 보안 가이드 | `09_relateDocs/05_SecurityBestPractices.md` | 보안 best practices |

## 11.3 변경 이력

| 버전 | 날짜 | 작성자 | 변경 내용 |
|------|------|--------|-----------|
| 1.0 | 2025-12-29 | - | 초안 작성 |

---

**문서 끝**

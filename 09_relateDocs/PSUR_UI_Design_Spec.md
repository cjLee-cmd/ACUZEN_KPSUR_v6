# KPSUR AGENT UI/UX 설계 명세서

**버전**: 2.0
**작성일**: 2025-12-31
**목적**: LLM 기반 PSUR 자동 생성 시스템 UI 설계

---

## 1. 시스템 개요

### 1.1 핵심 기능
- **다중 LLM 지원**: Claude (Opus/Sonnet/Haiku), OpenAI (GPT-4/4o), Google Gemini
- **Hybrid 모드**: Sonnet 초안 → Opus 핵심섹션 개선 (비용 61% 절감)
- **자동+수동 QC**: LLM 자동 검증 후 사용자 최종 확인
- **Diff 뷰어**: 원본 대비 생성 결과 비교 기능

### 1.2 기술 스택
- **Frontend**: Vanilla JS (ES6 Modules)
- **Backend**: Supabase (Auth, Storage, Database)
- **LLM API**: Anthropic Claude, OpenAI, Google Gemini
- **문서 처리**: PDF.js, XLSX.js, Mammoth.js

---

## 2. 전체 워크플로우

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           KPSUR AGENT 워크플로우                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐  │
│  │  Stage 1 │──▶│  Stage 2 │──▶│  Stage 3 │──▶│  Stage 4 │──▶│  Stage 5 │  │
│  │  로그인   │   │ 보고서설정 │   │ 파일업로드 │   │ MD 변환  │   │데이터추출 │  │
│  └──────────┘   └──────────┘   └──────────┘   └──────────┘   └──────────┘  │
│                                                                              │
│                                                                              │
│  ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐                  │
│  │  Stage 9 │◀──│  Stage 8 │◀──│  Stage 7 │◀──│  Stage 6 │                  │
│  │ 최종출력  │   │ QC 검증  │   │   리뷰    │   │템플릿작성 │                  │
│  └──────────┘   └──────────┘   └──────────┘   └──────────┘                  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. Stage별 상세 설계

### 3.1 Stage 1: 로그인 (P01_Login.html)
**기존 유지** - 변경 없음

### 3.2 Stage 2: 보고서 설정 (P13_NewReport.html) - 개선

#### 3.2.1 화면 구성

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  📋 새 보고서 생성                                                [설정 ⚙️]   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ 기본 정보                                                            │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │  보고서명:    [_________________________________]                    │    │
│  │  성분명:      [_________________________________]                    │    │
│  │  보고기간:    [시작일] ~ [종료일]                                     │    │
│  │  제출일:      [_________]                                            │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ 🤖 LLM 설정                                             [고급설정 ▼] │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  생성 모드:   ○ Single Model    ● Hybrid Mode (권장)                 │    │
│  │                                                                      │    │
│  │  ┌─────────────────────────────────────────────────────────────┐    │    │
│  │  │  Hybrid 모드 설정                                           │    │    │
│  │  │  ┌──────────────────┐    ┌──────────────────┐              │    │    │
│  │  │  │ 📝 Phase 1: 초안  │───▶│ ✨ Phase 2: 개선  │              │    │    │
│  │  │  │ ┌──────────────┐ │    │ ┌──────────────┐ │              │    │    │
│  │  │  │ │ Sonnet 3.5   │ │    │ │ Opus 4.5     │ │              │    │    │
│  │  │  │ │ 전체 15섹션   │ │    │ │ 섹션 9, 10   │ │              │    │    │
│  │  │  │ │ ~$0.60      │ │    │ │ ~$0.60       │ │              │    │    │
│  │  │  │ └──────────────┘ │    │ └──────────────┘ │              │    │    │
│  │  │  └──────────────────┘    └──────────────────┘              │    │    │
│  │  │                                                             │    │    │
│  │  │  예상 비용: ~$1.20 (Opus 단독 대비 61% 절감)                  │    │    │
│  │  └─────────────────────────────────────────────────────────────┘    │    │
│  │                                                                      │    │
│  │  [Single Model 선택 시]                                              │    │
│  │  모델 선택:   [Claude Opus 4.5 ▼]                                    │    │
│  │              • Claude Opus 4.5 ($15/$75) - 최고 품질                 │    │
│  │              • Claude Sonnet 3.5 ($3/$15) - 균형                     │    │
│  │              • GPT-4o ($5/$15) - OpenAI                              │    │
│  │              • Gemini 2.0 Pro ($0.075/$0.30) - 경제적               │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│                              [이전] [다음 단계 →]                            │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 3.2.2 LLM 고급 설정 모달

```
┌──────────────────────────────────────────────────────────────────────────┐
│  ⚙️ LLM 고급 설정                                                    [X]  │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  🔑 API 키 설정                                                          │
│  ├─ Anthropic Claude: [••••••••••••••••] [테스트 ✓]                      │
│  ├─ OpenAI:          [____________________] [테스트]                     │
│  └─ Google Gemini:   [••••••••••••••••] [테스트 ✓]                      │
│                                                                           │
│  📊 모델별 파라미터                                                       │
│  ┌────────────────────────────────────────────────────────────────────┐  │
│  │ 모델          │ Temperature │ Max Tokens │ Top P │ 용도            │  │
│  ├───────────────┼─────────────┼────────────┼───────┼────────────────┤  │
│  │ Opus 4.5     │    0.3      │   16,000   │ 0.95  │ 분석/평가       │  │
│  │ Sonnet 3.5   │    0.5      │   12,000   │ 0.95  │ 초안 작성       │  │
│  │ Haiku 3.5    │    0.2      │    8,000   │ 0.90  │ 분류/검증       │  │
│  │ GPT-4o       │    0.4      │   12,000   │ 0.95  │ 대체 옵션       │  │
│  │ Gemini Pro   │    0.4      │   12,000   │ 0.95  │ 경제적 옵션     │  │
│  └────────────────────────────────────────────────────────────────────┘  │
│                                                                           │
│  🔄 Hybrid 모드 커스텀 설정                                               │
│  ├─ Phase 1 모델: [Sonnet 3.5 ▼]                                         │
│  ├─ Phase 2 모델: [Opus 4.5   ▼]                                         │
│  ├─ Phase 2 대상 섹션: [☑ 9. 종합평가] [☑ 10. 결론] [☐ 1. 서론]         │
│  └─ 자동 비용 최적화: [ON/OFF]                                           │
│                                                                           │
│                                    [기본값 복원] [저장]                    │
│                                                                           │
└──────────────────────────────────────────────────────────────────────────┘
```

---

### 3.3 Stage 3: 파일 업로드 (P14_FileUpload.html) - 기존 유지

**변경 없음** - 현재 구현이 이미 완성도 높음

---

### 3.4 Stage 4: 마크다운 변환 (P15_MarkdownConversion.html) - 개선

#### 3.4.1 화면 구성

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  🔄 마크다운 변환 (Stage 4)                                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │ 변환 진행 상황                                                        │   │
│  │ ████████████████████░░░░░░░░░░ 67% (8/12 파일)                        │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │ 파일 목록                                              [전체 변환 ▶]  │   │
│  ├──────────────────────────────────────────────────────────────────────┤   │
│  │                                                                       │   │
│  │  📄 RAW1_첨부문서.pdf                    [✓ 변환완료] [미리보기 👁]    │   │
│  │  📊 RAW3_판매량데이터.xlsx               [✓ 변환완료] [미리보기 👁]    │   │
│  │  📝 RAW4_허가현황.docx                   [🔄 변환중...] 45%            │   │
│  │  📊 RAW12_국외신속보고.xlsx              [⏳ 대기중]                    │   │
│  │  📊 RAW14_원시자료.xlsx                  [⏳ 대기중]                    │   │
│  │  ...                                                                  │   │
│  │                                                                       │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │ 마크다운 미리보기                                                     │   │
│  ├─────────────────────────────┬────────────────────────────────────────┤   │
│  │       원본 (PDF)            │         변환 결과 (Markdown)            │   │
│  │  ┌──────────────────────┐  │  ┌────────────────────────────────────┐ │   │
│  │  │ [PDF 렌더링 영역]     │  │  │ # 제목                             │ │   │
│  │  │                      │  │  │ ## 1. 개요                         │ │   │
│  │  │                      │  │  │ 본 문서는...                       │ │   │
│  │  │                      │  │  │                                    │ │   │
│  │  │                      │  │  │ | 항목 | 값 |                      │ │   │
│  │  │                      │  │  │ |------|-----|                     │ │   │
│  │  │                      │  │  │ | A    | 100 |                     │ │   │
│  │  └──────────────────────┘  │  └────────────────────────────────────┘ │   │
│  └─────────────────────────────┴────────────────────────────────────────┘   │
│                                                                              │
│                              [이전] [다음 단계 →]                            │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### 3.5 Stage 5: 데이터 추출 (P16_DataExtraction.html) - 개선

#### 3.5.1 화면 구성

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  ⚙️ 데이터 추출 (Stage 5)                                 사용 모델: Haiku  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │ 추출 진행 상황                                                        │   │
│  │ ████████████████████████████░░ 85% (CS: 완료 | PH: 완료 | Table: 진행) │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ┌────────────────────────────┬─────────────────────────────────────────┐   │
│  │ 추출 항목                  │ 추출된 값                                │   │
│  ├────────────────────────────┼─────────────────────────────────────────┤   │
│  │                            │                                          │   │
│  │ 📌 CS (Common String)      │                                          │   │
│  │  ├─ CS0_성분명             │ 메만틴염산염                              │   │
│  │  ├─ CS1_브랜드명           │ 글리빅사정                                │   │
│  │  ├─ CS2_제조사             │ 대웅바이오(주)                            │   │
│  │  ├─ CS3_허가일             │ 2018-11-10                               │   │
│  │  └─ ...                    │                                          │   │
│  │                            │                                          │   │
│  │ 📊 PH (Placeholder)        │                                          │   │
│  │  ├─ PH1_보고기간_시작      │ 2020-05-01                               │   │
│  │  ├─ PH2_보고기간_종료      │ 2025-04-30                               │   │
│  │  └─ ...                    │                                          │   │
│  │                            │                                          │   │
│  │ 📋 Table                   │                                          │   │
│  │  ├─ TBL1_허가현황          │ [12행 x 5열] [미리보기 📋]                │   │
│  │  ├─ TBL2_판매량            │ [6행 x 8열] [미리보기 📋]                 │   │
│  │  ├─ TBL3_국외신속보고      │ [5건] [미리보기 📋]                       │   │
│  │  └─ TBL4_국내신속보고      │ [5건] [미리보기 📋]                       │   │
│  │                            │                                          │   │
│  └────────────────────────────┴─────────────────────────────────────────┘   │
│                                                                              │
│  ⚠️ 검증 필요 항목: 2개                                                     │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │ • CS5_보고서버전: "v.1.0" vs "1.0" → [v.1.0 선택] [1.0 선택] [수정]   │   │
│  │ • TBL2_판매량: 2025년 데이터 누락 가능성 → [확인] [무시]               │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│                              [이전] [다음 단계 →]                            │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### 3.6 Stage 6: 템플릿 작성 (P17_TemplateWriting.html) - 신규

#### 3.6.1 화면 구성 - Hybrid 모드

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  📄 보고서 생성 (Stage 6)                                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │ 🤖 Hybrid 생성 모드                                                   │   │
│  │                                                                       │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐ │   │
│  │  │  Phase 1: Sonnet 초안 생성                              [완료 ✓] │ │   │
│  │  │  ████████████████████████████████████████ 100%                  │ │   │
│  │  │  • 15개 섹션 초안 생성 완료                                      │ │   │
│  │  │  • 소요 시간: 45초 | 비용: $0.58                                 │ │   │
│  │  └─────────────────────────────────────────────────────────────────┘ │   │
│  │                                    ↓                                  │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐ │   │
│  │  │  Phase 2: Opus 핵심 섹션 개선                           [진행중] │ │   │
│  │  │  ████████████████████░░░░░░░░░░░░░░░░░░░░ 50%                   │ │   │
│  │  │  • 섹션 9 (종합평가): 개선 완료 ✓                                │ │   │
│  │  │  • 섹션 10 (결론): 개선 중... 🔄                                 │ │   │
│  │  │  • 예상 추가 비용: $0.62                                        │ │   │
│  │  └─────────────────────────────────────────────────────────────────┘ │   │
│  │                                                                       │   │
│  │  📊 총 예상 비용: $1.20 (Opus 단독 대비 61% 절감)                    │   │
│  │                                                                       │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │ 📑 생성 중인 섹션 미리보기                                            │   │
│  ├──────────────────────────────────────────────────────────────────────┤   │
│  │  [1.서론] [2.허가현황] [3.조치] [4.변경] [5.노출] [6.증례] [7.시험]   │   │
│  │  [8.기타] [9.평가 🔄] [10.결론 ⏳] [11.참고] [12.별첨]               │   │
│  ├──────────────────────────────────────────────────────────────────────┤   │
│  │                                                                       │   │
│  │  ## 9. 종합적인 안전성 평가                                          │   │
│  │                                                                       │   │
│  │  ### 9.1 이상사례 발생 현황 종합                                     │   │
│  │                                                                       │   │
│  │  본 보고기간(2020년 05월 01일 ~ 2025년 04월 30일) 동안...            │   │
│  │  ▌ (Opus가 생성 중...)                                               │   │
│  │                                                                       │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│                              [이전] [생성 중단] [다음 단계 →]                │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### 3.7 Stage 7: 리뷰 (P18_Review.html) - 대폭 개선

#### 3.7.1 Diff 뷰어 포함 리뷰 화면

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  ✏️ 보고서 리뷰 (Stage 7)                      [Diff 모드 ▼] [저장] [원복]  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │ 섹션 네비게이션                                                        │ │
│  │ [1] [2] [3] [4] [5] [6] [7] [8] [●9●] [10] [11] [12]                  │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌───────────────────────────────┬────────────────────────────────────────┐ │
│  │      📄 원본 데이터            │         ✨ 생성된 보고서                │ │
│  │      (RAW 마크다운)            │         (편집 가능)                    │ │
│  ├───────────────────────────────┼────────────────────────────────────────┤ │
│  │                               │                                         │ │
│  │ ## RAW12: 국외 신속보고       │ ## 9. 종합적인 안전성 평가              │ │
│  │                               │                                         │ │
│  │ | 접수번호 | 나이 | 이상사례  │ ### 9.1 이상사례 발생 현황              │ │
│  │ |---------|------|-----------|                                         │ │
│  │ | 203001  | 20세 | 신장감염  │ 본 보고기간 동안 수집된 이상사례는      │ │
│  │ | 203002  | 21세 | 쇼크      │ 다음과 같다:                            │ │
│  │ | 203003  | 65세 | 뇌출혈    │                                         │ │
│  │                               │ | 구분 | 건수 | 비율 |                  │ │
│  │ ## RAW14: 국내 신속보고       │ |------|------|------|                  │ │
│  │                               │ | 국외 | 5건  | 50%  |                  │ │
│  │ | 접수번호 | 나이 | 이상사례  │ | 국내 | 5건  | 50%  |                  │ │
│  │ |---------|------|-----------|                                         │ │
│  │ | 203201  | 23세 | 신장감염  │ [⚠️ LLM 생성 - 원본 데이터 확인 필요]    │ │
│  │ | 203202  | 33세 | 쇼크      │                                         │ │
│  │                               │                                         │ │
│  │                               │ ### 9.2 중대한 이상사례 분석            │ │
│  │ [하이라이트: 참조된 데이터]    │                                         │ │
│  │                               │ 중대한 이상사례 18건 중:                │ │
│  │                               │ - 입원: 13건 (72.2%)                    │ │
│  │                               │ - 생명위협: 2건 (11.1%)  [← 편집 중]    │ │
│  │                               │                                         │ │
│  └───────────────────────────────┴────────────────────────────────────────┘ │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │ 💬 리뷰 코멘트                                              [추가 ➕]  │ │
│  ├────────────────────────────────────────────────────────────────────────┤ │
│  │ • [섹션9.2] 생명위협 비율 계산 확인 필요 - 김검토자 (2025-12-31)       │ │
│  │ • [섹션10] 결론 문구 조정 요청 - 이승인자 (2025-12-30)                 │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│                              [이전] [다음 단계 →]                            │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 3.7.2 Diff 모드 옵션

```
Diff 모드:
  • Side-by-side: 원본 | 생성결과 (기본)
  • Inline Diff: 변경사항 하이라이트
  • 생성결과만: 편집 전용 모드
  • 원본만: 참조 전용 모드
```

---

### 3.8 Stage 8: QC 검증 (P19_QC.html) - 대폭 개선

#### 3.8.1 자동+수동 병행 QC 화면

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  ✅ QC 검증 (Stage 8)                               [자동 검증 🤖] [수동 ✋] │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │ 🤖 AI 자동 검증 결과                                      [재검증 🔄] │   │
│  ├──────────────────────────────────────────────────────────────────────┤   │
│  │                                                                       │   │
│  │  전체 검증 점수: 94/100 ████████████████████░░ (우수)                 │   │
│  │                                                                       │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐ │   │
│  │  │ 검증 카테고리             │ 점수  │ 상태  │ 상세                 │ │   │
│  │  ├──────────────────────────┼───────┼───────┼─────────────────────┤ │   │
│  │  │ 📊 데이터 정확성          │ 98/100│  ✅   │ 숫자/날짜 일치 확인  │ │   │
│  │  │ 📝 필수 항목 완전성       │ 100/100│ ✅   │ 15개 섹션 모두 포함  │ │   │
│  │  │ 🔗 원본 출처 일치         │ 95/100│  ✅   │ 2건 확인 필요        │ │   │
│  │  │ ⚖️ 규제 요건 준수         │ 92/100│  ⚠️   │ 표현 수정 권장       │ │   │
│  │  │ 📋 형식 및 구조          │ 88/100│  ⚠️   │ 표 정렬 조정 필요    │ │   │
│  │  └─────────────────────────────────────────────────────────────────┘ │   │
│  │                                                                       │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │ ⚠️ 검증 이슈 (3건)                                                    │   │
│  ├──────────────────────────────────────────────────────────────────────┤   │
│  │                                                                       │   │
│  │  🔴 Issue #1: 데이터 불일치 (섹션 5 - 환자 노출)                      │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐ │   │
│  │  │ 원본 (RAW3): 총 판매량 33,882,413정                             │ │   │
│  │  │ 생성 결과:   총 판매량 33,882,413정 ✓ 일치                      │ │   │
│  │  │                                                                  │ │   │
│  │  │ 원본 (RAW3): 2025년 판매량 5,890,546정                          │ │   │
│  │  │ 생성 결과:   2025년(1-10월) 5,890,546정 ✓ 일치                  │ │   │
│  │  │                                                                  │ │   │
│  │  │ ⚠️ 경고: Patient-years 계산 (~46,393) 원본에 없음 - LLM 계산값  │ │   │
│  │  │                                                                  │ │   │
│  │  │ [계산 로직 확인] [수정] [승인 ✓] [거부 ✗]                        │ │   │
│  │  └─────────────────────────────────────────────────────────────────┘ │   │
│  │                                                                       │   │
│  │  🟡 Issue #2: 표현 수정 권장 (섹션 10 - 결론)                        │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐ │   │
│  │  │ 현재: "유익성-위해성 균형이 양호하다"                            │ │   │
│  │  │ 권장: "유익성-위해성 균형이 긍정적으로 유지되고 있다"            │ │   │
│  │  │      (MFDS 권장 표현)                                           │ │   │
│  │  │                                                                  │ │   │
│  │  │ [수정 적용] [현재 유지] [사유 입력]                              │ │   │
│  │  └─────────────────────────────────────────────────────────────────┘ │   │
│  │                                                                       │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │ ✋ 수동 체크리스트                                          [펼치기 ▼] │   │
│  ├──────────────────────────────────────────────────────────────────────┤   │
│  │  ☑ 표지 정보 확인 (품목명, 보고기간, 제출일)                         │   │
│  │  ☑ 목차 및 섹션 번호 일치                                            │   │
│  │  ☐ 표 데이터 정확성 검토 (판매량, 이상사례)                          │   │
│  │  ☐ 참고문헌 형식 확인                                                │   │
│  │  ☐ 별첨 첨부 확인                                                    │   │
│  │                                                                       │   │
│  │  진행률: 2/5 완료                                                    │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│                      [이전] [QC 완료 및 승인 ✓] [반려 (리뷰로)]             │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### 3.9 Stage 9: 최종 출력 (P20_Output.html) - 개선

#### 3.9.1 화면 구성

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  📤 최종 출력 (Stage 9)                                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │ ✅ 보고서 생성 완료                                                   │   │
│  │                                                                       │   │
│  │  📋 보고서명: 글리빅사정_PSUR_2024Q4                                  │   │
│  │  📅 보고기간: 2020-05-01 ~ 2025-04-30                                │   │
│  │  🤖 생성 모드: Hybrid (Sonnet → Opus)                                │   │
│  │  💰 사용 비용: $1.18                                                 │   │
│  │  ⏱️ 소요 시간: 3분 42초                                              │   │
│  │                                                                       │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │ 📁 출력 파일                                                          │   │
│  ├──────────────────────────────────────────────────────────────────────┤   │
│  │                                                                       │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐ │   │
│  │  │ 📄 PSUR 보고서 (Word)                                           │ │   │
│  │  │    글리빅사정_PSUR_2024Q4_Final.docx                             │ │   │
│  │  │    크기: 2.4 MB                                                  │ │   │
│  │  │                                        [다운로드 ⬇️] [미리보기 👁] │ │   │
│  │  └─────────────────────────────────────────────────────────────────┘ │   │
│  │                                                                       │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐ │   │
│  │  │ 📝 PSUR 보고서 (Markdown)                                       │ │   │
│  │  │    글리빅사정_PSUR_2024Q4_Final.md                               │ │   │
│  │  │    크기: 156 KB                                                  │ │   │
│  │  │                                        [다운로드 ⬇️] [미리보기 👁] │ │   │
│  │  └─────────────────────────────────────────────────────────────────┘ │   │
│  │                                                                       │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐ │   │
│  │  │ 📊 LLM 대화 로그                                                 │ │   │
│  │  │    글리빅사정_PSUR_2024Q4_LLMLog.md                              │ │   │
│  │  │    크기: 89 KB                                                   │ │   │
│  │  │                                        [다운로드 ⬇️] [미리보기 👁] │ │   │
│  │  └─────────────────────────────────────────────────────────────────┘ │   │
│  │                                                                       │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐ │   │
│  │  │ ✅ QC 검증 보고서                                                │ │   │
│  │  │    글리빅사정_PSUR_2024Q4_QC_Report.pdf                          │ │   │
│  │  │    크기: 45 KB                                                   │ │   │
│  │  │                                        [다운로드 ⬇️] [미리보기 👁] │ │   │
│  │  └─────────────────────────────────────────────────────────────────┘ │   │
│  │                                                                       │   │
│  │                                             [전체 다운로드 (ZIP) ⬇️]  │   │
│  │                                                                       │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│                      [대시보드로 🏠] [새 보고서 생성 ➕]                      │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 공통 컴포넌트

### 4.1 LLM 선택 드롭다운

```javascript
// components/LLMSelector.js
const LLM_OPTIONS = {
  claude: {
    'claude-opus-4-5': { name: 'Claude Opus 4.5', inputPrice: 15, outputPrice: 75, quality: 'highest' },
    'claude-sonnet-3-5': { name: 'Claude Sonnet 3.5', inputPrice: 3, outputPrice: 15, quality: 'high' },
    'claude-haiku-3-5': { name: 'Claude Haiku 3.5', inputPrice: 0.80, outputPrice: 4, quality: 'fast' }
  },
  openai: {
    'gpt-4o': { name: 'GPT-4o', inputPrice: 5, outputPrice: 15, quality: 'high' },
    'gpt-4o-mini': { name: 'GPT-4o Mini', inputPrice: 0.15, outputPrice: 0.60, quality: 'fast' }
  },
  google: {
    'gemini-2.0-flash': { name: 'Gemini 2.0 Flash', inputPrice: 0.075, outputPrice: 0.30, quality: 'fast' },
    'gemini-2.0-pro': { name: 'Gemini 2.0 Pro', inputPrice: 1.25, outputPrice: 5, quality: 'high' }
  }
};
```

### 4.2 Diff 뷰어 컴포넌트

```javascript
// components/DiffViewer.js
class DiffViewer {
  constructor(container, options = {}) {
    this.container = container;
    this.mode = options.mode || 'side-by-side'; // 'side-by-side', 'inline', 'unified'
    this.leftContent = '';
    this.rightContent = '';
  }

  setContents(left, right) {
    this.leftContent = left;
    this.rightContent = right;
    this.render();
  }

  setMode(mode) {
    this.mode = mode;
    this.render();
  }

  render() {
    // Diff 계산 및 렌더링
  }

  highlightChanges() {
    // 변경사항 하이라이트
  }

  syncScroll() {
    // 좌우 스크롤 동기화
  }
}
```

### 4.3 QC 검증 컴포넌트

```javascript
// components/QCValidator.js
class QCValidator {
  constructor(reportData, rawData) {
    this.reportData = reportData;
    this.rawData = rawData;
    this.issues = [];
    this.score = 0;
  }

  async runAutoValidation() {
    const categories = [
      { name: 'dataAccuracy', weight: 30, validator: this.validateDataAccuracy },
      { name: 'completeness', weight: 25, validator: this.validateCompleteness },
      { name: 'sourceMatch', weight: 20, validator: this.validateSourceMatch },
      { name: 'regulatory', weight: 15, validator: this.validateRegulatory },
      { name: 'formatting', weight: 10, validator: this.validateFormatting }
    ];

    for (const category of categories) {
      const result = await category.validator.call(this);
      this.issues.push(...result.issues);
      this.score += result.score * (category.weight / 100);
    }

    return { score: this.score, issues: this.issues };
  }

  // LLM 기반 검증
  async validateWithLLM(prompt) {
    // Haiku로 빠르게 검증
  }
}
```

---

## 5. 데이터 흐름

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                            데이터 흐름 다이어그램                              │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│   [Stage 3]              [Stage 4]              [Stage 5]                    │
│   ┌─────────┐            ┌─────────┐            ┌─────────┐                  │
│   │ 원본파일 │────PDF.js───▶│ Markdown│────LLM────▶│ CS/PH/  │                 │
│   │ PDF/XLSX│ Mammoth.js │  변환    │  (Haiku)  │  Table  │                  │
│   │ DOCX    │            │         │            │  추출   │                  │
│   └─────────┘            └─────────┘            └─────────┘                  │
│                                                       │                       │
│                                                       ▼                       │
│   [Stage 6]              [Stage 7]              [Stage 8]                    │
│   ┌─────────┐            ┌─────────┐            ┌─────────┐                  │
│   │ 보고서  │◀───Hybrid────│  리뷰   │◀──────────│   QC    │                  │
│   │ 생성    │    모드     │ (Diff)  │           │  검증   │                  │
│   │         │            │         │            │ Auto+Man│                  │
│   └─────────┘            └─────────┘            └─────────┘                  │
│        │                                              │                       │
│        │  Phase 1: Sonnet (전체)                      │                       │
│        │  Phase 2: Opus (섹션 9, 10)                  │                       │
│        │                                              │                       │
│        ▼                                              ▼                       │
│   [Stage 9]                                                                   │
│   ┌─────────┐                                                                │
│   │ DOCX    │◀─────────────────────────────────────────                      │
│   │ 출력    │                                                                │
│   └─────────┘                                                                │
│                                                                               │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. API 설계

### 6.1 Multi-LLM Client

```javascript
// js/multi-llm-client.js
class MultiLLMClient {
  constructor() {
    this.providers = {
      claude: new ClaudeProvider(),
      openai: new OpenAIProvider(),
      google: new GeminiProvider()
    };
  }

  async generate(prompt, options = {}) {
    const provider = this.providers[options.provider || 'claude'];
    const model = options.model || provider.defaultModel;

    return await provider.generate(prompt, {
      model,
      temperature: options.temperature || 0.3,
      maxTokens: options.maxTokens || 8192
    });
  }

  async hybridGenerate(prompt, hybridConfig) {
    // Phase 1: Sonnet 초안
    const draft = await this.generate(prompt, {
      provider: 'claude',
      model: 'claude-sonnet-3-5',
      temperature: 0.5
    });

    // Phase 2: Opus 핵심 섹션 개선
    const refinementPrompt = this.buildRefinementPrompt(draft, hybridConfig.sections);
    const refined = await this.generate(refinementPrompt, {
      provider: 'claude',
      model: 'claude-opus-4-5',
      temperature: 0.3
    });

    return this.mergeResults(draft, refined, hybridConfig.sections);
  }
}
```

### 6.2 QC Validation API

```javascript
// js/qc-validator.js
class QCValidator {
  async validate(report, rawData) {
    const results = {
      autoValidation: await this.runAutoValidation(report, rawData),
      manualChecklist: this.getManualChecklist(),
      overallScore: 0,
      issues: []
    };

    results.overallScore = this.calculateOverallScore(results);
    return results;
  }

  async runAutoValidation(report, rawData) {
    const checks = [
      { name: 'dataAccuracy', fn: this.checkDataAccuracy },
      { name: 'completeness', fn: this.checkCompleteness },
      { name: 'sourceMatch', fn: this.checkSourceMatch },
      { name: 'regulatory', fn: this.checkRegulatoryCompliance },
      { name: 'formatting', fn: this.checkFormatting }
    ];

    const results = [];
    for (const check of checks) {
      results.push(await check.fn.call(this, report, rawData));
    }
    return results;
  }
}
```

---

## 7. 파일 구조 (추가/수정)

```
02_KSUR_v6/
├── js/
│   ├── llm-client.js           → multi-llm-client.js (확장)
│   ├── providers/
│   │   ├── claude-provider.js   (신규)
│   │   ├── openai-provider.js   (신규)
│   │   └── gemini-provider.js   (신규)
│   ├── qc-validator.js          (신규)
│   └── hybrid-generator.js      (신규)
├── components/
│   ├── LLMSelector.js           (신규)
│   ├── DiffViewer.js            (신규)
│   ├── QCChecklist.js           (신규)
│   └── CostEstimator.js         (신규)
├── pages/
│   ├── P13_NewReport.html       (LLM 설정 추가)
│   ├── P17_TemplateWriting.html (Hybrid 모드 UI)
│   ├── P18_Review.html          (Diff 뷰어 추가)
│   └── P19_QC.html              (자동+수동 QC)
└── css/
    └── styles/
        ├── diff-viewer.css      (신규)
        └── qc-validator.css     (신규)
```

---

## 8. 구현 우선순위

| 순서 | 항목 | 난이도 | 예상 시간 |
|-----|------|-------|----------|
| 1 | Multi-LLM Client (Claude + OpenAI + Gemini) | 중 | 4시간 |
| 2 | LLM 선택 UI (P13, P91) | 하 | 2시간 |
| 3 | Hybrid Generator (Sonnet → Opus) | 중 | 3시간 |
| 4 | Diff Viewer 컴포넌트 | 중 | 4시간 |
| 5 | QC 자동 검증 로직 | 상 | 6시간 |
| 6 | QC 수동 체크리스트 UI | 하 | 2시간 |
| 7 | Word 출력 기능 | 중 | 3시간 |
| 8 | 비용 추적 및 표시 | 하 | 2시간 |

**총 예상 시간**: 약 26시간

---

## 9. 결론

본 설계서는 기존 KPSUR AGENT 프로젝트를 확장하여:

1. **다중 LLM 지원**으로 비용 최적화 (Hybrid 모드로 61% 절감)
2. **Diff 뷰어**로 원본-생성 결과 비교 기능 제공
3. **자동+수동 QC 병행**으로 정확성과 효율성 확보
4. **기존 Vanilla JS 구조 유지**로 일관성 있는 개발

을 목표로 합니다.

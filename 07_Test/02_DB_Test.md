# 데이터베이스 연결 테스트 프로시저

## 목적
KSUR 시스템에서 사용할 Supabase 데이터베이스의 연결 상태와 권한 설정을 검증

## 테스트 대상

### Supabase 프로젝트 정보
- **프로젝트 ID**: `toelnxgizxwbdikskmxa`
- **URL**: `https://toelnxgizxwbdikskmxa.supabase.co`
- **Anon Key**: 공개 키 (클라이언트에서 안전하게 사용 가능)

### 테스트 대상 테이블 (11개)
1. **users** - 사용자 정보
2. **products** - 제품 마스터
3. **reports** - 보고서 메타데이터
4. **source_documents** - 업로드된 원본 소스 문서
5. **markdown_documents** - 마크다운 변환 문서
6. **extracted_data** - 추출된 데이터
7. **report_sections** - 보고서 섹션
8. **review_changes** - 리뷰 변경사항
9. **llm_dialogs** - LLM 대화 기록
10. **file_matching_table** - 파일 매칭 테이블
11. **system_settings** - 시스템 설정

## 테스트 항목

### 1. 기본 연결 테스트
- **목적**: Supabase 서버 연결 확인
- **방법**: Anon Key로 Supabase 클라이언트 생성
- **기준**: 에러 없이 클라이언트 생성 성공

### 2. 인증 테스트
- **목적**: 사용자 인증 시스템 확인
- **방법**: 테스트 계정으로 로그인 시도
- **테스트 계정**:
  - 이메일: `author@kpsur.test`
  - 비밀번호: `test1234`
- **기준**: 로그인 성공, 세션 토큰 발급

### 3. RLS (Row Level Security) 테스트
- **목적**: 데이터 접근 권한 확인
- **방법**:
  - 로그인 전: 데이터 조회 불가 확인
  - 로그인 후: 권한에 따른 데이터 조회 확인
- **기준**:
  - 비로그인: 접근 차단
  - Author: 자신의 데이터만 조회
  - Master: 모든 데이터 조회

### 4. 테이블 구조 테스트
- **목적**: 필수 테이블 존재 확인
- **방법**: 11개 테이블 메타데이터 조회
- **기준**: 모든 테이블 존재, 스키마 일치

### 5. CRUD 테스트
- **목적**: 데이터 생성/읽기/수정/삭제 확인
- **방법**: 테스트 데이터로 CRUD 수행
- **테스트 대상**: `reports` 테이블
- **기준**: 모든 작업 성공

### 6. Storage 테스트
- **목적**: 파일 저장소 연결 확인
- **방법**:
  - Bucket 목록 조회
  - 테스트 파일 업로드 (선택)
  - 파일 다운로드 (선택)
  - 파일 삭제 (선택)
- **기준**: Bucket 조회 성공

### 7. 실시간 구독 테스트
- **목적**: Realtime 기능 확인
- **방법**: `reports` 테이블 변경사항 구독
- **기준**: 구독 채널 연결 성공

### 8. 성능 테스트
- **목적**: 응답 속도 측정
- **방법**:
  - 단일 레코드 조회 시간
  - 여러 레코드 조회 시간
- **기준**:
  - 단일 조회: 500ms 이하
  - 다중 조회: 1초 이하

## 평가 기준

### 성공 기준
- ✅ 모든 테스트 항목 통과 (8/8)
- ✅ RLS 정상 작동 (권한별 차단/허용)
- ✅ 11개 테이블 모두 존재
- ✅ CRUD 작업 100% 성공
- ✅ 응답 속도 기준 충족

### 성능 기준
| 작업 | 목표 시간 | 허용 시간 |
|------|-----------|-----------|
| 연결 생성 | < 100ms | < 300ms |
| 단일 조회 | < 200ms | < 500ms |
| 다중 조회 | < 500ms | < 1초 |
| 데이터 삽입 | < 500ms | < 1초 |

### 보안 기준
| 항목 | 요구사항 |
|------|----------|
| 비로그인 접근 | 완전 차단 |
| Author 권한 | 본인 데이터만 조회 |
| Reviewer 권한 | 할당된 보고서만 조회 |
| Master 권한 | 모든 데이터 조회 |

## 웹 인터페이스 사용법

### 테스트 페이지 접근
1. **로그인 전**: 로그인 페이지 하단 "시스템 테스트" 링크
2. **로그인 후**: 사이드바 하단 "시스템 테스트" 버튼

### 테스트 실행
1. **전체 테스트**: 8개 테스트 자동 실행
2. **개별 테스트**: 원하는 테스트만 선택 실행
3. **결과 확인**: 실시간 진행 상황 및 결과 표시
4. **결과 내보내기**: JSON 파일로 다운로드

### 결과 해석
- **✅ 녹색**: 성공
- **❌ 빨간색**: 실패
- **⏱️ 시간 표시**: 성능 측정
- **⚠️ 노란색**: 경고 (느린 응답 등)

## 자동 테스트 (로그인 시)

로그인 프로세스에 통합된 간단한 헬스체크:

1. **로그인 시도 시 자동 실행**
   - 기본 연결 테스트
   - 인증 테스트

2. **결과 표시**
   - 성공: 대시보드로 이동
   - 실패: 오류 메시지 + 시스템 테스트 링크 제공

3. **백그라운드 체크**
   - 로그인 후 연결 상태 모니터링
   - 연결 끊김 시 알림 표시

## 통합 모니터링

### 실시간 상태 표시
- 헤더 우측에 DB 연결 상태 표시
  - 🟢 정상: 500ms 이하
  - 🟡 느림: 500-1000ms
  - 🔴 장애: 1000ms 초과 또는 연결 끊김

## 문제 해결

### 일반적인 오류

**1. 연결 실패**
```
Error: Failed to connect to Supabase
해결: 네트워크 연결 확인, Supabase 서비스 상태 확인
```

**2. 인증 실패**
```
Error: Invalid login credentials
해결: 이메일/비밀번호 확인, 계정 존재 여부 확인
```

**3. RLS 오류**
```
Error: Row level security policy violation
해결: 정상 동작 (권한 없는 데이터 접근 차단)
```

**4. 테이블 없음**
```
Error: relation "table_name" does not exist
해결: 마이그레이션 스크립트 실행 필요
```

## 참고 사항

- 테스트는 **비파괴적**으로 수행 (실제 데이터 영향 최소화)
- 테스트 데이터는 가능한 자동 삭제
- RLS 차단은 정상 동작 (보안 정책)
- 성능은 네트워크 상태에 따라 변동 가능

## 업데이트 이력

- 2025-12-29: 초기 프로시저 작성

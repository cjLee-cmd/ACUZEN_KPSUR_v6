# LLM 연결 테스트 프로시저

## 목적
KSUR 시스템에서 사용할 Gemini 모델들의 성능과 안정성을 검증

## 테스트 대상 모델

1. **Gemini 2.5 Pro** (`gemini-2.5-pro`)
   - 용도: QC 검증, 복잡한 데이터 추출
   - 특징: 최고 성능, 높은 비용

2. **Gemini 2.5 Flash** (`gemini-2.5-flash`)
   - 용도: RAW ID 분류, 마크다운 변환
   - 특징: 빠른 속도, 합리적 비용

3. **Gemini 2.0 Flash Experimental** (`gemini-2.0-flash-exp`)
   - 용도: 실험적 기능 테스트
   - 특징: 최신 기능, 무료 할당량

4. **Gemini 2.0 Flash Thinking** (`gemini-2.0-flash-thinking-exp`)
   - 용도: QC 정밀 검증
   - 특징: 사고 과정 노출, 정밀 분석

## 테스트 항목

### 1. 기본 연결 테스트
- **목적**: API 연결 확인
- **방법**: 간단한 프롬프트로 응답 받기
- **기준**: 5초 이내 응답, 에러 없음

### 2. 한국어 응답 테스트
- **목적**: 한국어 처리 능력 확인
- **방법**: 한국어로 질문하고 한국어 응답 받기
- **기준**: 자연스러운 한국어, 문법 오류 없음

### 3. System Instruction 테스트
- **목적**: KSUR 전문가 역할 설정 확인
- **방법**: 약물감시 전문가로 설정 후 전문 질문
- **기준**: 전문적이고 정확한 답변

### 4. JSON 모드 테스트
- **목적**: 구조화된 데이터 추출 확인
- **방법**: JSON 형식으로 데이터 추출 요청
- **기준**: 유효한 JSON, 요청한 필드 포함

### 5. 토큰 카운팅 테스트
- **목적**: 비용 추정 기능 확인
- **방법**: 텍스트의 토큰 수 계산
- **기준**: 정확한 토큰 수 반환

### 6. 성능 테스트
- **목적**: 응답 속도 측정
- **방법**: 동일 프롬프트로 응답 시간 측정
- **기준**: 모델별 특성에 맞는 속도

### 7. KSUR 특화 테스트
- **목적**: KSUR 워크플로우 시뮬레이션
- **테스트 케이스**:
  - RAW ID 분류
  - 마크다운 변환
  - 데이터 추출
  - QC 검증

## 테스트 절차

### Step 1: 환경 설정 확인
```bash
# .env 파일에 API 키 확인
GOOGLE_API_KEY=...

# 필요한 패키지 설치 확인
python3 -m pip list | grep google-genai
```

### Step 2: 기본 연결 테스트 실행
```bash
cd /Users/cjlee/Documents/진행중/ACUZEN/02_KSUR_v6
python3 07_Test/test_all_models.py
```

### Step 3: 결과 분석
- 각 모델별 성공/실패 확인
- 응답 시간 비교
- 응답 품질 평가

### Step 4: 최적 모델 선정
- 각 워크플로우 단계별 최적 모델 결정
- 비용 대비 성능 분석

## 평가 기준

### 성공 기준
- ✅ 모든 테스트 항목 통과
- ✅ 에러율 0%
- ✅ 한국어 응답 자연스러움
- ✅ JSON 형식 유효성 100%

### 성능 기준
| 모델 | 예상 응답 속도 | 용도 |
|------|---------------|------|
| 2.5 Pro | 5-10초 | 복잡한 분석, QC |
| 2.5 Flash | 2-5초 | 일반 작업, 분류 |
| 2.0 Flash Exp | 2-4초 | 실험적 기능 |
| 2.0 Flash Thinking | 10-20초 | 정밀 검증 |

### 비용 기준
| 모델 | Input (per 1M tokens) | Output (per 1M tokens) |
|------|----------------------|------------------------|
| 2.5 Pro | $1.25 | $5.00 |
| 2.5 Flash | $0.075 | $0.30 |
| 2.0 Flash Exp | Free (quota) | Free (quota) |
| 2.0 Flash Thinking | Free (quota) | Free (quota) |

## 테스트 결과 기록

### 모델: Gemini 3 Pro Preview
- [x] 기본 연결: ⏱️ 13.0 초 ✅
- [x] 한국어 응답: ⭐ 5/5 ✅
- [x] System Instruction: ✅
- [x] JSON 모드: ✅
- [x] 토큰 카운팅: 15 tokens ✅
- [x] RAW ID 분류: ✅ (6.72초, 신뢰도 0.98)
- [x] 데이터 추출: ✅ (31.88초)
- [x] QC 검증: ✅ (20.04초)
- **전체 성공률**: 100% (8/8)

### 모델: Gemini 3 Flash Preview
- [x] 기본 연결: ⏱️ 3.55 초 ✅
- [x] 한국어 응답: ⭐ 5/5 ✅
- [x] System Instruction: ✅
- [x] JSON 모드: ✅
- [x] 토큰 카운팅: 15 tokens ✅
- [x] RAW ID 분류: ✅ (3.74초, 신뢰도 0.98)
- [x] 데이터 추출: ✅ (4.49초)
- [x] QC 검증: ✅ (7.0초)
- **전체 성공률**: 100% (8/8)

### 모델: Gemini 2.5 Pro
- [x] 기본 연결: ⏱️ 16.77 초 ✅
- [x] 한국어 응답: ⭐ 5/5 ✅
- [x] System Instruction: ✅
- [x] JSON 모드: ✅
- [x] 토큰 카운팅: 15 tokens ✅
- [x] RAW ID 분류: ✅ (10.59초, 신뢰도 0.95)
- [x] 데이터 추출: ✅ (7.96초)
- [x] QC 검증: ✅ (20.27초)
- **전체 성공률**: 100% (8/8)

### 모델: Gemini 2.5 Flash
- [x] 기본 연결: ⏱️ 1.93 초 ✅
- [x] 한국어 응답: ⭐ 5/5 ✅
- [x] System Instruction: ✅
- [x] JSON 모드: ✅
- [x] 토큰 카운팅: 15 tokens ✅
- [x] RAW ID 분류: ✅ (3.35초, 신뢰도 0.95)
- [x] 데이터 추출: ✅ (2.12초)
- [x] QC 검증: ✅ (12.4초)
- **전체 성공률**: 100% (8/8)

## 권장 모델 설정 (테스트 완료 - 2025-12-29)

### Stage별 최적 모델

| Stage | 작업 | 권장 모델 | 이유 | 평균 속도 |
|-------|------|----------|------|-----------|
| 3-1 | RAW ID 분류 | **Gemini 2.5 Flash** | 빠른 속도(3.35초), 높은 정확도(95%), 저비용 | 3-4초 |
| 4 | 마크다운 변환 | **Gemini 2.5 Flash** | 빠른 속도, 구조화된 변환에 적합 | 2-3초 |
| 5 | 데이터 추출 | **Gemini 3 Flash** | JSON 추출 최적화(4.49초), 높은 정확도(98%) | 4-5초 |
| 6 | 템플릿 작성 | **Gemini 2.5 Flash** | 빠른 생성 속도, 충분한 품질 | 2-5초 |
| 8 | QC 검증 | **Gemini 3 Pro** | 정밀한 분석 필요, 상세한 이슈 감지 | 15-25초 |

### 비용 vs 성능 분석

#### 최고 속도: Gemini 2.5 Flash
- 기본 연결: 1.93초
- RAW ID 분류: 3.35초
- 데이터 추출: 2.12초
- **총 비용**: 가장 저렴 ($0.075/1M input, $0.30/1M output)
- **추천 용도**: 대량 처리, 실시간 응답 필요 작업

#### 최고 정확도: Gemini 3 Pro
- RAW ID 분류 신뢰도: 0.98
- 상세한 QC 분석: 품질 점수 40점, 4가지 이슈 + 4가지 권장사항
- **총 비용**: 중간 수준
- **추천 용도**: 품질 검증, 복잡한 분석

#### 균형: Gemini 3 Flash
- 속도: 3-7초 (중간)
- 정확도: 0.98 (높음)
- 한국어 품질: 5/5
- **총 비용**: 저렴
- **추천 용도**: 일반적인 모든 작업

### 최종 권장사항

**개발/테스트 환경**:
- 모든 작업: Gemini 2.5 Flash (속도 최우선)

**프로덕션 환경**:
- RAW ID 분류: Gemini 2.5 Flash
- 마크다운 변환: Gemini 2.5 Flash
- 데이터 추출: Gemini 3 Flash (정확도 중요)
- 템플릿 작성: Gemini 2.5 Flash
- QC 검증: Gemini 3 Pro (품질 최우선)

## 문제 해결

### 일반적인 오류

**1. API Key 오류**
```
Error: API key not valid
해결: .env 파일의 GOOGLE_API_KEY 확인
```

**2. Rate Limit 오류**
```
Error: Resource exhausted
해결: 무료 할당량 초과, 유료 플랜 고려 또는 대기
```

**3. Model Not Found**
```
Error: Model not found
해결: 모델 이름 확인 (models/ 접두사 필요 여부)
```

**4. Timeout**
```
Error: Deadline exceeded
해결: timeout 값 증가 또는 프롬프트 단순화
```

## 웹 인터페이스 사용법

### 테스트 페이지 접근
1. **로그인 전**: 로그인 페이지 하단 "시스템 테스트" 링크
2. **로그인 후**: 사이드바 하단 "시스템 테스트" 버튼

### 테스트 실행
1. **LLM 테스트 탭** 선택
2. **테스트할 모델** 선택 (다중 선택 가능)
   - Gemini 3 Pro Preview
   - Gemini 3 Flash Preview
   - Gemini 2.5 Pro
   - Gemini 2.5 Flash
3. **전체 테스트 실행** 또는 **개별 테스트** 선택
4. **결과 확인**: 실시간 진행 상황 및 결과 표시

### 테스트 결과 해석
- **✅ 녹색**: 테스트 성공
- **❌ 빨간색**: 테스트 실패
- **⏱️ 시간**: 응답 속도 (초 단위)
- **⭐ 평가**: 한국어 품질 (1-5점)
- **📊 차트**: 모델별 성능 비교

### 결과 내보내기
- **JSON 다운로드**: 상세 결과 데이터
- **보고서 생성**: PDF 형식 테스트 리포트

## 자동 테스트 (로그인 시)

로그인 프로세스에 통합된 간단한 헬스체크:

1. **로그인 시도 시 자동 실행**
   - 기본 연결 테스트 (1개 모델)
   - 응답 시간 측정

2. **결과 표시**
   - 성공: 대시보드로 이동
   - 실패: 오류 메시지 + 시스템 테스트 링크 제공
   - 느린 응답: 경고 표시

3. **백그라운드 체크**
   - 로그인 후 LLM 연결 상태 모니터링
   - API 할당량 잔량 확인
   - 비정상 종료 시 알림

## 참고 사항

- 각 모델의 무료 할당량을 고려하여 테스트 횟수 조절
- 실험적 모델은 예고 없이 변경될 수 있음
- QC 검증은 정밀도가 중요하므로 속도보다 정확도 우선
- 비용 효율을 위해 일반 작업은 Flash 모델 사용 권장
- 웹 테스트는 브라우저 콘솔에서 상세 로그 확인 가능

## 업데이트 이력

- 2025-12-29 15:00: 초기 프로시저 작성
- 2025-12-29 15:30: 4개 모델 종합 테스트 완료
  - Gemini 3 Pro Preview: 100% (8/8)
  - Gemini 3 Flash Preview: 100% (8/8)
  - Gemini 2.5 Pro: 100% (8/8)
  - Gemini 2.5 Flash: 100% (8/8)
- 2025-12-29 15:35: Stage별 최적 모델 권장사항 작성 완료

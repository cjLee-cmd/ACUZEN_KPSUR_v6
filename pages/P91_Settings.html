<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹œìŠ¤í…œ ì„¤ì • - KPSUR AGENT | ACUZEN AI</title>
    <link rel="stylesheet" href="../css/styles/globals.css">
    <link rel="stylesheet" href="../css/styles/layout.css">
    <link rel="stylesheet" href="../css/styles/components.css">
    <style>
        body {
            background: #F3F4F6;
            min-height: 100vh;
            padding: 20px;
        }

        .settings-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .settings-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .settings-title {
            font-size: 32px;
            font-weight: 700;
            color: #25739B;
            margin-bottom: 8px;
        }

        .settings-subtitle {
            font-size: 14px;
            color: #6B7280;
        }

        .settings-card {
            background: white;
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: #374151;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: #F9FAFB;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .status-label {
            font-size: 14px;
            color: #6B7280;
            font-weight: 500;
        }

        .badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #ECFDF5;
            color: #065F46;
            border: 1px solid #6EE7B7;
        }

        .badge-error {
            background: #FEF2F2;
            color: #991B1B;
            border: 1px solid #FCA5A5;
        }

        .masked-key {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #374151;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .input-with-button {
            display: flex;
            gap: 8px;
        }

        .api-key-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            transition: all 0.3s ease;
        }

        .api-key-input:focus {
            outline: none;
            border-color: #25739B;
            box-shadow: 0 0 0 4px rgba(37, 115, 155, 0.1);
        }

        .toggle-visibility-btn {
            padding: 12px 16px;
            background: #F3F4F6;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s;
        }

        .toggle-visibility-btn:hover {
            background: #E5E7EB;
        }

        .button-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #25739B 0%, #369EE1 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 115, 155, 0.3);
        }

        .btn-secondary {
            background: white;
            color: #25739B;
            border: 2px solid #25739B;
        }

        .btn-secondary:hover {
            background: #F3F4F6;
        }

        .btn-danger {
            background: white;
            color: #DC2626;
            border: 2px solid #DC2626;
        }

        .btn-danger:hover {
            background: #FEF2F2;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .guide-steps {
            counter-reset: step;
            margin: 0;
            padding: 0;
            list-style: none;
        }

        .guide-steps li {
            counter-increment: step;
            padding: 12px 0;
            padding-left: 40px;
            position: relative;
            font-size: 14px;
            line-height: 1.6;
            color: #374151;
        }

        .guide-steps li::before {
            content: counter(step);
            position: absolute;
            left: 0;
            top: 12px;
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #25739B 0%, #369EE1 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 12px;
        }

        .guide-link {
            color: #25739B;
            text-decoration: none;
            font-weight: 600;
        }

        .guide-link:hover {
            text-decoration: underline;
        }

        .security-notice {
            background: #FEF3C7;
            border: 2px solid #FDE047;
            padding: 20px;
            border-radius: 12px;
        }

        .security-notice-title {
            font-size: 15px;
            font-weight: 700;
            color: #92400E;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .security-notice ul {
            margin: 0;
            padding-left: 20px;
            color: #92400E;
            font-size: 13px;
            line-height: 1.8;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .info-item {
            padding: 12px;
            background: #F9FAFB;
            border-radius: 8px;
        }

        .info-label {
            font-size: 12px;
            color: #6B7280;
            margin-bottom: 4px;
        }

        .info-value {
            font-size: 14px;
            color: #374151;
            font-weight: 600;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: none;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast-success {
            background: #ECFDF5;
            color: #065F46;
            border: 1px solid #6EE7B7;
        }

        .toast-error {
            background: #FEF2F2;
            color: #991B1B;
            border: 1px solid #FCA5A5;
        }

        .toast-warning {
            background: #FEF3C7;
            color: #92400E;
            border: 1px solid #FDE047;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }

        .loading-content {
            background: white;
            padding: 32px;
            border-radius: 16px;
            text-align: center;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #E5E7EB;
            border-top-color: #25739B;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 14px;
            color: #6B7280;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #25739B;
            text-decoration: none;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 24px;
            transition: all 0.2s;
        }

        .back-link:hover {
            gap: 12px;
        }

        /* ë‹¤í¬ëª¨ë“œ ë³€ìˆ˜ */
        :root {
            --page-bg: #F3F4F6;
            --card-bg: white;
            --text-primary: #374151;
            --text-secondary: #6B7280;
            --text-muted: #9CA3AF;
            --border-color: #E5E7EB;
            --section-bg: #F9FAFB;
            --input-bg: white;
        }

        [data-theme="dark"] {
            --page-bg: #1e293b;
            --card-bg: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: #334155;
            --section-bg: #334155;
            --input-bg: #334155;
        }

        [data-theme="dark"] body {
            background: #1e293b;
        }

        /* ë‹¤í¬ëª¨ë“œ ìŠ¤íƒ€ì¼ */
        [data-theme="dark"] .settings-card {
            background: transparent;
            border: 1px solid #475569;
        }

        [data-theme="dark"] .section-title {
            color: var(--text-primary);
        }

        [data-theme="dark"] .status-row {
            background: #334155;
        }

        [data-theme="dark"] .status-label {
            color: #94a3b8;
        }

        [data-theme="dark"] .badge-success {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
            border-color: #34d399;
        }

        [data-theme="dark"] .badge-error {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            border-color: #fbbf24;
        }

        [data-theme="dark"] .masked-key {
            color: var(--text-primary);
        }

        [data-theme="dark"] .input-label {
            color: var(--text-primary);
        }

        [data-theme="dark"] .api-key-input {
            background: #334155;
            border-color: #475569;
            color: var(--text-primary);
        }

        [data-theme="dark"] .api-key-input:focus {
            border-color: #60a5fa;
            box-shadow: 0 0 0 4px rgba(96, 165, 250, 0.1);
        }

        [data-theme="dark"] .toggle-visibility-btn {
            background: #334155;
            border-color: #475569;
        }

        [data-theme="dark"] .toggle-visibility-btn:hover {
            background: #3f4f63;
        }

        [data-theme="dark"] .btn-secondary {
            background: #334155;
            border-color: #60a5fa;
            color: #60a5fa;
        }

        [data-theme="dark"] .btn-secondary:hover {
            background: rgba(96, 165, 250, 0.1);
        }

        [data-theme="dark"] .btn-danger {
            background: #334155;
            border-color: #fbbf24;
            color: #fbbf24;
        }

        [data-theme="dark"] .btn-danger:hover {
            background: rgba(251, 191, 36, 0.1);
        }

        [data-theme="dark"] .guide-steps li {
            color: var(--text-primary);
        }

        [data-theme="dark"] .guide-link {
            color: #60a5fa;
        }

        [data-theme="dark"] .security-notice {
            background: rgba(251, 191, 36, 0.15);
            border-color: #fbbf24;
        }

        [data-theme="dark"] .security-notice-title {
            color: #fbbf24;
        }

        [data-theme="dark"] .security-notice ul {
            color: #fcd34d;
        }

        [data-theme="dark"] .info-item {
            background: #334155;
        }

        [data-theme="dark"] .info-label {
            color: #94a3b8;
        }

        [data-theme="dark"] .info-value {
            color: var(--text-primary);
        }

        [data-theme="dark"] .toast-success {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
            border-color: #34d399;
        }

        [data-theme="dark"] .toast-error {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            border-color: #fbbf24;
        }

        [data-theme="dark"] .toast-warning {
            background: rgba(251, 191, 36, 0.15);
            color: #fcd34d;
            border-color: #fcd34d;
        }

        [data-theme="dark"] .loading-content {
            background: #1e293b;
            border: 1px solid #475569;
        }

        [data-theme="dark"] .loading-text {
            color: #94a3b8;
        }

        [data-theme="dark"] .back-link {
            color: #60a5fa;
        }

        /* Header styles */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 24px;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header-logo {
            font-size: 18px;
            font-weight: 700;
            color: #25739B;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .dark-mode-toggle {
            background: var(--section-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .dark-mode-toggle:hover {
            border-color: #25739B;
        }

        [data-theme="dark"] .dark-mode-toggle {
            background: #334155;
            border-color: #475569;
        }

        .icon-sun, .icon-moon {
            font-size: 16px;
        }

        [data-theme="light"] .icon-moon {
            display: none;
        }

        [data-theme="dark"] .icon-sun {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Dark Mode Script -->
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();

        function toggleDarkMode() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }
    </script>

    <!-- Header -->
    <header class="app-header">
        <div class="header-left">
            <div class="header-logo">KPSUR AGENT</div>
        </div>
        <div class="header-right">
            <button class="dark-mode-toggle" onclick="toggleDarkMode()">
                <span class="icon-sun">â˜€ï¸</span>
                <span class="icon-moon">ğŸŒ™</span>
            </button>
        </div>
    </header>

    <div class="app-layout">
    <div class="app-content">
    <main class="main-content">
    <div class="settings-container">
        <a href="../index.html" class="back-link">
            â† ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°
        </a>

        <div class="settings-header">
            <div class="settings-title">âš™ï¸ ì‹œìŠ¤í…œ ì„¤ì •</div>
            <div class="settings-subtitle">KPSUR AGENT ì‹œìŠ¤í…œ êµ¬ì„± ê´€ë¦¬</div>
        </div>

        <!-- First Setup Banner (shown only when redirected from initial setup) -->
        <div id="firstSetupBanner" style="display: none; background: linear-gradient(135deg, #EFF6FF 0%, #DBEAFE 100%); border: 2px solid #3B82F6; border-radius: 12px; padding: 24px; margin-bottom: 24px; text-align: center;">
            <div style="font-size: 24px; margin-bottom: 12px;">ğŸ‘‹ í™˜ì˜í•©ë‹ˆë‹¤!</div>
            <div style="font-size: 16px; font-weight: 600; color: #1E40AF; margin-bottom: 8px;">
                KPSUR AGENTë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ë¨¼ì € API í‚¤ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”
            </div>
            <div style="font-size: 14px; color: #1E40AF; line-height: 1.6;">
                Google Gemini API í‚¤ëŠ” ë¬´ë£Œë¡œ ë°œê¸‰ë°›ì„ ìˆ˜ ìˆìœ¼ë©°,<br>
                ì•„ë˜ ê°€ì´ë“œë¥¼ ë”°ë¼ ì„¤ì •í•˜ì‹œë©´ ë°”ë¡œ ì‚¬ìš©í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </div>
        </div>

        <!-- Section 1: API Key Management -->
        <div class="settings-card">
            <div class="section-title">
                <span>ğŸ”‘</span>
                <span>API í‚¤ ê´€ë¦¬</span>
            </div>

            <div class="status-row">
                <div>
                    <div class="status-label">í˜„ì¬ ìƒíƒœ</div>
                    <span class="badge" id="statusBadge">âŒ ë¯¸ì„¤ì •</span>
                </div>
                <div>
                    <div class="status-label">ì €ì¥ëœ í‚¤</div>
                    <span class="masked-key" id="maskedKey">-</span>
                </div>
            </div>

            <div class="input-group">
                <label class="input-label" for="apiKeyInput">Gemini API í‚¤</label>
                <div class="input-with-button">
                    <input
                        type="password"
                        id="apiKeyInput"
                        class="api-key-input"
                        placeholder="AIzaë¡œ ì‹œì‘í•˜ëŠ” API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                    >
                    <button class="toggle-visibility-btn" id="toggleBtn" title="í‚¤ í‘œì‹œ/ìˆ¨ê¸°ê¸°">ğŸ‘ï¸</button>
                </div>
            </div>

            <div class="button-group">
                <button class="btn btn-primary" id="btnSave">
                    <span>ğŸ’¾</span>
                    <span>ì €ì¥</span>
                </button>
                <button class="btn btn-secondary" id="btnTest">
                    <span>ğŸ”Œ</span>
                    <span>ì—°ê²° í…ŒìŠ¤íŠ¸</span>
                </button>
                <button class="btn btn-danger" id="btnClear">
                    <span>ğŸ—‘ï¸</span>
                    <span>ì‚­ì œ</span>
                </button>
            </div>
        </div>

        <!-- Section 2: API Key Issuance Guide -->
        <div class="settings-card">
            <div class="section-title">
                <span>ğŸ“‹</span>
                <span>API í‚¤ ë°œê¸‰ ê°€ì´ë“œ</span>
            </div>

            <ol class="guide-steps">
                <li>
                    <a href="https://ai.google.dev/" target="_blank" class="guide-link">Google AI Studio</a> ì›¹ì‚¬ì´íŠ¸ì— ì ‘ì†í•˜ì„¸ìš”
                </li>
                <li>
                    ìš°ì¸¡ ìƒë‹¨ì˜ <strong>"Get API Key"</strong> ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”
                </li>
                <li>
                    í”„ë¡œì íŠ¸ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ìƒˆë¡œ ìƒì„±í•˜ì„¸ìš”
                </li>
                <li>
                    ìƒì„±ëœ API í‚¤ë¥¼ ë³µì‚¬í•˜ì—¬ ìœ„ ì…ë ¥ë€ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”
                </li>
                <li>
                    "ì—°ê²° í…ŒìŠ¤íŠ¸" ë²„íŠ¼ìœ¼ë¡œ í‚¤ê°€ ì •ìƒ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”
                </li>
                <li>
                    í…ŒìŠ¤íŠ¸ ì„±ê³µ í›„ "ì €ì¥" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”
                </li>
            </ol>

            <div style="margin-top: 16px; padding: 12px; background: #EFF6FF; border-radius: 8px; font-size: 13px; color: #1E40AF;">
                ğŸ’¡ <strong>ë¬´ë£Œ í• ë‹¹ëŸ‰:</strong> ë¶„ë‹¹ 15íšŒ, ì¼ì¼ 1,500íšŒ ìš”ì²­ ê°€ëŠ¥
            </div>
        </div>

        <!-- Section 3: Security Notice -->
        <div class="settings-card security-notice">
            <div class="security-notice-title">
                <span>âš ï¸</span>
                <span>ë³´ì•ˆ ì£¼ì˜ì‚¬í•­</span>
            </div>
            <ul>
                <li>API í‚¤ëŠ” ë¸Œë¼ìš°ì €ì˜ localStorageì—ë§Œ ì €ì¥ë˜ë©°, ì„œë²„ë¡œ ì „ì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤</li>
                <li>ê³µìš© ì»´í“¨í„°ì—ì„œ ì‚¬ìš© í›„ì—ëŠ” ë°˜ë“œì‹œ ë¡œê·¸ì•„ì›ƒí•˜ê³  "ì‚­ì œ" ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</li>
                <li>API í‚¤ë¥¼ ë‹¤ë¥¸ ì‚¬ëŒê³¼ ê³µìœ í•˜ì§€ ë§ˆì„¸ìš”</li>
                <li>ìŠ¤í¬ë¦°ìƒ·ì´ë‚˜ í™”ë©´ ê³µìœ  ì‹œ API í‚¤ê°€ ë…¸ì¶œë˜ì§€ ì•Šë„ë¡ ì£¼ì˜í•˜ì„¸ìš”</li>
                <li>ì‚¬ìš©ëŸ‰ì€ <a href="https://console.cloud.google.com/" target="_blank" class="guide-link">Google Cloud Console</a>ì—ì„œ ëª¨ë‹ˆí„°ë§í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
            </ul>
        </div>

        <!-- Section 4: System Info -->
        <div class="settings-card">
            <div class="section-title">
                <span>â„¹ï¸</span>
                <span>ì‹œìŠ¤í…œ ì •ë³´</span>
            </div>

            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">í™˜ê²½ ëª¨ë“œ</div>
                    <div class="info-value" id="envMode">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">í˜¸ìŠ¤íŠ¸</div>
                    <div class="info-value" id="hostname">-</div>
                </div>
            </div>
        </div>
    </div>
    </main>
    </div>

    <!-- Footer -->
    <footer class="app-footer">
        <div class="footer-content">
            Copyright. Power Solution., Inc. 2026.
        </div>
    </footer>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div class="loading-text" id="loadingText">ì²˜ë¦¬ ì¤‘...</div>
        </div>
    </div>

    <script>
        // settingsManager stub
        const settingsManager = {
            getApiKey: () => localStorage.getItem('gemini_api_key'),
            setApiKey: (key) => {
                localStorage.setItem('gemini_api_key', key);
                return true;
            },
            removeApiKey: () => {
                localStorage.removeItem('gemini_api_key');
                return true;
            },
            getApiKeyStatus: () => {
                const key = localStorage.getItem('gemini_api_key');
                return {
                    configured: !!key,
                    maskedKey: key ? key.substring(0, 8) + '...' + key.substring(key.length - 4) : null
                };
            },
            testApiKey: async (key) => {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
                    return { success: response.ok };
                } catch (e) {
                    return { success: false, error: e.message };
                }
            }
        };

        // Initialize page
        async function initSettingsPage() {
            // Check if this is first setup
            checkFirstSetup();

            displayApiKeyStatus();
            displayEnvironmentInfo();
            setupEventListeners();
        }

        // Check if redirected from first setup
        function checkFirstSetup() {
            const urlParams = new URLSearchParams(window.location.search);
            const isFirstSetup = urlParams.get('firstSetup') === 'true';

            if (isFirstSetup) {
                document.getElementById('firstSetupBanner').style.display = 'block';
                // Auto-focus on API key input
                setTimeout(() => {
                    document.getElementById('apiKeyInput').focus();
                }, 500);
            }
        }

        // Display current API key status
        function displayApiKeyStatus() {
            const status = settingsManager.getApiKeyStatus();
            const badgeEl = document.getElementById('statusBadge');
            const maskedEl = document.getElementById('maskedKey');

            if (status.configured) {
                badgeEl.textContent = 'âœ… ì„¤ì •ë¨';
                badgeEl.className = 'badge badge-success';
                maskedEl.textContent = status.masked;
            } else {
                badgeEl.textContent = 'âŒ ë¯¸ì„¤ì •';
                badgeEl.className = 'badge badge-error';
                maskedEl.textContent = '-';
            }
        }

        // Display environment information
        function displayEnvironmentInfo() {
            const env = settingsManager.getEnvironmentInfo();
            document.getElementById('envMode').textContent = env.mode;
            document.getElementById('hostname').textContent = env.hostname;
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('btnSave').addEventListener('click', saveApiKey);
            document.getElementById('btnTest').addEventListener('click', testConnection);
            document.getElementById('btnClear').addEventListener('click', clearApiKey);
            document.getElementById('toggleBtn').addEventListener('click', toggleVisibility);
        }

        // Save API key with pre-validation
        async function saveApiKey() {
            const input = document.getElementById('apiKeyInput').value.trim();

            if (!input) {
                showToast('API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”', 'warning');
                return;
            }

            // Format validation
            const formatCheck = settingsManager.validateApiKeyFormat(input);
            if (!formatCheck.valid) {
                showToast('âŒ ' + formatCheck.error, 'error');
                return;
            }

            // Test connection before saving
            showLoading('ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...');
            const testResult = await settingsManager.testApiKey(input);
            hideLoading();

            if (!testResult.success) {
                showToast('âŒ ' + testResult.message, 'error');
                return;
            }

            // Save to localStorage
            const saved = settingsManager.saveApiKey(input);
            if (saved) {
                displayApiKeyStatus();
                document.getElementById('apiKeyInput').value = '';
                showToast('âœ… API í‚¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');

                // If this was first setup, redirect to dashboard after 1.5 seconds
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('firstSetup') === 'true') {
                    setTimeout(() => {
                        window.location.href = '../index.html';
                    }, 1500);
                }
            } else {
                showToast('âŒ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
            }
        }

        // Test API connection
        async function testConnection() {
            const input = document.getElementById('apiKeyInput').value.trim();

            if (!input) {
                showToast('API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”', 'warning');
                return;
            }

            showLoading('ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...');
            const result = await settingsManager.testApiKey(input);
            hideLoading();

            if (result.success) {
                showToast(result.message, 'success');
            } else {
                showToast('âŒ ' + result.message, 'error');
            }
        }

        // Clear API key
        function clearApiKey() {
            if (!confirm('API í‚¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì‚­ì œ í›„ ì‹œìŠ¤í…œ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ë‹¤ì‹œ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤.')) {
                return;
            }

            const cleared = settingsManager.clearApiKey();
            if (cleared) {
                displayApiKeyStatus();
                document.getElementById('apiKeyInput').value = '';
                showToast('âœ… API í‚¤ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            } else {
                showToast('âŒ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
            }
        }

        // Toggle password visibility
        function toggleVisibility() {
            const input = document.getElementById('apiKeyInput');
            const btn = document.getElementById('toggleBtn');

            if (input.type === 'password') {
                input.type = 'text';
                btn.textContent = 'ğŸ™ˆ';
                btn.title = 'í‚¤ ìˆ¨ê¸°ê¸°';
            } else {
                input.type = 'password';
                btn.textContent = 'ğŸ‘ï¸';
                btn.title = 'í‚¤ í‘œì‹œ';
            }
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast toast-${type}`;
            toast.style.display = 'block';

            setTimeout(() => {
                toast.style.display = 'none';
            }, 5000);
        }

        // Show loading overlay
        function showLoading(text = 'ì²˜ë¦¬ ì¤‘...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        // Hide loading overlay
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initSettingsPage);
    </script>
</body>
</html>

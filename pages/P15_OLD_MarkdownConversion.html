<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§ˆí¬ë‹¤ìš´ ë³€í™˜ - KPSUR AGENT | ACUZEN AI</title>
    <link rel="stylesheet" href="../css/styles/globals.css">
    <link rel="stylesheet" href="../css/styles/layout.css">
    <!-- íŒŒì¼ íŒŒì‹± ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <!-- OCR ë¼ì´ë¸ŒëŸ¬ë¦¬ (ì´ë¯¸ì§€ ê¸°ë°˜ PDF ì²˜ë¦¬) -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <!-- ë§ˆí¬ë‹¤ìš´ ë Œë”ë§ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
    <style>
        /* ë‹¤í¬ëª¨ë“œ ë³€ìˆ˜ */
        :root {
            --page-bg: #F5F7FA;
            --card-bg: white;
            --card-shadow: rgba(0, 0, 0, 0.1);
            --text-primary: #374151;
            --text-secondary: #6B7280;
            --text-muted: #9CA3AF;
            --border-color: #E5E7EB;
            --section-bg: #F9FAFB;
            --input-bg: white;
            /* ê²½ê³ ìƒ‰ - ì£¼í™©ìƒ‰ ê³„ì—´ (ëˆˆì— í¸í•¨) */
            --warning-bg: #FFFBEB;
            --warning-border: #FCD34D;
            --warning-title: #B45309;
            --warning-text: #92400E;
            /* ìƒíƒœ ìƒ‰ìƒ */
            --status-success: #10B981;
            --status-error: #F59E0B;
            --status-pending: #D1D5DB;
        }

        [data-theme="dark"] {
            --page-bg: #1e293b;
            --card-bg: #1e293b;
            --card-shadow: none;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: #334155;
            --section-bg: #334155;
            --input-bg: #334155;
            /* ê²½ê³ ìƒ‰ - ë‹¤í¬ëª¨ë“œ (ì£¼í™©ìƒ‰ ê³„ì—´) */
            --warning-bg: #451a03;
            --warning-border: #b45309;
            --warning-title: #fbbf24;
            --warning-text: #fcd34d;
            /* ìƒíƒœ ìƒ‰ìƒ - ë‹¤í¬ëª¨ë“œ */
            --status-success: #34d399;
            --status-error: #fbbf24;
            --status-pending: #64748b;
        }

        /* ë‹¤í¬ëª¨ë“œ ì¹´ë“œ ìŠ¤íƒ€ì¼ í†µì¼ */
        [data-theme="dark"] .file-list-section,
        [data-theme="dark"] .preview-section,
        [data-theme="dark"] .log-section {
            background: transparent !important;
            box-shadow: none !important;
            border: 1px solid #475569;
        }

        .page-container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .page-header {
            margin-bottom: var(--spacing-xl);
        }

        .page-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
        }

        .page-description {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* ê²½ê³  ë°°ë„ˆ */
        .warning-banner {
            background: var(--warning-bg);
            border: 2px solid var(--warning-border);
            border-radius: 8px;
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
            display: flex;
            align-items: start;
            gap: var(--spacing-md);
        }

        .warning-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .warning-content {
            flex: 1;
        }

        .warning-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--warning-title);
            margin-bottom: 4px;
        }

        .warning-text {
            font-size: 12px;
            color: var(--warning-text);
            line-height: 1.5;
        }

        /* ì»¨í…ì¸  ê·¸ë¦¬ë“œ */
        .content-grid {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }

        /* íŒŒì¼ ëª©ë¡ */
        .file-list-section {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 1px 3px var(--card-shadow);
            display: flex;
            flex-direction: column;
            max-height: 600px;
        }

        .section-header {
            padding: var(--spacing-lg);
            border-bottom: 2px solid var(--border-color);
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-sm);
        }

        .conversion-stats {
            display: flex;
            gap: var(--spacing-lg);
            font-size: 12px;
            color: var(--text-secondary);
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .stat-value {
            font-weight: 700;
            color: var(--text-primary);
        }

        .file-list {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-md);
        }

        .file-group {
            margin-bottom: var(--spacing-lg);
        }

        .file-group:last-child {
            margin-bottom: 0;
        }

        .group-header {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: var(--spacing-sm);
            padding: 0 var(--spacing-sm);
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: var(--spacing-xs);
        }

        .file-item:hover {
            background: rgba(37, 115, 155, 0.05);
        }

        [data-theme="dark"] .file-item:hover {
            background: rgba(37, 115, 155, 0.15);
        }

        .file-item.active {
            background: rgba(37, 115, 155, 0.1);
            border-left: 3px solid #25739B;
        }

        [data-theme="dark"] .file-item.active {
            background: rgba(37, 115, 155, 0.2);
        }

        .file-item.converting {
            background: rgba(37, 115, 155, 0.05);
        }

        .file-item-icon {
            font-size: 20px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--section-bg);
            border-radius: 6px;
            flex-shrink: 0;
        }

        .file-item-info {
            flex: 1;
            min-width: 0;
        }

        .file-item-name {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-bottom: 2px;
        }

        .file-item-raw {
            font-size: 10px;
            color: #25739B;
            font-weight: 600;
        }

        .file-status {
            font-size: 16px;
            flex-shrink: 0;
        }

        .file-status.pending {
            color: var(--status-pending);
        }

        .file-status.converting {
            animation: spin 1s linear infinite;
        }

        .file-status.completed {
            color: var(--status-success);
        }

        .file-status.error {
            color: var(--status-error);
        }

        /* ë¯¸ë¦¬ë³´ê¸° ì„¹ì…˜ */
        .preview-section {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 1px 3px var(--card-shadow);
            display: flex;
            flex-direction: column;
            max-height: 600px;
            overflow: hidden;
        }

        .preview-tabs {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            padding: 0 var(--spacing-lg);
        }

        .preview-tab {
            padding: var(--spacing-md) var(--spacing-lg);
            border: none;
            background: transparent;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
        }

        .preview-tab:hover {
            color: #25739B;
        }

        .preview-tab.active {
            color: #25739B;
        }

        .preview-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(135deg, #25739B 0%, #369EE1 100%);
        }

        .preview-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: auto;
            padding: var(--spacing-lg);
        }

        .preview-pane {
            display: none;
        }

        .preview-pane.active {
            display: block;
        }

        .preview-empty {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .preview-empty-icon {
            font-size: 48px;
            margin-bottom: var(--spacing-md);
        }

        .preview-empty-text {
            font-size: 14px;
        }

        .markdown-preview {
            font-size: 13px;
            line-height: 1.8;
            color: var(--text-primary);
            overflow-x: auto;
            max-width: 100%;
        }

        .markdown-preview h1,
        .markdown-preview h2,
        .markdown-preview h3 {
            margin-top: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            color: #25739B;
        }

        .markdown-preview p {
            margin-bottom: var(--spacing-md);
        }

        .markdown-preview pre {
            background: var(--section-bg);
            padding: var(--spacing-md);
            border-radius: 6px;
            overflow-x: auto;
            margin-bottom: var(--spacing-md);
            color: var(--text-primary);
        }

        .table-wrapper {
            overflow: scroll;
            margin-bottom: var(--spacing-md);
            max-width: 100%;
            max-height: 400px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            -webkit-overflow-scrolling: touch;
        }

        .table-wrapper::-webkit-scrollbar {
            width: 10px;
            height: 10px;
            display: block;
        }

        .table-wrapper::-webkit-scrollbar-track {
            background: var(--section-bg);
            border-radius: 4px;
        }

        .table-wrapper::-webkit-scrollbar-thumb {
            background: var(--text-muted);
            border-radius: 4px;
        }

        .table-wrapper::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        .markdown-preview table {
            min-width: 600px;
            border-collapse: collapse;
            margin-bottom: 0;
        }

        .markdown-preview th,
        .markdown-preview td {
            border: 1px solid var(--border-color);
            padding: var(--spacing-sm);
            text-align: left;
            white-space: nowrap;
        }

        .markdown-preview th {
            background: var(--section-bg);
            font-weight: 600;
        }

        /* ë³€í™˜ ë¡œê·¸ */
        .log-section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: var(--spacing-lg);
            box-shadow: 0 1px 3px var(--card-shadow);
            max-height: 300px;
            display: flex;
            flex-direction: column;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-sm);
            border-bottom: 2px solid var(--border-color);
        }

        .log-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .log-clear {
            font-size: 11px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .log-clear:hover {
            background: var(--section-bg);
        }

        .log-list {
            flex: 1;
            overflow-y: auto;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 11px;
        }

        .log-entry {
            padding: 4px 0;
            display: flex;
            gap: var(--spacing-sm);
        }

        .log-time {
            color: var(--text-muted);
            flex-shrink: 0;
        }

        .log-message {
            color: var(--text-primary);
        }

        .log-message.success {
            color: var(--status-success);
        }

        .log-message.error {
            color: var(--status-error);
        }

        .log-message.warning {
            color: #F59E0B;
        }

        [data-theme="dark"] .log-message.warning {
            color: #fbbf24;
        }

        /* ì•¡ì…˜ ë²„íŠ¼ */
        .action-section {
            display: flex;
            justify-content: space-between;
            gap: var(--spacing-md);
            margin-top: var(--spacing-xl);
        }

        .btn {
            padding: var(--spacing-md) var(--spacing-xl);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .btn-primary {
            background: linear-gradient(135deg, #25739B 0%, #369EE1 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(37, 115, 155, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            color: var(--text-secondary);
        }

        [data-theme="dark"] .btn-secondary {
            background: var(--section-bg);
        }

        .btn-convert {
            flex: 1;
        }

        @media (max-width: 1200px) {
            .content-grid {
                grid-template-columns: 1fr;
            }

            .file-list-section,
            .preview-section {
                max-height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="app-layout">
        <!-- Header -->
        <header class="app-header">
            <div class="header-left">
                <div class="logo">
                    <span class="logo-text">KPSUR AGENT</span>
                    <span class="logo-subtitle">ACUZEN AI</span>
                </div>
                <span class="deployment-badge test">í…ŒìŠ¤íŠ¸</span>
            </div>

            <div class="header-center">
                <div class="breadcrumb">
                    <span class="breadcrumb-item" onclick="navigateTo('P10_Dashboard.html')" style="cursor: pointer;">ëŒ€ì‹œë³´ë“œ</span>
                    <span class="breadcrumb-separator">/</span>
                    <span class="breadcrumb-item">ë³´ê³ ì„œ</span>
                    <span class="breadcrumb-separator">/</span>
                    <span class="breadcrumb-item active">ë§ˆí¬ë‹¤ìš´ ë³€í™˜</span>
                </div>
            </div>

            <div class="header-right">
                <button class="dark-mode-toggle" onclick="toggleDarkMode()" title="ë‹¤í¬ëª¨ë“œ ì „í™˜">
                    <span class="icon-sun">â˜€ï¸</span>
                    <span class="icon-moon">ğŸŒ™</span>
                </button>
                <div class="user-menu">
                    <div class="user-avatar">ì‚¬</div>
                    <div class="user-info">
                        <div class="user-name">ì‚¬ìš©ì</div>
                        <div class="user-role">Author</div>
                    </div>
                    <button class="user-menu-toggle">â–¼</button>
                </div>
            </div>
        </header>

        <!-- Content with Sidebar -->
        <div class="app-content">
            <!-- Main Content -->
            <main class="main-content">
                <div class="page-container">
                    <!-- Page Header -->
                    <div class="page-header">
                        <h1 class="page-title">ë§ˆí¬ë‹¤ìš´ ë³€í™˜ (Stage 4)</h1>
                        <p class="page-description">
                            ì—…ë¡œë“œëœ ì†ŒìŠ¤ ë¬¸ì„œ(PDF, Excel, Word)ë¥¼ LLMì„ ì‚¬ìš©í•˜ì—¬ ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
                            ë³€í™˜ ì‹œ ì›ë³¸ ë‚´ìš©ì„ ì •í™•íˆ ë³´ì¡´í•˜ë©°, ë‚´ìš©ì„ ì¶”ê°€í•˜ê±°ë‚˜ ìˆ˜ì •í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                        </p>
                    </div>

                    <!-- Warning Banner -->
                    <div class="warning-banner">
                        <div class="warning-icon">âš ï¸</div>
                        <div class="warning-content">
                            <div class="warning-title">ì¤‘ìš”: ì›ë³¸ ë³´ì¡´ ì›ì¹™</div>
                            <div class="warning-text">
                                ë§ˆí¬ë‹¤ìš´ ë³€í™˜ ì‹œ ì ˆëŒ€ë¡œ ë‚´ìš©ì„ ì¶”ê°€í•˜ê±°ë‚˜ ë³€í˜•í•´ì„œëŠ” ì•ˆ ë©ë‹ˆë‹¤.
                                ì›ë³¸ ë¬¸ì„œì˜ ëª¨ë“  ë‚´ìš©ì„ ê·¸ëŒ€ë¡œ ë³´ì¡´í•˜ì—¬ì•¼ í•˜ë©°, í˜•ì‹ë§Œ ë§ˆí¬ë‹¤ìš´ìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
                                í‘œ, ëª©ë¡, ì œëª© ë“±ì˜ êµ¬ì¡°ë¥¼ ë§ˆí¬ë‹¤ìš´ ë¬¸ë²•ì— ë§ê²Œ ë³€í™˜í•˜ë˜ ë‚´ìš©ì€ ë³€ê²½í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                            </div>
                        </div>
                    </div>

                    <!-- Content Grid -->
                    <div class="content-grid">
                        <!-- File List -->
                        <div class="file-list-section">
                            <div class="section-header">
                                <h2 class="section-title">ë³€í™˜ ëŒ€ìƒ íŒŒì¼</h2>
                                <div class="conversion-stats">
                                    <div class="stat-item">
                                        <span>ì´</span>
                                        <span class="stat-value" id="totalFiles">0</span>
                                    </div>
                                    <div class="stat-item">
                                        <span>ì™„ë£Œ</span>
                                        <span class="stat-value" id="completedFiles">0</span>
                                    </div>
                                    <div class="stat-item">
                                        <span>ëŒ€ê¸°</span>
                                        <span class="stat-value" id="pendingFiles">0</span>
                                    </div>
                                </div>
                            </div>

                            <div class="file-list" id="fileList">
                                <!-- JavaScriptë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤ -->
                            </div>
                        </div>

                        <!-- Preview Section -->
                        <div class="preview-section">
                            <div class="preview-tabs">
                                <button class="preview-tab active" onclick="switchPreviewTab('original')">ì›ë³¸</button>
                                <button class="preview-tab" onclick="switchPreviewTab('markdown')">ë§ˆí¬ë‹¤ìš´</button>
                            </div>

                            <div class="preview-content">
                                <div id="preview-original" class="preview-pane active">
                                    <div class="preview-empty">
                                        <div class="preview-empty-icon">ğŸ“„</div>
                                        <div class="preview-empty-text">íŒŒì¼ì„ ì„ íƒí•˜ë©´ ì›ë³¸ì„ ë¯¸ë¦¬ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>
                                    </div>
                                </div>

                                <div id="preview-markdown" class="preview-pane">
                                    <div class="preview-empty">
                                        <div class="preview-empty-icon">ğŸ“</div>
                                        <div class="preview-empty-text">ë³€í™˜ì´ ì™„ë£Œë˜ë©´ ë§ˆí¬ë‹¤ìš´ì„ ë¯¸ë¦¬ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Conversion Log -->
                    <div class="log-section">
                        <div class="log-header">
                            <div class="log-title">ë³€í™˜ ë¡œê·¸</div>
                            <div class="log-clear" onclick="clearLog()">ì§€ìš°ê¸°</div>
                        </div>
                        <div class="log-list" id="logList">
                            <!-- JavaScriptë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤ -->
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="action-section">
                        <button class="btn btn-secondary" onclick="navigateTo('P14_FileUpload.html')">
                            <span>â† ì´ì „</span>
                        </button>
                        <button class="btn btn-primary btn-convert" id="convertBtn">
                            <span>âœ¨</span>
                            <span>ë§ˆí¬ë‹¤ìš´ ë³€í™˜ ë° LLM ë¶„ë¥˜</span>
                        </button>
                        <button class="btn btn-primary" id="nextBtn" disabled>
                            <span>ë‹¤ìŒ ë‹¨ê³„ë¡œ</span>
                            <span>â†’</span>
                        </button>
                    </div>
                </div>
            </main>

            <!-- Workflow Sidebar (Right) -->
            <aside class="workflow-sidebar">
                <div class="workflow-header">
                    <h3>ì§„í–‰ ìƒí™©</h3>
                    <div class="workflow-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 37.5%"></div>
                        </div>
                        <div class="progress-text">4 / 9 ë‹¨ê³„</div>
                    </div>
                </div>

                <div class="workflow-stages">
                    <div class="workflow-stage completed">
                        <div class="stage-icon">ğŸ”</div>
                        <div class="stage-info">
                            <div class="stage-name">Stage 1</div>
                            <div class="stage-label">ë¡œê·¸ì¸</div>
                        </div>
                        <div class="stage-status">âœ“</div>
                    </div>

                    <div class="workflow-stage completed">
                        <div class="stage-icon">ğŸ“‹</div>
                        <div class="stage-info">
                            <div class="stage-name">Stage 2</div>
                            <div class="stage-label">ë³´ê³ ì„œ ìƒíƒœ</div>
                        </div>
                        <div class="stage-status">âœ“</div>
                    </div>

                    <div class="workflow-stage completed">
                        <div class="stage-icon">ğŸ“¤</div>
                        <div class="stage-info">
                            <div class="stage-name">Stage 3</div>
                            <div class="stage-label">íŒŒì¼ ì—…ë¡œë“œ</div>
                        </div>
                        <div class="stage-status">âœ“</div>
                    </div>

                    <div class="workflow-stage current">
                        <div class="stage-icon">ğŸ”„</div>
                        <div class="stage-info">
                            <div class="stage-name">Stage 4</div>
                            <div class="stage-label">MD ë³€í™˜</div>
                        </div>
                        <div class="stage-status">â—‰</div>
                    </div>

                    <div class="workflow-stage pending">
                        <div class="stage-icon">âš™ï¸</div>
                        <div class="stage-info">
                            <div class="stage-name">Stage 5</div>
                            <div class="stage-label">ë°ì´í„° ì¶”ì¶œ</div>
                        </div>
                        <div class="stage-status">â—‹</div>
                    </div>

                    <div class="workflow-stage pending">
                        <div class="stage-icon">ğŸ“„</div>
                        <div class="stage-info">
                            <div class="stage-name">Stage 6</div>
                            <div class="stage-label">í…œí”Œë¦¿ ì‘ì„±</div>
                        </div>
                        <div class="stage-status">â—‹</div>
                    </div>

                    <div class="workflow-stage pending">
                        <div class="stage-icon">âœï¸</div>
                        <div class="stage-info">
                            <div class="stage-name">Stage 7</div>
                            <div class="stage-label">ë¦¬ë·°</div>
                        </div>
                        <div class="stage-status">â—‹</div>
                    </div>

                    <div class="workflow-stage pending">
                        <div class="stage-icon">âœ…</div>
                        <div class="stage-info">
                            <div class="stage-name">Stage 8</div>
                            <div class="stage-label">QC ê²€ì¦</div>
                        </div>
                        <div class="stage-status">â—‹</div>
                    </div>

                    <div class="workflow-stage pending">
                        <div class="stage-icon">ğŸ“¤</div>
                        <div class="stage-info">
                            <div class="stage-name">Stage 9</div>
                            <div class="stage-label">ìµœì¢… ì¶œë ¥</div>
                        </div>
                        <div class="stage-status">â—‹</div>
                    </div>
                </div>

                <div class="workflow-footer">
                    <div class="medical-badge">ì˜ë£Œìš© AI ì†Œí”„íŠ¸ì›¨ì–´</div>
                </div>
            </aside>
        </div>

        <!-- Footer -->
        <footer class="app-footer">
            <div class="footer-content">
                Copyright. Power Solution., Inc. 2026.
            </div>
        </footer>
    </div>

    <!-- Dark Mode Script -->
    <script>
        // ë‹¤í¬ëª¨ë“œ ì´ˆê¸°í™” (í˜ì´ì§€ ë¡œë“œ ì¦‰ì‹œ)
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();

        // ë‹¤í¬ëª¨ë“œ í† ê¸€ í•¨ìˆ˜
        function toggleDarkMode() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }
    </script>

    <!-- Core JS ëª¨ë“ˆ ë¡œë“œ (ì „ì—­ ìŠ¤í¬ë¦½íŠ¸) -->
    <script src="../utils/globals.js"></script>
    <script src="../js/config.js"></script>
    <script src="../js/file-handler.js"></script>
    <script src="../js/file-storage.js"></script>
    <script src="../js/markdown-converter.js"></script>
    <script src="../js/multi-llm-client.js"></script>
    <script src="../js/workflow-manager.js"></script>
    <script src="../js/cost-tracker.js"></script>
    <script src="../js/psur-generator.js"></script>

    <!-- JavaScript -->
    <script src="../components/AppLayout.js"></script>
    <script src="../utils/layout-helper.js"></script>
    <script>
        // ì „ì—­ ë³€ìˆ˜ ì°¸ì¡°
        const Storage = window.Storage || {
            get: (key) => { try { return JSON.parse(localStorage.getItem(key)); } catch { return null; } },
            set: (key, value) => { try { localStorage.setItem(key, JSON.stringify(value)); } catch {} }
        };

        // ì „ì—­ ëª¨ë“ˆ ì°¸ì¡°
        const markdownConverter = window.markdownConverter;
        const fileHandler = window.fileHandler;
        const fileStorage = window.fileStorage;
        const llmClient = window.multiLLMClient || window.llmClient;

        // ì—…ë¡œë“œëœ íŒŒì¼ ë°ì´í„° ë¡œë“œ
        const uploadedFilesData = Storage.get('uploadedFiles') || [];
        const files = uploadedFilesData.map((fileData, index) => ({
            id: index + 1,
            name: fileData.fileName,
            rawId: fileData.rawId,
            url: fileData.url,
            path: fileData.path,
            status: 'pending',
            markdown: null,
            convertedAt: null
        }));

        let selectedFile = null;
        let logs = [];

        // ì „ì—­ ìŠ¤ì½”í”„ì— files ë…¸ì¶œ (ë””ë²„ê¹… ë° ë°ì´í„° ì ‘ê·¼ìš©)
        window.files = files;

        // ì €ì¥ëœ ë³€í™˜ ê²°ê³¼ ë³µì›
        const savedConversions = Storage.get('convertedMarkdowns') || {};
        files.forEach(file => {
            const saved = savedConversions[file.name];
            if (saved) {
                file.markdown = saved.markdown;
                file.convertedAt = saved.convertedAt;
                file.status = 'completed';
            }
        });

        /**
         * íŒŒì¼ ê°ì²´ ë¡œë“œ (IndexedDB ë˜ëŠ” Supabase Storage)
         * @param {Object} file - íŒŒì¼ ë©”íƒ€ë°ì´í„°
         * @returns {Promise<File>} íŒŒì¼ ê°ì²´
         */
        async function loadFileObject(file) {
            // 1. IndexedDBì—ì„œ íŒŒì¼ ë¡œë“œ ì‹œë„
            const storedFile = await fileStorage.loadFileByName(file.name);
            if (storedFile.success) {
                console.log(`âœ… File loaded from IndexedDB: ${file.name}`);
                return storedFile.file;
            }

            // 2. IndexedDBì— ì—†ìœ¼ë©´ Supabase Storageì—ì„œ ê°€ì ¸ì˜¤ê¸°
            if (file.url) {
                const response = await fetch(file.url);
                if (!response.ok) {
                    throw new Error(`íŒŒì¼ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${response.statusText}`);
                }
                const blob = await response.blob();
                return new File([blob], file.name, { type: blob.type });
            }

            throw new Error('íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }

        /**
         * íŒŒì¼ ë°ì´í„°ë¥¼ localStorageì— ì €ì¥
         * @param {Object} file - íŒŒì¼ ê°ì²´
         */
        function saveFileToLocalStorage(file) {
            // uploadedFiles ì—…ë°ì´íŠ¸ (rawId í¬í•¨)
            const uploadedFiles = Storage.get('uploadedFiles') || [];
            const idx = uploadedFiles.findIndex(f => f.fileName === file.name);
            if (idx >= 0) {
                uploadedFiles[idx].rawId = file.rawId;
            }
            Storage.set('uploadedFiles', uploadedFiles);

            // convertedMarkdowns ì—…ë°ì´íŠ¸
            const savedConversions = Storage.get('convertedMarkdowns') || {};
            savedConversions[file.name] = {
                markdown: file.markdown,
                rawId: file.rawId,
                convertedAt: file.convertedAt
            };
            Storage.set('convertedMarkdowns', savedConversions);
        }

        /**
         * ë§ˆí¬ë‹¤ìš´ ë³€í™˜ + LLM ë¶„ë¥˜ í†µí•© ì‹¤í–‰
         * Step 1: ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ ë§ˆí¬ë‹¤ìš´ ë³€í™˜
         * Step 2: LLMì— íŒŒì¼ëª…+ë§ˆí¬ë‹¤ìš´ ì „ì†¡í•˜ì—¬ Raw ID ë¶„ë¥˜
         * Step 3: localStorageì— ì €ì¥
         */
        async function classifyAndConvertAllFiles() {
            const pendingFiles = files.filter(f => f.status === 'pending' || f.status === 'error');

            if (pendingFiles.length === 0) {
                if (typeof showToast === 'function') {
                    showToast('ëª¨ë“  íŒŒì¼ì´ ì´ë¯¸ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
                }
                return;
            }

            // API í‚¤ í™•ì¸ (llmClientê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ)
            if (llmClient && typeof llmClient.getApiKey === 'function') {
                const apiKey = llmClient.getApiKey();
                if (!apiKey) {
                    if (typeof showToast === 'function') {
                        showToast('API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì„¤ì • í˜ì´ì§€ì—ì„œ API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                    }
                    return;
                }
            }

            document.getElementById('convertBtn').disabled = true;
            addLog(`${pendingFiles.length}ê°œ íŒŒì¼ ì²˜ë¦¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...`, 'info');
            if (typeof showLLMLoading === 'function') {
                showLLMLoading('ë§ˆí¬ë‹¤ìš´ ë³€í™˜ ë° LLM ë¶„ë¥˜ë¥¼ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤...');
            }

            for (const file of pendingFiles) {
                try {
                    // === Step 1: ë§ˆí¬ë‹¤ìš´ìœ¼ë¡œ ë³€í™˜ (ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš©) ===
                    addLog(`ğŸ“„ ${file.name} ë§ˆí¬ë‹¤ìš´ ë³€í™˜ ì¤‘...`, 'info');
                    file.status = 'converting';
                    renderFileList();
                    updateStats();

                    const fileObj = await loadFileObject(file);
                    const conversionResult = await markdownConverter.convertFile(fileObj, file.rawId || 'UNKNOWN');

                    if (conversionResult.success) {
                        file.markdown = conversionResult.data.markdownContent;
                        file.convertedAt = conversionResult.data.convertedAt;
                        addLog(`âœ… ${file.name} ë§ˆí¬ë‹¤ìš´ ë³€í™˜ ì™„ë£Œ (${conversionResult.data.duration}s)`, 'success');
                    } else {
                        file.status = 'error';
                        addLog(`âŒ ${file.name} ë³€í™˜ ì‹¤íŒ¨: ${conversionResult.error}`, 'error');
                        continue; // ë‹¤ìŒ íŒŒì¼ë¡œ ì§„í–‰
                    }

                    // === Step 2: LLMì— íŒŒì¼ëª… + ë§ˆí¬ë‹¤ìš´ ì „ì†¡í•˜ì—¬ Raw ID ë¶„ë¥˜ ===
                    addLog(`ğŸ” ${file.name} Raw ID ë¶„ë¥˜ ì¤‘ (LLM)...`, 'info');

                    // ë§ˆí¬ë‹¤ìš´ ë‚´ìš©ì„ LLMì— ì „ì†¡ (ìµœëŒ€ 3000ì)
                    const contentPreview = file.markdown.substring(0, 3000);

                    // LLM ë¶„ë¥˜ ì‹œë„
                    let classifyResult = { success: false };
                    if (llmClient && typeof llmClient.classifyDocument === 'function') {
                        classifyResult = await llmClient.classifyDocument(file.name, contentPreview);
                    } else if (fileHandler && typeof fileHandler.classifyByContent === 'function') {
                        // fileHandlerì˜ ê·œì¹™ ê¸°ë°˜ ë¶„ë¥˜ ì‚¬ìš©
                        classifyResult = fileHandler.classifyByContent(file.name, contentPreview);
                    }

                    if (classifyResult.success && classifyResult.rawId) {
                        file.rawId = classifyResult.rawId;
                        file.rawIdSource = 'llm';
                        addLog(`âœ… ${file.name} â†’ ${file.rawId} ë¶„ë¥˜ ì™„ë£Œ`, 'success');
                    } else if (classifyResult.needsUserInput) {
                        addLog(`âš ï¸ ${file.name}: ë¶„ë¥˜ ë¶ˆí™•ì‹¤ - ì‚¬ìš©ì í™•ì¸ í•„ìš”`, 'warning');
                    } else {
                        addLog(`âš ï¸ ${file.name} ë¶„ë¥˜ ì‹¤íŒ¨: ${classifyResult.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`, 'warning');
                    }

                    file.status = 'completed';
                    renderFileList();
                    updateStats();

                    // === Step 3: localStorageì— ì €ì¥ ===
                    saveFileToLocalStorage(file);

                    // ì„ íƒëœ íŒŒì¼ì´ë©´ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
                    if (selectedFile?.id === file.id) {
                        selectFile(file.id);
                    }

                    // Rate limit ë°©ì§€ë¥¼ ìœ„í•œ ë”œë ˆì´
                    await new Promise(resolve => setTimeout(resolve, 800));

                } catch (error) {
                    console.error('Processing error:', error);
                    file.status = 'error';
                    addLog(`âŒ ${file.name} ì²˜ë¦¬ ì‹¤íŒ¨: ${error.message}`, 'error');
                    renderFileList();
                    updateStats();
                }
            }

            if (typeof hideLLMLoading === 'function') hideLLMLoading();
            document.getElementById('convertBtn').disabled = false;
            addLog('ëª¨ë“  íŒŒì¼ ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            if (typeof showToast === 'function') {
                showToast('ë§ˆí¬ë‹¤ìš´ ë³€í™˜ ë° LLM ë¶„ë¥˜ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            }
        }

        // í†µí•© í•¨ìˆ˜ ì „ì—­ ë…¸ì¶œ
        window.classifyAndConvertAllFiles = classifyAndConvertAllFiles;

        // Wait for both DOM and globals to load
        async function initializePage() {
            // Check if globals are loaded
            if (!window.__GLOBALS_LOADED__) {
                setTimeout(initializePage, 50);
                return;
            }

            // ì„¸ì…˜ ë¡œë“œ (ì „ì—­ í•¨ìˆ˜ ì‚¬ìš©)
            const session = typeof loadSessionData === 'function' ? loadSessionData() : null;
            if (session) {
                const userNameEl = document.querySelector('.user-name');
                const userRoleEl = document.querySelector('.user-role');
                const userAvatarEl = document.querySelector('.user-avatar');
                if (userNameEl) userNameEl.textContent = session.userName;
                if (userRoleEl) userRoleEl.textContent = session.userRole;
                if (userAvatarEl) userAvatarEl.textContent = session.userName.charAt(0);
            }

            // ì‚¬ìš©ì ë©”ë‰´ ì„¤ì •
            if (typeof setupUserMenu === 'function') {
                setupUserMenu();
            }

            renderFileList();
            updateStats();

            addLog('ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ.');

            // ì²˜ë¦¬ í•„ìš”í•œ íŒŒì¼ ìˆ˜ í‘œì‹œ
            const pendingCount = files.filter(f => f.status === 'pending').length;
            const completedCount = files.filter(f => f.status === 'completed').length;

            if (pendingCount > 0) {
                addLog(`${pendingCount}ê°œ íŒŒì¼ì´ ì²˜ë¦¬ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤. "ë§ˆí¬ë‹¤ìš´ ë³€í™˜ ë° LLM ë¶„ë¥˜" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.`);
            } else if (completedCount === files.length) {
                addLog('ëª¨ë“  íŒŒì¼ì´ ì²˜ë¦¬ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'success');
            }
        }

        // Start initialization when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializePage);
        } else {
            initializePage();
        }

        function renderFileList() {
            const fileList = document.getElementById('fileList');

            // Group by RAW ID prefix
            const requiredIds = ['RAW1', 'RAW2.1', 'RAW2.2', 'RAW2.3', 'RAW3', 'RAW4'];
            const lineListingIds = ['RAW12', 'RAW13', 'RAW14', 'RAW15'];
            const optionalIds = ['RAW2.6', 'RAW5', 'RAW6', 'RAW7.1', 'RAW7.2', 'RAW7.3', 'RAW7.4', 'RAW8', 'RAW9'];

            const groups = {
                'required': files.filter(f => requiredIds.includes(f.rawId)),
                'lineListing': files.filter(f => lineListingIds.includes(f.rawId)),
                'optional': files.filter(f => optionalIds.includes(f.rawId))
            };

            fileList.innerHTML = `
                <div class="file-group">
                    <div class="group-header">í•„ìˆ˜ ë¬¸ì„œ</div>
                    ${groups.required.map(file => renderFileItem(file)).join('')}
                </div>
                <div class="file-group">
                    <div class="group-header">Line Listing</div>
                    ${groups.lineListing.map(file => renderFileItem(file)).join('')}
                </div>
                ${groups.optional.length > 0 ? `
                <div class="file-group">
                    <div class="group-header">ì„ íƒ ë¬¸ì„œ</div>
                    ${groups.optional.map(file => renderFileItem(file)).join('')}
                </div>
                ` : ''}
            `;
        }

        function renderFileItem(file) {
            const statusIcons = {
                'pending': 'â—‹',
                'converting': 'âŸ³',
                'completed': 'âœ“',
                'error': 'âœ—'
            };

            return `
                <div class="file-item ${file.status} ${selectedFile?.id === file.id ? 'active' : ''}"
                     onclick="selectFile(${file.id})">
                    <div class="file-item-icon">${getFileIcon(file.name)}</div>
                    <div class="file-item-info">
                        <div class="file-item-name">${file.name}</div>
                        <div class="file-item-raw">${file.rawId}</div>
                    </div>
                    <div class="file-status ${file.status}">
                        ${statusIcons[file.status]}
                    </div>
                </div>
            `;
        }

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const icons = {
                'pdf': 'ğŸ“„',
                'xlsx': 'ğŸ“Š',
                'xls': 'ğŸ“Š',
                'docx': 'ğŸ“'
            };
            return icons[ext] || 'ğŸ“„';
        }

        function selectFile(fileId) {
            selectedFile = files.find(f => f.id === fileId);
            renderFileList();

            // Update preview
            if (selectedFile) {
                document.getElementById('preview-original').innerHTML = `
                    <div style="padding: 20px; background: var(--section-bg); border-radius: 8px;">
                        <h3 style="margin-bottom: 16px; color: var(--text-primary);">${selectedFile.name}</h3>
                        <p style="color: var(--text-secondary); font-size: 13px;">
                            ì›ë³¸ íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°ëŠ” ì‹¤ì œ êµ¬í˜„ ì‹œ PDF/Excel/Word ë·°ì–´ë¥¼ í†µí•´ í‘œì‹œë©ë‹ˆë‹¤.
                        </p>
                    </div>
                `;

                if (selectedFile.status === 'completed' && selectedFile.markdown) {
                    // marked.jsë¡œ ë§ˆí¬ë‹¤ìš´ì„ HTMLë¡œ ë Œë”ë§
                    let renderedHtml = marked.parse(selectedFile.markdown);
                    // í…Œì´ë¸”ì„ ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ wrapperë¡œ ê°ì‹¸ê¸°
                    renderedHtml = renderedHtml.replace(/<table>/g, '<div class="table-wrapper"><table>').replace(/<\/table>/g, '</table></div>');
                    document.getElementById('preview-markdown').innerHTML = `
                        <div class="markdown-preview">
                            ${renderedHtml}
                        </div>
                    `;
                } else {
                    document.getElementById('preview-markdown').innerHTML = `
                        <div class="preview-empty">
                            <div class="preview-empty-icon">â³</div>
                            <div class="preview-empty-text">ë³€í™˜ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</div>
                        </div>
                    `;
                }
            }
        }

        function switchPreviewTab(tab) {
            document.querySelectorAll('.preview-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.preview-pane').forEach(p => p.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(`preview-${tab}`).classList.add('active');
        }

        function updateStats() {
            document.getElementById('totalFiles').textContent = files.length;
            document.getElementById('completedFiles').textContent = files.filter(f => f.status === 'completed').length;
            document.getElementById('pendingFiles').textContent = files.filter(f => f.status === 'pending').length;

            // ëª¨ë“  íŒŒì¼ì´ ë³€í™˜ ì™„ë£Œë˜ë©´ ë‹¤ìŒ ë²„íŠ¼ í™œì„±í™”
            const allCompleted = files.every(f => f.status === 'completed');
            document.getElementById('nextBtn').disabled = !allCompleted;
        }

        function addLog(message, type = 'info') {
            const now = new Date();
            const time = now.toTimeString().slice(0, 8);

            logs.push({ time, message, type });

            const logList = document.getElementById('logList');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `
                <span class="log-time">[${time}]</span>
                <span class="log-message ${type}">${message}</span>
            `;

            logList.appendChild(entry);
            logList.scrollTop = logList.scrollHeight;
        }

        function clearLog() {
            logs = [];
            document.getElementById('logList').innerHTML = '';
            addLog('ë¡œê·¸ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        // ì „ì—­ ìŠ¤ì½”í”„ì— í•¨ìˆ˜ ë…¸ì¶œ (ì¸ë¼ì¸ onclickì—ì„œ í˜¸ì¶œ ê°€ëŠ¥í•˜ë„ë¡)
        window.selectFile = selectFile;
        window.switchPreviewTab = switchPreviewTab;
        window.clearLog = clearLog;

        // ë§ˆí¬ë‹¤ìš´ ë³€í™˜ ë° LLM ë¶„ë¥˜ (í†µí•© ë²„íŠ¼)
        document.getElementById('convertBtn').addEventListener('click', classifyAndConvertAllFiles);

        // ë‹¤ìŒ ë‹¨ê³„ë¡œ
        document.getElementById('nextBtn').addEventListener('click', () => {
            // ë³€í™˜ ê²°ê³¼ localStorageì— ì €ì¥
            const convertedMarkdowns = files.map(file => ({
                fileName: file.name,
                rawId: file.rawId,
                markdown: file.markdown,
                convertedAt: file.convertedAt,
                status: file.status
            }));

            Storage.set('convertedMarkdowns', convertedMarkdowns);

            // ë³€í™˜ ìš”ì•½ ì €ì¥
            if (markdownConverter && typeof markdownConverter.getConversionHistory === 'function') {
                const conversionSummary = markdownConverter.getConversionHistory();
                Storage.set('conversionSummary', conversionSummary);
            }

            // workflowManagerì—ë„ ì €ì¥ (ìˆëŠ” ê²½ìš°)
            if (window.workflowManager) {
                files.forEach(file => {
                    if (file.markdown) {
                        window.workflowManager.saveMarkdownData(file.rawId, file.markdown);
                    }
                });
            }

            // === ë§ˆí¬ë‹¤ìš´ í†µí•© (PSURGenerator ì‚¬ìš©) ===
            if (window.PSURGenerator) {
                const combinedMarkdown = window.PSURGenerator.combineAllMarkdowns(convertedMarkdowns);
                if (combinedMarkdown) {
                    Storage.set('combinedMarkdown', {
                        content: combinedMarkdown,
                        generatedAt: new Date().toISOString(),
                        fileCount: convertedMarkdowns.length
                    });
                    addLog(`ë§ˆí¬ë‹¤ìš´ í†µí•© ì™„ë£Œ: ${combinedMarkdown.length.toLocaleString()} ì`, 'success');
                }
            }

            const reportId = new URLSearchParams(window.location.search).get('reportId') || Date.now().toString();

            addLog('ë³€í™˜ ê²°ê³¼ë¥¼ ì €ì¥í–ˆìŠµë‹ˆë‹¤. ë°ì´í„° ì¶”ì¶œ ë‹¨ê³„ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
            if (typeof showToast === 'function') {
                showToast('ë°ì´í„° ì¶”ì¶œ ë‹¨ê³„ë¡œ ì´ë™í•©ë‹ˆë‹¤.', 'success');
            }

            setTimeout(() => {
                if (typeof navigateTo === 'function') {
                    navigateTo(`P16_DataExtraction.html?reportId=${reportId}`);
                } else {
                    window.location.href = `P16_DataExtraction.html?reportId=${reportId}`;
                }
            }, 1000);
        });
    </script>
</body>
</html>

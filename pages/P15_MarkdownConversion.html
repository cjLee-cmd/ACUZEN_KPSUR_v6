<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§ˆí¬ë‹¤ìš´ ë³€í™˜ - KPSUR AGENT | ACUZEN AI</title>
    <link rel="stylesheet" href="../css/styles/globals.css">
    <link rel="stylesheet" href="../css/styles/layout.css">
    <style>
        .page-container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .page-header {
            margin-bottom: var(--spacing-xl);
        }

        .page-title {
            font-size: 24px;
            font-weight: 700;
            color: #374151;
            margin-bottom: var(--spacing-xs);
        }

        .page-description {
            font-size: 14px;
            color: #6B7280;
            line-height: 1.6;
        }

        /* ê²½ê³  ë°°ë„ˆ */
        .warning-banner {
            background: #FEF2F2;
            border: 2px solid #FCA5A5;
            border-radius: 8px;
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
            display: flex;
            align-items: start;
            gap: var(--spacing-md);
        }

        .warning-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .warning-content {
            flex: 1;
        }

        .warning-title {
            font-size: 14px;
            font-weight: 700;
            color: #DC2626;
            margin-bottom: 4px;
        }

        .warning-text {
            font-size: 12px;
            color: #991B1B;
            line-height: 1.5;
        }

        /* ì»¨í…ì¸  ê·¸ë¦¬ë“œ */
        .content-grid {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }

        /* íŒŒì¼ ëª©ë¡ */
        .file-list-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            max-height: 600px;
        }

        .section-header {
            padding: var(--spacing-lg);
            border-bottom: 2px solid #E5E7EB;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #374151;
            margin-bottom: var(--spacing-sm);
        }

        .conversion-stats {
            display: flex;
            gap: var(--spacing-lg);
            font-size: 12px;
            color: #6B7280;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .stat-value {
            font-weight: 700;
            color: #374151;
        }

        .file-list {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-md);
        }

        .file-group {
            margin-bottom: var(--spacing-lg);
        }

        .file-group:last-child {
            margin-bottom: 0;
        }

        .group-header {
            font-size: 11px;
            font-weight: 600;
            color: #9CA3AF;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: var(--spacing-sm);
            padding: 0 var(--spacing-sm);
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: var(--spacing-xs);
        }

        .file-item:hover {
            background: rgba(37, 115, 155, 0.05);
        }

        .file-item.active {
            background: rgba(37, 115, 155, 0.1);
            border-left: 3px solid #25739B;
        }

        .file-item.converting {
            background: rgba(37, 115, 155, 0.05);
        }

        .file-item-icon {
            font-size: 20px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border-radius: 6px;
            flex-shrink: 0;
        }

        .file-item-info {
            flex: 1;
            min-width: 0;
        }

        .file-item-name {
            font-size: 12px;
            font-weight: 600;
            color: #374151;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-bottom: 2px;
        }

        .file-item-raw {
            font-size: 10px;
            color: #25739B;
            font-weight: 600;
        }

        .file-status {
            font-size: 16px;
            flex-shrink: 0;
        }

        .file-status.pending {
            color: #D1D5DB;
        }

        .file-status.converting {
            animation: spin 1s linear infinite;
        }

        .file-status.completed {
            color: #10B981;
        }

        .file-status.error {
            color: #EF4444;
        }

        /* ë¯¸ë¦¬ë³´ê¸° ì„¹ì…˜ */
        .preview-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            max-height: 600px;
        }

        .preview-tabs {
            display: flex;
            border-bottom: 2px solid #E5E7EB;
            padding: 0 var(--spacing-lg);
        }

        .preview-tab {
            padding: var(--spacing-md) var(--spacing-lg);
            border: none;
            background: transparent;
            font-size: 13px;
            font-weight: 600;
            color: #6B7280;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
        }

        .preview-tab:hover {
            color: #25739B;
        }

        .preview-tab.active {
            color: #25739B;
        }

        .preview-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(135deg, #25739B 0%, #369EE1 100%);
        }

        .preview-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-lg);
        }

        .preview-pane {
            display: none;
        }

        .preview-pane.active {
            display: block;
        }

        .preview-empty {
            text-align: center;
            padding: 60px 20px;
            color: #9CA3AF;
        }

        .preview-empty-icon {
            font-size: 48px;
            margin-bottom: var(--spacing-md);
        }

        .preview-empty-text {
            font-size: 14px;
        }

        .markdown-preview {
            font-size: 13px;
            line-height: 1.8;
            color: #374151;
        }

        .markdown-preview h1,
        .markdown-preview h2,
        .markdown-preview h3 {
            margin-top: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            color: #25739B;
        }

        .markdown-preview p {
            margin-bottom: var(--spacing-md);
        }

        .markdown-preview pre {
            background: #F9FAFB;
            padding: var(--spacing-md);
            border-radius: 6px;
            overflow-x: auto;
            margin-bottom: var(--spacing-md);
        }

        .markdown-preview table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: var(--spacing-md);
        }

        .markdown-preview th,
        .markdown-preview td {
            border: 1px solid #E5E7EB;
            padding: var(--spacing-sm);
            text-align: left;
        }

        .markdown-preview th {
            background: #F9FAFB;
            font-weight: 600;
        }

        /* ë³€í™˜ ë¡œê·¸ */
        .log-section {
            background: white;
            border-radius: 12px;
            padding: var(--spacing-lg);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            max-height: 300px;
            display: flex;
            flex-direction: column;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-sm);
            border-bottom: 2px solid #E5E7EB;
        }

        .log-title {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
        }

        .log-clear {
            font-size: 11px;
            color: #6B7280;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .log-clear:hover {
            background: #F3F4F6;
        }

        .log-list {
            flex: 1;
            overflow-y: auto;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 11px;
        }

        .log-entry {
            padding: 4px 0;
            display: flex;
            gap: var(--spacing-sm);
        }

        .log-time {
            color: #9CA3AF;
            flex-shrink: 0;
        }

        .log-message {
            color: #374151;
        }

        .log-message.success {
            color: #10B981;
        }

        .log-message.error {
            color: #EF4444;
        }

        .log-message.warning {
            color: #F59E0B;
        }

        /* ì•¡ì…˜ ë²„íŠ¼ */
        .action-section {
            display: flex;
            justify-content: space-between;
            gap: var(--spacing-md);
            margin-top: var(--spacing-xl);
        }

        .btn {
            padding: var(--spacing-md) var(--spacing-xl);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .btn-primary {
            background: linear-gradient(135deg, #25739B 0%, #369EE1 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(37, 115, 155, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: white;
            border: 2px solid #E5E7EB;
            color: #6B7280;
        }

        .btn-convert {
            flex: 1;
        }

        @media (max-width: 1200px) {
            .content-grid {
                grid-template-columns: 1fr;
            }

            .file-list-section,
            .preview-section {
                max-height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="app-layout">
        <!-- Header -->
        <header class="app-header">
            <div class="header-left">
                <div class="logo">
                    <span class="logo-text">KPSUR AGENT</span>
                    <span class="logo-subtitle">ACUZEN AI</span>
                </div>
                <span class="deployment-badge test">í…ŒìŠ¤íŠ¸</span>
            </div>

            <div class="header-center">
                <div class="breadcrumb">
                    <span class="breadcrumb-item" onclick="navigateTo('P10_Dashboard.html')" style="cursor: pointer;">ëŒ€ì‹œë³´ë“œ</span>
                    <span class="breadcrumb-separator">/</span>
                    <span class="breadcrumb-item">ë³´ê³ ì„œ</span>
                    <span class="breadcrumb-separator">/</span>
                    <span class="breadcrumb-item active">ë§ˆí¬ë‹¤ìš´ ë³€í™˜</span>
                </div>
            </div>

            <div class="header-right">
                <div class="user-menu">
                    <div class="user-avatar">ì‚¬</div>
                    <div class="user-info">
                        <div class="user-name">ì‚¬ìš©ì</div>
                        <div class="user-role">Author</div>
                    </div>
                    <button class="user-menu-toggle">â–¼</button>
                </div>
            </div>
        </header>

        <!-- Content with Sidebar -->
        <div class="app-content">
            <!-- Main Content -->
            <main class="main-content">
                <div class="page-container">
                    <!-- Page Header -->
                    <div class="page-header">
                        <h1 class="page-title">ë§ˆí¬ë‹¤ìš´ ë³€í™˜ (Stage 4)</h1>
                        <p class="page-description">
                            ì—…ë¡œë“œëœ ì†ŒìŠ¤ ë¬¸ì„œ(PDF, Excel, Word)ë¥¼ LLMì„ ì‚¬ìš©í•˜ì—¬ ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
                            ë³€í™˜ ì‹œ ì›ë³¸ ë‚´ìš©ì„ ì •í™•íˆ ë³´ì¡´í•˜ë©°, ë‚´ìš©ì„ ì¶”ê°€í•˜ê±°ë‚˜ ìˆ˜ì •í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                        </p>
                    </div>

                    <!-- Warning Banner -->
                    <div class="warning-banner">
                        <div class="warning-icon">âš ï¸</div>
                        <div class="warning-content">
                            <div class="warning-title">ì¤‘ìš”: ì›ë³¸ ë³´ì¡´ ì›ì¹™</div>
                            <div class="warning-text">
                                ë§ˆí¬ë‹¤ìš´ ë³€í™˜ ì‹œ ì ˆëŒ€ë¡œ ë‚´ìš©ì„ ì¶”ê°€í•˜ê±°ë‚˜ ë³€í˜•í•´ì„œëŠ” ì•ˆ ë©ë‹ˆë‹¤.
                                ì›ë³¸ ë¬¸ì„œì˜ ëª¨ë“  ë‚´ìš©ì„ ê·¸ëŒ€ë¡œ ë³´ì¡´í•˜ì—¬ì•¼ í•˜ë©°, í˜•ì‹ë§Œ ë§ˆí¬ë‹¤ìš´ìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
                                í‘œ, ëª©ë¡, ì œëª© ë“±ì˜ êµ¬ì¡°ë¥¼ ë§ˆí¬ë‹¤ìš´ ë¬¸ë²•ì— ë§ê²Œ ë³€í™˜í•˜ë˜ ë‚´ìš©ì€ ë³€ê²½í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                            </div>
                        </div>
                    </div>

                    <!-- Content Grid -->
                    <div class="content-grid">
                        <!-- File List -->
                        <div class="file-list-section">
                            <div class="section-header">
                                <h2 class="section-title">ë³€í™˜ ëŒ€ìƒ íŒŒì¼</h2>
                                <div class="conversion-stats">
                                    <div class="stat-item">
                                        <span>ì´</span>
                                        <span class="stat-value" id="totalFiles">0</span>
                                    </div>
                                    <div class="stat-item">
                                        <span>ì™„ë£Œ</span>
                                        <span class="stat-value" id="completedFiles">0</span>
                                    </div>
                                    <div class="stat-item">
                                        <span>ëŒ€ê¸°</span>
                                        <span class="stat-value" id="pendingFiles">0</span>
                                    </div>
                                </div>
                            </div>

                            <div class="file-list" id="fileList">
                                <!-- JavaScriptë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤ -->
                            </div>
                        </div>

                        <!-- Preview Section -->
                        <div class="preview-section">
                            <div class="preview-tabs">
                                <button class="preview-tab active" onclick="switchPreviewTab('original')">ì›ë³¸</button>
                                <button class="preview-tab" onclick="switchPreviewTab('markdown')">ë§ˆí¬ë‹¤ìš´</button>
                            </div>

                            <div class="preview-content">
                                <div id="preview-original" class="preview-pane active">
                                    <div class="preview-empty">
                                        <div class="preview-empty-icon">ğŸ“„</div>
                                        <div class="preview-empty-text">íŒŒì¼ì„ ì„ íƒí•˜ë©´ ì›ë³¸ì„ ë¯¸ë¦¬ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>
                                    </div>
                                </div>

                                <div id="preview-markdown" class="preview-pane">
                                    <div class="preview-empty">
                                        <div class="preview-empty-icon">ğŸ“</div>
                                        <div class="preview-empty-text">ë³€í™˜ì´ ì™„ë£Œë˜ë©´ ë§ˆí¬ë‹¤ìš´ì„ ë¯¸ë¦¬ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Conversion Log -->
                    <div class="log-section">
                        <div class="log-header">
                            <div class="log-title">ë³€í™˜ ë¡œê·¸</div>
                            <div class="log-clear" onclick="clearLog()">ì§€ìš°ê¸°</div>
                        </div>
                        <div class="log-list" id="logList">
                            <!-- JavaScriptë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤ -->
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="action-section">
                        <button class="btn btn-secondary" onclick="navigateTo('P14_FileUpload.html')">
                            <span>â† ì´ì „</span>
                        </button>
                        <button class="btn btn-primary btn-convert" id="convertBtn">
                            <span>âœ¨</span>
                            <span>ì „ì²´ ë³€í™˜ ì‹œì‘</span>
                        </button>
                        <button class="btn btn-primary" id="nextBtn" disabled>
                            <span>ë‹¤ìŒ ë‹¨ê³„ë¡œ</span>
                            <span>â†’</span>
                        </button>
                    </div>
                </div>
            </main>

            <!-- Workflow Sidebar (Right) -->
            <aside class="workflow-sidebar">
                <div class="workflow-header">
                    <h3>ì§„í–‰ ìƒí™©</h3>
                    <div class="workflow-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 37.5%"></div>
                        </div>
                        <div class="progress-text">4 / 9 ë‹¨ê³„</div>
                    </div>
                </div>

                <div class="workflow-stages">
                    <div class="workflow-stage completed">
                        <div class="stage-icon">ğŸ”</div>
                        <div class="stage-info">
                            <div class="stage-name">Stage 1</div>
                            <div class="stage-label">ë¡œê·¸ì¸</div>
                        </div>
                        <div class="stage-status">âœ“</div>
                    </div>

                    <div class="workflow-stage completed">
                        <div class="stage-icon">ğŸ“‹</div>
                        <div class="stage-info">
                            <div class="stage-name">Stage 2</div>
                            <div class="stage-label">ë³´ê³ ì„œ ìƒíƒœ</div>
                        </div>
                        <div class="stage-status">âœ“</div>
                    </div>

                    <div class="workflow-stage completed">
                        <div class="stage-icon">ğŸ“¤</div>
                        <div class="stage-info">
                            <div class="stage-name">Stage 3</div>
                            <div class="stage-label">íŒŒì¼ ì—…ë¡œë“œ</div>
                        </div>
                        <div class="stage-status">âœ“</div>
                    </div>

                    <div class="workflow-stage current">
                        <div class="stage-icon">ğŸ”„</div>
                        <div class="stage-info">
                            <div class="stage-name">Stage 4</div>
                            <div class="stage-label">MD ë³€í™˜</div>
                        </div>
                        <div class="stage-status">â—‰</div>
                    </div>

                    <div class="workflow-stage pending">
                        <div class="stage-icon">âš™ï¸</div>
                        <div class="stage-info">
                            <div class="stage-name">Stage 5</div>
                            <div class="stage-label">ë°ì´í„° ì¶”ì¶œ</div>
                        </div>
                        <div class="stage-status">â—‹</div>
                    </div>

                    <div class="workflow-stage pending">
                        <div class="stage-icon">ğŸ“„</div>
                        <div class="stage-info">
                            <div class="stage-name">Stage 6</div>
                            <div class="stage-label">í…œí”Œë¦¿ ì‘ì„±</div>
                        </div>
                        <div class="stage-status">â—‹</div>
                    </div>

                    <div class="workflow-stage pending">
                        <div class="stage-icon">âœï¸</div>
                        <div class="stage-info">
                            <div class="stage-name">Stage 7</div>
                            <div class="stage-label">ë¦¬ë·°</div>
                        </div>
                        <div class="stage-status">â—‹</div>
                    </div>

                    <div class="workflow-stage pending">
                        <div class="stage-icon">âœ…</div>
                        <div class="stage-info">
                            <div class="stage-name">Stage 8</div>
                            <div class="stage-label">QC ê²€ì¦</div>
                        </div>
                        <div class="stage-status">â—‹</div>
                    </div>

                    <div class="workflow-stage pending">
                        <div class="stage-icon">ğŸ“¤</div>
                        <div class="stage-info">
                            <div class="stage-name">Stage 9</div>
                            <div class="stage-label">ìµœì¢… ì¶œë ¥</div>
                        </div>
                        <div class="stage-status">â—‹</div>
                    </div>
                </div>

                <div class="workflow-footer">
                    <div class="medical-badge">ì˜ë£Œìš© AI ì†Œí”„íŠ¸ì›¨ì–´</div>
                </div>
            </aside>
        </div>

        <!-- Footer -->
        <footer class="app-footer">
            <div class="footer-content">
                Copyright. Power Solution., Inc. 2026.
            </div>
        </footer>
    </div>

    <!-- JavaScript -->
    <script src="../components/AppLayout.js"></script>
    <script src="../utils/layout-helper.js"></script>
    <script type="module">
        // ES6 Modules
        import { CONFIG, Storage, DateHelper } from '../js/config.js';
        import markdownConverter from '../js/markdown-converter.js';
        import fileHandler from '../js/file-handler.js';
        import authManager from '../js/auth.js';

        // ì—…ë¡œë“œëœ íŒŒì¼ ë°ì´í„° ë¡œë“œ
        const uploadedFilesData = Storage.get('uploadedFiles') || [];
        const files = uploadedFilesData.map((fileData, index) => ({
            id: index + 1,
            name: fileData.fileName,
            rawId: fileData.rawId,
            url: fileData.url,
            path: fileData.path,
            status: 'pending',
            markdown: null,
            convertedAt: null
        }));

        let selectedFile = null;
        let logs = [];

        // Wait for both DOM and globals to load
        function initializePage() {
            // Check if globals are loaded
            if (!window.__GLOBALS_LOADED__) {
                setTimeout(initializePage, 50);
                return;
            }

            const session = loadSessionData();
            if (session) {
                document.querySelector('.user-name').textContent = session.userName;
                document.querySelector('.user-role').textContent = session.userRole;
                document.querySelector('.user-avatar').textContent = session.userName.charAt(0);
            }

            setupUserMenu();
            renderFileList();
            updateStats();

            addLog('ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ. ë³€í™˜ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        }

        // Start initialization when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializePage);
        } else {
            initializePage();
        }

        function renderFileList() {
            const fileList = document.getElementById('fileList');

            // Group by RAW ID prefix
            const groups = {
                'required': files.filter(f => ['RAW1', 'RAW2.1', 'RAW2.2', 'RAW2.3', 'RAW3', 'RAW4'].includes(f.rawId)),
                'lineListing': files.filter(f => ['RAW12', 'RAW14', 'RAW15'].includes(f.rawId))
            };

            fileList.innerHTML = `
                <div class="file-group">
                    <div class="group-header">í•„ìˆ˜ ë¬¸ì„œ</div>
                    ${groups.required.map(file => renderFileItem(file)).join('')}
                </div>
                <div class="file-group">
                    <div class="group-header">Line Listing</div>
                    ${groups.lineListing.map(file => renderFileItem(file)).join('')}
                </div>
            `;
        }

        function renderFileItem(file) {
            const statusIcons = {
                'pending': 'â—‹',
                'converting': 'âŸ³',
                'completed': 'âœ“',
                'error': 'âœ—'
            };

            return `
                <div class="file-item ${file.status} ${selectedFile?.id === file.id ? 'active' : ''}"
                     onclick="selectFile(${file.id})">
                    <div class="file-item-icon">${getFileIcon(file.name)}</div>
                    <div class="file-item-info">
                        <div class="file-item-name">${file.name}</div>
                        <div class="file-item-raw">${file.rawId}</div>
                    </div>
                    <div class="file-status ${file.status}">
                        ${statusIcons[file.status]}
                    </div>
                </div>
            `;
        }

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const icons = {
                'pdf': 'ğŸ“„',
                'xlsx': 'ğŸ“Š',
                'xls': 'ğŸ“Š',
                'docx': 'ğŸ“'
            };
            return icons[ext] || 'ğŸ“„';
        }

        function selectFile(fileId) {
            selectedFile = files.find(f => f.id === fileId);
            renderFileList();

            // Update preview
            if (selectedFile) {
                document.getElementById('preview-original').innerHTML = `
                    <div style="padding: 20px; background: #F9FAFB; border-radius: 8px;">
                        <h3 style="margin-bottom: 16px; color: #374151;">${selectedFile.name}</h3>
                        <p style="color: #6B7280; font-size: 13px;">
                            ì›ë³¸ íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°ëŠ” ì‹¤ì œ êµ¬í˜„ ì‹œ PDF/Excel/Word ë·°ì–´ë¥¼ í†µí•´ í‘œì‹œë©ë‹ˆë‹¤.
                        </p>
                    </div>
                `;

                if (selectedFile.status === 'completed' && selectedFile.markdown) {
                    document.getElementById('preview-markdown').innerHTML = `
                        <div class="markdown-preview">
                            ${selectedFile.markdown}
                        </div>
                    `;
                } else {
                    document.getElementById('preview-markdown').innerHTML = `
                        <div class="preview-empty">
                            <div class="preview-empty-icon">â³</div>
                            <div class="preview-empty-text">ë³€í™˜ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</div>
                        </div>
                    `;
                }
            }
        }

        function switchPreviewTab(tab) {
            document.querySelectorAll('.preview-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.preview-pane').forEach(p => p.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(`preview-${tab}`).classList.add('active');
        }

        function updateStats() {
            document.getElementById('totalFiles').textContent = files.length;
            document.getElementById('completedFiles').textContent = files.filter(f => f.status === 'completed').length;
            document.getElementById('pendingFiles').textContent = files.filter(f => f.status === 'pending').length;

            // ëª¨ë“  íŒŒì¼ì´ ë³€í™˜ ì™„ë£Œë˜ë©´ ë‹¤ìŒ ë²„íŠ¼ í™œì„±í™”
            const allCompleted = files.every(f => f.status === 'completed');
            document.getElementById('nextBtn').disabled = !allCompleted;
        }

        function addLog(message, type = 'info') {
            const now = new Date();
            const time = now.toTimeString().slice(0, 8);

            logs.push({ time, message, type });

            const logList = document.getElementById('logList');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `
                <span class="log-time">[${time}]</span>
                <span class="log-message ${type}">${message}</span>
            `;

            logList.appendChild(entry);
            logList.scrollTop = logList.scrollHeight;
        }

        function clearLog() {
            logs = [];
            document.getElementById('logList').innerHTML = '';
            addLog('ë¡œê·¸ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        // ì „ì²´ ë³€í™˜ ì‹œì‘
        document.getElementById('convertBtn').addEventListener('click', async () => {
            const pendingFiles = files.filter(f => f.status === 'pending');

            if (pendingFiles.length === 0) {
                showToast('ëª¨ë“  íŒŒì¼ì´ ì´ë¯¸ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
                return;
            }

            document.getElementById('convertBtn').disabled = true;
            addLog(`${pendingFiles.length}ê°œ íŒŒì¼ ë³€í™˜ì„ ì‹œì‘í•©ë‹ˆë‹¤.`, 'info');

            showLLMLoading('AIê°€ ë¬¸ì„œë¥¼ ë§ˆí¬ë‹¤ìš´ìœ¼ë¡œ ë³€í™˜í•˜ê³  ìˆìŠµë‹ˆë‹¤...');

            // ìˆœì°¨ì ìœ¼ë¡œ ë³€í™˜
            for (const file of pendingFiles) {
                file.status = 'converting';
                renderFileList();
                updateStats();
                addLog(`${file.name} ë³€í™˜ ì¤‘...`, 'info');

                try {
                    // Supabase Storageì—ì„œ íŒŒì¼ ê°€ì ¸ì˜¤ê¸°
                    const response = await fetch(file.url);
                    if (!response.ok) {
                        throw new Error(`íŒŒì¼ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${response.statusText}`);
                    }

                    const blob = await response.blob();
                    const fileObj = new File([blob], file.name, { type: blob.type });

                    // ë§ˆí¬ë‹¤ìš´ ë³€í™˜
                    const result = await markdownConverter.convertFile(fileObj, file.rawId);

                    if (result.success) {
                        file.markdown = result.markdown;
                        file.convertedAt = result.convertedAt;
                        file.status = 'completed';

                        addLog(`${file.name} ë³€í™˜ ì™„ë£Œ (${result.duration}ms)`, 'success');
                    } else {
                        file.status = 'error';
                        addLog(`${file.name} ë³€í™˜ ì‹¤íŒ¨: ${result.error}`, 'error');
                    }
                } catch (error) {
                    console.error('Conversion error:', error);
                    file.status = 'error';
                    addLog(`${file.name} ë³€í™˜ ì‹¤íŒ¨: ${error.message}`, 'error');
                }

                renderFileList();
                updateStats();

                // ì„ íƒëœ íŒŒì¼ì´ë©´ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
                if (selectedFile?.id === file.id) {
                    selectFile(file.id);
                }
            }

            hideLLMLoading();
            document.getElementById('convertBtn').disabled = false;
            addLog('ëª¨ë“  íŒŒì¼ ë³€í™˜ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            showToast('ë§ˆí¬ë‹¤ìš´ ë³€í™˜ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        });

        // ë‹¤ìŒ ë‹¨ê³„ë¡œ
        document.getElementById('nextBtn').addEventListener('click', () => {
            // ë³€í™˜ ê²°ê³¼ localStorageì— ì €ì¥
            const convertedMarkdowns = files.map(file => ({
                fileName: file.name,
                rawId: file.rawId,
                markdown: file.markdown,
                convertedAt: file.convertedAt,
                status: file.status
            }));

            Storage.set('convertedMarkdowns', convertedMarkdowns);

            // ë³€í™˜ ìš”ì•½ ì €ì¥
            const conversionSummary = markdownConverter.getConversionHistory();
            Storage.set('conversionSummary', conversionSummary);

            const reportId = new URLSearchParams(window.location.search).get('reportId') || Date.now().toString();

            addLog('ë³€í™˜ ê²°ê³¼ë¥¼ ì €ì¥í–ˆìŠµë‹ˆë‹¤. ë°ì´í„° ì¶”ì¶œ ë‹¨ê³„ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
            showToast('ë°ì´í„° ì¶”ì¶œ ë‹¨ê³„ë¡œ ì´ë™í•©ë‹ˆë‹¤.', 'success');

            setTimeout(() => {
                navigateTo(`P16_DataExtraction.html?reportId=${reportId}`);
            }, 1000);
        });
    </script>
    <script type="module" src="../utils/globals.js"></script>
</body>
</html>

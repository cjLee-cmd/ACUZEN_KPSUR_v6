<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P-20 Final Output - KPSUR AGENT</title>
    <link rel="stylesheet" href="../css/styles/globals.css">
    <link rel="stylesheet" href="../css/styles/layout.css">
    <link rel="stylesheet" href="../css/styles/components.css">
    <style>
        /* ë‹¤í¬ëª¨ë“œ ë³€ìˆ˜ */
        :root {
            --page-bg: #F5F7FA;
            --card-bg: white;
            --text-primary: #07161D;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --border-color: #e2e8f0;
            --section-bg: #f8fafc;
            --input-bg: white;
        }

        [data-theme="dark"] {
            --page-bg: #1e293b;
            --card-bg: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: #334155;
            --section-bg: #334155;
            --input-bg: #334155;
        }

        /* ë‹¤í¬ëª¨ë“œ íŒ¨ë„ ìŠ¤íƒ€ì¼ */
        [data-theme="dark"] .preview-panel,
        [data-theme="dark"] .export-panel {
            background: transparent !important;
            border-color: #475569;
        }

        [data-theme="dark"] .preview-header {
            background: #334155;
            border-color: #475569;
        }

        [data-theme="dark"] .preview-title {
            color: var(--text-primary);
        }

        [data-theme="dark"] .preview-info {
            background: rgba(16, 185, 129, 0.15);
            border-left-color: #34d399;
        }

        [data-theme="dark"] .preview-info-text {
            color: #34d399;
        }

        [data-theme="dark"] .preview-content {
            background: #1e293b;
        }

        [data-theme="dark"] .document-preview {
            background: #334155;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        [data-theme="dark"] .document-preview h1 {
            color: var(--text-primary);
            border-color: #475569;
        }

        [data-theme="dark"] .document-preview h2 {
            color: #60a5fa;
        }

        [data-theme="dark"] .document-preview h3 {
            color: #93c5fd;
        }

        [data-theme="dark"] .document-preview p {
            color: var(--text-secondary);
        }

        [data-theme="dark"] .document-preview td {
            border-color: #475569;
        }

        [data-theme="dark"] .zoom-control {
            background: #334155;
            border-color: #475569;
        }

        [data-theme="dark"] .zoom-btn {
            color: #94a3b8;
        }

        [data-theme="dark"] .zoom-btn:hover {
            color: #60a5fa;
        }

        [data-theme="dark"] .zoom-level {
            color: var(--text-primary);
        }

        [data-theme="dark"] .export-section-title {
            color: var(--text-primary);
            border-color: #475569;
        }

        [data-theme="dark"] .export-option {
            background: #334155;
            border-color: #475569;
        }

        [data-theme="dark"] .export-option:hover {
            border-color: #60a5fa;
            background: rgba(59, 130, 246, 0.1);
        }

        [data-theme="dark"] .export-option-label {
            color: var(--text-primary);
        }

        [data-theme="dark"] .format-badge {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }

        [data-theme="dark"] .file-name-input {
            background: #334155;
            border-color: #475569;
            color: var(--text-primary);
        }

        [data-theme="dark"] .file-name-preview {
            background: #334155;
            color: #94a3b8;
        }

        [data-theme="dark"] .version-info {
            background: #334155;
        }

        [data-theme="dark"] .version-info-label {
            color: #94a3b8;
        }

        [data-theme="dark"] .version-info-value {
            color: var(--text-primary);
        }

        [data-theme="dark"] .export-btn.secondary {
            background: #334155;
            border-color: #60a5fa;
            color: #60a5fa;
        }

        [data-theme="dark"] .export-btn.secondary:hover {
            background: rgba(59, 130, 246, 0.1);
        }

        [data-theme="dark"] .submission-panel {
            background: rgba(251, 191, 36, 0.15);
            border-color: #fbbf24;
        }

        [data-theme="dark"] .submission-title,
        [data-theme="dark"] .submission-text {
            color: #fbbf24;
        }

        [data-theme="dark"] .submission-checklist {
            background: #334155;
        }

        [data-theme="dark"] .submission-checklist-item {
            color: var(--text-primary);
        }

        [data-theme="dark"] .export-history-item {
            background: #334155;
        }

        [data-theme="dark"] .export-history-name {
            color: var(--text-primary);
        }

        [data-theme="dark"] .export-history-meta {
            color: #94a3b8;
        }

        [data-theme="dark"] .history-action-btn {
            background: #1e293b;
            border-color: #475569;
            color: #94a3b8;
        }

        [data-theme="dark"] .history-action-btn:hover {
            border-color: #60a5fa;
            color: #60a5fa;
        }

        /* Header styles */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 24px;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .dark-mode-toggle {
            background: var(--section-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .dark-mode-toggle:hover {
            border-color: #25739B;
        }

        [data-theme="dark"] .dark-mode-toggle {
            background: #334155;
            border-color: #475569;
        }

        .icon-sun, .icon-moon {
            font-size: 16px;
        }

        [data-theme="light"] .icon-moon {
            display: none;
        }

        [data-theme="dark"] .icon-sun {
            display: none;
        }

        .output-container {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 16px;
            padding: 16px;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Left Panel - Document Preview */
        .preview-panel {
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .preview-header {
            padding: 16px;
            border-bottom: 1px solid #e2e8f0;
            background: #f8fafc;
        }

        .preview-title {
            font-size: 16px;
            font-weight: 600;
            color: #07161D;
            margin-bottom: 12px;
        }

        .preview-info {
            background: #ECFDF5;
            border-left: 4px solid #10B981;
            padding: 12px;
            border-radius: 4px;
        }

        .preview-info-text {
            font-size: 11px;
            color: #065F46;
            line-height: 1.4;
        }

        .preview-info-text strong {
            font-weight: 600;
        }

        .preview-controls {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .zoom-control {
            display: flex;
            align-items: center;
            gap: 4px;
            background: white;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            padding: 4px;
        }

        .zoom-btn {
            padding: 4px 8px;
            border: none;
            background: transparent;
            cursor: pointer;
            color: #64748b;
            font-size: 14px;
        }

        .zoom-btn:hover {
            color: #25739B;
        }

        .zoom-level {
            padding: 0 8px;
            font-size: 12px;
            color: #07161D;
            min-width: 50px;
            text-align: center;
        }

        .preview-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: #f8fafc;
        }

        .document-preview {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 60px 80px;
            min-height: 1000px;
        }

        .document-preview h1 {
            font-size: 24px;
            font-weight: 600;
            color: #07161D;
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 16px;
            border-bottom: 2px solid #e2e8f0;
        }

        .document-preview h2 {
            font-size: 18px;
            font-weight: 600;
            color: #25739B;
            margin: 24px 0 12px 0;
        }

        .document-preview h3 {
            font-size: 16px;
            font-weight: 600;
            color: #122E4E;
            margin: 20px 0 8px 0;
        }

        .document-preview p {
            font-size: 14px;
            color: #334155;
            line-height: 1.8;
            margin-bottom: 12px;
        }

        .document-preview table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
            font-size: 13px;
        }

        .document-preview th {
            background: #25739B;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 500;
        }

        .document-preview td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
        }

        /* Right Panel - Export Options */
        .export-panel {
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            padding: 16px;
            overflow-y: auto;
        }

        .export-section {
            margin-bottom: 24px;
        }

        .export-section-title {
            font-size: 14px;
            font-weight: 600;
            color: #07161D;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e2e8f0;
        }

        .export-option-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }

        .export-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: #f8fafc;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.2s;
        }

        .export-option:hover {
            border-color: #25739B;
            background: #EBF5FF;
        }

        .export-option input[type="radio"],
        .export-option input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }

        .export-option-label {
            flex: 1;
            font-size: 13px;
            color: #07161D;
        }

        .export-option-icon {
            font-size: 18px;
        }

        .format-badge {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            background: #DBEAFE;
            color: #1E40AF;
        }

        .file-name-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 13px;
            margin-bottom: 8px;
        }

        .file-name-preview {
            font-size: 11px;
            color: #64748b;
            background: #f8fafc;
            padding: 6px 8px;
            border-radius: 4px;
        }

        .version-info {
            background: #f8fafc;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 12px;
        }

        .version-info-row {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin-bottom: 4px;
        }

        .version-info-label {
            color: #64748b;
        }

        .version-info-value {
            color: #07161D;
            font-weight: 500;
        }

        .export-button-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .export-btn {
            width: 100%;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .export-btn.primary {
            background: #25739B;
            color: white;
            border: none;
        }

        .export-btn.primary:hover {
            background: #1E5F7F;
        }

        .export-btn.secondary {
            background: white;
            color: #25739B;
            border: 2px solid #25739B;
        }

        .export-btn.secondary:hover {
            background: #EBF5FF;
        }

        .export-history {
            margin-top: 24px;
        }

        .export-history-item {
            padding: 10px;
            background: #f8fafc;
            border-radius: 6px;
            margin-bottom: 6px;
            font-size: 12px;
        }

        .export-history-name {
            font-weight: 600;
            color: #07161D;
            margin-bottom: 4px;
        }

        .export-history-meta {
            color: #64748b;
            font-size: 11px;
        }

        .export-history-actions {
            display: flex;
            gap: 4px;
            margin-top: 6px;
        }

        .history-action-btn {
            padding: 4px 8px;
            font-size: 11px;
            background: white;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            cursor: pointer;
        }

        .submission-panel {
            background: #FEF3C7;
            border: 2px solid #F59E0B;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }

        .submission-title {
            font-size: 14px;
            font-weight: 600;
            color: #92400E;
            margin-bottom: 8px;
        }

        .submission-text {
            font-size: 12px;
            color: #92400E;
            line-height: 1.4;
            margin-bottom: 12px;
        }

        .submission-checklist {
            background: white;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 12px;
        }

        .submission-checklist-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 0;
            font-size: 12px;
            color: #07161D;
        }

        .submission-checklist-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }
    </style>
</head>
<body>
    <div class="app-layout" id="app">
        <!-- Header -->
        <header class="app-header">
            <div class="header-left">
                <div class="logo">
                    <span class="logo-text">KPSUR AGENT</span>
                    <span class="logo-subtitle">ACUZEN AI</span>
                </div>
                <span class="deployment-badge test">í…ŒìŠ¤íŠ¸</span>
            </div>

            <div class="header-center">
                <div class="breadcrumb">
                    <span class="breadcrumb-item">ë³´ê³ ì„œ</span>
                    <span class="breadcrumb-separator">/</span>
                    <span class="breadcrumb-item active">ìµœì¢… ì¶œë ¥</span>
                </div>
            </div>

            <div class="header-right">
                <button class="dark-mode-toggle" onclick="toggleDarkMode()" title="ë‹¤í¬ëª¨ë“œ ì „í™˜">
                    <span class="icon-sun">â˜€ï¸</span>
                    <span class="icon-moon">ğŸŒ™</span>
                </button>
                <div class="user-menu">
                    <div class="user-avatar">ì‚¬</div>
                    <div class="user-info">
                        <div class="user-name">ì‚¬ìš©ì</div>
                        <div class="user-role">Author</div>
                    </div>
                    <button class="user-menu-toggle">â–¼</button>
                </div>
            </div>
        </header>
    </div>

    <!-- Supabase SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <!-- ê³µí†µ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ -->
    <script src="../js/config.js"></script>
    <script src="../utils/ui-helpers.js"></script>
    <script src="../utils/session.js"></script>
    <script src="../utils/navigation.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/workflow-manager.js"></script>
    <script src="../js/output-generator.js"></script>
    <script src="../js/hybrid-generator.js"></script>
    <script src="../js/supabase-client.js" type="module"></script>

    <!-- Dark Mode Script -->
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();

        function toggleDarkMode() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }
    </script>

    <!-- Main Script -->
    <script>
        // ì „ì—­ ì˜ì¡´ì„± fallback (config.jsì—ì„œ ì´ë¯¸ ì„ ì–¸ëœ ê²½ìš° ì¬ì„ ì–¸í•˜ì§€ ì•ŠìŒ)
        if (!window.CONFIG) {
            window.CONFIG = {
                SUPABASE_URL: 'https://toelnxgizxwbdikskmxa.supabase.co',
                SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvZWxueGdpenh3YmRpa3NrbXhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkwMDE0MDIsImV4cCI6MjA2NDU3NzQwMn0.LQNQJP93IjNA0PIoYj5UEfcBLgFckAbz_qJHpjlWpL0',
                APP_NAME: 'KPSUR AGENT',
                VERSION: '1.0.0'
            };
        }

        if (!window.Storage) {
            window.Storage = {
                get: (key) => { try { return JSON.parse(localStorage.getItem(key)); } catch { return null; } },
                set: (key, value) => { try { localStorage.setItem(key, JSON.stringify(value)); return true; } catch { return false; } },
                remove: (key) => { try { localStorage.removeItem(key); return true; } catch { return false; } }
            };
        }

        if (!window.DateHelper) {
            window.DateHelper = {
                format: (date, format = 'YYYY-MM-DD') => {
                    const d = new Date(date);
                    const year = d.getFullYear();
                    const month = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    const hours = String(d.getHours()).padStart(2, '0');
                    const minutes = String(d.getMinutes()).padStart(2, '0');
                    return format.replace('YYYY', year).replace('MM', month).replace('DD', day).replace('HH', hours).replace('mm', minutes);
                },
                formatISO: (date = new Date()) => date.toISOString(),
                now: () => new Date().toISOString()
            };
        }

        // outputGenerator fallback (hybrid-generator.jsì—ì„œ ë¡œë“œ)
        if (!window.outputGenerator && !window.hybridGenerator) {
            window.outputGenerator = {
                validateReportFormat: (content) => ({ valid: true, issues: [] }),
                addMetadata: (content, metadata) => content,
                generateWordDocument: async (name, content, isDraft) => ({ filename: name + '.docx' }),
                downloadHTML: (name, content, isDraft) => ({ filename: name + '.html' }),
                printToPDF: (name, content, isDraft) => ({ filename: name + '.pdf' }),
                getOutputHistory: () => []
            };
        }

        // ë¡œì»¬ ì°¸ì¡° ì—†ì´ window.* ì§ì ‘ ì‚¬ìš©
        // Storage, DateHelperëŠ” window.Storage, window.DateHelperë¡œ ì ‘ê·¼
        var outputGenerator = window.hybridGenerator || window.outputGenerator;

        // AppLayout stub class
        class AppLayout {
            constructor(options = {}) {
                this.currentStage = options.currentStage || 0;
                this.reportName = options.reportName || '';
            }

            render(content) {
                return content;
            }
        }

        // authManager fallback (auth.jsì—ì„œ ì´ë¯¸ ì„ ì–¸ëœ ê²½ìš° ì¬ì„ ì–¸í•˜ì§€ ì•ŠìŒ)
        if (!window.authManager) {
            window.authManager = {
                isAuthenticated: () => true,
                getUser: () => ({ name: 'ê´€ë¦¬ì', role: 'Admin' }),
                getCurrentUser: () => ({ name: 'ê´€ë¦¬ì', role: 'Admin' })
            };
        }
        // window.authManager ì§ì ‘ ì‚¬ìš©

        // URLì—ì„œ reportId ê°€ì ¸ì˜¤ê¸°
        const urlParams = new URLSearchParams(window.location.search);
        const reportId = urlParams.get('reportId');
        console.log('[P20] Report ID from URL:', reportId);

        // Load draft report and QC results
        const draftReport = window.Storage.get('draftReport') || {};
        const qcResults = window.Storage.get('qcResults') || {};
        let generatedSections = window.Storage.get('generatedSections') || [];
        const reportContent = draftReport.content || '';

        // DBì—ì„œ ì„¹ì…˜ ë¡œë“œ í•¨ìˆ˜
        async function loadSectionsFromDB() {
            if (!reportId) {
                console.log('[P20] No reportId, using localStorage');
                return;
            }

            try {
                // supabaseClient ëŒ€ê¸°
                if (typeof window.supabaseClient === 'undefined') {
                    const module = await import('../js/supabase-client.js');
                    window.supabaseClient = module.default;
                }

                if (!window.supabaseClient) {
                    console.warn('[P20] supabaseClient not available');
                    return;
                }

                const result = await window.supabaseClient.getSections(reportId);

                if (result.success && result.sections && result.sections.length > 0) {
                    console.log(`[P20] âœ… Loaded ${result.sections.length} sections from DB`);

                    // DB ë°ì´í„°ë¥¼ generatedSections í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                    generatedSections = {};
                    result.sections.forEach(dbSection => {
                        generatedSections[dbSection.section_number] = {
                            id: dbSection.section_number,
                            name: dbSection.section_name,
                            content: dbSection.content_markdown,
                            dbId: dbSection.id,
                            version: dbSection.version
                        };
                    });

                    // ë¯¸ë¦¬ë³´ê¸° ê°±ì‹ 
                    const preview = document.getElementById('documentPreview');
                    if (preview) {
                        preview.innerHTML = generatePreviewHTML();
                    }
                }
            } catch (error) {
                console.error('[P20] DB load error:', error);
            }
        }

        let zoomLevel = 100;

        // ë§ˆí¬ë‹¤ìš´ì„ HTMLë¡œ ë³€í™˜í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
        function convertMarkdownToHTML(content) {
            // í‘œ ë³€í™˜ (ì¤„ë°”ê¿ˆ ë³€í™˜ ì „ì— ë¨¼ì € ì²˜ë¦¬)
            content = content.replace(/(\|[^\n]+\|\n)+/g, (tableMatch) => {
                const rows = tableMatch.trim().split('\n');
                let tableHtml = '<table>';
                rows.forEach((row, idx) => {
                    const cells = row.split('|').filter(c => c.trim() !== '');
                    // êµ¬ë¶„ì„  (|---|---|) ê±´ë„ˆë›°ê¸°
                    if (cells.every(c => /^[\s:-]+$/.test(c))) {
                        return;
                    }
                    const isHeader = idx === 0;
                    const tag = isHeader ? 'th' : 'td';
                    const cellsHtml = cells.map(c => '<' + tag + '>' + c.trim() + '</' + tag + '>').join('');
                    tableHtml += '<tr>' + cellsHtml + '</tr>';
                });
                tableHtml += '</table>';
                return tableHtml;
            });

            // ê¸°ë³¸ ë§ˆí¬ë‹¤ìš´ ë³€í™˜ - í—¤ë” ë ˆë²¨ ìˆœì„œëŒ€ë¡œ ì²˜ë¦¬ (ë†’ì€ ë ˆë²¨ë¶€í„°)
            content = content
                .replace(/^###### (.*$)/gim, '<h6>$1</h6>')
                .replace(/^##### (.*$)/gim, '<h5>$1</h5>')
                .replace(/^#### (.*$)/gim, '<h4>$1</h4>')
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');

            return content;
        }

        // Generate preview HTML from sections
        function generatePreviewHTML() {
            // 1. generatedSectionsì—ì„œ ìƒì„± (ìš°ì„ ìˆœìœ„ ìµœìƒìœ„)
            let sectionsArray = [];

            if (generatedSections) {
                if (Array.isArray(generatedSections)) {
                    sectionsArray = generatedSections;
                } else if (typeof generatedSections === 'object') {
                    // ê°ì²´ì¸ ê²½ìš° ê°’ë“¤ì„ ë°°ì—´ë¡œ ë³€í™˜í•˜ê³  ID ê¸°ì¤€ ì •ë ¬
                    sectionsArray = Object.values(generatedSections).sort((a, b) => {
                        const idA = parseInt(a.id) || 0;
                        const idB = parseInt(b.id) || 0;
                        return idA - idB;
                    });
                }
            }

            if (sectionsArray.length > 0) {
                let html = '<h1>ì˜ì•½í’ˆ ì¬ì‹¬ì‚¬ ì•ˆì „ì„± ì •ê¸°ë³´ê³ ì„œ</h1>\n';

                sectionsArray.forEach((section) => {
                    if (section && section.content) {
                        // í—¬í¼ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ë§ˆí¬ë‹¤ìš´ ë³€í™˜
                        const content = convertMarkdownToHTML(section.content);
                        html += `<div class="section-content"><p>${content}</p></div>\n`;
                    }
                });

                return html;
            }

            // 2. draftReport.contentê°€ ìˆìœ¼ë©´ ì‚¬ìš© (Fallback)
            if (reportContent && reportContent.trim().length > 0) {
                return '<div class="section-content"><p>' + convertMarkdownToHTML(reportContent) + '</p></div>';
            }

            // 3. Fallback - ê¸°ë³¸ ë©”ì‹œì§€
            return `
                <h1>ì˜ì•½í’ˆ ì¬ì‹¬ì‚¬ ì•ˆì „ì„± ì •ê¸°ë³´ê³ ì„œ</h1>
                <div style="text-align: center; padding: 40px; color: #64748b;">
                    <p style="font-size: 16px;">ğŸ“ ìƒì„±ëœ ë³´ê³ ì„œ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    <p style="font-size: 14px;">í…œí”Œë¦¿ ì‘ì„± ë‹¨ê³„ì—ì„œ ë³´ê³ ì„œë¥¼ ìƒì„±í•´ ì£¼ì„¸ìš”.</p>
                </div>
            `;
        }
        // outputGeneratorëŠ” output-generator.jsì—ì„œ ë¡œë“œë¨
        let exportHistory = [];
        try {
            if (outputGenerator && typeof outputGenerator.getOutputHistory === 'function') {
                exportHistory = outputGenerator.getOutputHistory() || [];
            }
        } catch (e) {
            console.warn('Export history not available:', e.message);
        }

        // Initialize the page
        function init() {
            const layout = new AppLayout({
                currentStage: 9,
                reportName: 'testPill_1'
            });

            const content = `
                <div class="app-content">
                <main class="main-content">
                <div class="output-container">
                    <!-- Left Panel - Document Preview -->
                    <div class="preview-panel">
                        <div class="preview-header">
                            <h2 class="preview-title">ğŸ“„ ìµœì¢… ë¬¸ì„œ ë¯¸ë¦¬ë³´ê¸°</h2>

                            <div class="preview-info">
                                <div class="preview-info-text">
                                    <strong>âœ… QC ê²€ì¦ ì™„ë£Œ!</strong> ìµœì¢… ë³´ê³ ì„œë¥¼ ë¯¸ë¦¬ í™•ì¸í•˜ê³  ì›í•˜ëŠ” í˜•ì‹ìœ¼ë¡œ ë‚´ë³´ë‚´ì„¸ìš”.
                                </div>
                            </div>

                            <div class="preview-controls">
                                <div class="zoom-control">
                                    <button class="zoom-btn" onclick="zoomOut()">-</button>
                                    <span class="zoom-level" id="zoomLevel">${zoomLevel}%</span>
                                    <button class="zoom-btn" onclick="zoomIn()">+</button>
                                </div>
                                <button class="btn btn-secondary" onclick="printPreview()">
                                    ğŸ–¨ï¸ ì¸ì‡„ ë¯¸ë¦¬ë³´ê¸°
                                </button>
                                <button class="btn btn-secondary" onclick="fullscreen()">
                                    ğŸ–¥ï¸ ì „ì²´í™”ë©´
                                </button>
                            </div>
                        </div>

                        <div class="preview-content" id="previewContent">
                            <div class="document-preview" id="documentPreview">
                                ${generatePreviewHTML()}
                            </div>
                        </div>
                    </div>

                    <!-- Right Panel - Export Options -->
                    <div class="export-panel">
                        <div class="export-section">
                            <h3 class="export-section-title">ğŸ“¤ ë‚´ë³´ë‚´ê¸° í˜•ì‹</h3>

                            <div class="export-option-group">
                                <label class="export-option">
                                    <input type="radio" name="exportFormat" value="docx" checked>
                                    <span class="export-option-label">
                                        Word ë¬¸ì„œ
                                        <span class="format-badge">.docx</span>
                                    </span>
                                    <span class="export-option-icon">ğŸ“</span>
                                </label>

                                <label class="export-option">
                                    <input type="radio" name="exportFormat" value="pdf">
                                    <span class="export-option-label">
                                        PDF ë¬¸ì„œ
                                        <span class="format-badge">.pdf</span>
                                    </span>
                                    <span class="export-option-icon">ğŸ“„</span>
                                </label>

                                <label class="export-option">
                                    <input type="radio" name="exportFormat" value="both">
                                    <span class="export-option-label">
                                        Word + PDF
                                        <span class="format-badge">ë‘˜ ë‹¤</span>
                                    </span>
                                    <span class="export-option-icon">ğŸ“¦</span>
                                </label>
                            </div>
                        </div>

                        <div class="export-section">
                            <h3 class="export-section-title">ğŸ“‹ ì¶”ê°€ ì˜µì…˜</h3>

                            <div class="export-option-group">
                                <label class="export-option">
                                    <input type="checkbox" id="includeTableData" checked>
                                    <span class="export-option-label">í‘œ ë°ì´í„° Excel íŒŒì¼ í¬í•¨</span>
                                    <span class="export-option-icon">ğŸ“Š</span>
                                </label>

                                <label class="export-option">
                                    <input type="checkbox" id="includeSourceDocs">
                                    <span class="export-option-label">ì†ŒìŠ¤ ë¬¸ì„œ í¬í•¨</span>
                                    <span class="export-option-icon">ğŸ“</span>
                                </label>

                                <label class="export-option">
                                    <input type="checkbox" id="includeChangeLogs">
                                    <span class="export-option-label">ë³€ê²½ ì´ë ¥ í¬í•¨</span>
                                    <span class="export-option-icon">ğŸ“</span>
                                </label>
                            </div>
                        </div>

                        <div class="export-section">
                            <h3 class="export-section-title">ğŸ“ íŒŒì¼ëª…</h3>

                            <input type="text" class="file-name-input" id="fileName" value="testPill_1_v1.1" placeholder="íŒŒì¼ëª… ì…ë ¥">
                            <div class="file-name-preview">
                                ë¯¸ë¦¬ë³´ê¸°: <strong id="fileNamePreview">testPill_1_v1.1.docx</strong>
                            </div>
                        </div>

                        <div class="export-section">
                            <h3 class="export-section-title">ğŸ“Š ë²„ì „ ì •ë³´</h3>

                            <div class="version-info">
                                <div class="version-info-row">
                                    <span class="version-info-label">í˜„ì¬ ë²„ì „:</span>
                                    <span class="version-info-value">v1.1</span>
                                </div>
                                <div class="version-info-row">
                                    <span class="version-info-label">ìƒì„±ì¼:</span>
                                    <span class="version-info-value">2025-01-15 14:23</span>
                                </div>
                                <div class="version-info-row">
                                    <span class="version-info-label">ì‘ì„±ì:</span>
                                    <span class="version-info-value">í™ê¸¸ë™</span>
                                </div>
                                <div class="version-info-row">
                                    <span class="version-info-label">ìƒíƒœ:</span>
                                    <span class="version-info-value">âœ… QC ìŠ¹ì¸ë¨</span>
                                </div>
                            </div>
                        </div>

                        <div class="export-section">
                            <div class="export-button-group">
                                <button class="export-btn primary magic-effect" onclick="exportDocument()">
                                    ğŸ“¤ ìµœì¢… ë¬¸ì„œ ë‚´ë³´ë‚´ê¸°
                                </button>
                                <button class="export-btn secondary" onclick="saveAsDraft()">
                                    ğŸ’¾ ì„ì‹œ ì €ì¥
                                </button>
                            </div>
                        </div>

                        <div class="submission-panel">
                            <div class="submission-title">ğŸ“® MFDS ì œì¶œ ì¤€ë¹„</div>
                            <div class="submission-text">
                                ì‹í’ˆì˜ì•½í’ˆì•ˆì „ì²˜(MFDS) ì œì¶œì„ ìœ„í•œ ìµœì¢… ì²´í¬ë¦¬ìŠ¤íŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.
                            </div>

                            <div class="submission-checklist">
                                <div class="submission-checklist-item">
                                    <input type="checkbox" id="checkComplete" checked disabled>
                                    <label for="checkComplete">ëª¨ë“  ì„¹ì…˜ ì‘ì„± ì™„ë£Œ</label>
                                </div>
                                <div class="submission-checklist-item">
                                    <input type="checkbox" id="checkQC" checked disabled>
                                    <label for="checkQC">QC ê²€ì¦ í†µê³¼</label>
                                </div>
                                <div class="submission-checklist-item">
                                    <input type="checkbox" id="checkReview">
                                    <label for="checkReview">ì±…ì„ì ê²€í†  ì™„ë£Œ</label>
                                </div>
                                <div class="submission-checklist-item">
                                    <input type="checkbox" id="checkApproval">
                                    <label for="checkApproval">ìµœì¢… ìŠ¹ì¸ì ì„œëª…</label>
                                </div>
                            </div>

                            <button class="export-btn primary" onclick="prepareSubmission()" style="width: 100%;">
                                ğŸ“® ì œì¶œ íŒ¨í‚¤ì§€ ìƒì„±
                            </button>
                        </div>

                        <div class="export-section export-history">
                            <h3 class="export-section-title">ğŸ“š ë‚´ë³´ë‚´ê¸° ê¸°ë¡</h3>
                            <div id="exportHistoryList"></div>
                        </div>
                    </div>
                </div>
                </main>
                </div>

                <!-- Footer -->
                <footer class="app-footer">
                    <div class="footer-content">
                        Copyright. Power Solution., Inc. 2026.
                    </div>
                </footer>
            `;

            const appElement = document.getElementById('app');
            const header = appElement.querySelector('.app-header');
            if (header) {
                header.insertAdjacentHTML('afterend', layout.render(content));
            } else {
                appElement.innerHTML = layout.render(content);
            }

            setupEventListeners();
            renderExportHistory();

            // DBì—ì„œ ì„¹ì…˜ ë¡œë“œ (ë¹„ë™ê¸°)
            if (reportId) {
                loadSectionsFromDB();
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // File name input change
            document.getElementById('fileName').addEventListener('input', (e) => {
                updateFileNamePreview();
            });

            // Export format change
            document.querySelectorAll('input[name="exportFormat"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    updateFileNamePreview();
                });
            });
        }

        // Update file name preview
        function updateFileNamePreview() {
            const fileName = document.getElementById('fileName').value;
            const format = document.querySelector('input[name="exportFormat"]:checked').value;

            let preview = fileName;
            if (format === 'docx') {
                preview += '.docx';
            } else if (format === 'pdf') {
                preview += '.pdf';
            } else if (format === 'both') {
                preview += '.docx / .pdf';
            }

            document.getElementById('fileNamePreview').textContent = preview;
        }

        // Zoom functions
        function zoomIn() {
            if (zoomLevel < 150) {
                zoomLevel += 10;
                applyZoom();
            }
        }

        function zoomOut() {
            if (zoomLevel > 50) {
                zoomLevel -= 10;
                applyZoom();
            }
        }

        function applyZoom() {
            const preview = document.getElementById('documentPreview');
            preview.style.transform = `scale(${zoomLevel / 100})`;
            preview.style.transformOrigin = 'top center';
            document.getElementById('zoomLevel').textContent = zoomLevel + '%';
        }

        // Print preview
        function printPreview() {
            window.print();
        }

        // Fullscreen
        function fullscreen() {
            const element = document.getElementById('previewContent');
            if (element.requestFullscreen) {
                element.requestFullscreen();
            }
        }

        // Export document
        async function exportDocument() {
            const format = document.querySelector('input[name="exportFormat"]:checked').value;
            const fileName = document.getElementById('fileName').value;
            const isDraft = document.getElementById('saveAsDraft')?.checked || false;

            // outputGenerator í™•ì¸ - OutputGenerator ì¸ìŠ¤í„´ìŠ¤ ìš°ì„  ì‚¬ìš©
            let generator = window.outputGenerator;
            // validateReportFormatì´ ì—†ìœ¼ë©´ OutputGenerator í´ë˜ìŠ¤ì—ì„œ ìƒˆ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
            if (!generator || typeof generator.validateReportFormat !== 'function') {
                if (window.OutputGenerator) {
                    generator = new window.OutputGenerator();
                    console.log('Created new OutputGenerator instance for export');
                } else {
                    showToast('ì¶œë ¥ ëª¨ë“ˆì„ ë¡œë“œí•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', 'error');
                    return;
                }
            }

            showLLMLoading('ìµœì¢… ë¬¸ì„œë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...');

            try {
                // ì €ì¥ëœ ë³´ê³ ì„œ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
                let content = reportContent;

                // ë‚´ìš©ì´ ì—†ìœ¼ë©´ í˜„ì¬ ë¯¸ë¦¬ë³´ê¸°ì—ì„œ ê°€ì ¸ì˜¤ê¸°
                if (!content || content.trim().length === 0) {
                    const preview = document.getElementById('documentPreview');
                    if (preview) {
                        content = preview.innerHTML;
                    }
                }

                // ë³´ê³ ì„œ ê²€ì¦ (ë‚´ìš©ì´ ìˆì„ ë•Œë§Œ)
                if (content && content.length > 100) {
                    const validation = generator.validateReportFormat(content);
                    if (!validation.valid) {
                        // ê²½ê³ ë§Œ í‘œì‹œí•˜ê³  ê³„ì† ì§„í–‰
                        console.warn('Report validation warnings:', validation.issues);
                    }
                }

                // Add metadata
                const metadata = {
                    reportName: fileName,
                    version: '1.0',
                    date: window.DateHelper.formatISO ? window.DateHelper.formatISO() : new Date().toISOString(),
                    author: window.authManager.getCurrentUser()?.name || 'Unknown',
                    isDraft: isDraft
                };

                const contentWithMetadata = generator.addMetadata(content, metadata);

                // Export based on format
                let result;
                if (format === 'docx') {
                    result = await generator.generateWordDocument(fileName, contentWithMetadata, isDraft);
                } else if (format === 'html') {
                    result = generator.downloadHTML(fileName, contentWithMetadata, isDraft);
                } else if (format === 'pdf') {
                    result = generator.printToPDF(fileName, contentWithMetadata, isDraft);
                } else if (format === 'both') {
                    result = await generator.generateWordDocument(fileName, contentWithMetadata, isDraft);
                    generator.printToPDF(fileName, contentWithMetadata, isDraft);
                }

                // Update export history
                exportHistory = generator.getOutputHistory();
                renderExportHistory();

                hideLLMLoading();
                showToast(`${result.filename || fileName} íŒŒì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');
            } catch (error) {
                console.error('Export error:', error);
                hideLLMLoading();
                showToast('ë¬¸ì„œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            }
        }

        // Save as draft
        function saveAsDraft() {
            showLLMLoading('ì„ì‹œ ì €ì¥ ì¤‘...');

            setTimeout(() => {
                hideLLMLoading();
                showToast('ì„ì‹œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            }, 1000);
        }

        // Prepare submission
        async function prepareSubmission() {
            const checkReview = document.getElementById('checkReview').checked;
            const checkApproval = document.getElementById('checkApproval').checked;

            if (!checkReview || !checkApproval) {
                showToast('ì±…ì„ì ê²€í† ì™€ ìµœì¢… ìŠ¹ì¸ì ì„œëª…ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”', 'error');
                return;
            }

            showLLMLoading('MFDS ì œì¶œ íŒ¨í‚¤ì§€ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...');

            await new Promise(resolve => setTimeout(resolve, 3000));

            hideLLMLoading();
            showToast('ì œì¶œ íŒ¨í‚¤ì§€ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');

            // Show completion message
            setTimeout(() => {
                if (confirm('ëª¨ë“  ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ëŒ€ì‹œë³´ë“œë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    navigateTo('P10_Dashboard.html');
                }
            }, 500);
        }

        // Render export history
        function renderExportHistory() {
            const historyHtml = exportHistory.map(item => `
                <div class="export-history-item">
                    <div class="export-history-name">${item.name}</div>
                    <div class="export-history-meta">
                        ${item.format} Â· ${item.timestamp} Â· ${item.size}
                    </div>
                    <div class="export-history-actions">
                        <button class="history-action-btn" onclick="downloadExport(${item.id})">
                            ğŸ“¥ ë‹¤ìš´ë¡œë“œ
                        </button>
                        <button class="history-action-btn" onclick="deleteExport(${item.id})">
                            ğŸ—‘ï¸ ì‚­ì œ
                        </button>
                    </div>
                </div>
            `).join('');

            document.getElementById('exportHistoryList').innerHTML = historyHtml || `
                <p style="color: #94a3b8; font-size: 12px; text-align: center; padding: 20px 0;">
                    ë‚´ë³´ë‚´ê¸° ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤
                </p>
            `;
        }

        // Download export
        function downloadExport(id) {
            const item = exportHistory.find(e => e.id === id);
            showToast(`${item.name} ë‹¤ìš´ë¡œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤`, 'info');
        }

        // Delete export
        function deleteExport(id) {
            if (!confirm('ì´ ë‚´ë³´ë‚´ê¸°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            const index = exportHistory.findIndex(e => e.id === id);
            if (index !== -1) {
                exportHistory.splice(index, 1);
                renderExportHistory();
                showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            }
        }

        // Initialize on load
        init();
    </script>
</body>
</html>

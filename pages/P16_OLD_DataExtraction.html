<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P-16 Data Extraction - KPSUR AGENT</title>
    <link rel="stylesheet" href="../css/styles/globals.css">
    <link rel="stylesheet" href="../css/styles/layout.css">
    <link rel="stylesheet" href="../css/styles/components.css">
    <style>
        /* Override parent container constraints for full-width layout */
        .app-content {
            max-width: 100% !important;
            width: 100% !important;
        }

        .main-content {
            max-width: 100% !important;
            width: 100% !important;
            padding: 0 !important;
        }

        .extraction-container {
            display: grid;
            grid-template-columns: minmax(250px, 300px) 1fr;
            gap: 16px;
            padding: 16px;
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
            box-sizing: border-box;
        }

        /* Left Panel - File List */
        .file-list-panel {
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            padding: 16px;
            overflow-y: auto;
        }

        .file-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .file-list-header h3 {
            font-size: 14px;
            font-weight: 600;
            color: #07161D;
            margin: 0;
        }

        .file-stats {
            font-size: 11px;
            color: #64748b;
        }

        .file-category {
            margin-bottom: 16px;
        }

        .file-category-title {
            font-size: 12px;
            font-weight: 600;
            color: #25739B;
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 1px solid #e2e8f0;
        }

        .file-item {
            padding: 8px;
            margin-bottom: 4px;
            background: #f8fafc;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 12px;
        }

        .file-item:hover {
            background: #f1f5f9;
        }

        .file-item.active {
            background: #EBF5FF;
            border-left: 3px solid #25739B;
        }

        .file-item.selected {
            background: #EBF5FF;
        }

        .file-name {
            font-weight: 500;
            color: #07161D;
            margin-bottom: 4px;
        }

        .file-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 10px;
            color: #64748b;
        }

        .file-status {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 500;
        }

        .file-status.pending { background: #FEF3C7; color: #92400E; }
        .file-status.extracting { background: #DBEAFE; color: #1E40AF; }
        .file-status.completed { background: #D1FAE5; color: #065F46; }
        .file-status.conflict { background: #FEE2E2; color: #991B1B; }
        .file-status.error { background: #FEE2E2; color: #991B1B; }

        /* Main Panel - Data Extraction */
        .data-panel {
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .data-panel-header {
            padding: 16px;
            border-bottom: 1px solid #e2e8f0;
            background: #f8fafc;
        }

        .data-panel-title {
            font-size: 16px;
            font-weight: 600;
            color: #07161D;
            margin: 0 0 8px 0;
        }

        .extraction-warning {
            background: #FEF3C7;
            border-left: 4px solid #F59E0B;
            padding: 12px;
            margin-bottom: 12px;
            border-radius: 4px;
        }

        .extraction-warning-title {
            font-weight: 600;
            color: #92400E;
            font-size: 13px;
            margin-bottom: 4px;
        }

        .extraction-warning-text {
            font-size: 11px;
            color: #92400E;
            line-height: 1.4;
        }

        .extraction-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        .llm-model-select {
            padding: 6px 10px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 12px;
            color: #07161D;
            background: white;
        }

        .data-tabs {
            display: flex;
            gap: 4px;
            padding: 0 16px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .data-tab {
            padding: 10px 16px;
            font-size: 13px;
            font-weight: 500;
            color: #64748b;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }

        .data-tab:hover {
            color: #25739B;
        }

        .data-tab.active {
            color: #25739B;
            border-bottom-color: #25739B;
        }

        .data-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .data-section {
            display: none;
        }

        .data-section.active {
            display: block;
        }

        /* CS Data Grid */
        .cs-data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 12px;
        }

        .cs-data-item {
            background: #f8fafc;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        .cs-data-item.has-conflict {
            border-color: #F59E0B;
            background: #FFFBEB;
        }

        .cs-data-item.has-value {
            border-color: #10B981;
        }

        .cs-data-label {
            font-size: 11px;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cs-data-value {
            font-size: 13px;
            color: #07161D;
            min-height: 20px;
            padding: 6px;
            background: white;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
        }

        .cs-data-value.empty {
            color: #94a3b8;
            font-style: italic;
        }

        .cs-data-value.editable {
            cursor: pointer;
        }

        .cs-data-value.editable:hover {
            border-color: #25739B;
        }

        /* CS17 í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .cs-data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
            margin-top: 4px;
        }

        .cs-data-table th,
        .cs-data-table td {
            border: 1px solid #e2e8f0;
            padding: 4px 6px;
            text-align: left;
        }

        .cs-data-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #475569;
        }

        .cs-data-table td {
            background: white;
        }

        .cs-data-table tr:hover td {
            background: #f1f5f9;
        }

        .conflict-indicator {
            background: #F59E0B;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            cursor: pointer;
        }

        .missing-indicator {
            background: #EF4444;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
        }

        /* PH Data */
        .ph-data-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .ph-data-item {
            background: #f8fafc;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        .ph-data-item.has-value {
            border-color: #10B981;
        }

        .ph-data-label {
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 8px;
        }

        .ph-data-value {
            font-size: 13px;
            color: #07161D;
            line-height: 1.6;
            min-height: 60px;
            padding: 8px;
            background: white;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
            white-space: pre-wrap;
        }

        /* Table Data */
        .table-data-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .table-data-item {
            background: #f8fafc;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        .table-data-item.has-value {
            border-color: #10B981;
        }

        .table-data-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .table-data-label {
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
        }

        .table-preview {
            overflow-x: auto;
        }

        .table-preview table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }

        .table-preview th {
            background: #25739B;
            color: white;
            padding: 6px 8px;
            text-align: left;
            font-weight: 500;
        }

        .table-preview td {
            padding: 6px 8px;
            border-bottom: 1px solid #e2e8f0;
        }

        .table-preview tr:hover {
            background: #f1f5f9;
        }

        /* Extraction Progress */
        .extraction-progress {
            background: #f8fafc;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
        }

        .progress-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 8px;
        }

        .progress-stat {
            font-size: 12px;
        }

        .progress-stat-label {
            color: #64748b;
            font-size: 11px;
        }

        .progress-stat-value {
            font-weight: 600;
            color: #07161D;
            font-size: 14px;
        }

        .progress-bar-container {
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #25739B, #369EE1);
            transition: width 0.3s ease;
        }

        /* Conflict Resolution Modal */
        .conflict-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .conflict-modal.show {
            display: flex;
        }

        .conflict-modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .conflict-modal-header {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            background: #FEF3C7;
        }

        .conflict-modal-title {
            font-size: 16px;
            font-weight: 600;
            color: #92400E;
            margin: 0;
        }

        .conflict-modal-body {
            padding: 20px;
        }

        .conflict-description {
            font-size: 13px;
            color: #64748b;
            margin-bottom: 16px;
        }

        .conflict-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .conflict-option {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .conflict-option:hover {
            border-color: #25739B;
            background: #EBF5FF;
        }

        .conflict-option.selected {
            border-color: #25739B;
            background: #EBF5FF;
        }

        .conflict-option-source {
            font-size: 11px;
            color: #64748b;
            margin-bottom: 4px;
        }

        .conflict-option-value {
            font-size: 13px;
            color: #07161D;
            font-weight: 500;
        }

        .conflict-modal-footer {
            padding: 16px 20px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 16px;
            border-top: 1px solid #e2e8f0;
            background: #f8fafc;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .extraction-container {
                grid-template-columns: minmax(220px, 280px) 1fr;
            }
        }

        @media (max-width: 900px) {
            .extraction-container {
                grid-template-columns: 1fr;
            }

            .file-list-panel {
                max-height: 300px;
            }

            .cs-data-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 600px) {
            .extraction-container {
                padding: 8px;
                gap: 8px;
            }

            .data-panel-header {
                padding: 12px;
            }

            .data-content {
                padding: 12px;
            }

            .progress-stats {
                flex-wrap: wrap;
            }

            .data-tabs {
                padding: 0 8px;
                overflow-x: auto;
            }

            .data-tab {
                padding: 8px 12px;
                font-size: 12px;
                white-space: nowrap;
            }
        }

        /* Markdown Preview Popup */
        .markdown-popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .markdown-popup-overlay.active {
            display: flex;
        }

        .markdown-popup-content {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .markdown-popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid #e2e8f0;
            background: #f8fafc;
            border-radius: 12px 12px 0 0;
        }

        .markdown-popup-title {
            font-size: 14px;
            font-weight: 600;
            color: #07161D;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .markdown-popup-title .raw-id-badge {
            background: #25739B;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
        }

        .markdown-popup-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #64748b;
            padding: 4px 8px;
            line-height: 1;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .markdown-popup-close:hover {
            background: #e2e8f0;
            color: #07161D;
        }

        .markdown-popup-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 13px;
            line-height: 1.6;
            color: #1e293b;
            white-space: pre-wrap;
            word-break: break-word;
            background: #fafafa;
        }

        .markdown-popup-body::-webkit-scrollbar {
            width: 8px;
        }

        .markdown-popup-body::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        .markdown-popup-body::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .markdown-popup-body::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .markdown-empty {
            color: #94a3b8;
            font-style: italic;
            text-align: center;
            padding: 40px 20px;
        }

        /* ë‹¤í¬ëª¨ë“œ ë³€ìˆ˜ */
        :root {
            --page-bg: #F5F7FA;
            --card-bg: white;
            --text-primary: #07161D;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --border-color: #e2e8f0;
            --section-bg: #f8fafc;
            --input-bg: white;
        }

        [data-theme="dark"] {
            --page-bg: #1e293b;
            --card-bg: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: #334155;
            --section-bg: #334155;
            --input-bg: #334155;
        }

        /* ë‹¤í¬ëª¨ë“œ íŒ¨ë„ ìŠ¤íƒ€ì¼ */
        [data-theme="dark"] .file-list-panel,
        [data-theme="dark"] .data-panel {
            background: transparent !important;
            border-color: #475569;
        }

        [data-theme="dark"] .file-list-header h3,
        [data-theme="dark"] .data-panel-title {
            color: var(--text-primary);
        }

        [data-theme="dark"] .file-stats {
            color: #94a3b8;
        }

        [data-theme="dark"] .file-category-title {
            color: #60a5fa;
            border-color: #475569;
        }

        [data-theme="dark"] .file-item {
            background: #334155;
        }

        [data-theme="dark"] .file-item:hover {
            background: #3f4f63;
        }

        [data-theme="dark"] .file-item.active,
        [data-theme="dark"] .file-item.selected {
            background: rgba(59, 130, 246, 0.2);
            border-left-color: #60a5fa;
        }

        [data-theme="dark"] .file-name {
            color: var(--text-primary);
        }

        [data-theme="dark"] .file-meta {
            color: #94a3b8;
        }

        [data-theme="dark"] .file-status.pending {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        [data-theme="dark"] .file-status.extracting {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }

        [data-theme="dark"] .file-status.completed {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
        }

        [data-theme="dark"] .file-status.conflict,
        [data-theme="dark"] .file-status.error {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        [data-theme="dark"] .data-panel-header {
            background: #334155;
            border-color: #475569;
        }

        [data-theme="dark"] .extraction-warning {
            background: rgba(251, 191, 36, 0.15);
            border-left-color: #fbbf24;
        }

        [data-theme="dark"] .extraction-warning-title,
        [data-theme="dark"] .extraction-warning-text {
            color: #fbbf24;
        }

        [data-theme="dark"] .llm-model-select {
            background: #334155;
            border-color: #475569;
            color: var(--text-primary);
        }

        [data-theme="dark"] .data-tabs {
            background: #334155;
            border-color: #475569;
        }

        [data-theme="dark"] .data-tab {
            color: #94a3b8;
        }

        [data-theme="dark"] .data-tab.active {
            color: #60a5fa;
            border-bottom-color: #60a5fa;
        }

        [data-theme="dark"] .data-tab:hover {
            color: #60a5fa;
        }

        [data-theme="dark"] .data-content {
            background: #1e293b;
        }

        [data-theme="dark"] .extraction-item {
            background: #334155;
            border-color: #475569;
        }

        [data-theme="dark"] .extraction-label {
            color: var(--text-secondary);
        }

        [data-theme="dark"] .extraction-value {
            background: #1e293b;
            border-color: #475569;
            color: var(--text-primary);
        }

        [data-theme="dark"] .extraction-status.extracted {
            color: #34d399;
        }

        [data-theme="dark"] .extraction-status.pending {
            color: #94a3b8;
        }

        [data-theme="dark"] .extraction-status.conflict {
            color: #fbbf24;
        }

        [data-theme="dark"] .markdown-preview {
            background: #334155;
            border-color: #475569;
        }

        [data-theme="dark"] .markdown-content {
            color: var(--text-primary);
        }

        [data-theme="dark"] .conflict-modal-content {
            background: #1e293b;
            border: 1px solid #475569;
        }

        [data-theme="dark"] .conflict-modal-header {
            background: #334155;
            border-color: #475569;
        }

        [data-theme="dark"] .conflict-modal-title {
            color: var(--text-primary);
        }

        [data-theme="dark"] .conflict-description {
            color: var(--text-secondary);
        }

        [data-theme="dark"] .conflict-option {
            background: #334155;
            border-color: #475569;
        }

        [data-theme="dark"] .conflict-option:hover {
            border-color: #60a5fa;
        }

        [data-theme="dark"] .conflict-option.selected {
            border-color: #60a5fa;
            background: rgba(59, 130, 246, 0.1);
        }

        [data-theme="dark"] .conflict-source {
            color: var(--text-secondary);
        }

        [data-theme="dark"] .conflict-value {
            color: var(--text-primary);
        }

        /* Header styles */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 24px;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header-logo {
            font-size: 18px;
            font-weight: 700;
            color: #25739B;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .dark-mode-toggle {
            background: var(--section-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .dark-mode-toggle:hover {
            border-color: #25739B;
        }

        [data-theme="dark"] .dark-mode-toggle {
            background: #334155;
            border-color: #475569;
        }

        .icon-sun, .icon-moon {
            font-size: 16px;
        }

        [data-theme="light"] .icon-moon {
            display: none;
        }

        [data-theme="dark"] .icon-sun {
            display: none;
        }
    </style>
</head>
<body>
    <div class="app-layout" id="app">
        <!-- Header -->
        <header class="app-header">
            <div class="header-left">
                <div class="logo">
                    <span class="logo-text">KPSUR AGENT</span>
                    <span class="logo-subtitle">ACUZEN AI</span>
                </div>
                <span class="deployment-badge test">í…ŒìŠ¤íŠ¸</span>
            </div>

            <div class="header-center">
                <div class="breadcrumb">
                    <span class="breadcrumb-item">ë³´ê³ ì„œ</span>
                    <span class="breadcrumb-separator">/</span>
                    <span class="breadcrumb-item active">ë°ì´í„° ì¶”ì¶œ</span>
                </div>
            </div>

            <div class="header-right">
                <button class="dark-mode-toggle" onclick="toggleDarkMode()" title="ë‹¤í¬ëª¨ë“œ ì „í™˜">
                    <span class="icon-sun">â˜€ï¸</span>
                    <span class="icon-moon">ğŸŒ™</span>
                </button>
                <div class="user-menu">
                    <div class="user-avatar">ì‚¬</div>
                    <div class="user-info">
                        <div class="user-name">ì‚¬ìš©ì</div>
                        <div class="user-role">Author</div>
                    </div>
                    <button class="user-menu-toggle">â–¼</button>
                </div>
            </div>
        </header>
    </div>

    <!-- Dark Mode Script -->
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();

        function toggleDarkMode() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }
    </script>

    <!-- Conflict Resolution Modal -->
    <div id="conflictModal" class="conflict-modal">
        <div class="conflict-modal-content">
            <div class="conflict-modal-header">
                <h3 class="conflict-modal-title">âš ï¸ ë°ì´í„° ì¶©ëŒ í•´ê²°</h3>
            </div>
            <div class="conflict-modal-body">
                <p class="conflict-description">
                    ì„œë¡œ ë‹¤ë¥¸ ì†ŒìŠ¤ì—ì„œ <strong id="conflictFieldName"></strong>ì— ëŒ€í•œ ìƒì´í•œ ê°’ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.<br>
                    ì‚¬ìš©í•  ê°’ì„ ì„ íƒí•´ ì£¼ì„¸ìš”:
                </p>
                <div id="conflictOptions" class="conflict-options">
                    <!-- Options will be populated dynamically -->
                </div>
            </div>
            <div class="conflict-modal-footer">
                <button class="btn btn-secondary" onclick="closeConflictModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="resolveConflict()">ì„ íƒí•œ ê°’ ì ìš©</button>
            </div>
        </div>
    </div>

    <!-- Markdown Preview Popup -->
    <div id="markdownPopup" class="markdown-popup-overlay" onclick="handleMarkdownPopupClick(event)">
        <div class="markdown-popup-content" onclick="event.stopPropagation()">
            <div class="markdown-popup-header">
                <h3 class="markdown-popup-title">
                    <span>ğŸ“„</span>
                    <span id="markdownPopupFileName">íŒŒì¼ëª…</span>
                    <span class="raw-id-badge" id="markdownPopupRawId">RAW1</span>
                </h3>
                <button class="markdown-popup-close" onclick="closeMarkdownPopup()">&times;</button>
            </div>
            <div class="markdown-popup-body" id="markdownPopupBody">
                <!-- Markdown content will be displayed here -->
            </div>
        </div>
    </div>

    <!-- Core JS ëª¨ë“ˆ ë¡œë“œ (ì „ì—­ ìŠ¤í¬ë¦½íŠ¸) -->
    <script src="../utils/globals.js"></script>
    <script src="../js/config.js"></script>
    <script src="../js/file-handler.js"></script>
    <script src="../js/file-storage.js"></script>
    <script src="../js/markdown-converter.js"></script>
    <script src="../js/multi-llm-client.js"></script>
    <script src="../js/workflow-manager.js"></script>
    <script src="../js/cost-tracker.js"></script>
    <script src="../js/psur-generator.js"></script>

    <script>
        // ë‹¤í¬ëª¨ë“œ ì´ˆê¸°í™” (IIFE) - í˜ì´ì§€ ë¡œë“œ ì „ í…Œë§ˆ ì ìš©
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();

        // ë‹¤í¬ëª¨ë“œ í† ê¸€ í•¨ìˆ˜
        function toggleDarkMode() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        // ì „ì—­ ëª¨ë“ˆ ì°¸ì¡°
        const multiLLMClient = window.multiLLMClient;
        const workflowManager = window.workflowManager;
        const fileStorage = window.fileStorage;
        const Storage = window.Storage || {
            get: (key) => { try { return JSON.parse(localStorage.getItem(key)); } catch { return null; } },
            set: (key, value) => { try { localStorage.setItem(key, JSON.stringify(value)); } catch {} }
        };

        // CONFIG - System configuration (fallback if not loaded from config.js)
        const CONFIG = window.CONFIG || {
            SUPABASE_URL: 'https://toelnxgizxwbdikskmxa.supabase.co',
            SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvZWxueGdpenh3YmRpa3NrbXhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIwMDAyMzUsImV4cCI6MjA3NzU3NjIzNX0.mpBAWTufodmfPUp6nmg7Qez6uygrplK9S91xl8c4mR8',
            LLM: {
                DEFAULT_MODEL: 'gemini-2.5-flash',
                MODELS: {
                    FLASH: 'gemini-2.5-flash',
                    PRO: 'gemini-2.5-pro'
                },
                API_ENDPOINT: 'https://generativelanguage.googleapis.com/v1beta/models'
            },
            STORAGE_KEYS: {
                GOOGLE_API_KEY: 'GOOGLE_API_KEY',
                SESSION: 'session',
                CURRENT_REPORT: 'current_report',
                LAST_STAGE: 'last_stage'
            },
            PAGES: {
                LOGIN: 'P01_Login.html',
                DASHBOARD: 'P10_Dashboard.html',
                SETTINGS: 'P91_Settings.html'
            }
        };

        // Storage Helper
        const Storage = {
            get(key) {
                try {
                    const value = localStorage.getItem(key);
                    return value ? JSON.parse(value) : null;
                } catch (e) {
                    console.error(`Error reading from localStorage (${key}):`, e);
                    return null;
                }
            },
            set(key, value) {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                    return true;
                } catch (e) {
                    console.error(`Error writing to localStorage (${key}):`, e);
                    return false;
                }
            },
            remove(key) {
                try {
                    localStorage.removeItem(key);
                    return true;
                } catch (e) {
                    console.error(`Error removing from localStorage (${key}):`, e);
                    return false;
                }
            }
        };

        // DateHelper - Date formatting utilities
        const DateHelper = {
            now() {
                return new Date();
            },
            formatYYMMDD_hhmmss(date = new Date()) {
                const yy = String(date.getFullYear()).slice(-2);
                const MM = String(date.getMonth() + 1).padStart(2, '0');
                const DD = String(date.getDate()).padStart(2, '0');
                const hh = String(date.getHours()).padStart(2, '0');
                const mm = String(date.getMinutes()).padStart(2, '0');
                const ss = String(date.getSeconds()).padStart(2, '0');
                return `${yy}${MM}${DD}_${hh}${mm}${ss}`;
            },
            formatISO(date = new Date()) {
                return date.toISOString();
            }
        };

        // DataExtractor stub - minimal implementation for page to function
        const dataExtractor = {
            extractedData: { CS: {}, PH: {}, Table: {} },
            conflicts: [],
            dataDefinitions: { CS: {}, PH: {}, Table: {} },
            definitionsLoaded: false,

            // ë°ì´í„° ì •ì˜ íŒŒì¼ ë¡œë“œ (Ref/*.md íŒŒì¼)
            async loadDataDefinitions() {
                if (this.definitionsLoaded) {
                    return true;
                }

                console.log('ğŸ“š Loading data definitions from Ref/*.md files...');

                const definitionFiles = [
                    { type: 'CS', path: '../Ref/01_CSData_Definition.md' },
                    { type: 'PH', path: '../Ref/02_PHData_Definition.md' },
                    { type: 'Table', path: '../Ref/03_TableData_Definition.md' }
                ];

                for (const file of definitionFiles) {
                    try {
                        const response = await fetch(file.path);
                        if (response.ok) {
                            const markdown = await response.text();
                            this.parseDefinitionMarkdown(markdown, file.type);
                            console.log(`âœ… Loaded ${file.type} definitions`);
                        } else {
                            console.warn(`âš ï¸ Could not load ${file.path}: ${response.status}`);
                        }
                    } catch (error) {
                        console.error(`âŒ Error loading ${file.path}:`, error);
                    }
                }

                this.definitionsLoaded = true;
                console.log('ğŸ“š Data definitions loaded:', {
                    CS: Object.keys(this.dataDefinitions.CS).length,
                    PH: Object.keys(this.dataDefinitions.PH).length,
                    Table: Object.keys(this.dataDefinitions.Table).length
                });

                return true;
            },

            // ë§ˆí¬ë‹¤ìš´ ì •ì˜ íŒŒì¼ íŒŒì‹±
            parseDefinitionMarkdown(markdown, type) {
                // ### N. [ë³€ìˆ˜ID_ë³€ìˆ˜ëª…] íŒ¨í„´ ë§¤ì¹­
                const sectionRegex = /### \d+\. \[([^\]]+)\]([\s\S]*?)(?=### \d+\. \[|---\s*$|$)/g;
                let match;

                while ((match = sectionRegex.exec(markdown)) !== null) {
                    const fullId = match[1];  // ì˜ˆ: CS0_ì„±ë¶„ëª…, PH4_ì›ì‹œìë£Œì„œìˆ ë¬¸, í‘œ2_ì—°ë„ë³„íŒë§¤ëŸ‰
                    const content = match[2];

                    // Variable ID ì¶”ì¶œ
                    const idMatch = fullId.match(/^(CS\d+(?:\.\d+)?|PH\d+|í‘œ\d+)/);
                    if (!idMatch) continue;

                    let variableId = idMatch[1];
                    // í‘œX -> TX ë³€í™˜
                    if (variableId.startsWith('í‘œ')) {
                        variableId = 'T' + variableId.substring(1);
                    }

                    // Variable Name ì¶”ì¶œ
                    const nameMatch = content.match(/\*\*Variable Name:\*\*\s*(.+)/);
                    const name = nameMatch ? nameMatch[1].trim() : fullId.split('_').slice(1).join('_');

                    // Data Source ì¶”ì¶œ
                    const sourceMatch = content.match(/\*\*Data Source:\*\*\s*(.+)/);
                    const source = sourceMatch ? sourceMatch[1].trim() : '';

                    // ë°ì´í„° ì¶”ì¶œ ë°©ë²• ì¶”ì¶œ
                    const methodMatch = content.match(/#### ë°ì´í„° ì¶”ì¶œ ë°©ë²•[\s\S]*?> \*\*\[ì§€ì¹¨\]\*\*\s*([\s\S]*?)(?=####|$)/);
                    let method = '';
                    if (methodMatch) {
                        method = methodMatch[1].trim()
                            .replace(/> \*\*\[ì§€ì¹¨\]\*\*/g, '\n')
                            .replace(/\n+/g, ' ')
                            .trim();
                    }

                    // ì¶”ê°€ ì§€ì¹¨ ì¶”ì¶œ
                    const additionalMatch = content.match(/#### ì¶”ê°€ ì§€ì¹¨[\s\S]*?> \*\*\[ì§€ì¹¨\]\*\*\s*([\s\S]*?)(?=####|$)/);
                    if (additionalMatch && !method) {
                        method = additionalMatch[1].trim()
                            .replace(/> \*\*\[ì§€ì¹¨\]\*\*/g, '\n')
                            .replace(/\n+/g, ' ')
                            .trim();
                    }

                    // ì˜ˆì‹œ ì¶”ì¶œ
                    const exampleMatch = content.match(/#### ì˜ˆì‹œ[\s\S]*?1\.\s*`([^`]+)`/);
                    const example = exampleMatch ? exampleMatch[1] : '';

                    // ì •ì˜ ì €ì¥
                    this.dataDefinitions[type][variableId] = {
                        name: name,
                        source: source,
                        method: method.substring(0, 500),  // ë„ˆë¬´ ê¸´ ê²½ìš° ìë¥´ê¸°
                        example: example.substring(0, 300)
                    };
                }
            },

            // ë¡œë“œëœ ì •ì˜ì—ì„œ í•„ë“œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            getFieldDefinition(fieldId) {
                // CS, PH, Table ìˆœì„œë¡œ ê²€ìƒ‰
                if (fieldId.startsWith('CS')) {
                    return this.dataDefinitions.CS[fieldId];
                } else if (fieldId.startsWith('PH')) {
                    return this.dataDefinitions.PH[fieldId];
                } else if (fieldId.startsWith('T')) {
                    return this.dataDefinitions.Table[fieldId];
                }
                return null;
            },

            async extractFromMarkdown(markdownContent, rawId, dataDefinitions) {
                // ë¨¼ì € ë°ì´í„° ì •ì˜ ë¡œë“œ
                await this.loadDataDefinitions();
                console.log(`ğŸ“Š Extracting data from RAW ID: ${rawId}`);

                const apiKey = Storage.get(CONFIG.STORAGE_KEYS.GOOGLE_API_KEY);
                if (!apiKey) {
                    console.error('âŒ API key not found');
                    return { success: false, error: 'API key not found' };
                }

                const model = document.getElementById('llmModel').value || CONFIG.LLM.DEFAULT_MODEL;
                const modelName = model === 'pro' ? 'gemini-2.5-pro-preview-06-05' : 'gemini-2.5-flash';
                const url = `${CONFIG.LLM.API_ENDPOINT}/${modelName}:generateContent?key=${apiKey}`;

                // RAW IDë³„ ì¶”ì¶œ ëŒ€ìƒ ì •ì˜
                const extractionTargets = this.getExtractionTargets(rawId);
                if (!extractionTargets || extractionTargets.length === 0) {
                    console.log(`â­ï¸ No extraction targets for RAW ID: ${rawId}`);
                    return { success: true, csData: {}, phData: {}, tableData: {}, extractedAt: DateHelper.formatISO() };
                }

                const prompt = this.buildExtractionPrompt(markdownContent, rawId, extractionTargets);

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            generationConfig: { temperature: 0.1, maxOutputTokens: 8192 }
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`API error: ${response.status}`);
                    }

                    const data = await response.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                    console.log(`âœ… LLM response for ${rawId}:`, text.substring(0, 200));

                    const extracted = this.parseExtractionResponse(text, rawId);
                    return {
                        success: true,
                        csData: extracted.csData || {},
                        phData: extracted.phData || {},
                        tableData: extracted.tableData || {},
                        extractedAt: DateHelper.formatISO()
                    };
                } catch (error) {
                    console.error(`âŒ Extraction API error for ${rawId}:`, error);
                    return { success: false, error: error.message };
                }
            },

            getExtractionTargets(rawId) {
                // RAW IDë³„ ì¶”ì¶œ ëŒ€ìƒ ë§¤í•‘ (Source-CS-Sections.md ê¸°ì¤€)
                const targetMap = {
                    'RAW1': ['CS15', 'CS16', 'CS20'],  // ìµœì‹ ì²¨ë¶€ë¬¸ì„œ: íš¨ëŠ¥íš¨ê³¼, ìš©ë²•ìš©ëŸ‰, 1ì¼íˆ¬ì—¬ëŸ‰
                    'RAW2.1': ['CS16', 'CS20'],  // ìš©ë²•ìš©ëŸ‰, 1ì¼íˆ¬ì—¬ëŸ‰
                    'RAW2.2': ['CS15'],  // íš¨ëŠ¥íš¨ê³¼
                    'RAW2.3': [],  // ì‚¬ìš©ìƒì˜ì£¼ì˜ì‚¬í•­ - CS56.7ì—ì„œ ì‚¬ìš©
                    'RAW2.6': [],  // ë³´ê³ ì‹œì‘ì‹œì  ì‚¬ìš©ìƒì˜ì£¼ì˜ì‚¬í•­ - CS56.4ì—ì„œ ì‚¬ìš©
                    'RAW3': ['CS19', 'CS19.1', 'CS19.2', 'CS19.3', 'T2'],  // ì‹œíŒí›„salesë°ì´í„°
                    'RAW4': ['CS17.1', 'CS17.2', 'CS17.3', 'CS17.4', 'CS17.5', 'CS17.6'],  // í—ˆê°€í˜„í™© (CS17.1~CS17.6ë§Œ ì¶”ì¶œ, í…Œì´ë¸” ì œì™¸)
                    'RAW5': ['CS55'],  // ì•ˆì „ì„±ì¡°ì¹˜í—ˆê°€ë©”ì¼
                    'RAW5.1': ['CS55'],  // ì•ˆì „ì„±ì¡°ì¹˜í—ˆê°€ë©”ì¼
                    'RAW6': ['CS55'],  // ì•ˆì „ì„±ì¡°ì¹˜í—ˆê°€ë©”ì¼_ì·¨í•©ë³¸
                    'RAW6.1': ['CS55'],  // ì•ˆì „ì„±ì¡°ì¹˜í—ˆê°€ë©”ì¼_ì·¨í•©ë³¸
                    'RAW7': ['CS56', 'CS56.1', 'CS56.2', 'CS56.3', 'CS56.4', 'CS56.5', 'CS56.6', 'CS56.7'],  // ì•ˆì „ì„±ì •ë³´ë³€ê²½
                    'RAW7.1': ['CS56', 'CS56.1'],  // ì•ˆì „ì„±ì •ë³´ë³€ê²½_ë³µìˆ˜í•­ëª©
                    'RAW7.2': ['CS56', 'CS56.1'],  // ì•ˆì „ì„±ì •ë³´ë³€ê²½
                    'RAW7.3': ['CS56', 'CS56.1'],  // ì•ˆì „ì„±ì •ë³´ë³€ê²½_ìš©ë²•ìš©ëŸ‰
                    'RAW7.4': ['CS56', 'CS56.1'],  // ì•ˆì „ì„±ì •ë³´ë³€ê²½_í‘œí˜•ì‹ë³µìˆ˜í•­ëª©
                    'RAW8': ['CS18'],  // ì„ìƒë…¸ì¶œë°ì´í„°
                    'RAW9': ['PH9'],  // ë¬¸í—Œìë£Œ
                    'RAW12': ['CS25.1', 'CS25.2', 'CS25.3', 'CS25.4', 'CS33', 'T5'],  // êµ­ì™¸ì‹ ì†ë³´ê³ LineListing
                    'RAW13': ['CS25.1', 'CS25.2', 'CS25.3', 'CS25.4', 'CS33', 'T5'],  // êµ­ë‚´ì‹ ì†ë³´ê³ LineListing
                    'RAW14': ['CS28', 'CS29', 'CS30', 'PH4', 'PH5', 'T7'],  // ì›ì‹œìë£ŒLineListing
                    'RAW15': ['CS34', 'PH6', 'T6']   // ì •ê¸°ë³´ê³ LineListing
                };
                return targetMap[rawId] || [];
            },

            buildExtractionPrompt(content, rawId, targets) {
                // ë¡œë“œëœ ë°ì´í„° ì •ì˜ ì‚¬ìš© (Ref/*.md íŒŒì¼ ê¸°ë°˜)
                // ëŒ€ìƒ í•„ë“œë³„ ìƒì„¸ ì •ë³´ êµ¬ì„± (ë¡œë“œëœ ì •ì˜ì—ì„œ ê°€ì ¸ì˜´)
                const targetDetails = targets.map(t => {
                    const def = this.getFieldDefinition(t);
                    if (def && (def.name || def.source || def.method)) {
                        let detail = `### ${t}: ${def.name || t}`;
                        if (def.source) detail += `\n- **ë°ì´í„° ì†ŒìŠ¤**: ${def.source}`;
                        if (def.method) detail += `\n- **ì¶”ì¶œ ë°©ë²•**: ${def.method}`;
                        if (def.example) detail += `\n- **ì˜ˆì‹œ ì¶œë ¥**: ${def.example}`;
                        return detail;
                    } else {
                        // Fallback: ê¸°ë³¸ ì„¤ëª…
                        const fallbackDescriptions = this.getFallbackDescriptions();
                        return `### ${t}: ${fallbackDescriptions[t] || t}`;
                    }
                }).join('\n\n');

                return `ë‹¹ì‹ ì€ í•œêµ­ PSUR(ì£¼ê¸°ì  ì•ˆì „ì„± ë³´ê³ ì„œ) ì‘ì„±ì„ ìœ„í•´ ì˜ì•½í’ˆ ë¬¸ì„œì—ì„œ ë°ì´í„°ë¥¼ ì¶”ì¶œí•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

## ì¶”ì¶œ ì›ì¹™
1. **ì ˆëŒ€ ë°ì´í„°ë¥¼ ìƒì„±í•˜ì§€ ë§ˆì„¸ìš”** - ë¬¸ì„œì— ëª…ì‹œì ìœ¼ë¡œ ì¡´ì¬í•˜ëŠ” ì •ë³´ë§Œ ì¶”ì¶œ
2. **ë°ì´í„°ê°€ ì—†ìœ¼ë©´ null ë°˜í™˜** - ì¶”ì¸¡í•˜ê±°ë‚˜ ìœ ì‚¬í•œ ë°ì´í„°ë¡œ ëŒ€ì²´ ê¸ˆì§€
3. **ì •í™•í•œ ìˆ˜ì¹˜/ë‚ ì§œ ì¶”ì¶œ** - countë‚˜ ê³„ì‚°ì€ 2ì¤‘ ê²€ì¦ í•„ìš”

## ë¬¸ì„œ ì •ë³´
- **RAW ID**: ${rawId}
- **ë¬¸ì„œ ìœ í˜•**: ${this.getRawDescription(rawId)}

## ì¶”ì¶œ ëŒ€ìƒ í•„ë“œ ìƒì„¸ (ë°ì´í„° ì •ì˜ íŒŒì¼ ê¸°ì¤€)

${targetDetails}

## ë¬¸ì„œ ë‚´ìš©
\`\`\`
${content.substring(0, 8000)}
\`\`\`

## ì‘ë‹µ í˜•ì‹ (ì¤‘ìš”!)
- ë°˜ë“œì‹œ JSON ì½”ë“œ ë¸”ë¡ë§Œ ì¶œë ¥í•˜ì„¸ìš”
- ì„¤ëª…, ë¶„ì„, ì½”ë©˜íŠ¸ ì—†ì´ ì˜¤ì§ JSONë§Œ ë°˜í™˜í•˜ì„¸ìš”
- ì•„ë˜ í˜•ì‹ì„ ì •í™•íˆ ë”°ë¥´ì„¸ìš”:

\`\`\`json
{
${targets.map(t => `  "${t}": "ì¶”ì¶œëœ ê°’ ë˜ëŠ” null"`).join(',\n')}
}
\`\`\``;
            },

            // Fallback ì„¤ëª… (ì •ì˜ íŒŒì¼ì— ì—†ëŠ” í•„ë“œìš©)
            getFallbackDescriptions() {
                return {
                    'CS0': 'ì„±ë¶„ëª… (ìœ íš¨ì„±ë¶„ëª…)',
                    'CS1': 'ë¸Œëœë“œëª… (ì œí’ˆëª…)',
                    'CS2': 'íšŒì‚¬ëª… (íŒë§¤ì‚¬/ì œì¡°ì‚¬)',
                    'CS3': 'ë³´ê³ ì‹œì‘ë‚ ì§œ (CS4ì—ì„œ 5ë…„ ì „)',
                    'CS4': 'ë³´ê³ ì¢…ë£Œë‚ ì§œ',
                    'CS5': 'êµ­ë‚´í—ˆê°€ì¼ì (YYYY-MM-DD í˜•ì‹)',
                    'CS6': 'ë³´ê³ ì„œì œì¶œì¼',
                    'CS7': 'ë²„ì „ë„˜ë²„',
                    'CS8': 'ë²„ì „ë‚ ì§œ (CS4ì™€ ë™ì¼)',
                    'CS9': 'ëª©ì°¨',
                    'CS10': 'í‘œëª©ì°¨',
                    'CS11': 'ë³„ì²¨ëª©ì°¨',
                    'CS12': 'ì•½ì–´í‘œ',
                    'CS13': 'ìœ íš¨ê¸°ê°„',
                    'CS14': 'ì‹ ì²­ê¸°í•œ (CS13ì—ì„œ 6ê°œì›” ì „)',
                    'CS15': 'íš¨ëŠ¥íš¨ê³¼',
                    'CS16': 'ìš©ë²•ìš©ëŸ‰',
                    'CS17': 'ì „ì„¸ê³„í—ˆê°€í˜„í™©í‘œ',
                    'CS18': 'ì„ìƒë…¸ì¶œ',
                    'CS19': 'ì‹œíŒí›„ë…¸ì¶œcountì‹œì‘ë‚ ì§œ',
                    'CS19.1': 'ì‹œíŒí›„ë…¸ì¶œcountì¢…ë£Œë‚ ì§œ',
                    'CS19.2': 'ì‹œíŒí›„íŒë§¤ì—°ë„ë³„íŒë§¤ëŸ‰',
                    'CS19.3': 'ì‹œíŒí›„íŒë§¤ëŸ‰í•©ê³„',
                    'CS20': '1ì¼ì‚¬ìš©ëŸ‰',
                    'CS21': 'í™˜ì1ëª…ë‹¹ì‚¬ìš©ëŸ‰ (ì—°ê°„)',
                    'CS22': 'ì—°í‰ê· íŒë§¤ëŸ‰',
                    'CS23': 'ì—°í‰ê· í™˜ìë…¸ì¶œ',
                    'CS24': 'MedDRAë²„ì „',
                    'CS25.1': 'ì‹ ì†ë³´ê³ ì¼ì',
                    'CS25.2': 'ì‹ ì†ë³´ê³ ê´€ë¦¬ë²ˆí˜¸',
                    'CS25.3': 'ì‹ ì†ë³´ê³ ì´ìƒì‚¬ë¡€ëª…',
                    'CS25.4': 'ì‹ ì†ë³´ê³ ë¹„ê³ ',
                    'CS28': 'ì›ì‹œì´í™˜ììˆ˜',
                    'CS29': 'ì›ì‹œì´ì´ìƒì‚¬ë¡€ìˆ˜',
                    'CS30': 'ì›ì‹œì¤‘ëŒ€í•œì‚¬ë¡€ìˆ˜',
                    'CS31': 'ì›ì‹œìë£Œì‹ ì²­ì¼',
                    'CS32': 'ì „ì²´ë³´ê³ ê±´ìˆ˜ (CS33+CS34)',
                    'CS33': 'ì‹ ì†ë³´ê³ ê±´ìˆ˜',
                    'CS34': 'ì •ê¸°ë³´ê³ ê±´ìˆ˜',
                    'CS35': 'ì „ì²´ì´ìƒì‚¬ë¡€ê±´ìˆ˜',
                    'CS36': 'ì¤‘ëŒ€í•œì´ìƒì‚¬ë¡€ê±´ìˆ˜',
                    'CS37': 'ë¹„ì¤‘ëŒ€ì´ìƒì‚¬ë¡€ê±´ìˆ˜',
                    'CS53': 'ë¬¸í—ŒDBëª…',
                    'CS55': 'ì•ˆì „ì„±ì¡°ì¹˜ì„œìˆ ë¬¸',
                    'CS56': 'ì°¸ê³ ì •ë³´ì˜ë³€ê²½ì„œìˆ ë¬¸',
                    'CS56.1': 'í—ˆê°€ì‚¬í•­ë³€ê²½ì¼',
                    'CS56.2': 'ê¸°ì¡´íš¨ëŠ¥íš¨ê³¼',
                    'CS56.3': 'ê¸°ì¡´ìš©ëŸ‰ìš©ë²•',
                    'CS56.4': 'ê¸°ì¡´ì‚¬ìš©ìƒì˜ì£¼ì˜ì‚¬í•­',
                    'CS56.5': 'ìµœì‹ íš¨ëŠ¥íš¨ê³¼',
                    'CS56.6': 'ìµœì‹ ìš©ë²•ìš©ëŸ‰',
                    'CS56.7': 'ìµœì‹ ì‚¬ìš©ìƒì£¼ì˜ì‚¬í•­',
                    'CS57': 'ì°¸ê³ ë¬¸í—Œëª©ë¡',
                    'PH4': 'ì›ì‹œìë£Œì„œìˆ ë¬¸',
                    'PH5': 'ì›ì‹œìë£Œì„œìˆ ë¬¸2',
                    'PH6': 'ê°œë³„ì¦ë¡€ë¶„ì„ë¬¸',
                    'PH7': 'ìƒˆë¡œë¶„ì„ëœì˜ë¢°ì˜ì‹œí—˜',
                    'PH8': 'ì‹œì‘ë˜ëŠ”ì§„í–‰ì¤‘ì‹œí—˜',
                    'PH9': 'ë¬¸í—Œì—ë°œí‘œëœì•ˆì „ì„±',
                    'PH10': 'ìœ íš¨ì„±ê´€ë ¨ì •ë³´',
                    'PH11': 'ì´ê´„í‰ê°€ë¬¸',
                    'PH12': 'ê²°ë¡ ',
                    'T1': 'í‘œ1_ì „ì„¸ê³„íŒë§¤í—ˆê°€í˜„í™©',
                    'T2': 'í‘œ2_ì—°ë„ë³„íŒë§¤ëŸ‰',
                    'T3': 'í‘œ3_ì—°í‰ê· í™˜ìë…¸ì¶œ',
                    'T5': 'í‘œ5_ì‹ ì†ë³´ê³ ë‚´ì—­',
                    'T6': 'í‘œ6_ì •ê¸°ë³´ê³ ë‚´ì—­',
                    'T7': 'í‘œ7_ì›ì‹œìë£Œë‚´ì—­',
                    'T8': 'í‘œ8_ëª¨ë“ ì´ìƒì‚¬ë¡€ê±´ìˆ˜',
                    'T9': 'í‘œ9_SOCë³„ê±´ìˆ˜'
                };
            },

            // ê¸°ì¡´ í•˜ë“œì½”ë”©ëœ ì •ì˜ (ë ˆê±°ì‹œ í˜¸í™˜ìš© - ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
            _legacyFieldDefinitions: {
                    // === CS ë°ì´í„° ===
                    'CS15': {
                        name: 'íš¨ëŠ¥íš¨ê³¼',
                        source: '[RAW1.1_ìµœì‹ ì²¨ë¶€ë¬¸ì„œ] OR [RAW2.2_íš¨ëŠ¥íš¨ê³¼]',
                        method: 'íš¨ëŠ¥íš¨ê³¼ ì„¹ì…˜ì„ ì°¾ì•„ ì¶”ì¶œ. ë¶„ëŸ‰ì´ ë„ˆë¬´ ê¸¸ë‹¤ë©´ ì¤‘ìš”ë¶€ë¶„ì„ ìœ„ì£¼ë¡œ ìš”ì•½.',
                        example: '"ì¤‘ë“±ë„ì—ì„œ ì¤‘ì¦ì˜ ì•Œì¸ í•˜ì´ë¨¸ë³‘ ì¹˜ë£Œ"'
                    },
                    'CS16': {
                        name: 'ìš©ë²•ìš©ëŸ‰',
                        source: '[RAW1.1_ìµœì‹ ì²¨ë¶€ë¬¸ì„œ] OR [RAW2.1_ìš©ë²•ìš©ëŸ‰]',
                        method: 'ìš©ë²•ìš©ëŸ‰ ë¶€ë¶„ì„ ì°¸ê³ . ë¶„ëŸ‰ì´ ë„ˆë¬´ ê¸¸ë‹¤ë©´ ì¤‘ìš”ë¶€ë¶„ì„ ìœ„ì£¼ë¡œ ìš”ì•½.',
                        example: '"1ì¼ 1íšŒ 5mgìœ¼ë¡œ ì‹œì‘í•˜ì—¬ 4ì£¼ ê°„ê²©ìœ¼ë¡œ 5mgì”© ì¦ëŸ‰, ìœ ì§€ìš©ëŸ‰ 1ì¼ 20mg(10mgì”© 1ì¼ 2íšŒ)"'
                    },
                    'CS17': {
                        name: 'ì „ì„¸ê³„í—ˆê°€í˜„í™©í‘œ',
                        source: '[RAW4_í—ˆê°€í˜„í™©]',
                        method: 'í—ˆê°€ëœ êµ­ê°€/ì§€ì—­, í—ˆê°€ì¼, í’ˆëª©ëª…, í—ˆê°€ê¶Œì, ë¹„ê³ ë¥¼ í‘œ í˜•íƒœë¡œ ì¶”ì¶œ. í•œ êµ­ê°€ì—ì„œ ì—¬ëŸ¬ë²ˆ í—ˆê°€ë‚œ ê²½ìš° ë‚ ì§œìˆœ ì •ë ¬.',
                        example: '[{"êµ­ê°€": "í•œêµ­", "í—ˆê°€ì¼": "2021-03-05", "í’ˆëª©ëª…": "ì½”ë¯¸ë‚˜í‹°ì£¼", "í—ˆê°€ê¶Œì": "í•œêµ­í™”ì´ì", "ë¹„ê³ ": "ê¸´ê¸‰ì‚¬ìš©ìŠ¹ì¸"}]'
                    },
                    'CS17.1': {
                        name: 'í—ˆê°€ êµ­ê°€',
                        source: '[RAW4_í—ˆê°€í˜„í™©]',
                        method: 'í•œêµ­ì–´ë¡œ êµ­ê°€ëª… í‘œê¸°',
                        example: '"ëŒ€í•œë¯¼êµ­", "ë¯¸êµ­", "ìœ ëŸ½ì—°í•©"'
                    },
                    'CS17.2': {
                        name: 'í—ˆê°€ì¼',
                        source: '[RAW4_í—ˆê°€í˜„í™©]',
                        method: 'YYYY-MM-DD í˜•ì‹. ìš©ëŸ‰ì¶”ê°€ë¡œ ì—¬ëŸ¬ë²ˆ í—ˆê°€ì‹œ ë‚ ì§œ ì˜†ì— ê´„í˜¸ë¡œ ìš©ëŸ‰ í‘œê¸°.',
                        example: '"2021-03-05 (100mg)", "2022-01-10 (200mg ì¶”ê°€)"'
                    },
                    'CS17.3': {
                        name: 'í—ˆê°€í’ˆëª©ëª…',
                        source: '[RAW4_í—ˆê°€í˜„í™©]',
                        method: 'RAW ë°ì´í„°ì— ëª…ì‹œëœ ëª…ì¹­ ê·¸ëŒ€ë¡œ ì‚¬ìš©. Â® ë˜ëŠ” â„¢ ë§ˆí¬ëŠ” ìœ„ì²¨ìë¡œ í‘œê¸°.',
                        example: '"RemsimaÂ®", "ì½”ë¯¸ë‚˜í‹°ì£¼"'
                    },
                    'CS17.4': {
                        name: 'í—ˆê°€ê¶Œì',
                        source: '[RAW4_í—ˆê°€í˜„í™©]',
                        method: 'RAW ë°ì´í„°ì— ëª…ì‹œëœ ëª…ì¹­ ê·¸ëŒ€ë¡œ ì‚¬ìš©',
                        example: '"í•œêµ­í™”ì´ìì œì•½(ì£¼)", "Pfizer Inc."'
                    },
                    'CS17.5': {
                        name: 'í—ˆê°€ ë¹„ê³ ',
                        source: '[RAW4_í—ˆê°€í˜„í™©]',
                        method: 'RAW ë°ì´í„°ì˜ ì „ë°˜ì ì¸ ì •ë³´ë¥¼ ë³´ê³  ë§¥ë½ì„ ê³ ë ¤í•˜ì—¬ ì¶”ì¶œ',
                        example: '"ê¸´ê¸‰ì‚¬ìš©ìŠ¹ì¸", "ìš©ëŸ‰ ì¶”ê°€", "ì ì‘ì¦ ì¶”ê°€"'
                    },
                    'CS17.6': {
                        name: 'í—ˆê°€í˜„í™©ì„œìˆ ë¬¸',
                        source: '[RAW4_í—ˆê°€í˜„í™©] OR [CS17_ì „ì„¸ê³„í—ˆê°€í˜„í™©í‘œ]',
                        method: 'í—ˆê°€êµ­ê°€ 5ê°œ ì´ˆê³¼ì‹œ "ì´ XXê°œêµ­" í˜•íƒœë¡œ ìš”ì•½',
                        example: '"ê¸€ë¦¬ë¹…ì‚¬(ë©”ë§Œí‹´ì—¼ì‚°ì—¼)ì˜ í’ˆëª©í—ˆê°€ì¼ì€ 2018-11-10ì´ê³ , ì´ 15ê°œêµ­ì—ì„œ í—ˆê°€ë¥¼ ë“í•˜ì˜€ë‹¤."'
                    },
                    'CS18': {
                        name: 'ì„ìƒë…¸ì¶œ',
                        source: '[RAW8_ì„ìƒë…¸ì¶œë°ì´í„°]',
                        method: 'ë³´ê³ ê¸°ê°„ ì¤‘ ì¢…ë£Œëœ ì„ìƒì‹œí—˜ íŒŒì•…. ì‹œí—˜ì˜ì•½í’ˆ, ìœ„ì•½, í™œì„±ëŒ€ì¡°ì•½ ê°ê°ì˜ ëŒ€ìƒì ìˆ˜ íŒŒì•…. ê°€ëŠ¥í•˜ë©´ ì—°ë ¹/ì„±ë³„/ì¸ì¢… í•˜ìœ„ê·¸ë£¹ë³„ ë°ì´í„°.',
                        example: '[{"ì‹œí—˜ëª…": "COV001", "ì¢…ë£Œì¼": "2021-11-28", "ì‹œí—˜êµ°": 500, "ëŒ€ì¡°êµ°": 250}]'
                    },
                    'CS19': {
                        name: 'ì‹œíŒí›„ë…¸ì¶œcountì‹œì‘ë‚ ì§œ',
                        source: '[RAW3_ì‹œíŒí›„salesë°ì´í„°]',
                        method: 'salesíŒ€ ë°ì´í„° ì£¼ê¸°(ì›”ë³„/ë¶„ê¸°ë³„) í™•ì¸ í›„, ë³´ê³ ì‹œì‘ë‚ ì§œì— ê°€ì¥ ê°€ê¹Œìš´ ì›”ì˜ 1ì¼',
                        example: '"2017-01-01"'
                    },
                    'CS19.1': {
                        name: 'ì‹œíŒí›„ë…¸ì¶œcountì¢…ë£Œë‚ ì§œ',
                        source: '[RAW3_ì‹œíŒí›„salesë°ì´í„°]',
                        method: 'ë³´ê³ ì¢…ë£Œë‚ ì§œì— ê°€ì¥ ê°€ê¹Œìš´ ì›”ì˜ ë§ì¼',
                        example: '"2022-07-31"'
                    },
                    'CS19.2': {
                        name: 'ì—°ë„ë³„íŒë§¤ëŸ‰',
                        source: '[RAW3_ì‹œíŒí›„salesë°ì´í„°]',
                        method: 'ì—°ë„ë³„ íŒë§¤ëŸ‰ ì§‘ê³„. ìš©ë²•ìš©ëŸ‰ì— ë”°ë¼ ë‹¨ìœ„(ì •, ë°”ì´ì•Œ ë“±) ê²°ì •',
                        example: '{"2020ë…„": "150,000ì •", "2021ë…„": "180,000ì •", "2022ë…„(1~7ì›”)": "95,000ì •"}'
                    },
                    'CS19.3': {
                        name: 'ì´íŒë§¤ëŸ‰í•©ê³„',
                        source: '[CS19.2_ì‹œíŒí›„íŒë§¤ì—°ë„ë³„íŒë§¤ëŸ‰]',
                        method: 'ì—°ë„ë³„ íŒë§¤ëŸ‰ í•©ê³„',
                        example: '"425,000ì •"'
                    },
                    'CS20': {
                        name: '1ì¼ì‚¬ìš©ëŸ‰',
                        source: '[RAW1.1_ìµœì‹ ì²¨ë¶€ë¬¸ì„œ] OR [RAW2.1_ìš©ë²•ìš©ëŸ‰]',
                        method: 'ìš©ë²•ìš©ëŸ‰ì—ì„œ 1ì¼ íˆ¬ì—¬ëŸ‰ ì¶”ì¶œ. ë‹¨ìœ„ëŠ” ìš©ë²•ìš©ëŸ‰ì— ë§ì¶¤(ì •, ë°”ì´ì•Œ ë“±)',
                        example: '"1ì¼ 20mg (10mg Ã— 2íšŒ)"'
                    },
                    'CS55': {
                        name: 'ì•ˆì „ì„±ì¡°ì¹˜ì„œìˆ ë¬¸',
                        source: '[RAW5_ì•ˆì „ì„±ì¡°ì¹˜í—ˆê°€íŒ€ë©”ì¼] OR [RAW6_ì•ˆì „ì„±ì¡°ì¹˜í—ˆê°€íŒ€ë©”ì¼_ì·¨í•©ë³¸]',
                        method: `ë°˜ë“œì‹œ ë‹¤ìŒ 4ê°€ì§€ í•­ëª©ì„ ì°¾ì•„ ì„œìˆ :
1. ì–´ë–¤ êµ­ê°€ì˜ ì–´ë–¤ ê·œì œë‹¹êµ­ì´
2. ì–´ë–¤ ì•ˆì „ì„±ì¡°ì¹˜ê°€ ì·¨í•´ì¡ŒëŠ”ê°€ (ì˜ˆ: DHPC ë°°í¬, RMP ì—…ë°ì´íŠ¸, PI ë³€ê²½)
3. ì–´ë–¤ ì•ˆì „ì„± ë¬¸ì œì— ëŒ€í•´ì„œ (ì˜ˆ: í˜ˆì†ŒíŒê°ì†Œì¦, ê¸¸ë­-ë°”ë ˆì¦í›„êµ°, ëª¨ì„¸í˜ˆê´€ëˆ„ì¶œì¦í›„êµ°)
4. ì¡°ì¹˜ ìš”ì²­ì¼ìê°€ ìˆë‹¤ë©´ í¬í•¨`,
                        example: '"EMA ë° MHRAì—ì„œ Vaxzevria ê´€ë ¨ ì•ˆì „ì„± ë¦¬ë·° ê²°ê³¼, SmPC 4.4í•­ì— í˜ˆì†ŒíŒê°ì†Œ ë™ë°˜/ë¹„ë™ë°˜ ë‡Œì •ë§¥ë™í˜ˆì „ì¦(CVST) ê²½ê³  ì¶”ê°€ë¥¼ ìš”êµ¬í•˜ì˜€ë‹¤."'
                    },
                    'CS56': {
                        name: 'ì°¸ê³ ì •ë³´ì˜ë³€ê²½ì„œìˆ ë¬¸',
                        source: '[RAW7_ì•ˆì „ì„±ì •ë³´ë³€ê²½]',
                        method: `ìš©ë²•ìš©ëŸ‰, íš¨ëŠ¥íš¨ê³¼, ì‚¬ìš©ìƒì£¼ì˜ì‚¬í•­ ë³€ê²½ í™•ì¸. ì„œìˆ ë¬¸ì— í¬í•¨í•  ë‚´ìš©:
1. ë³€ê²½ ë‚ ì§œ
2. ë³€ê²½ëœ ì„¹ì…˜ ì œëª© ë° ë²ˆí˜¸
3. ë³€ê²½ë‚´ìš© ìš”ì•½`,
                        example: '"2022ë…„ 1ì›” 6ì¼, 7. ì„ë¶€/ìˆ˜ìœ ë¶€ì— ëŒ€í•œ íˆ¬ì—¬ ì„¹ì…˜ì— ì„ì‹ ë¶€ ë°±ì‹  ì ‘ì¢… ê´€ë ¨ ìµœì‹  ì•ˆì „ì„± ë°ì´í„°ê°€ ë°˜ì˜ë˜ì—ˆë‹¤."'
                    },
                    'CS56.1': {
                        name: 'í—ˆê°€ì‚¬í•­ë³€ê²½ì¼',
                        source: '[RAW7_ì•ˆì „ì„±ì •ë³´ë³€ê²½]',
                        method: 'ë‹¨ì¼ ë‚ ì§œ: YYYYë…„ MMì›” DDì¼. ë³µìˆ˜: ë‚ ì§œ(ë³€ê²½ë‚´ìš©ìš”ì•½) í˜•íƒœ',
                        example: '"2022ë…„1ì›” 2ì¼(ìš©ë²•ìš©ëŸ‰ ë³€ê²½), 2024ë…„ 1ì›” 2ì¼(ì‚¬ìš©ìƒì˜ ì£¼ì˜ì‚¬í•­ ë³€ê²½)"'
                    },
                    'CS28': {
                        name: 'ì›ì‹œì´í™˜ììˆ˜',
                        source: '[Raw14_ì›ì‹œìë£ŒLineListing]',
                        method: 'Caseë²ˆí˜¸(ë¶€ì„œì ‘ìˆ˜ë²ˆí˜¸) ì¤‘ë³µ ì œê±° í›„ count. í™˜ììˆ˜ = ê³ ìœ  Case ìˆ˜',
                        example: '5'
                    },
                    'CS29': {
                        name: 'ì›ì‹œì´ì´ìƒì‚¬ë¡€ìˆ˜',
                        source: '[Raw14_ì›ì‹œìë£ŒLineListing]',
                        method: 'Event ì‹œíŠ¸ì—ì„œ MedDRA PT Term ê°œìˆ˜ count',
                        example: '9'
                    },
                    'CS30': {
                        name: 'ì›ì‹œì¤‘ëŒ€í•œì‚¬ë¡€ìˆ˜',
                        source: '[Raw14_ì›ì‹œìë£ŒLineListing]',
                        method: 'Seriousness=Yesì¸ eventë§Œ count. Event seriousnessì™€ Case seriousness ëª¨ë‘ ìˆìœ¼ë©´ Event seriousness ìš°ì„ ',
                        example: '4'
                    },
                    'CS33': {
                        name: 'ì‹ ì†ë³´ê³ ì´ì‚¬ë¡€ìˆ˜',
                        source: '[RAW12_êµ­ì™¸ì‹ ì†ë³´ê³ LineListing]+[RAW13_êµ­ë‚´ì‹ ì†ë³´ê³ LineListing]',
                        method: 'ì‹ ì†ë³´ê³  LineListingë“¤ì„ í•©ì³ì„œ ì´ìƒì‚¬ë¡€ ê°œìˆ˜ count',
                        example: '15'
                    },
                    'CS34': {
                        name: 'ì •ê¸°ë³´ê³ ì´ì‚¬ë¡€ìˆ˜',
                        source: '[RAW15_ì •ê¸°ë³´ê³ LineListing]',
                        method: 'Event ì‹œíŠ¸ì—ì„œ ì´ìƒì‚¬ë¡€ ê°œìˆ˜ count',
                        example: '5'
                    },
                    'CS25.1': {
                        name: 'ì‹ ì†ë³´ê³ ì¼ì',
                        source: '[RAW12] ë˜ëŠ” [RAW13]',
                        method: 'ë³´ê³ ì¼ì ì»¬ëŸ¼ì—ì„œ ì¶”ì¶œ',
                        example: '["2024-11-26", "2024-08-13", "2024-04-09"]'
                    },
                    'CS25.2': {
                        name: 'ì‹ ì†ê´€ë¦¬ë²ˆí˜¸',
                        source: '[RAW12] ë˜ëŠ” [RAW13]',
                        method: 'ê´€ë¦¬ë²ˆí˜¸ ì»¬ëŸ¼ì—ì„œ ì¶”ì¶œ',
                        example: '["DW-US-20301111", "DW-US-20301112"]'
                    },
                    // PH ë°ì´í„°
                    'PH4': {
                        name: 'ì›ì‹œìë£Œ ê¸°ë°˜ ì„œìˆ ë¬¸',
                        source: '[Raw14_ì›ì‹œìë£ŒLineListing]',
                        method: 'CS28, CS29, CS30ì„ í™œìš©í•˜ì—¬ ì„œìˆ ',
                        example: '"í‘œ7 ì›ì‹œìë£ŒLineListingì— ë”°ë¥´ë©´, ì´ 5ê±´ì˜ ê³ ìœ  ì¦ë¡€ì—ì„œ 9ê±´ì˜ ì´ìƒì‚¬ë¡€ê°€ ë³´ê³ ë˜ì—ˆìœ¼ë©°, ì´ ì¤‘ 4ê±´ì€ ì¤‘ëŒ€í•œ ì´ìƒì‚¬ë¡€ì˜€ìŠµë‹ˆë‹¤."'
                    },
                    'PH9': {
                        name: 'ë¬¸í—Œ ê²€ìƒ‰ ê²°ê³¼ ì„œìˆ ',
                        source: '[RAW9_ë¬¸í—Œìë£Œ]',
                        method: 'ë¬¸í—Œê²€ìƒ‰ ìˆ˜í–‰ ì—¬ë¶€ ë° ê²°ê³¼ ê¸°ìˆ . ê²€ìƒ‰ DB, ê²€ìƒ‰ì–´, ê²°ê³¼ ê±´ìˆ˜ í¬í•¨',
                        example: '"Pubmed, Koreamedì—ì„œ ì„±ë¶„ëª…+ì´ìƒì‚¬ë¡€ í‚¤ì›Œë“œë¡œ ê²€ìƒ‰í•œ ê²°ê³¼, ê´€ë ¨ ë¬¸í—Œ 0ê±´ í™•ì¸ë¨"'
                    },
                    // Table ë°ì´í„°
                    'T1': {
                        name: 'í‘œ1_ì „ì„¸ê³„íŒë§¤í—ˆê°€í˜„í™©',
                        source: '[RAW4_í—ˆê°€í˜„í™©]',
                        method: 'CS17.1~CS17.5 ë°ì´í„°ë¡œ í‘œ êµ¬ì„±',
                        example: '[{"êµ­ê°€": "í•œêµ­", "í—ˆê°€ì¼": "2021-03-05", "í’ˆëª©ëª…": "ì½”ë¯¸ë‚˜í‹°ì£¼", "í—ˆê°€ê¶Œì": "í•œêµ­í™”ì´ì", "ë¹„ê³ ": ""}]'
                    },
                    'T2': {
                        name: 'í‘œ2_ì—°ë„ë³„íŒë§¤ëŸ‰',
                        source: '[RAW3_ì‹œíŒí›„salesë°ì´í„°]',
                        method: 'ì—°ë„, íŒë§¤ëŸ‰ í‘œ í˜•íƒœë¡œ ì¶”ì¶œ',
                        example: '[{"ì—°ë„": "2020ë…„", "íŒë§¤ëŸ‰": "150,000ì •"}, {"ì—°ë„": "2021ë…„", "íŒë§¤ëŸ‰": "180,000ì •"}]'
                    },
                    'T5': {
                        name: 'í‘œ5_ì‹ ì†ë³´ê³ LineListing',
                        source: '[RAW12]+[RAW13]',
                        method: 'ì‹ ì†ë³´ê³  ëª©ë¡ì„ í‘œ í˜•íƒœë¡œ',
                        example: '[{"ë³´ê³ ì¼": "2024-11-26", "ê´€ë¦¬ë²ˆí˜¸": "DW-US-20301111", "ì´ìƒì‚¬ë¡€ëª…": "ë‘í†µ", "ë¹„ê³ ": ""}]'
                    },
                    'T6': {
                        name: 'í‘œ6_ì •ê¸°ë³´ê³ LineListing',
                        source: '[RAW15]',
                        method: 'ì •ê¸°ë³´ê³  ëª©ë¡ì„ í‘œ í˜•íƒœë¡œ',
                        example: '[{"ë³´ê³ ì¼": "2024-10-15", "ê´€ë¦¬ë²ˆí˜¸": "DW-KR-10001", "ì´ìƒì‚¬ë¡€ëª…": "ì˜¤ì‹¬", "ë¹„ê³ ": ""}]'
                    },
                    'T7': {
                        name: 'í‘œ7_ì›ì‹œìë£ŒLineListing',
                        source: '[RAW14]',
                        method: 'ì›ì‹œìë£Œ ëª©ë¡ì„ í‘œ í˜•íƒœë¡œ',
                        example: '[{"Caseë²ˆí˜¸": "KAERS-001", "PTëª…": "ë‘í†µ", "ì¤‘ëŒ€ì„±": "No"}, {"Caseë²ˆí˜¸": "KAERS-001", "PTëª…": "ì˜¤ì‹¬", "ì¤‘ëŒ€ì„±": "Yes"}]'
                    }
                },

            getRawDescription(rawId) {
                const descriptions = {
                    'RAW1': 'ìµœì‹ ì²¨ë¶€ë¬¸ì„œ (íš¨ëŠ¥íš¨ê³¼, ìš©ë²•ìš©ëŸ‰, ì‚¬ìš©ìƒì£¼ì˜ì‚¬í•­ í¬í•¨)',
                    'RAW2.1': 'ìš©ë²•ìš©ëŸ‰ ì „ë¬¸',
                    'RAW2.2': 'íš¨ëŠ¥íš¨ê³¼ ì „ë¬¸',
                    'RAW2.3': 'ì‚¬ìš©ìƒì£¼ì˜ì‚¬í•­ ì „ë¬¸',
                    'RAW2.6': 'ë³´ê³ ì‹œì‘ì‹œì  ì‚¬ìš©ìƒì£¼ì˜ì‚¬í•­',
                    'RAW3': 'ì‹œíŒí›„ sales ë°ì´í„° (ì—°ë„ë³„ íŒë§¤ëŸ‰)',
                    'RAW4': 'ì „ì„¸ê³„ í—ˆê°€í˜„í™©',
                    'RAW5': 'ì•ˆì „ì„±ì¡°ì¹˜ í—ˆê°€íŒ€ë©”ì¼',
                    'RAW6': 'ì•ˆì „ì„±ì¡°ì¹˜ í—ˆê°€íŒ€ë©”ì¼ ì·¨í•©ë³¸',
                    'RAW7': 'ì•ˆì „ì„±ì •ë³´ ë³€ê²½ì‚¬í•­',
                    'RAW7.1': 'ì•ˆì „ì„±ì •ë³´ ë³€ê²½ì‚¬í•­ (ë³µìˆ˜í•­ëª©)',
                    'RAW7.3': 'ì•ˆì „ì„±ì •ë³´ ë³€ê²½ì‚¬í•­ (ìš©ë²•ìš©ëŸ‰)',
                    'RAW7.4': 'ì•ˆì „ì„±ì •ë³´ ë³€ê²½ì‚¬í•­ (í‘œí˜•ì‹ ë³µìˆ˜í•­ëª©)',
                    'RAW8': 'ì„ìƒë…¸ì¶œ ë°ì´í„° (ì„ìƒì‹œí—˜ ì •ë³´)',
                    'RAW9': 'ë¬¸í—Œìë£Œ (ë¬¸í—Œê²€ìƒ‰ ê²°ê³¼)',
                    'RAW12': 'êµ­ì™¸ ì‹ ì†ë³´ê³  Line Listing',
                    'RAW13': 'êµ­ë‚´ ì‹ ì†ë³´ê³  Line Listing',
                    'RAW14': 'ì›ì‹œìë£Œ Line Listing',
                    'RAW15': 'ì •ê¸°ë³´ê³  Line Listing'
                };
                return descriptions[rawId] || rawId;
            },

            parseExtractionResponse(text, rawId) {
                const result = { csData: {}, phData: {}, tableData: {} };

                try {
                    // 1. ì™„ì „í•œ ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡ì—ì„œ JSON ì¶”ì¶œ ì‹œë„
                    let jsonStr = null;
                    const codeBlockMatch = text.match(/```(?:json)?\s*([\s\S]*?)```/);
                    if (codeBlockMatch) {
                        jsonStr = codeBlockMatch[1].trim();
                    }

                    // 2. ì½”ë“œ ë¸”ë¡ì´ ì—†ìœ¼ë©´ truncated ì½”ë“œ ë¸”ë¡ ì‹œë„ (ë‹«ëŠ” ``` ì—†ìŒ)
                    if (!jsonStr) {
                        const truncatedMatch = text.match(/```(?:json)?\s*([\s\S]*)/);
                        if (truncatedMatch) {
                            jsonStr = truncatedMatch[1].trim();
                        }
                    }

                    // 3. ì½”ë“œ ë¸”ë¡ì´ ì—†ìœ¼ë©´ ì¼ë°˜ JSON ë¸”ë¡ ì¶”ì¶œ
                    if (!jsonStr) {
                        const jsonMatch = text.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            jsonStr = jsonMatch[0];
                        }
                    }

                    if (!jsonStr) {
                        console.warn('âš ï¸ No JSON found in response for', rawId);
                        return result;
                    }

                    // JSON íŒŒì‹± ì‹œë„, ì‹¤íŒ¨ ì‹œ ë¶€ë¶„ íŒŒì‹±
                    let parsed;
                    try {
                        parsed = JSON.parse(jsonStr);
                    } catch (parseError) {
                        // Truncated JSON ë³µêµ¬ ì‹œë„: ë¶ˆì™„ì „í•œ JSON ìˆ˜ì •
                        console.warn(`âš ï¸ Attempting to repair truncated JSON for ${rawId}`);
                        let repairedJson = jsonStr;

                        // 1. ë¶ˆì™„ì „í•œ í‚¤-ê°’ ìŒ ì œê±° (ì˜ˆ: "key": nul, "key": tru, "key": "incomplete)
                        repairedJson = repairedJson.replace(/,?\s*"[^"]*"\s*:\s*(?:nul|tru|fal|"[^"]*)?$/g, '');

                        // 2. ë§ˆì§€ë§‰ìœ¼ë¡œ ì™„ì „í•œ ê°’ ì°¾ê¸° (ì‰¼í‘œë¡œ ëë‚˜ëŠ” í‚¤-ê°’ ìŒ)
                        const lastCommaPatterns = ['"},', 'null,', 'true,', 'false,', '},', '],'];
                        let lastValidPos = -1;
                        lastCommaPatterns.forEach(pattern => {
                            const pos = repairedJson.lastIndexOf(pattern);
                            if (pos > lastValidPos) {
                                lastValidPos = pos + pattern.length - 1; // ì‰¼í‘œ ìœ„ì¹˜
                            }
                        });

                        // 3. ì™„ì „í•œ ê°’ ìœ„ì¹˜ê¹Œì§€ ìë¥´ê¸° (ì‰¼í‘œ ì œê±°)
                        if (lastValidPos > 0) {
                            repairedJson = repairedJson.substring(0, lastValidPos);
                        }

                        // 4. ì—´ë¦° ê´„í˜¸ ìˆ˜ ê³„ì‚° ë° ë‹«ê¸°
                        const openBraces = (repairedJson.match(/\{/g) || []).length;
                        const closeBraces = (repairedJson.match(/\}/g) || []).length;
                        const openBrackets = (repairedJson.match(/\[/g) || []).length;
                        const closeBrackets = (repairedJson.match(/\]/g) || []).length;

                        for (let i = 0; i < openBrackets - closeBrackets; i++) {
                            repairedJson += ']';
                        }
                        for (let i = 0; i < openBraces - closeBraces; i++) {
                            repairedJson += '}';
                        }

                        try {
                            parsed = JSON.parse(repairedJson);
                            console.log(`âœ… Repaired JSON for ${rawId}:`, Object.keys(parsed));
                        } catch (e2) {
                            throw parseError; // ì›ë˜ ì—ëŸ¬ ë˜ì§€ê¸°
                        }
                    }

                    Object.keys(parsed).forEach(key => {
                        const value = parsed[key];
                        if (value && value !== 'null' && value !== null) {
                            if (key.startsWith('CS')) {
                                result.csData[key] = { value: value, source: rawId };
                            } else if (key.startsWith('PH')) {
                                result.phData[key] = { value: value, source: rawId };
                            } else if (key.startsWith('T') && /^T\d+/.test(key)) {
                                // Table ë°ì´í„° (T1-T9)
                                result.tableData[key] = { value: value, source: rawId };
                            }
                        }
                    });

                    console.log(`âœ… Parsed extraction for ${rawId}:`, result);
                } catch (e) {
                    console.error('âŒ JSON parse error:', e.message, 'Raw:', text.substring(0, 500));
                }

                return result;
            },

            mergeExtractedData(extractionResults) {
                console.log('ğŸ“Š Merging extracted data...');
                const merged = { csData: {}, phData: {}, tableData: {} };
                this.conflicts = [];

                extractionResults.forEach(result => {
                    // Merge CS Data
                    Object.keys(result.csData || {}).forEach(key => {
                        if (!merged.csData[key]) {
                            merged.csData[key] = result.csData[key];
                        } else if (merged.csData[key].value !== result.csData[key].value) {
                            // ì¶©ëŒ ë°œìƒ
                            this.conflicts.push({
                                field: key,
                                options: [
                                    { value: merged.csData[key].value, source: merged.csData[key].source },
                                    { value: result.csData[key].value, source: result.csData[key].source }
                                ]
                            });
                        }
                    });

                    // Merge PH Data
                    Object.keys(result.phData || {}).forEach(key => {
                        if (!merged.phData[key]) {
                            merged.phData[key] = result.phData[key];
                        }
                    });

                    // Merge Table Data
                    Object.keys(result.tableData || {}).forEach(key => {
                        if (!merged.tableData[key]) {
                            merged.tableData[key] = result.tableData[key];
                        }
                    });
                });

                // CS17 ìë™ ìƒì„± (CS17.1~CS17.5 ë³‘ë ¬ ë°°ì—´ì—ì„œ)
                this.generateCS17FromParallelArrays(merged);

                console.log('âœ… Merged data:', merged);
                return merged;
            },

            getConflictData() {
                return this.conflicts;
            },

            // CS17 ìë™ ìƒì„±: CS17.1~CS17.5 ë³‘ë ¬ ë°°ì—´ì—ì„œ ê°ì²´ ë°°ì—´ë¡œ ë³€í™˜
            generateCS17FromParallelArrays(merged) {
                const cs171 = merged.csData['CS17.1'];
                const cs172 = merged.csData['CS17.2'];
                const cs173 = merged.csData['CS17.3'];
                const cs174 = merged.csData['CS17.4'];
                const cs175 = merged.csData['CS17.5'];

                // CS17.1ì´ ë°°ì—´ì¸ ê²½ìš°ì—ë§Œ ì²˜ë¦¬
                if (cs171 && Array.isArray(cs171.value) && cs171.value.length > 0) {
                    const tableArray = cs171.value.map((country, i) => ({
                        êµ­ê°€: country,
                        í—ˆê°€ì¼: cs172?.value?.[i] || null,
                        í’ˆëª©ëª…: cs173?.value?.[i] || null,
                        í—ˆê°€ê¶Œì: cs174?.value?.[i] || null,
                        ë¹„ê³ : Array.isArray(cs175?.value) ? cs175.value[i] : null
                    }));

                    merged.csData['CS17'] = {
                        value: tableArray,
                        source: 'auto-generated'
                    };

                    console.log('âœ… CS17 ìë™ ìƒì„± ì™„ë£Œ:', tableArray.length, 'ê°œ í–‰');
                }
            }
        };

        // AuthManager stub - minimal implementation
        const authManager = {
            getCurrentUser() {
                const session = Storage.get(CONFIG.STORAGE_KEYS.SESSION);
                return session ? session.user : null;
            },

            checkSession() {
                const session = Storage.get(CONFIG.STORAGE_KEYS.SESSION);
                if (!session) {
                    return { authenticated: false };
                }
                return {
                    authenticated: true,
                    user: session.user,
                    session: session
                };
            },

            redirectToLogin() {
                window.location.href = CONFIG.PAGES.LOGIN;
            }
        };

        // AppLayout stub - simple layout wrapper without ES6 modules
        class AppLayout {
            constructor(options = {}) {
                this.currentStage = options.currentStage || 0;
                this.reportName = options.reportName || '';
            }

            render(content) {
                // Load session data for user info
                const session = Storage.get('session') || {};
                const userName = session.userName || 'ì‚¬ìš©ì';
                const userRole = session.userRole || 'Author';
                const userInitial = userName.charAt(0);

                // Render full layout with header
                return `
                    <div class="app-layout">
                        <!-- Header -->
                        <header class="app-header">
                            <div class="header-left">
                                <div class="logo">
                                    <span class="logo-text">KPSUR AGENT</span>
                                    <span class="logo-subtitle">ACUZEN AI</span>
                                </div>
                                <span class="deployment-badge test">í…ŒìŠ¤íŠ¸</span>
                            </div>

                            <div class="header-center">
                                <div class="breadcrumb">
                                    <span class="breadcrumb-item" onclick="navigateTo('P10_Dashboard.html')" style="cursor: pointer;">ëŒ€ì‹œë³´ë“œ</span>
                                    <span class="breadcrumb-separator">/</span>
                                    <span class="breadcrumb-item">ë³´ê³ ì„œ</span>
                                    <span class="breadcrumb-separator">/</span>
                                    <span class="breadcrumb-item active">ë°ì´í„° ì¶”ì¶œ</span>
                                </div>
                            </div>

                            <div class="header-right">
                                <button class="dark-mode-toggle" onclick="toggleDarkMode()" title="ë‹¤í¬ëª¨ë“œ ì „í™˜">
                                    <span class="icon-sun">â˜€ï¸</span>
                                    <span class="icon-moon">ğŸŒ™</span>
                                </button>
                                <div class="user-menu">
                                    <div class="user-avatar">${userInitial}</div>
                                    <div class="user-info">
                                        <div class="user-name">${userName}</div>
                                        <div class="user-role">${userRole}</div>
                                    </div>
                                    <button class="user-menu-toggle">â–¼</button>
                                </div>
                            </div>
                        </header>

                        ${content}
                    </div>
                `;
            }
        }

        // Load converted markdown files from localStorage
        const convertedMarkdowns = Storage.get('convertedMarkdowns') || [];
        const markdownFiles = convertedMarkdowns.map((file, index) => {
            const category = ['RAW12', 'RAW14', 'RAW15'].includes(file.rawId) ? 'lineListing' : 'required';
            return {
                id: index + 1,
                rawId: file.rawId,
                name: file.fileName.replace(/\.(pdf|xlsx|docx|txt)$/i, '.md'),
                markdown: file.markdown,
                category: category,
                status: 'pending'
            };
        });

        // CS Data template (Source-CS-Sections.md ê¸°ì¤€ - 60ê°œ)
        const csDataTemplate = [
            // ì‚¬ìš©ìì…ë ¥ í•„ë“œ (00_í‘œì§€, 03_ì„œë¡  ë“±)
            { id: 'CS0', label: 'CS0_ì„±ë¶„ëª…', value: '', source: 'user_input', hasConflict: false },
            { id: 'CS1', label: 'CS1_ë¸Œëœë“œëª…', value: '', source: 'user_input', hasConflict: false },
            { id: 'CS2', label: 'CS2_íšŒì‚¬ëª…', value: '', source: 'user_input', hasConflict: false },
            { id: 'CS3', label: 'CS3_ë³´ê³ ì‹œì‘ë‚ ì§œ', value: '', source: 'calculated', hasConflict: false },  // CS4 - 5ë…„
            { id: 'CS4', label: 'CS4_ë³´ê³ ì¢…ë£Œë‚ ì§œ', value: '', source: 'user_input', hasConflict: false },
            { id: 'CS5', label: 'CS5_êµ­ë‚´í—ˆê°€ì¼ì', value: '', source: 'user_input', hasConflict: false },
            { id: 'CS6', label: 'CS6_ë³´ê³ ì„œì œì¶œì¼', value: '', source: 'user_input', hasConflict: false },
            { id: 'CS7', label: 'CS7_ë²„ì „ë„˜ë²„', value: '', source: 'user_input', hasConflict: false },
            { id: 'CS8', label: 'CS8_ë²„ì „ë‚ ì§œ', value: '', source: 'calculated', hasConflict: false },  // CS4ì™€ ë™ì¼
            // ëª©ì°¨ ê´€ë ¨ (ìƒì„±ë¬¸ì„œì „ë°˜)
            { id: 'CS9', label: 'CS9_ëª©ì°¨', value: '', source: 'auto_generated', hasConflict: false },
            { id: 'CS10', label: 'CS10_í‘œëª©ì°¨', value: '', source: 'auto_generated', hasConflict: false },
            { id: 'CS11', label: 'CS11_ë³„ì²¨ëª©ì°¨', value: '', source: 'auto_generated', hasConflict: false },
            { id: 'CS12', label: 'CS12_ì•½ì–´í‘œ', value: '', source: 'auto_generated', hasConflict: false },
            // ì„œë¡  ê´€ë ¨
            { id: 'CS13', label: 'CS13_ìœ íš¨ê¸°ê°„', value: '', source: 'user_input', hasConflict: false },
            { id: 'CS14', label: 'CS14_ì‹ ì²­ê¸°í•œ', value: '', source: 'calculated', hasConflict: false },  // CS13 - 6ê°œì›”
            { id: 'CS15', label: 'CS15_íš¨ëŠ¥íš¨ê³¼', value: '', source: 'RAW1/RAW2.2', hasConflict: false },
            { id: 'CS16', label: 'CS16_ìš©ë²•ìš©ëŸ‰', value: '', source: 'RAW1/RAW2.1', hasConflict: false },
            // í—ˆê°€í˜„í™© (RAW4)
            { id: 'CS17', label: 'CS17_ì „ì„¸ê³„í—ˆê°€í˜„í™©í‘œ', value: '', source: 'RAW4', hasConflict: false },
            { id: 'CS17.1', label: 'CS17.1_í—ˆê°€êµ­ê°€', value: '', source: 'RAW4', hasConflict: false },
            { id: 'CS17.2', label: 'CS17.2_í—ˆê°€ì¼', value: '', source: 'RAW4', hasConflict: false },
            { id: 'CS17.3', label: 'CS17.3_í—ˆê°€í’ˆëª©ëª…', value: '', source: 'RAW4', hasConflict: false },
            { id: 'CS17.4', label: 'CS17.4_í—ˆê°€ê¶Œì', value: '', source: 'RAW4', hasConflict: false },
            { id: 'CS17.5', label: 'CS17.5_í—ˆê°€ë¹„ê³ ', value: '', source: 'RAW4', hasConflict: false },
            { id: 'CS17.6', label: 'CS17.6_í—ˆê°€í˜„í™©ì„œìˆ ë¬¸', value: '', source: 'RAW4', hasConflict: false },
            // ì„ìƒì‹œí—˜ (RAW8)
            { id: 'CS18', label: 'CS18_ì„ìƒë…¸ì¶œ', value: '', source: 'RAW8', hasConflict: false },
            // í™˜ìë…¸ì¶œ (RAW3)
            { id: 'CS19', label: 'CS19_ì‹œíŒí›„ë…¸ì¶œcountì‹œì‘ë‚ ì§œ', value: '', source: 'RAW3', hasConflict: false },
            { id: 'CS19.1', label: 'CS19.1_ì‹œíŒí›„ë…¸ì¶œcountì¢…ë£Œë‚ ì§œ', value: '', source: 'RAW3', hasConflict: false },
            { id: 'CS19.2', label: 'CS19.2_ì‹œíŒí›„íŒë§¤ì—°ë„ë³„íŒë§¤ëŸ‰', value: '', source: 'RAW3', hasConflict: false },
            { id: 'CS19.3', label: 'CS19.3_ì‹œíŒí›„íŒë§¤ëŸ‰í•©ê³„', value: '', source: 'calculated', hasConflict: false },
            { id: 'CS20', label: 'CS20_1ì¼ì‚¬ìš©ëŸ‰', value: '', source: 'RAW1/RAW2.1', hasConflict: false },
            { id: 'CS21', label: 'CS21_í™˜ì1ëª…ë‹¹ì‚¬ìš©ëŸ‰', value: '', source: 'calculated', hasConflict: false },  // CS20 Ã— 365
            { id: 'CS22', label: 'CS22_ì—°í‰ê· íŒë§¤ëŸ‰', value: '', source: 'calculated', hasConflict: false },
            { id: 'CS23', label: 'CS23_ì—°í‰ê· í™˜ìë…¸ì¶œ', value: '', source: 'calculated', hasConflict: false },  // CS22 / CS21
            // ê°œë³„ì¦ë¡€ë³‘ë ¥
            { id: 'CS24', label: 'CS24_MedDRAë²„ì „', value: '', source: 'user_input', hasConflict: false },
            { id: 'CS25.1', label: 'CS25.1_ì‹ ì†ë³´ê³ ì¼ì', value: '', source: 'RAW12/RAW13', hasConflict: false },
            { id: 'CS25.2', label: 'CS25.2_ì‹ ì†ë³´ê³ ê´€ë¦¬ë²ˆí˜¸', value: '', source: 'RAW12/RAW13', hasConflict: false },
            { id: 'CS25.3', label: 'CS25.3_ì‹ ì†ë³´ê³ ì´ìƒì‚¬ë¡€ëª…', value: '', source: 'RAW12/RAW13', hasConflict: false },
            { id: 'CS25.4', label: 'CS25.4_ì‹ ì†ë³´ê³ ë¹„ê³ ', value: '', source: 'RAW12/RAW13', hasConflict: false },
            { id: 'CS28', label: 'CS28_ì›ì‹œì´í™˜ììˆ˜', value: '', source: 'RAW14', hasConflict: false },
            { id: 'CS29', label: 'CS29_ì›ì‹œì´ì´ìƒì‚¬ë¡€ìˆ˜', value: '', source: 'RAW14', hasConflict: false },
            { id: 'CS30', label: 'CS30_ì›ì‹œì¤‘ëŒ€í•œì‚¬ë¡€ìˆ˜', value: '', source: 'RAW14', hasConflict: false },
            { id: 'CS31', label: 'CS31_ì›ì‹œìë£Œì‹ ì²­ì¼', value: '', source: 'user_input', hasConflict: false },
            { id: 'CS32', label: 'CS32_ì „ì²´ë³´ê³ ê±´ìˆ˜', value: '', source: 'calculated', hasConflict: false },  // CS33 + CS34
            { id: 'CS33', label: 'CS33_ì‹ ì†ë³´ê³ ê±´ìˆ˜', value: '', source: 'RAW12/RAW13', hasConflict: false },
            { id: 'CS34', label: 'CS34_ì •ê¸°ë³´ê³ ê±´ìˆ˜', value: '', source: 'RAW15', hasConflict: false },
            { id: 'CS35', label: 'CS35_ì „ì²´ì´ìƒì‚¬ë¡€ê±´ìˆ˜', value: '', source: 'calculated', hasConflict: false },  // CS33 + CS34 + CS29
            { id: 'CS36', label: 'CS36_ì¤‘ëŒ€í•œì´ìƒì‚¬ë¡€ê±´ìˆ˜', value: '', source: 'RAW12/13/14/15', hasConflict: false },
            { id: 'CS37', label: 'CS37_ë¹„ì¤‘ëŒ€ì´ìƒì‚¬ë¡€ê±´ìˆ˜', value: '', source: 'RAW12/13/14/15', hasConflict: false },
            // ë¬¸í—Œ
            { id: 'CS53', label: 'CS53_ë¬¸í—ŒDBëª…', value: '', source: 'user_input', hasConflict: false },
            // ì•ˆì „ì„±ì¡°ì¹˜ (RAW5/RAW6)
            { id: 'CS55', label: 'CS55_ì•ˆì „ì„±ì¡°ì¹˜ì„œìˆ ë¬¸', value: '', source: 'RAW5/RAW6', hasConflict: false },
            // ì•ˆì „ì„±ì •ë³´ë³€ê²½ (RAW7)
            { id: 'CS56', label: 'CS56_ì°¸ê³ ì •ë³´ì˜ë³€ê²½ì„œìˆ ë¬¸', value: '', source: 'RAW7', hasConflict: false },
            { id: 'CS56.1', label: 'CS56.1_í—ˆê°€ì‚¬í•­ë³€ê²½ì¼', value: '', source: 'RAW7', hasConflict: false },
            { id: 'CS56.2', label: 'CS56.2_ê¸°ì¡´íš¨ëŠ¥íš¨ê³¼', value: '', source: 'RAW7', hasConflict: false },
            { id: 'CS56.3', label: 'CS56.3_ê¸°ì¡´ìš©ëŸ‰ìš©ë²•', value: '', source: 'RAW7', hasConflict: false },
            { id: 'CS56.4', label: 'CS56.4_ê¸°ì¡´ì‚¬ìš©ìƒì˜ì£¼ì˜ì‚¬í•­', value: '', source: 'RAW7', hasConflict: false },
            { id: 'CS56.5', label: 'CS56.5_ìµœì‹ íš¨ëŠ¥íš¨ê³¼', value: '', source: 'RAW7', hasConflict: false },
            { id: 'CS56.6', label: 'CS56.6_ìµœì‹ ìš©ë²•ìš©ëŸ‰', value: '', source: 'RAW7', hasConflict: false },
            { id: 'CS56.7', label: 'CS56.7_ìµœì‹ ì‚¬ìš©ìƒì£¼ì˜ì‚¬í•­', value: '', source: 'RAW7', hasConflict: false },
            // ì°¸ê³ ë¬¸í—Œ
            { id: 'CS57', label: 'CS57_ì°¸ê³ ë¬¸í—Œëª©ë¡', value: '', source: 'auto_generated', hasConflict: false }
        ];

        // PH Data template (Source-CS-Sections.md ê¸°ì¤€ - 9ê°œ ì„œìˆ ë¬¸)
        const phDataTemplate = [
            { id: 'PH4', label: 'PH4_ì›ì‹œìë£Œê¸°ë°˜ì„œìˆ ë¬¸', value: '', source: 'RAW14/T7' },  // í‘œ7, CS28, CS29, CS30 í™œìš©
            { id: 'PH5', label: 'PH5_ì›ì‹œìë£Œê°„ë‹¨ìš”ì•½', value: '', source: 'RAW14/T7' },
            { id: 'PH6', label: 'PH6_ê°œë³„ì¦ë¡€ë¶„ì„ì„œìˆ ', value: '', source: 'RAW12/13/14/15' },  // ëª¨ë“  LL í†µí•©
            { id: 'PH7', label: 'PH7_ìƒˆë¡œë¶„ì„ëœì‹œí—˜ì„œìˆ ', value: '', source: 'auto_generated' },
            { id: 'PH8', label: 'PH8_ì‹œì‘ì§„í–‰ì¤‘ì‹œí—˜ì„œìˆ ', value: '', source: 'auto_generated' },
            { id: 'PH9', label: 'PH9_ë¬¸í—Œê²€ìƒ‰ê²°ê³¼ì„œìˆ ', value: '', source: 'RAW9' },  // CS53 DB í™œìš©
            { id: 'PH10', label: 'PH10_ìœ íš¨ì„±ê´€ë ¨ì´ìƒì‚¬ë¡€ë¶„ì„', value: '', source: 'RAW12/13/14/15' },
            { id: 'PH11', label: 'PH11_ì „ì²´ë°ì´í„°ì¢…í•©í‰ê°€', value: '', source: 'auto_generated' },
            { id: 'PH12', label: 'PH12_ìœ ìµì„±ìœ„í•´ì„±í‰ê°€ê²°ë¡ ', value: '', source: 'auto_generated' }
        ];

        // Table Data template (Source-CS-Sections.md ê¸°ì¤€ - 9ê°œ í‘œ)
        const tableDataTemplate = [
            { id: 'T1', label: 'í‘œ1_ì „ì„¸ê³„íŒë§¤í—ˆê°€í˜„í™©', hasData: false, rows: [], source: 'RAW4' },  // CS17.1~CS17.5
            { id: 'T2', label: 'í‘œ2_ì—°ë„ë³„íŒë§¤ëŸ‰', hasData: false, rows: [], source: 'RAW3' },  // CS19.1 Ã— CS19.2
            { id: 'T3', label: 'í‘œ3_í™˜ìë…¸ì¶œê³„ì‚°í‘œ', hasData: false, rows: [], source: 'calculated' },  // CS20, CS21, CS22, CS23
            { id: 'T4', label: 'í‘œ4_ì¦ë¡€ë¶„ë¥˜', hasData: false, rows: [], source: 'fixed_template' },  // ê³ ì • í…œí”Œë¦¿
            { id: 'T5', label: 'í‘œ5_ì‹ ì†ë³´ê³ LineListing', hasData: false, rows: [], source: 'RAW12/RAW13' },  // ìˆœë²ˆ, ë³´ê³ ì¼ì, ê´€ë¦¬ë²ˆí˜¸, ì´ìƒì‚¬ë¡€ëª…, ë¹„ê³ 
            { id: 'T6', label: 'í‘œ6_ì •ê¸°ë³´ê³ LineListing', hasData: false, rows: [], source: 'RAW15' },
            { id: 'T7', label: 'í‘œ7_ì›ì‹œìë£ŒLineListing', hasData: false, rows: [], source: 'RAW14' },
            { id: 'T8', label: 'í‘œ8_Seriousnessë¶„ë¥˜', hasData: false, rows: [], source: 'RAW12/13/14/15' },  // CS35, CS36, CS37
            { id: 'T9', label: 'í‘œ9_MedDRA_SOC_PTí”¼ë²—', hasData: false, rows: [], source: 'RAW12/13/14/15' }
        ];

        let selectedFile = null;
        let currentTab = 'cs';
        let csData = JSON.parse(JSON.stringify(csDataTemplate));
        let phData = JSON.parse(JSON.stringify(phDataTemplate));
        let tableData = JSON.parse(JSON.stringify(tableDataTemplate));
        let conflictData = null;

        // Initialize the page
        function init() {
            const layout = new AppLayout({
                currentStage: 5,
                reportName: 'testPill_1'
            });

            const content = `
                <div class="app-content">
                <main class="main-content">
                <div class="extraction-container">
                    <!-- Left Panel - File List -->
                    <div class="file-list-panel">
                        <div class="file-list-header">
                            <h3>ğŸ“„ ë§ˆí¬ë‹¤ìš´ íŒŒì¼</h3>
                            <div class="file-stats">
                                <span id="completedCount">0</span>/<span id="totalCount">${markdownFiles.length}</span>
                            </div>
                        </div>

                        <div class="file-category">
                            <div class="file-category-title">í•„ìˆ˜ ë¬¸ì„œ</div>
                            <div id="requiredFiles"></div>
                        </div>

                        <div class="file-category">
                            <div class="file-category-title">Line Listing</div>
                            <div id="lineListingFiles"></div>
                        </div>
                    </div>

                    <!-- Main Panel - Data Extraction -->
                    <div class="data-panel">
                        <div class="data-panel-header">
                            <h2 class="data-panel-title">ğŸ“Š ë°ì´í„° ì¶”ì¶œ (Stage 5)</h2>

                            <div class="extraction-warning">
                                <div class="extraction-warning-title">âš ï¸ ë°ì´í„° ì¶”ì¶œ ì›ì¹™</div>
                                <div class="extraction-warning-text">
                                    <strong>1. ì ˆëŒ€ ë°ì´í„°ë¥¼ ìƒì„±í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤</strong> - ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì‚¬ìš©ìì—ê²Œ ìš”ì²­<br>
                                    <strong>2. ì¶©ëŒ ë°ì´í„°ëŠ” ì„ì˜ë¡œ ì„ íƒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤</strong> - ëª¨ë“  ì˜µì…˜ì„ ì‚¬ìš©ìì—ê²Œ ì œì‹œ
                                </div>
                            </div>

                            <div class="extraction-progress">
                                <div class="progress-stats">
                                    <div class="progress-stat">
                                        <div class="progress-stat-label">CS ë°ì´í„°</div>
                                        <div class="progress-stat-value"><span id="csExtracted">0</span>/${csDataTemplate.length}</div>
                                    </div>
                                    <div class="progress-stat">
                                        <div class="progress-stat-label">PH ë°ì´í„°</div>
                                        <div class="progress-stat-value"><span id="phExtracted">0</span>/${phDataTemplate.length}</div>
                                    </div>
                                    <div class="progress-stat">
                                        <div class="progress-stat-label">í‘œ ë°ì´í„°</div>
                                        <div class="progress-stat-value"><span id="tableExtracted">0</span>/${tableDataTemplate.length}</div>
                                    </div>
                                </div>
                                <div class="progress-bar-container">
                                    <div id="progressBar" class="progress-bar" style="width: 0%"></div>
                                </div>
                            </div>

                            <div class="extraction-controls">
                                <select class="llm-model-select" id="llmModel">
                                    <option value="gemini-2.5-flash">Gemini 2.5 Flash (ë¹ ë¦„)</option>
                                    <option value="gemini-2.5-pro">Gemini 2.5 Pro (ì •í™•)</option>
                                </select>
                                <button class="btn btn-primary magic-effect" onclick="startExtraction()">
                                    âœ¨ AI ë°ì´í„° ì¶”ì¶œ ì‹œì‘
                                </button>
                                <button class="btn btn-secondary" onclick="exportData()">
                                    ğŸ’¾ ë°ì´í„° ì €ì¥
                                </button>
                                <button class="btn btn-primary" onclick="generatePSURReport()" id="generatePsurBtn" style="background: linear-gradient(135deg, #059669 0%, #10B981 100%);">
                                    ğŸ“„ PSUR ë³´ê³ ì„œ ìƒì„±
                                </button>
                                <button class="btn btn-success" onclick="proceedToNext()">
                                    ë‹¤ìŒ ë‹¨ê³„ â†’
                                </button>
                            </div>
                        </div>

                        <div class="data-tabs">
                            <button class="data-tab active" onclick="switchTab('cs')">CS ë°ì´í„° (52)</button>
                            <button class="data-tab" onclick="switchTab('ph')">PH ë°ì´í„° (9)</button>
                            <button class="data-tab" onclick="switchTab('table')">í‘œ ë°ì´í„° (9)</button>
                        </div>

                        <div class="data-content">
                            <!-- CS Data Section -->
                            <div id="csSection" class="data-section active">
                                <div class="cs-data-grid" id="csDataGrid"></div>
                            </div>

                            <!-- PH Data Section -->
                            <div id="phSection" class="data-section">
                                <div class="ph-data-list" id="phDataList"></div>
                            </div>

                            <!-- Table Data Section -->
                            <div id="tableSection" class="data-section">
                                <div class="table-data-list" id="tableDataList"></div>
                            </div>
                        </div>
                    </div>
                </div>
                </main>
                </div>

                <!-- Footer -->
                <footer class="app-footer">
                    <div class="footer-content">
                        Copyright. Power Solution., Inc. 2026.
                    </div>
                </footer>
            `;

            const appElement = document.getElementById('app');
            const header = appElement.querySelector('.app-header');
            if (header) {
                header.insertAdjacentHTML('afterend', layout.render(content));
            } else {
                appElement.innerHTML = layout.render(content);
            }

            // ì‚¬ìš©ì ì…ë ¥ ë°ì´í„° ë¡œë“œ (P13ì—ì„œ ì €ì¥í•œ ë°ì´í„°)
            loadUserInputData();

            renderFileList();
            renderCSData();
            renderPHData();
            renderTableData();
            updateStats();
        }

        // ì‚¬ìš©ì ì…ë ¥ ë°ì´í„° ë¡œë“œ (P13_NewReportì—ì„œ ì €ì¥í•œ ë°ì´í„°)
        function loadUserInputData() {
            try {
                const savedData = localStorage.getItem('current_report');
                if (!savedData) {
                    console.log('â„¹ï¸ ì €ì¥ëœ ì‚¬ìš©ì ì…ë ¥ ë°ì´í„° ì—†ìŒ');
                    return;
                }

                const userInput = JSON.parse(savedData);
                console.log('ğŸ“¥ ì‚¬ìš©ì ì…ë ¥ ë°ì´í„° ë¡œë“œ:', userInput);

                // CS ë°ì´í„°ì— ì‚¬ìš©ì ì…ë ¥ ê°’ ì±„ìš°ê¸° (01_CSData_Definition.md ê¸°ì¤€)
                const userInputFields = ['CS0', 'CS1', 'CS2', 'CS4', 'CS5', 'CS6', 'CS7', 'CS13', 'CS24', 'CS31', 'CS53'];

                userInputFields.forEach(fieldId => {
                    if (userInput[fieldId]) {
                        const csItem = csData.find(item => item.id === fieldId);
                        if (csItem) {
                            csItem.value = userInput[fieldId];
                            csItem.source = 'user_input';
                            console.log(`  âœ… ${fieldId}: ${userInput[fieldId]}`);
                        }
                    }
                });

                // ì¶”ê°€ ë©”íƒ€ ì •ë³´ ì €ì¥ (ë‚˜ì¤‘ì— í•„ìš”í•  ìˆ˜ ìˆìŒ)
                window.currentReportMeta = {
                    reportId: userInput.reportId,
                    createdAt: userInput.createdAt,
                    authorName: userInput.authorName,
                    authorPosition: userInput.authorPosition,
                    description: userInput.description
                };

                console.log('âœ… ì‚¬ìš©ì ì…ë ¥ ë°ì´í„° ë¡œë“œ ì™„ë£Œ');

            } catch (e) {
                console.error('âŒ ì‚¬ìš©ì ì…ë ¥ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
            }
        }

        // Render file list
        function renderFileList() {
            const requiredFiles = markdownFiles.filter(f => f.category === 'required');
            const lineListingFiles = markdownFiles.filter(f => f.category === 'lineListing');

            document.getElementById('requiredFiles').innerHTML = requiredFiles.map(file => `
                <div class="file-item ${selectedFile?.id === file.id ? 'selected' : ''}" onclick="showMarkdownPopup(${file.id})">
                    <div class="file-name">${file.name}</div>
                    <div class="file-meta">
                        <span>${file.rawId}</span>
                        <span class="file-status ${file.status}">${getStatusLabel(file.status)}</span>
                    </div>
                </div>
            `).join('');

            document.getElementById('lineListingFiles').innerHTML = lineListingFiles.map(file => `
                <div class="file-item ${selectedFile?.id === file.id ? 'selected' : ''}" onclick="showMarkdownPopup(${file.id})">
                    <div class="file-name">${file.name}</div>
                    <div class="file-meta">
                        <span>${file.rawId}</span>
                        <span class="file-status ${file.status}">${getStatusLabel(file.status)}</span>
                    </div>
                </div>
            `).join('');
        }

        function getStatusLabel(status) {
            const labels = {
                'pending': 'ëŒ€ê¸°',
                'extracting': 'ì¶”ì¶œ ì¤‘',
                'completed': 'ì™„ë£Œ',
                'conflict': 'ì¶©ëŒ',
                'error': 'ì˜¤ë¥˜'
            };
            return labels[status] || status;
        }

        // ë°ì´í„° ê°’ í¬ë§·íŒ… (ë°°ì—´, ê°ì²´ ì²˜ë¦¬)
        function formatDataValue(value) {
            try {
                if (value === null || value === undefined) {
                    return 'ë°ì´í„° ì—†ìŒ';
                }

                // CS17 ê°™ì€ ê°ì²´ ë°°ì—´ì¸ ê²½ìš° í…Œì´ë¸”ë¡œ í‘œì‹œ
                if (Array.isArray(value) && value.length > 0) {
                    const firstItem = value[0];
                    if (firstItem != null && typeof firstItem === 'object' && !Array.isArray(firstItem)) {
                        const headers = Object.keys(firstItem);
                        if (headers.length > 0) {
                            let table = '<table class="cs-data-table"><thead><tr>';
                            headers.forEach(h => table += `<th>${h}</th>`);
                            table += '</tr></thead><tbody>';
                            value.forEach(row => {
                                if (row != null) {
                                    table += '<tr>';
                                    headers.forEach(h => table += `<td>${row[h] ?? '-'}</td>`);
                                    table += '</tr>';
                                }
                            });
                            table += '</tbody></table>';
                            return table;
                        }
                    }
                    // ì¼ë°˜ ë°°ì—´ì¸ ê²½ìš° (CS17.1 ë“±)
                    return value.map(v => v ?? '-').join(', ');
                }

                // ì¼ë°˜ ê°’
                return String(value);
            } catch (e) {
                console.error('formatDataValue error:', e, value);
                return String(value);
            }
        }

        // Render CS Data
        function renderCSData() {
            const grid = document.getElementById('csDataGrid');
            grid.innerHTML = csData.map(item => `
                <div class="cs-data-item ${item.value ? 'has-value' : ''} ${item.hasConflict ? 'has-conflict' : ''}">
                    <div class="cs-data-label">
                        ${item.label}
                        ${item.hasConflict ? '<span class="conflict-indicator" onclick="showConflict(\'' + item.id + '\')">ì¶©ëŒ</span>' : ''}
                        ${!item.value && !item.hasConflict ? '<span class="missing-indicator">ë¯¸í™•ë³´</span>' : ''}
                    </div>
                    <div class="cs-data-value ${item.value ? '' : 'empty'} editable" onclick="editCSData('${item.id}')">
                        ${formatDataValue(item.value)}
                    </div>
                </div>
            `).join('');
        }

        // Render PH Data
        function renderPHData() {
            const list = document.getElementById('phDataList');
            list.innerHTML = phData.map(item => `
                <div class="ph-data-item ${item.value ? 'has-value' : ''}">
                    <div class="ph-data-label">${item.label}</div>
                    <div class="ph-data-value ${item.value ? '' : 'empty'}">
                        ${item.value || 'ì„œìˆ ë¬¸ ë°ì´í„° ì—†ìŒ'}
                    </div>
                </div>
            `).join('');
        }

        // Render Table Data
        function renderTableData() {
            const list = document.getElementById('tableDataList');
            list.innerHTML = tableData.map(item => `
                <div class="table-data-item ${item.hasData ? 'has-value' : ''}">
                    <div class="table-data-header">
                        <div class="table-data-label">${item.label}</div>
                        <span class="file-status ${item.hasData ? 'completed' : 'pending'}">
                            ${item.hasData ? 'ì™„ë£Œ' : 'ëŒ€ê¸°'}
                        </span>
                    </div>
                    <div class="table-preview">
                        ${item.hasData ? renderTablePreview(item) : '<p style="color: #94a3b8; font-size: 12px;">í‘œ ë°ì´í„° ì—†ìŒ</p>'}
                    </div>
                </div>
            `).join('');
        }

        function renderTablePreview(table) {
            if (!table.rows || table.rows.length === 0) return '<p>ë°ì´í„° ì—†ìŒ</p>';

            const headers = Object.keys(table.rows[0]);
            return `
                <table>
                    <thead>
                        <tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>
                    </thead>
                    <tbody>
                        ${table.rows.slice(0, 3).map(row => `
                            <tr>${headers.map(h => `<td>${row[h]}</td>`).join('')}</tr>
                        `).join('')}
                    </tbody>
                </table>
                ${table.rows.length > 3 ? `<p style="font-size: 11px; color: #64748b; margin-top: 4px;">+ ${table.rows.length - 3}ê°œ í–‰ ë”ë³´ê¸°</p>` : ''}
            `;
        }

        // Tab switching
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.data-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.data-section').forEach(s => s.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tab + 'Section').classList.add('active');
        }

        // File selection
        function selectFile(fileId) {
            selectedFile = markdownFiles.find(f => f.id === fileId);
            renderFileList();
        }

        // Show markdown popup
        function showMarkdownPopup(fileId) {
            const file = markdownFiles.find(f => f.id === fileId);
            if (!file) return;

            document.getElementById('markdownPopupFileName').textContent = file.name;
            document.getElementById('markdownPopupRawId').textContent = file.rawId;

            const body = document.getElementById('markdownPopupBody');
            if (file.markdown && file.markdown.trim()) {
                body.textContent = file.markdown;
                body.classList.remove('markdown-empty');
            } else {
                body.innerHTML = '<div class="markdown-empty">ë§ˆí¬ë‹¤ìš´ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            }

            document.getElementById('markdownPopup').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // Close markdown popup
        function closeMarkdownPopup() {
            document.getElementById('markdownPopup').classList.remove('active');
            document.body.style.overflow = '';
        }

        // Handle click on popup overlay (close when clicking outside)
        function handleMarkdownPopupClick(event) {
            if (event.target.id === 'markdownPopup') {
                closeMarkdownPopup();
            }
        }

        // Start extraction
        async function startExtraction() {
            const model = document.getElementById('llmModel').value;
            showLLMLoading(`${model}ë¥¼ ì‚¬ìš©í•˜ì—¬ ë°ì´í„°ë¥¼ ì¶”ì¶œí•˜ê³  ìˆìŠµë‹ˆë‹¤...`);

            const extractionResults = [];
            const totalFiles = markdownFiles.length;
            let currentIndex = 0;

            for (const file of markdownFiles) {
                currentIndex++;
                updateLLMProgress(currentIndex, totalFiles, file.name);
                file.status = 'extracting';
                renderFileList();

                try {
                    // Extract data from markdown using dataExtractor
                    const result = await dataExtractor.extractFromMarkdown(
                        file.markdown,
                        file.rawId
                    );

                    if (result.success) {
                        extractionResults.push({
                            rawId: file.rawId,
                            fileName: file.name,
                            csData: result.csData || {},
                            phData: result.phData || {},
                            tableData: result.tableData || {},
                            extractedAt: result.extractedAt
                        });

                        file.status = 'completed';
                    } else {
                        file.status = 'error';
                        console.error(`Extraction failed for ${file.name}:`, result.error);
                    }
                } catch (error) {
                    console.error(`Extraction error for ${file.name}:`, error);
                    file.status = 'error';
                }

                renderFileList();
                updateStats();
            }

            // Merge all extracted data
            const mergedData = dataExtractor.mergeExtractedData(extractionResults);

            // Update CS Data
            Object.keys(mergedData.csData || {}).forEach(key => {
                const csItem = csData.find(d => d.id === key);
                if (csItem && mergedData.csData[key]) {
                    csItem.value = mergedData.csData[key].value;
                    csItem.source = mergedData.csData[key].source;
                }
            });

            // Update PH Data
            Object.keys(mergedData.phData || {}).forEach(key => {
                const phItem = phData.find(d => d.id === key);
                if (phItem && mergedData.phData[key]) {
                    phItem.value = mergedData.phData[key].value;
                    phItem.source = mergedData.phData[key].source;
                }
            });

            // Update Table Data
            Object.keys(mergedData.tableData || {}).forEach(key => {
                const tableItem = tableData.find(d => d.id === key);
                if (tableItem && mergedData.tableData[key]) {
                    tableItem.hasData = true;
                    tableItem.rows = mergedData.tableData[key].rows || [];
                }
            });

            // Handle conflicts
            const conflicts = dataExtractor.getConflictData();
            if (conflicts && conflicts.length > 0) {
                conflicts.forEach(conflict => {
                    const csItem = csData.find(d => d.id === conflict.field);
                    if (csItem) {
                        csItem.hasConflict = true;
                        csItem.conflictOptions = conflict.options;
                    }
                });
            }

            // Save extracted data to localStorage
            Storage.set('extractedData', {
                csData: mergedData.csData,
                phData: mergedData.phData,
                tableData: mergedData.tableData,
                extractedAt: DateHelper.formatISO()
            });

            hideLLMLoading();
            renderCSData();
            renderPHData();
            renderTableData();

            const conflictCount = conflicts ? conflicts.length : 0;
            if (conflictCount > 0) {
                showToast(`ë°ì´í„° ì¶”ì¶œì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ${conflictCount}ê°œì˜ ì¶©ëŒ ë°ì´í„°ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.`, 'warning');
            } else {
                showToast('ë°ì´í„° ì¶”ì¶œì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            }
        }

        // Update stats
        function updateStats() {
            const completedFiles = markdownFiles.filter(f => f.status === 'completed').length;
            const csExtracted = csData.filter(d => d.value && !d.hasConflict).length;
            const phExtracted = phData.filter(d => d.value).length;
            const tableExtracted = tableData.filter(d => d.hasData).length;

            document.getElementById('completedCount').textContent = completedFiles;
            document.getElementById('totalCount').textContent = markdownFiles.length;
            document.getElementById('csExtracted').textContent = csExtracted;
            document.getElementById('phExtracted').textContent = phExtracted;
            document.getElementById('tableExtracted').textContent = tableExtracted;

            const totalData = csDataTemplate.length + phDataTemplate.length + tableDataTemplate.length;
            const extractedData = csExtracted + phExtracted + tableExtracted;
            const progressPercent = (extractedData / totalData) * 100;
            document.getElementById('progressBar').style.width = progressPercent + '%';
        }

        // Show conflict modal
        function showConflict(csId) {
            const item = csData.find(d => d.id === csId);
            if (!item || !item.hasConflict) return;

            conflictData = item;
            document.getElementById('conflictFieldName').textContent = item.label;

            const optionsHtml = item.conflictOptions.map((opt, idx) => `
                <div class="conflict-option" onclick="selectConflictOption(${idx})">
                    <div class="conflict-option-source">ğŸ“„ ${opt.source} (${opt.date})</div>
                    <div class="conflict-option-value">${opt.value}</div>
                </div>
            `).join('');

            document.getElementById('conflictOptions').innerHTML = optionsHtml;
            document.getElementById('conflictModal').classList.add('show');
        }

        function selectConflictOption(index) {
            document.querySelectorAll('.conflict-option').forEach((opt, idx) => {
                if (idx === index) {
                    opt.classList.add('selected');
                } else {
                    opt.classList.remove('selected');
                }
            });
        }

        function closeConflictModal() {
            document.getElementById('conflictModal').classList.remove('show');
            conflictData = null;
        }

        function resolveConflict() {
            const selectedOption = document.querySelector('.conflict-option.selected');
            if (!selectedOption) {
                showToast('ì˜µì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”', 'error');
                return;
            }

            const selectedIndex = Array.from(document.querySelectorAll('.conflict-option')).indexOf(selectedOption);
            const selectedValue = conflictData.conflictOptions[selectedIndex];

            conflictData.value = selectedValue.value;
            conflictData.source = selectedValue.source;
            conflictData.hasConflict = false;
            delete conflictData.conflictOptions;

            closeConflictModal();
            renderCSData();
            updateStats();
            showToast('ì¶©ëŒì´ í•´ê²°ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        }

        // Edit CS Data
        function editCSData(csId) {
            const item = csData.find(d => d.id === csId);
            const newValue = prompt(`${item.label} ê°’ì„ ì…ë ¥í•˜ì„¸ìš”:`, item.value);

            if (newValue !== null) {
                item.value = newValue;
                item.source = 'manual_edit';
                renderCSData();
                updateStats();
            }
        }

        // Export data
        function exportData() {
            const exportData = {
                csData: csData,
                phData: phData,
                tableData: tableData,
                timestamp: new Date().toISOString()
            };

            // In real implementation, this would save to file
            console.log('Exporting data:', exportData);
            showToast('ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        }

        // PSUR ë³´ê³ ì„œ ìƒì„± (LLM í˜¸ì¶œ)
        async function generatePSURReport() {
            // API í‚¤ í™•ì¸
            const apiKey = Storage.get(CONFIG.STORAGE_KEYS.GOOGLE_API_KEY);
            if (!apiKey) {
                showToast('API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì„¤ì • í˜ì´ì§€ì—ì„œ API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            // PSURGenerator ì´ˆê¸°í™”
            if (!window.PSURGenerator) {
                showToast('PSUR Generator ëª¨ë“ˆì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            window.PSURGenerator.apiKey = apiKey;

            // ë³€í™˜ëœ ë§ˆí¬ë‹¤ìš´ ë¡œë“œ
            const convertedMarkdowns = Storage.get('convertedMarkdowns') || [];
            if (convertedMarkdowns.length === 0) {
                showToast('ë³€í™˜ëœ ë§ˆí¬ë‹¤ìš´ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. P15ì—ì„œ ë§ˆí¬ë‹¤ìš´ ë³€í™˜ì„ ë¨¼ì € ìˆ˜í–‰í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            // ë¡œë”© í‘œì‹œ
            showLLMLoading('PSUR ë³´ê³ ì„œ ìƒì„± ì¤‘... (ìµœëŒ€ 2ë¶„ ì†Œìš”)');

            try {
                // PSUR ë³´ê³ ì„œ ìƒì„±
                const result = await window.PSURGenerator.generateFullReport({
                    convertedMarkdowns: convertedMarkdowns,
                    useTestData: true,  // í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚¬ìš©
                    onProgress: (progress) => {
                        console.log('[PSUR Generation]', progress.step, progress.message);
                        updateLLMProgress(0, 100, progress.message);
                    }
                });

                hideLLMLoading();

                if (result.success) {
                    const report = result.report;
                    showToast(`PSUR ë³´ê³ ì„œ ìƒì„± ì™„ë£Œ! (${report.duration}ì´ˆ ì†Œìš”)`, 'success');
                    console.log('[PSUR Report Generated]', report);

                    // ë³´ê³ ì„œ ë‹¤ìš´ë¡œë“œ í™•ì¸
                    if (confirm(`PSUR ë³´ê³ ì„œ ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\n- ì†Œìš” ì‹œê°„: ${report.duration}ì´ˆ\n- ì›ë³¸ íŒŒì¼: ${report.sourceFiles}ê°œ\n\në³´ê³ ì„œë¥¼ ë‹¤ìš´ë¡œë“œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                        window.PSURGenerator.downloadReport();
                    }
                } else {
                    showToast(`PSUR ìƒì„± ì‹¤íŒ¨: ${result.error}`, 'error');
                    console.error('[PSUR Generation Failed]', result.error);
                }

            } catch (error) {
                hideLLMLoading();
                showToast(`ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, 'error');
                console.error('[PSUR Generation Error]', error);
            }
        }

        // Proceed to next stage
        function proceedToNext() {
            const missingCS = csData.filter(d => !d.value).length;
            const conflicts = csData.filter(d => d.hasConflict).length;

            if (missingCS > 0 || conflicts > 0) {
                showToast(`ë¯¸í™•ë³´ ë°ì´í„° ${missingCS}ê°œ, ì¶©ëŒ ${conflicts}ê°œë¥¼ ë¨¼ì € í•´ê²°í•´ì£¼ì„¸ìš”`, 'error');
                return;
            }

            // Ensure extracted data is saved
            Storage.set('extractedData', {
                csData: Object.fromEntries(csData.map(d => [d.id, { value: d.value, source: d.source }])),
                phData: Object.fromEntries(phData.map(d => [d.id, { value: d.value, source: d.source }])),
                tableData: Object.fromEntries(tableData.map(d => [d.id, { hasData: d.hasData, rows: d.rows }])),
                extractedAt: DateHelper.formatISO()
            });

            const reportId = new URLSearchParams(window.location.search).get('reportId') || Date.now().toString();
            window.location.href = `P17_TemplateWriting.html?reportId=${reportId}`;
        }

        // Initialize on load
        init();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAW4 Unit Test - CS17 Extraction</title>
    <!-- SheetJS for Excel parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { margin-bottom: 20px; color: #333; }
        .test-section { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .test-section h2 { margin-bottom: 15px; color: #2563eb; }
        .btn { padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; margin-right: 10px; margin-bottom: 10px; }
        .btn-primary { background: #2563eb; color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-success { background: #16a34a; color: white; }
        .btn-success:hover { background: #15803d; }
        .log-area { background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 6px; font-family: monospace; font-size: 13px; max-height: 400px; overflow-y: auto; margin-top: 15px; white-space: pre-wrap; }
        .result-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .result-table th, .result-table td { border: 1px solid #e5e7eb; padding: 10px; text-align: left; }
        .result-table th { background: #f3f4f6; font-weight: 600; }
        .status-pass { color: #16a34a; font-weight: bold; }
        .status-fail { color: #dc2626; font-weight: bold; }
        .status-pending { color: #ca8a04; }
        .markdown-input { width: 100%; height: 200px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 6px; font-family: monospace; font-size: 13px; resize: vertical; }
        .markdown-preview { background: #fafafa; border: 1px solid #e5e7eb; padding: 15px; border-radius: 6px; max-height: 300px; overflow-y: auto; font-size: 13px; }
        .extracted-data { background: #f0fdf4; border: 1px solid #bbf7d0; padding: 15px; border-radius: 6px; margin-top: 10px; }
        .extracted-data pre { white-space: pre-wrap; font-size: 12px; }
        .loading { display: none; align-items: center; gap: 10px; padding: 15px; background: #fef3c7; border-radius: 6px; margin-top: 15px; }
        .loading.active { display: flex; }
        .spinner { width: 20px; height: 20px; border: 2px solid #f59e0b; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .input-tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .input-tab { padding: 10px 20px; border: none; background: #e5e7eb; border-radius: 6px 6px 0 0; cursor: pointer; font-weight: 500; }
        .input-tab.active { background: #2563eb; color: white; }
        .input-content { display: none; }
        .input-content.active { display: block; }
        .file-drop { border: 2px dashed #d1d5db; border-radius: 8px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .file-drop:hover { border-color: #2563eb; background: #f0f9ff; }
        .file-drop.dragover { border-color: #2563eb; background: #dbeafe; }
        .api-key-section { background: #fef3c7; padding: 15px; border-radius: 6px; margin-bottom: 15px; }
        .api-key-input { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-family: monospace; }
    </style>
</head>
<body>
    <div class="container">
        <h1>RAW4 Unit Test - CS17.1~CS17.6 Extraction</h1>

        <div class="test-section">
            <h2>1. API Key ì„¤ì •</h2>
            <div class="api-key-section">
                <label><strong>Google API Key:</strong></label>
                <input type="password" id="apiKeyInput" class="api-key-input" placeholder="Google Gemini API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                <button class="btn btn-secondary" onclick="saveApiKey()" style="margin-top: 10px;">ì €ì¥</button>
                <span id="apiKeyStatus" style="margin-left: 10px;"></span>
            </div>
            <div style="margin-top: 15px;">
                <label><strong>LLM Model:</strong></label>
                <select id="modelSelect" style="padding: 8px; margin-left: 10px;">
                    <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                    <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
                </select>
            </div>
        </div>

        <div class="test-section">
            <h2>2. RAW4 ë°ì´í„° ì…ë ¥</h2>
            <p style="margin-bottom: 15px; color: #6b7280;">Excel íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê±°ë‚˜ ë§ˆí¬ë‹¤ìš´ì„ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”.</p>

            <div class="input-tabs">
                <button class="input-tab active" onclick="switchTab('file')">ğŸ“ íŒŒì¼ ì—…ë¡œë“œ</button>
                <button class="input-tab" onclick="switchTab('paste')">ğŸ“ ë§ˆí¬ë‹¤ìš´ ë¶™ì—¬ë„£ê¸°</button>
                <button class="input-tab" onclick="switchTab('storage')">ğŸ’¾ localStorage</button>
            </div>

            <div id="tab-file" class="input-content active">
                <div class="file-drop" id="fileDrop" onclick="document.getElementById('fileInput').click()">
                    <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;" onchange="handleFileUpload(event)">
                    <p style="font-size: 18px; margin-bottom: 10px;">ğŸ“Š Excel íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì„¸ìš”</p>
                    <p style="color: #6b7280;">ì§€ì› í˜•ì‹: .xlsx, .xls</p>
                </div>
                <div id="fileInfo" style="margin-top: 10px; display: none;"></div>
            </div>

            <div id="tab-paste" class="input-content">
                <textarea id="markdownInput" class="markdown-input" placeholder="RAW4 ë§ˆí¬ë‹¤ìš´ì„ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>
                <button class="btn btn-secondary" onclick="useMarkdownInput()" style="margin-top: 10px;">ë§ˆí¬ë‹¤ìš´ ì‚¬ìš©</button>
            </div>

            <div id="tab-storage" class="input-content">
                <button class="btn btn-secondary" onclick="loadFromStorage()">localStorageì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                <div id="storageInfo" style="margin-top: 10px;"></div>
            </div>

            <div id="markdownPreview" class="markdown-preview" style="margin-top: 15px; display: none;"></div>
        </div>

        <div class="test-section">
            <h2>3. ì¶”ì¶œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰</h2>
            <p><strong>Target:</strong> CS17.1~CS17.6 (í—ˆê°€í˜„í™©)</p>
            <p><strong>Expected:</strong> CS17.1~CS17.5ëŠ” ë°°ì—´, CS17.6ì€ ë¬¸ìì—´</p>
            <div style="margin-top: 15px;">
                <button class="btn btn-primary" onclick="runTest()">ğŸš€ ì¶”ì¶œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
                <button class="btn btn-secondary" onclick="clearResults()">ğŸ—‘ï¸ ê²°ê³¼ ì´ˆê¸°í™”</button>
            </div>
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <span>LLMì—ì„œ ë°ì´í„° ì¶”ì¶œ ì¤‘...</span>
            </div>
            <div id="logArea" class="log-area" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h2>4. ì¶”ì¶œ ê²°ê³¼</h2>
            <table class="result-table">
                <thead>
                    <tr>
                        <th>í•„ë“œ</th>
                        <th>ê¸°ëŒ€ íƒ€ì…</th>
                        <th>ì‹¤ì œ íƒ€ì…</th>
                        <th>ê°’ ê°œìˆ˜</th>
                        <th>ìƒíƒœ</th>
                    </tr>
                </thead>
                <tbody id="resultTable">
                    <tr><td colspan="5" class="status-pending">í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ë©´ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤...</td></tr>
                </tbody>
            </table>
            <div id="extractedData" class="extracted-data" style="display: none;">
                <h3>ì¶”ì¶œëœ ë°ì´í„°:</h3>
                <pre id="extractedJson"></pre>
            </div>
        </div>

        <div class="test-section">
            <h2>5. í…ŒìŠ¤íŠ¸ ìš”ì•½</h2>
            <div id="testSummary">
                <p class="status-pending">ì•„ì§ í…ŒìŠ¤íŠ¸ê°€ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            API_KEY_STORAGE: 'GOOGLE_API_KEY',
            RAW4_TARGETS: ['CS17.1', 'CS17.2', 'CS17.3', 'CS17.4', 'CS17.5', 'CS17.6']
        };

        let raw4Markdown = null;
        let logs = [];

        // Initialize
        window.addEventListener('load', () => {
            // Load saved API key
            const savedKey = localStorage.getItem(CONFIG.API_KEY_STORAGE);
            if (savedKey) {
                document.getElementById('apiKeyInput').value = savedKey;
                document.getElementById('apiKeyStatus').innerHTML = '<span style="color: green;">âœ… API Key ì €ì¥ë¨</span>';
            }

            // Setup drag and drop
            const dropZone = document.getElementById('fileDrop');
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) {
                    handleFile(e.dataTransfer.files[0]);
                }
            });
        });

        function saveApiKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (key) {
                localStorage.setItem(CONFIG.API_KEY_STORAGE, key);
                document.getElementById('apiKeyStatus').innerHTML = '<span style="color: green;">âœ… ì €ì¥ë¨</span>';
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.input-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.input-content').forEach(c => c.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) handleFile(file);
        }

        async function handleFile(file) {
            log(`íŒŒì¼ ë¡œë“œ: ${file.name} (${(file.size/1024).toFixed(2)} KB)`);

            try {
                const arrayBuffer = await file.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array', codepage: 65001 });

                let markdown = `# ${file.name}\n\n`;

                workbook.SheetNames.forEach((sheetName, idx) => {
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });

                    markdown += `## Sheet: ${sheetName}\n\n`;

                    if (jsonData.length > 0) {
                        // Create markdown table
                        const headers = jsonData[0];
                        markdown += '| ' + headers.join(' | ') + ' |\n';
                        markdown += '| ' + headers.map(() => '---').join(' | ') + ' |\n';

                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i].map(cell => String(cell || '').replace(/\|/g, '\\|'));
                            markdown += '| ' + row.join(' | ') + ' |\n';
                        }
                        markdown += '\n';
                    }
                });

                raw4Markdown = markdown;
                showMarkdownPreview(file.name, markdown);
                document.getElementById('fileInfo').innerHTML = `<span style="color: green;">âœ… ${file.name} ë¡œë“œ ì™„ë£Œ</span>`;
                document.getElementById('fileInfo').style.display = 'block';

                log(`Excel â†’ Markdown ë³€í™˜ ì™„ë£Œ (${markdown.length} chars)`, 'success');

            } catch (error) {
                log(`íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜: ${error.message}`, 'error');
                alert('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function useMarkdownInput() {
            const markdown = document.getElementById('markdownInput').value.trim();
            if (!markdown) {
                alert('ë§ˆí¬ë‹¤ìš´ì„ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }
            raw4Markdown = markdown;
            showMarkdownPreview('ì§ì ‘ ì…ë ¥', markdown);
            log('ë§ˆí¬ë‹¤ìš´ ì…ë ¥ ì‚¬ìš©', 'success');
        }

        function loadFromStorage() {
            const markdowns = JSON.parse(localStorage.getItem('convertedMarkdowns') || '{}');
            const entries = Object.values(markdowns);
            const raw4 = entries.find(item => item.rawId === 'RAW4' || item.fileName?.includes('RAW4'));

            if (raw4 && raw4.markdown) {
                raw4Markdown = raw4.markdown;
                showMarkdownPreview(raw4.fileName || 'RAW4', raw4.markdown);
                document.getElementById('storageInfo').innerHTML = `<span style="color: green;">âœ… ${raw4.fileName || 'RAW4'} ë¡œë“œ ì™„ë£Œ</span>`;
                log(`localStorageì—ì„œ ë¡œë“œ: ${raw4.fileName} (${raw4.markdown.length} chars)`, 'success');
            } else {
                document.getElementById('storageInfo').innerHTML = '<span style="color: red;">âŒ RAW4 ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</span>';
                log('localStorageì—ì„œ RAW4 ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ', 'error');
            }
        }

        function showMarkdownPreview(name, markdown) {
            const preview = document.getElementById('markdownPreview');
            preview.style.display = 'block';
            preview.innerHTML = `
                <strong>ì†ŒìŠ¤:</strong> ${escapeHtml(name)}<br>
                <strong>ê¸¸ì´:</strong> ${markdown.length} chars<hr>
                <pre style="white-space: pre-wrap; max-height: 200px; overflow-y: auto;">${escapeHtml(markdown)}</pre>
            `;
        }

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warn' ? 'âš ï¸' : 'ğŸ“';
            const logMessage = `[${timestamp}] ${prefix} ${message}`;
            logs.push(logMessage);

            const logArea = document.getElementById('logArea');
            logArea.style.display = 'block';
            logArea.textContent = logs.join('\n');
            logArea.scrollTop = logArea.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function runTest() {
            if (!raw4Markdown) {
                alert('ë¨¼ì € RAW4 ë°ì´í„°ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            const apiKey = localStorage.getItem(CONFIG.API_KEY_STORAGE);
            if (!apiKey) {
                alert('API Keyë¥¼ ì„¤ì •í•˜ì„¸ìš”.');
                return;
            }

            logs = [];
            document.getElementById('loading').classList.add('active');
            log('RAW4 ì¶”ì¶œ í…ŒìŠ¤íŠ¸ ì‹œì‘...');

            try {
                const result = await extractFromRAW4(apiKey, raw4Markdown);
                displayResults(result);
            } catch (error) {
                log(`í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`, 'error');
            } finally {
                document.getElementById('loading').classList.remove('active');
            }
        }

        async function extractFromRAW4(apiKey, markdown) {
            const model = document.getElementById('modelSelect').value;
            const targets = CONFIG.RAW4_TARGETS;

            log(`ëª¨ë¸: ${model}`);
            log(`ì¶”ì¶œ ëŒ€ìƒ: ${targets.join(', ')}`);

            const prompt = buildPrompt(markdown, targets);
            log(`í”„ë¡¬í”„íŠ¸ ê¸¸ì´: ${prompt.length} chars`);

            const response = await callLLM(apiKey, model, prompt);
            log(`LLM ì‘ë‹µ ìˆ˜ì‹  (${response.length} chars)`, 'success');
            log(`ì‘ë‹µ ë¯¸ë¦¬ë³´ê¸°: ${response.substring(0, 500)}...`);

            const parsed = parseResponse(response);
            return parsed;
        }

        function buildPrompt(markdown, targets) {
            return `# ë°ì´í„° ì¶”ì¶œ ì‘ì—…

## ì›ë³¸ ë¬¸ì„œ (RAW4 - í—ˆê°€í˜„í™©)
${markdown}

## ì¶”ì¶œ ëŒ€ìƒ í•„ë“œ
${targets.map(t => `- ${t}`).join('\n')}

## ì¶”ì¶œ ì§€ì¹¨

### ì¤‘ìš”: ë°°ì—´ í˜•íƒœë¡œ ì¶”ì¶œ
- CS17.1 (í—ˆê°€êµ­ê°€): ëª¨ë“  í—ˆê°€ì™„ë£Œ êµ­ê°€ë¥¼ ë°°ì—´ë¡œ ì¶”ì¶œ
- CS17.2 (í—ˆê°€ì¼): ê° êµ­ê°€ë³„ ìµœì´ˆ í—ˆê°€ì¼ì„ ë°°ì—´ë¡œ ì¶”ì¶œ (CS17.1 êµ­ê°€ ìˆœì„œì™€ ë™ì¼)
- CS17.3 (í—ˆê°€í’ˆëª©ëª…/ë¸Œëœë“œëª…): ê° êµ­ê°€ë³„ ë¸Œëœë“œëª…ì„ ë°°ì—´ë¡œ ì¶”ì¶œ (CS17.1 êµ­ê°€ ìˆœì„œì™€ ë™ì¼)
- CS17.4 (í—ˆê°€ê¶Œì/ë‹´ë‹¹ì): ê° êµ­ê°€ë³„ ë‹´ë‹¹ìë¥¼ ë°°ì—´ë¡œ ì¶”ì¶œ (CS17.1 êµ­ê°€ ìˆœì„œì™€ ë™ì¼)
- CS17.5 (í—ˆê°€ë¹„ê³ ): ê° êµ­ê°€ë³„ ì£¼ìš” ë¹„ê³ ë¥¼ ë°°ì—´ë¡œ ì¶”ì¶œ (CS17.1 êµ­ê°€ ìˆœì„œì™€ ë™ì¼). ë¹„ê³ ê°€ ì—†ìœ¼ë©´ null
- CS17.6 (í—ˆê°€í˜„í™©ì„œìˆ ë¬¸): ì „ì²´ í—ˆê°€í˜„í™©ì„ ìš”ì•½í•œ ì„œìˆ ë¬¸ (ë¬¸ìì—´)

### ë°ì´í„° ì¶”ì¶œ ì›ì¹™
1. í—ˆê°€ì™„ë£Œ ìƒíƒœì¸ í•­ëª©ë§Œ í¬í•¨ (ì‹ ì²­ì¤‘, ì‹¬ì‚¬ì¤‘ ì œì™¸)
2. ê° êµ­ê°€ì˜ ìµœì´ˆ í—ˆê°€ ì •ë³´ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì¶”ì¶œ
3. ëª¨ë“  ë°°ì—´ì˜ ìˆœì„œëŠ” CS17.1ì˜ êµ­ê°€ ìˆœì„œì™€ ì¼ì¹˜í•´ì•¼ í•¨
4. ë°°ì—´ì˜ ê¸¸ì´ëŠ” ëª¨ë‘ ë™ì¼í•´ì•¼ í•¨ (êµ­ê°€ ìˆ˜ì™€ ë™ì¼)
5. ë°ì´í„°ê°€ ì—†ëŠ” í•­ëª©ì€ nullë¡œ í‘œì‹œ

## ì‘ë‹µ í˜•ì‹ (ì¤‘ìš”!)
- ë°˜ë“œì‹œ JSON ì½”ë“œ ë¸”ë¡ë§Œ ì¶œë ¥í•˜ì„¸ìš”
- ì„¤ëª…, ë¶„ì„, ì½”ë©˜íŠ¸ ì—†ì´ ì˜¤ì§ JSONë§Œ ë°˜í™˜í•˜ì„¸ìš”

\`\`\`json
{
  "CS17.1": ["êµ­ê°€1", "êµ­ê°€2", "êµ­ê°€3", ...],
  "CS17.2": ["YYYY-MM-DD", "YYYY-MM-DD", "YYYY-MM-DD", ...],
  "CS17.3": ["ë¸Œëœë“œëª…1", "ë¸Œëœë“œëª…2", "ë¸Œëœë“œëª…3", ...],
  "CS17.4": ["ë‹´ë‹¹ì1", "ë‹´ë‹¹ì2", "ë‹´ë‹¹ì3", ...],
  "CS17.5": ["ë¹„ê³ 1", null, "ë¹„ê³ 3", ...],
  "CS17.6": "í—ˆê°€í˜„í™© ì„œìˆ ë¬¸"
}
\`\`\``;
        }

        async function callLLM(apiKey, model, prompt) {
            // ëª¨ë¸ëª… ë§¤í•‘ (stable version ì‚¬ìš©)
            const modelId = model === 'gemini-2.5-pro' ? 'gemini-2.5-pro' : 'gemini-2.5-flash';
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelId}:generateContent?key=${apiKey}`;

            log(`API URL: ${url.replace(apiKey, '***')}`);  // API key ìˆ¨ê¹€

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        temperature: 0.1,
                        maxOutputTokens: 8192
                    }
                })
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`API Error: ${response.status} - ${errorText}`);
            }

            const data = await response.json();
            return data.candidates?.[0]?.content?.parts?.[0]?.text || '';
        }

        function parseResponse(response) {
            log('LLM ì‘ë‹µ íŒŒì‹± ì¤‘...');

            // Extract JSON from code block
            const jsonMatch = response.match(/```json\s*([\s\S]*?)\s*```/);
            if (!jsonMatch) {
                log('JSON ì½”ë“œ ë¸”ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ', 'error');
                throw new Error('JSONì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }

            const jsonStr = jsonMatch[1].trim();
            log(`ì¶”ì¶œëœ JSON: ${jsonStr.substring(0, 300)}...`);

            try {
                const parsed = JSON.parse(jsonStr);
                log('JSON íŒŒì‹± ì„±ê³µ', 'success');
                return parsed;
            } catch (e) {
                log(`JSON íŒŒì‹± ì˜¤ë¥˜: ${e.message}`, 'error');
                throw e;
            }
        }

        function displayResults(data) {
            const tbody = document.getElementById('resultTable');
            const fields = CONFIG.RAW4_TARGETS;

            let html = '';
            let passCount = 0;
            let failCount = 0;

            // Get CS17.1 count as reference
            const countryCount = Array.isArray(data['CS17.1']) ? data['CS17.1'].length : 0;
            log(`ê¸°ì¤€ êµ­ê°€ ìˆ˜ (CS17.1): ${countryCount}`);

            fields.forEach(field => {
                const value = data[field];
                const isArray = Array.isArray(value);
                const valueCount = isArray ? value.length : (value ? 1 : 0);

                // CS17.6 should be string, others should be arrays
                const expectedType = field === 'CS17.6' ? 'string' : 'array';
                const actualType = isArray ? 'array' : (typeof value);

                let status, statusClass;
                if (field === 'CS17.6') {
                    status = typeof value === 'string' && value.length > 0 ? 'PASS' : 'FAIL';
                } else {
                    status = isArray && valueCount === countryCount ? 'PASS' : 'FAIL';
                }

                statusClass = status === 'PASS' ? 'status-pass' : 'status-fail';
                if (status === 'PASS') passCount++; else failCount++;

                // Show actual values for arrays
                let valuePreview = '';
                if (isArray && value.length > 0) {
                    valuePreview = value.map((v, i) => `[${i}] ${v}`).join(', ');
                    if (valuePreview.length > 100) valuePreview = valuePreview.substring(0, 100) + '...';
                }

                html += `
                    <tr>
                        <td><strong>${field}</strong></td>
                        <td>${expectedType}</td>
                        <td>${actualType}</td>
                        <td>${valueCount}${field !== 'CS17.6' ? ` / ${countryCount}` : ''}</td>
                        <td class="${statusClass}">${status}</td>
                    </tr>
                `;

                log(`${field}: type=${actualType}, count=${valueCount}, status=${status}`);
            });

            tbody.innerHTML = html;

            // Show extracted data
            const extractedDiv = document.getElementById('extractedData');
            extractedDiv.style.display = 'block';
            document.getElementById('extractedJson').textContent = JSON.stringify(data, null, 2);

            // Summary
            const summary = document.getElementById('testSummary');
            const allPass = failCount === 0;
            summary.innerHTML = `
                <p class="${allPass ? 'status-pass' : 'status-fail'}">
                    ${allPass ? 'âœ… ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼!' : `âŒ ${failCount}ê°œ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨`}
                </p>
                <p>í†µê³¼: ${passCount} / ${fields.length}</p>
                <p>CS17.1 êµ­ê°€ ìˆ˜: ${countryCount}</p>
                ${countryCount > 0 ? `<p>êµ­ê°€ ëª©ë¡: ${data['CS17.1'].join(', ')}</p>` : ''}
            `;

            log(`í…ŒìŠ¤íŠ¸ ì™„ë£Œ: ${passCount}/${fields.length} í†µê³¼`, allPass ? 'success' : 'error');
        }

        function clearResults() {
            logs = [];
            raw4Markdown = null;
            document.getElementById('logArea').style.display = 'none';
            document.getElementById('logArea').textContent = '';
            document.getElementById('resultTable').innerHTML = '<tr><td colspan="5" class="status-pending">í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ë©´ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤...</td></tr>';
            document.getElementById('extractedData').style.display = 'none';
            document.getElementById('testSummary').innerHTML = '<p class="status-pending">ì•„ì§ í…ŒìŠ¤íŠ¸ê°€ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>';
            document.getElementById('markdownPreview').style.display = 'none';
            document.getElementById('fileInfo').style.display = 'none';
            document.getElementById('storageInfo').innerHTML = '';
            document.getElementById('markdownInput').value = '';
        }
    </script>
</body>
</html>

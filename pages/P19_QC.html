<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P-19 QC Validation - KPSUR AGENT</title>
    <link rel="stylesheet" href="../css/styles/globals.css">
    <link rel="stylesheet" href="../css/styles/layout.css">
    <link rel="stylesheet" href="../css/styles/components.css">
    <style>
        /* ë‹¤í¬ëª¨ë“œ ë³€ìˆ˜ */
        :root {
            --page-bg: #F5F7FA;
            --card-bg: white;
            --text-primary: #07161D;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --border-color: #e2e8f0;
            --section-bg: #f8fafc;
            --input-bg: white;
        }

        [data-theme="dark"] {
            --page-bg: #1e293b;
            --card-bg: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: #334155;
            --section-bg: #334155;
            --input-bg: #334155;
        }

        /* ë‹¤í¬ëª¨ë“œ íŒ¨ë„ ìŠ¤íƒ€ì¼ */
        [data-theme="dark"] .validation-panel,
        [data-theme="dark"] .issue-panel {
            background: transparent !important;
            border-color: #475569;
        }

        [data-theme="dark"] .validation-warning {
            background: rgba(251, 191, 36, 0.15);
            border-left-color: #fbbf24;
        }

        [data-theme="dark"] .validation-warning-title,
        [data-theme="dark"] .validation-warning-text {
            color: #fbbf24;
        }

        [data-theme="dark"] .validation-item {
            background: #334155;
        }

        [data-theme="dark"] .validation-item.checking {
            background: rgba(59, 130, 246, 0.2);
        }

        [data-theme="dark"] .validation-item.passed {
            background: rgba(16, 185, 129, 0.2);
        }

        [data-theme="dark"] .validation-item.failed {
            background: rgba(251, 191, 36, 0.2);
        }

        [data-theme="dark"] .category-status.pending {
            background: #334155;
            color: #94a3b8;
        }

        [data-theme="dark"] .category-status.checking {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }

        [data-theme="dark"] .category-status.passed {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
        }

        [data-theme="dark"] .category-status.failed {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        [data-theme="dark"] .issue-stat {
            background: #334155;
            border-color: #475569;
        }

        [data-theme="dark"] .issue-stat-value.critical {
            color: #fbbf24;
        }

        [data-theme="dark"] .issue-card {
            background: #334155;
        }

        [data-theme="dark"] .issue-card-severity.critical {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        [data-theme="dark"] .issue-card-severity.warning {
            background: rgba(251, 191, 36, 0.15);
            color: #fcd34d;
        }

        [data-theme="dark"] .issue-card-severity.info {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }

        [data-theme="dark"] .issue-card-details {
            background: #1e293b;
        }

        [data-theme="dark"] .issue-action-btn {
            background: #334155;
            border-color: #475569;
            color: #94a3b8;
        }

        [data-theme="dark"] .issue-action-btn:hover {
            border-color: #25739B;
            color: #60a5fa;
        }

        [data-theme="dark"] .approval-modal-content {
            background: #1e293b;
            border: 1px solid #475569;
        }

        [data-theme="dark"] .approval-checklist {
            background: #334155;
        }

        [data-theme="dark"] .approval-checklist-item {
            color: var(--text-primary);
        }

        [data-theme="dark"] .footer-message.error {
            color: #fbbf24;
        }

        .qc-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
            padding: 16px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .qc-main-grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 16px;
            height: 100%;
        }

        /* Left Panel - Validation Checklist */
        .validation-panel {
            background: var(--card-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            padding: 16px;
            overflow-y: auto;
        }

        .validation-header {
            margin-bottom: 16px;
        }

        .validation-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .validation-warning {
            background: #FEF3C7;
            border-left: 4px solid #F59E0B;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 12px;
        }

        .validation-warning-title {
            font-weight: 600;
            color: #92400E;
            font-size: 12px;
            margin-bottom: 4px;
        }

        .validation-warning-text {
            font-size: 11px;
            color: #92400E;
            line-height: 1.4;
        }

        .validation-progress {
            background: var(--section-bg);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
        }

        .validation-progress-bar {
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .validation-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10B981, #34D399);
            transition: width 0.3s ease;
        }

        .validation-progress-text {
            font-size: 11px;
            color: var(--text-secondary);
            text-align: center;
        }

        .validation-category {
            margin-bottom: 16px;
        }

        .validation-category-title {
            font-size: 13px;
            font-weight: 600;
            color: #25739B;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 2px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-status {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 500;
        }

        .category-status.pending {
            background: #F1F5F9;
            color: #64748b;
        }

        .category-status.checking {
            background: #DBEAFE;
            color: #1E40AF;
        }

        .category-status.passed {
            background: #D1FAE5;
            color: #065F46;
        }

        .category-status.failed {
            background: #FEE2E2;
            color: #991B1B;
        }

        .validation-item {
            padding: 8px;
            margin-bottom: 6px;
            background: var(--section-bg);
            border-radius: 4px;
            border-left: 3px solid #cbd5e1;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .validation-item.pending {
            border-left-color: #94a3b8;
        }

        .validation-item.checking {
            border-left-color: #3B82F6;
            background: #EFF6FF;
        }

        .validation-item.passed {
            border-left-color: #10B981;
            background: #ECFDF5;
        }

        .validation-item.failed {
            border-left-color: #fbbf24;
            background: #FEF3C7;
        }

        .validation-item-name {
            color: var(--text-primary);
        }

        .validation-item-status {
            font-size: 18px;
        }

        /* Right Panel - Issue Details */
        .issue-panel {
            background: var(--card-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .issue-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            background: var(--section-bg);
        }

        .issue-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .issue-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .issue-stat {
            text-align: center;
            padding: 12px;
            background: var(--card-bg);
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        .issue-stat-value {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .issue-stat-value.total {
            color: var(--text-secondary);
        }

        .issue-stat-value.critical {
            color: #fbbf24;
        }

        .issue-stat-value.warning {
            color: #F59E0B;
        }

        .issue-stat-value.passed {
            color: #10B981;
        }

        .issue-stat-label {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .qc-controls {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            background: var(--card-bg);
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .llm-model-select {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 13px;
            color: var(--text-primary);
            background: var(--input-bg);
            flex: 1;
        }

        .issue-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .issue-empty {
            text-align: center;
            color: var(--text-muted);
            padding: 40px 20px;
        }

        .issue-empty-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .issue-empty-text {
            font-size: 14px;
        }

        .issue-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .issue-card {
            background: var(--section-bg);
            border-radius: 6px;
            padding: 16px;
            border-left: 4px solid #fbbf24;
        }

        .issue-card.warning {
            border-left-color: #F59E0B;
        }

        .issue-card.info {
            border-left-color: #3B82F6;
        }

        .issue-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .issue-card-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .issue-card-severity {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .issue-card-severity.critical {
            background: #FEF3C7;
            color: #92400E;
        }

        .issue-card-severity.warning {
            background: #FEF3C7;
            color: #92400E;
        }

        .issue-card-severity.info {
            background: #DBEAFE;
            color: #1E40AF;
        }

        .issue-card-description {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            line-height: 1.6;
        }

        .issue-card-details {
            background: var(--card-bg);
            padding: 12px;
            border-radius: 4px;
            font-size: 12px;
            margin-bottom: 12px;
        }

        .issue-card-detail-row {
            display: flex;
            gap: 8px;
            margin-bottom: 4px;
        }

        .issue-card-detail-label {
            font-weight: 600;
            color: var(--text-secondary);
            min-width: 80px;
        }

        .issue-card-detail-value {
            color: var(--text-primary);
        }

        .issue-card-actions {
            display: flex;
            gap: 8px;
        }

        .issue-action-btn {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .issue-action-btn:hover {
            border-color: #25739B;
            color: #25739B;
        }

        .issue-action-btn.resolve {
            background: #10B981;
            color: white;
            border-color: #10B981;
        }

        .issue-action-btn.resolve:hover {
            background: #059669;
        }

        /* Footer Actions */
        .qc-footer {
            padding: 16px;
            border-top: 1px solid var(--border-color);
            background: var(--section-bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .footer-message {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .footer-message.error {
            color: #fbbf24;
            font-weight: 600;
        }

        .footer-message.success {
            color: #059669;
            font-weight: 600;
        }

        .footer-actions {
            display: flex;
            gap: 8px;
        }

        /* Approval Modal */
        .approval-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .approval-modal.show {
            display: flex;
        }

        .approval-modal-content {
            background: var(--card-bg);
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            padding: 24px;
        }

        .approval-modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .approval-modal-message {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .approval-checklist {
            background: var(--section-bg);
            padding: 16px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .approval-checklist-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            font-size: 13px;
            color: var(--text-primary);
        }

        .approval-checklist-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }

        .approval-modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }
        /* Header styles */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 24px;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header-logo {
            font-size: 18px;
            font-weight: 700;
            color: #25739B;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .dark-mode-toggle {
            background: var(--section-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .dark-mode-toggle:hover {
            border-color: #25739B;
        }

        [data-theme="dark"] .dark-mode-toggle {
            background: #334155;
            border-color: #475569;
        }

        .icon-sun, .icon-moon {
            font-size: 16px;
        }

        [data-theme="light"] .icon-moon {
            display: none;
        }

        [data-theme="dark"] .icon-sun {
            display: none;
        }

        /* ìˆ˜ë™ ì²´í¬ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .manual-checklist-section {
            padding: 16px;
            border-top: 1px solid var(--border-color);
            background: var(--section-bg);
        }

        .manual-checklist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .manual-checklist-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .manual-checklist-progress {
            font-size: 12px;
            color: var(--text-secondary);
            padding: 4px 12px;
            background: var(--card-bg);
            border-radius: 16px;
            border: 1px solid var(--border-color);
        }

        .manual-checklist-items {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .checklist-group {
            background: var(--card-bg);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .checklist-group-title {
            font-size: 12px;
            font-weight: 600;
            color: #25739B;
            margin-bottom: 10px;
            padding-bottom: 6px;
            border-bottom: 1px solid var(--border-color);
        }

        .checklist-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 6px 0;
            cursor: pointer;
            font-size: 12px;
            color: var(--text-primary);
        }

        .checklist-item:hover {
            background: var(--section-bg);
            margin: 0 -8px;
            padding-left: 8px;
            padding-right: 8px;
            border-radius: 4px;
        }

        .checklist-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            margin-top: 2px;
            cursor: pointer;
            accent-color: #10B981;
        }

        .checklist-item .check-text {
            flex: 1;
            line-height: 1.4;
        }

        .checklist-item input[type="checkbox"]:checked + .check-text {
            color: #059669;
            text-decoration: line-through;
        }

        [data-theme="dark"] .manual-checklist-section {
            background: transparent;
        }

        [data-theme="dark"] .checklist-group {
            background: #334155;
            border-color: #475569;
        }

        [data-theme="dark"] .checklist-group-title {
            color: #60a5fa;
            border-bottom-color: #475569;
        }

        [data-theme="dark"] .checklist-item:hover {
            background: rgba(96, 165, 250, 0.1);
        }

        [data-theme="dark"] .checklist-item input[type="checkbox"]:checked + .check-text {
            color: #34d399;
        }

        @media (max-width: 1024px) {
            .manual-checklist-items {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="app-layout" id="app">
        <!-- Header -->
        <header class="app-header">
            <div class="header-left">
                <div class="logo">
                    <span class="logo-text">KPSUR AGENT</span>
                    <span class="logo-subtitle">ACUZEN AI</span>
                </div>
                <span class="deployment-badge test">í…ŒìŠ¤íŠ¸</span>
            </div>

            <div class="header-center">
                <div class="breadcrumb">
                    <span class="breadcrumb-item">ë³´ê³ ì„œ</span>
                    <span class="breadcrumb-separator">/</span>
                    <span class="breadcrumb-item active">QC ê²€ì¦</span>
                </div>
            </div>

            <div class="header-right">
                <button class="dark-mode-toggle" onclick="toggleDarkMode()" title="ë‹¤í¬ëª¨ë“œ ì „í™˜">
                    <span class="icon-sun">â˜€ï¸</span>
                    <span class="icon-moon">ğŸŒ™</span>
                </button>
                <div class="user-menu">
                    <div class="user-avatar">ì‚¬</div>
                    <div class="user-info">
                        <div class="user-name">ì‚¬ìš©ì</div>
                        <div class="user-role">Author</div>
                    </div>
                    <button class="user-menu-toggle">â–¼</button>
                </div>
            </div>
        </header>
    </div>

    <!-- ê³µí†µ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ -->
    <script src="../js/config.js"></script>
    <script src="../utils/ui-helpers.js"></script>
    <script src="../utils/session.js"></script>
    <script src="../utils/navigation.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/multi-llm-client.js"></script>
    <script src="../js/workflow-manager.js"></script>
    <script src="../js/qc-validator.js"></script>

    <!-- Dark Mode Script -->
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();

        function toggleDarkMode() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }
    </script>

    <!-- Approval Modal -->
    <div id="approvalModal" class="approval-modal">
        <div class="approval-modal-content">
            <h3 class="approval-modal-title">âœ… ìµœì¢… ìŠ¹ì¸</h3>
            <p class="approval-modal-message">
                ëª¨ë“  QC ê²€ì¦ì´ í†µê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ í•­ëª©ì„ í™•ì¸í•˜ê³  ìµœì¢… ìŠ¹ì¸í•´ì£¼ì„¸ìš”:
            </p>
            <div class="approval-checklist">
                <div class="approval-checklist-item">
                    <input type="checkbox" id="checkData">
                    <label for="checkData">ëª¨ë“  ë°ì´í„°ê°€ ì •í™•í•˜ê²Œ ì¶”ì¶œë˜ì—ˆìŠµë‹ˆë‹¤</label>
                </div>
                <div class="approval-checklist-item">
                    <input type="checkbox" id="checkConflict">
                    <label for="checkConflict">ë°ì´í„° ì¶©ëŒì´ ëª¨ë‘ í•´ê²°ë˜ì—ˆìŠµë‹ˆë‹¤</label>
                </div>
                <div class="approval-checklist-item">
                    <input type="checkbox" id="checkTable">
                    <label for="checkTable">í‘œ ë²ˆí˜¸ ìˆœì„œê°€ ì˜¬ë°”ë¦…ë‹ˆë‹¤</label>
                </div>
                <div class="approval-checklist-item">
                    <input type="checkbox" id="checkNarrative">
                    <label for="checkNarrative">ì„œìˆ ë¬¸ì´ ì†ŒìŠ¤ ë¬¸ì„œì™€ ì¼ì¹˜í•©ë‹ˆë‹¤</label>
                </div>
                <div class="approval-checklist-item">
                    <input type="checkbox" id="checkReview">
                    <label for="checkReview">ë¦¬ë·° ë³€ê²½ì‚¬í•­ì´ ëª¨ë‘ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤</label>
                </div>
            </div>
            <div class="approval-modal-footer">
                <button class="btn btn-secondary" onclick="closeApprovalModal()">ì·¨ì†Œ</button>
                <button class="btn btn-success" onclick="finalApprove()" id="approveBtn" disabled>
                    ìµœì¢… ìŠ¹ì¸ ë° Draft ìƒíƒœ ì œê±°
                </button>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ì˜ì¡´ì„± fallback (ê³µí†µ ìŠ¤í¬ë¦½íŠ¸ê°€ ë¡œë“œë˜ì§€ ì•Šì€ ê²½ìš°)
        // config.jsì—ì„œ ì´ë¯¸ ì„ ì–¸ëœ ê²½ìš° ì¬ì„ ì–¸í•˜ì§€ ì•ŠìŒ
        if (!window.CONFIG) {
            window.CONFIG = {
                SUPABASE_URL: 'https://toelnxgizxwbdikskmxa.supabase.co',
                SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvZWxueGdpenh3YmRpa3NrbXhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkwMDE0MDIsImV4cCI6MjA2NDU3NzQwMn0.LQNQJP93IjNA0PIoYj5UEfcBLgFckAbz_qJHpjlWpL0',
                APP_NAME: 'KPSUR AGENT',
                VERSION: '1.0.0'
            };
        }

        if (!window.Storage) {
            window.Storage = {
                get: (key) => { try { return JSON.parse(localStorage.getItem(key)); } catch { return null; } },
                set: (key, value) => { try { localStorage.setItem(key, JSON.stringify(value)); return true; } catch { return false; } },
                remove: (key) => { try { localStorage.removeItem(key); return true; } catch { return false; } }
            };
        }

        if (!window.DateHelper) {
            window.DateHelper = {
                format: (date, format = 'YYYY-MM-DD') => {
                    const d = new Date(date);
                    const year = d.getFullYear();
                    const month = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    const hours = String(d.getHours()).padStart(2, '0');
                    const minutes = String(d.getMinutes()).padStart(2, '0');
                    return format.replace('YYYY', year).replace('MM', month).replace('DD', day).replace('HH', hours).replace('mm', minutes);
                },
                formatISO: (date = new Date()) => date.toISOString(),
                now: () => new Date().toISOString()
            };
        }

        // qcValidator fallback (qc-validator.jsì—ì„œ ë¡œë“œ)
        if (!window.qcValidator) {
            window.qcValidator = {
                runFullQC: async (draft, source, extracted) => ({ success: true, issues: [] }),
                isPassed: () => true,
                validate: async (data, source) => ({ success: true, issues: [] }),
                getReport: () => ({})
            };
        }

        // config.jsì—ì„œ ë¡œë“œëœ ì „ì—­ ê°ì²´ ì‚¬ìš©
        // (const ì¬ì„ ì–¸ ê¸ˆì§€ - ì „ì—­ ìŠ¤ì½”í”„ ì¶©ëŒ ë°©ì§€)

        // AppLayout stub class
        class AppLayout {
            constructor(options = {}) {
                this.currentStage = options.currentStage || 0;
                this.reportName = options.reportName || '';
            }

            render(content) {
                return content;
            }
        }

        // authManager fallback (auth.jsì—ì„œ ì´ë¯¸ ì„ ì–¸ëœ ê²½ìš° ì¬ì„ ì–¸í•˜ì§€ ì•ŠìŒ)
        if (!window.authManager) {
            window.authManager = {
                isAuthenticated: () => true,
                getUser: () => ({ name: 'ê´€ë¦¬ì', role: 'Admin' })
            };
        }

        // Load reviewed sections and source documents
        const reviewedSections = Storage.get('reviewedSections') || {};
        const convertedMarkdowns = Storage.get('convertedMarkdowns') || [];
        const extractedData = Storage.get('extractedData') || {};

        // Combine all markdown as source documents
        const sourceDocuments = convertedMarkdowns.map(md => md.markdown).join('\n\n---\n\n');

        // Get draft report content
        const draftReport = Storage.get('draftReport') || {};
        const draftContent = draftReport.content || '';

        // Validation categories and items
        const validationCategories = [
            {
                id: 'data',
                name: 'ë°ì´í„° ì¶”ì¶œ ê²€ì¦',
                items: [
                    { id: 'data-1', name: 'CS ë°ì´í„° ì™„ì „ì„±', status: 'pending' },
                    { id: 'data-2', name: 'PH ë°ì´í„° ì™„ì „ì„±', status: 'pending' },
                    { id: 'data-3', name: 'í‘œ ë°ì´í„° ì™„ì „ì„±', status: 'pending' },
                    { id: 'data-4', name: 'ì†ŒìŠ¤ ë¬¸ì„œ ëŒ€ì¡°', status: 'pending' }
                ],
                status: 'pending'
            },
            {
                id: 'conflict',
                name: 'ë°ì´í„° ì¶©ëŒ ê²€ì¦',
                items: [
                    { id: 'conflict-1', name: 'ì„¹ì…˜ ê°„ ë°ì´í„° ì¼ì¹˜ì„±', status: 'pending' },
                    { id: 'conflict-2', name: 'ë‚ ì§œ ì •ë³´ ì¼ê´€ì„±', status: 'pending' },
                    { id: 'conflict-3', name: 'ìˆ˜ì¹˜ ë°ì´í„° ì¼ì¹˜ì„±', status: 'pending' }
                ],
                status: 'pending'
            },
            {
                id: 'structure',
                name: 'êµ¬ì¡° ê²€ì¦',
                items: [
                    { id: 'structure-1', name: 'í‘œ ë²ˆí˜¸ ìˆœì„œ', status: 'pending' },
                    { id: 'structure-2', name: 'ì„¹ì…˜ ë²ˆí˜¸ ìˆœì„œ', status: 'pending' },
                    { id: 'structure-3', name: 'ì°¸ì¡° ë¬¸í—Œ ì¼ì¹˜ì„±', status: 'pending' }
                ],
                status: 'pending'
            },
            {
                id: 'content',
                name: 'ë‚´ìš© ê²€ì¦',
                items: [
                    { id: 'content-1', name: 'ì„œìˆ ë¬¸ ì†ŒìŠ¤ ëŒ€ì¡°', status: 'pending' },
                    { id: 'content-2', name: 'í…œí”Œë¦¿ êµ¬ì¡° ì¤€ìˆ˜', status: 'pending' },
                    { id: 'content-3', name: 'ë¦¬ë·° ë³€ê²½ì‚¬í•­ ë°˜ì˜', status: 'pending' }
                ],
                status: 'pending'
            },
            {
                id: 'regulatory',
                name: 'ê·œì œ ì¤€ìˆ˜ ê²€ì¦',
                items: [
                    { id: 'regulatory-1', name: 'MFDS ê°€ì´ë“œë¼ì¸ ì¤€ìˆ˜', status: 'pending' },
                    { id: 'regulatory-2', name: 'í•„ìˆ˜ í•­ëª© í¬í•¨ ì—¬ë¶€', status: 'pending' },
                    { id: 'regulatory-3', name: 'ìš©ì–´ ì •í™•ì„±', status: 'pending' }
                ],
                status: 'pending'
            }
        ];

        let issues = [];
        let qcInProgress = false;

        // Initialize the page
        function init() {
            const layout = new AppLayout({
                currentStage: 8,
                reportName: 'testPill_1'
            });

            const content = `
                <div class="app-content">
                <main class="main-content">
                <div class="qc-container">
                    <div class="qc-main-grid">
                        <!-- Left Panel - Validation Checklist -->
                        <div class="validation-panel">
                            <div class="validation-header">
                                <h3 class="validation-title">ğŸ” QC ê²€ì¦ ì²´í¬ë¦¬ìŠ¤íŠ¸</h3>

                                <div class="validation-warning">
                                    <div class="validation-warning-title">âš ï¸ ì§‘ì¤‘ ê²€ì¦ ëª¨ë“œ</div>
                                    <div class="validation-warning-text">
                                        AIê°€ ë‹¨ê³„ë³„ë¡œ ì‹ ì¤‘í•˜ê²Œ ê²€ì¦í•©ë‹ˆë‹¤.<br>
                                        "Think step by step", "Take your time" í”„ë¡¬í”„íŠ¸ ì ìš©
                                    </div>
                                </div>

                                <div class="validation-progress">
                                    <div class="validation-progress-bar">
                                        <div class="validation-progress-fill" id="validationProgressBar" style="width: 0%"></div>
                                    </div>
                                    <div class="validation-progress-text">
                                        <span id="validationProgressText">0 / ${getTotalValidationItems()} í•­ëª© ì™„ë£Œ</span>
                                    </div>
                                </div>
                            </div>

                            <div id="validationCategories"></div>
                        </div>

                        <!-- Right Panel - Issues -->
                        <div class="issue-panel">
                            <div class="issue-header">
                                <h3 class="issue-title">ğŸ“‹ ë°œê²¬ëœ ì´ìŠˆ</h3>
                                <div class="issue-stats">
                                    <div class="issue-stat">
                                        <div class="issue-stat-value total" id="totalIssues">0</div>
                                        <div class="issue-stat-label">ì „ì²´</div>
                                    </div>
                                    <div class="issue-stat">
                                        <div class="issue-stat-value critical" id="criticalIssues">0</div>
                                        <div class="issue-stat-label">ì¤‘ëŒ€</div>
                                    </div>
                                    <div class="issue-stat">
                                        <div class="issue-stat-value warning" id="warningIssues">0</div>
                                        <div class="issue-stat-label">ê²½ê³ </div>
                                    </div>
                                    <div class="issue-stat">
                                        <div class="issue-stat-value passed" id="passedChecks">0</div>
                                        <div class="issue-stat-label">í†µê³¼</div>
                                    </div>
                                </div>
                            </div>

                            <div class="qc-controls">
                                <select class="llm-model-select" id="llmModel">
                                    <option value="gemini-3-flash-preview" selected>Gemini 3 Flash Preview (ê¸°ë³¸)</option>
                                    <option value="gemini-2.0-pro">Gemini 2.0 Pro (ì •í™•ë„ ìš°ì„ )</option>
                                    <option value="gemini-2.0-flash">Gemini 2.0 Flash (ì†ë„ ìš°ì„ )</option>
                                </select>
                                <button class="btn btn-primary magic-effect" onclick="startQC()" id="startQCBtn">
                                    âœ¨ QC ê²€ì¦ ì‹œì‘
                                </button>
                                <button class="btn btn-secondary" onclick="resetQC()" id="resetQCBtn" disabled>
                                    ğŸ”„ ì´ˆê¸°í™”
                                </button>
                            </div>

                            <div class="issue-content" id="issueContent">
                                <div class="issue-empty">
                                    <div class="issue-empty-icon">ğŸ”</div>
                                    <div class="issue-empty-text">
                                        "QC ê²€ì¦ ì‹œì‘" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬<br>
                                        ë³´ê³ ì„œ í’ˆì§ˆ ê²€ì¦ì„ ì‹œì‘í•˜ì„¸ìš”
                                    </div>
                                </div>
                            </div>

                            <!-- ìˆ˜ë™ ì²´í¬ë¦¬ìŠ¤íŠ¸ ì„¹ì…˜ -->
                            <div class="manual-checklist-section" id="manualChecklistSection">
                                <div class="manual-checklist-header">
                                    <h4 class="manual-checklist-title">ğŸ“‹ ìˆ˜ë™ ê²€ì¦ ì²´í¬ë¦¬ìŠ¤íŠ¸</h4>
                                    <div class="manual-checklist-progress">
                                        <span id="manualCheckProgress">0</span> / <span id="manualCheckTotal">12</span> ì™„ë£Œ
                                    </div>
                                </div>
                                <div class="manual-checklist-items">
                                    <div class="checklist-group">
                                        <div class="checklist-group-title">ğŸ“Š ë°ì´í„° ì •í™•ì„±</div>
                                        <label class="checklist-item">
                                            <input type="checkbox" class="manual-check" data-category="data">
                                            <span class="check-text">ëª¨ë“  CS ë°ì´í„°ê°€ ì›ë³¸ ë¬¸ì„œì™€ ì¼ì¹˜í•¨</span>
                                        </label>
                                        <label class="checklist-item">
                                            <input type="checkbox" class="manual-check" data-category="data">
                                            <span class="check-text">ëª¨ë“  PH ì„œìˆ ë¬¸ì´ ì •í™•í•˜ê²Œ ì¶”ì¶œë¨</span>
                                        </label>
                                        <label class="checklist-item">
                                            <input type="checkbox" class="manual-check" data-category="data">
                                            <span class="check-text">í‘œ ë°ì´í„° ìˆ«ìê°€ ì›ë³¸ê³¼ ë™ì¼í•¨</span>
                                        </label>
                                    </div>
                                    <div class="checklist-group">
                                        <div class="checklist-group-title">ğŸ“„ ë¬¸ì„œ êµ¬ì¡°</div>
                                        <label class="checklist-item">
                                            <input type="checkbox" class="manual-check" data-category="structure">
                                            <span class="check-text">í‘œ ë²ˆí˜¸ê°€ ìˆœì°¨ì ìœ¼ë¡œ ì •ë ¬ë¨</span>
                                        </label>
                                        <label class="checklist-item">
                                            <input type="checkbox" class="manual-check" data-category="structure">
                                            <span class="check-text">ì„¹ì…˜ ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ê²Œ ì§€ì •ë¨</span>
                                        </label>
                                        <label class="checklist-item">
                                            <input type="checkbox" class="manual-check" data-category="structure">
                                            <span class="check-text">ëª©ì°¨ì™€ ì‹¤ì œ ì„¹ì…˜ì´ ì¼ì¹˜í•¨</span>
                                        </label>
                                    </div>
                                    <div class="checklist-group">
                                        <div class="checklist-group-title">âœï¸ ë‚´ìš© ê²€í† </div>
                                        <label class="checklist-item">
                                            <input type="checkbox" class="manual-check" data-category="content">
                                            <span class="check-text">ì„œìˆ ë¬¸ì´ RAW ë¬¸ì„œ ë‚´ìš©ê³¼ ì¼ì¹˜í•¨</span>
                                        </label>
                                        <label class="checklist-item">
                                            <input type="checkbox" class="manual-check" data-category="content">
                                            <span class="check-text">ì˜í•™ ìš©ì–´ê°€ ì •í™•í•˜ê²Œ ì‚¬ìš©ë¨</span>
                                        </label>
                                        <label class="checklist-item">
                                            <input type="checkbox" class="manual-check" data-category="content">
                                            <span class="check-text">ë¦¬ë·°ì—ì„œ ìˆ˜ì •í•œ ë‚´ìš©ì´ ë°˜ì˜ë¨</span>
                                        </label>
                                    </div>
                                    <div class="checklist-group">
                                        <div class="checklist-group-title">âš–ï¸ ê·œì • ì¤€ìˆ˜</div>
                                        <label class="checklist-item">
                                            <input type="checkbox" class="manual-check" data-category="regulatory">
                                            <span class="check-text">MFDS ê°€ì´ë“œë¼ì¸ ìš”êµ¬ì‚¬í•­ ì¶©ì¡±</span>
                                        </label>
                                        <label class="checklist-item">
                                            <input type="checkbox" class="manual-check" data-category="regulatory">
                                            <span class="check-text">í•„ìˆ˜ ì„¹ì…˜ì´ ëª¨ë‘ í¬í•¨ë¨</span>
                                        </label>
                                        <label class="checklist-item">
                                            <input type="checkbox" class="manual-check" data-category="regulatory">
                                            <span class="check-text">íšŒì‚¬ ì •ë³´ê°€ ì •í™•í•˜ê²Œ ê¸°ì¬ë¨</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="qc-footer">
                                <div class="footer-message" id="footerMessage">
                                    ê²€ì¦ì„ ì‹œì‘í•˜ë ¤ë©´ "QC ê²€ì¦ ì‹œì‘" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”
                                </div>
                                <div class="footer-actions">
                                    <button class="btn btn-secondary" onclick="exportIssueReport()" id="exportIssuesBtn" style="display: none;">
                                        ğŸ“„ ì´ìŠˆ ë¦¬í¬íŠ¸ ë‚´ë³´ë‚´ê¸°
                                    </button>
                                    <button class="btn btn-success" onclick="showApprovalModal()" id="approveBtn" style="display: none;">
                                        âœ… ìµœì¢… ìŠ¹ì¸
                                    </button>
                                    <button class="btn btn-success" onclick="proceedToOutput()">
                                        ìµœì¢… ì¶œë ¥ ë‹¨ê³„ë¡œ â†’
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </main>
                </div>

                <!-- Footer -->
                <footer class="app-footer">
                    <div class="footer-content">
                        Copyright. Power Solution., Inc. 2026.
                    </div>
                </footer>
            `;

            const appElement = document.getElementById('app');
            const header = appElement.querySelector('.app-header');
            if (header) {
                header.insertAdjacentHTML('afterend', layout.render(content));
            } else {
                appElement.innerHTML = layout.render(content);
            }

            renderValidationCategories();
            updateStats();
        }

        function getTotalValidationItems() {
            return validationCategories.reduce((sum, cat) => sum + cat.items.length, 0);
        }

        // Render validation categories
        function renderValidationCategories() {
            const html = validationCategories.map(category => `
                <div class="validation-category">
                    <div class="validation-category-title">
                        ${category.name}
                        <span class="category-status ${category.status}">${getStatusLabel(category.status)}</span>
                    </div>
                    ${category.items.map(item => `
                        <div class="validation-item ${item.status}">
                            <span class="validation-item-name">${item.name}</span>
                            <span class="validation-item-status">${getStatusIcon(item.status)}</span>
                        </div>
                    `).join('')}
                </div>
            `).join('');

            document.getElementById('validationCategories').innerHTML = html;
        }

        function getStatusLabel(status) {
            const labels = {
                'pending': 'ëŒ€ê¸°',
                'checking': 'ê²€ì¦ ì¤‘',
                'passed': 'í†µê³¼',
                'failed': 'ì‹¤íŒ¨'
            };
            return labels[status] || status;
        }

        function getStatusIcon(status) {
            const icons = {
                'pending': 'â—‹',
                'checking': 'â³',
                'passed': 'âœ“',
                'failed': 'âœ—'
            };
            return icons[status] || 'â—‹';
        }

        // Start QC validation
        async function startQC() {
            const model = document.getElementById('llmModel').value;

            qcInProgress = true;
            document.getElementById('startQCBtn').disabled = true;
            document.getElementById('resetQCBtn').disabled = false;

            showLLMLoading(`${model}ë¥¼ ì‚¬ìš©í•˜ì—¬ QC ê²€ì¦ì„ ìˆ˜í–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤...`);

            issues = [];

            try {
                // Run full QC validation using qcValidator
                const qcResult = await qcValidator.runFullQC(
                    draftContent,
                    sourceDocuments,
                    extractedData
                );

                if (qcResult.success) {
                    issues = qcResult.issues || [];

                    // Update validation categories based on issues
                    validationCategories.forEach(category => {
                        // Set all items to passed first
                        category.items.forEach(item => {
                            item.status = 'passed';
                        });

                        // Category status is derived from items - if all items passed, category passed
                        const hasFailedItem = category.items.some(item => item.status === 'failed');
                        category.status = hasFailedItem ? 'failed' : 'passed';
                    });

                    console.log(`QC completed: ${issues.length} issues found`);
                } else {
                    throw new Error(qcResult.error || 'QC validation failed');
                }
            } catch (error) {
                console.error('QC validation error:', error);
                showToast('QC ê²€ì¦ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            }

            hideLLMLoading();
            qcInProgress = false;

            // Update UI
            renderValidationCategories();
            const completedItems = validationCategories.reduce((sum, cat) =>
                sum + cat.items.filter(item => item.status === 'passed' || item.status === 'failed').length, 0
            );
            updateProgress(completedItems, getTotalValidationItems());
            renderIssues();
            updateStats();
            updateFooterMessage();
        }

        // Generate sample issue
        function generateIssue(category, item) {
            const issueTemplates = {
                'data-1': {
                    severity: 'critical',
                    title: 'CS15_íš¨ëŠ¥íš¨ê³¼ ë°ì´í„° ëˆ„ë½',
                    description: 'CS15_íš¨ëŠ¥íš¨ê³¼ í•„ë“œì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì†ŒìŠ¤ ë¬¸ì„œ RAW2.2ì—ì„œ ë°ì´í„°ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
                    location: 'Section 01 - ê°œìš”',
                    source: 'RAW2.2_íš¨ëŠ¥íš¨ê³¼.md'
                },
                'conflict-1': {
                    severity: 'critical',
                    title: 'ì„¹ì…˜ ê°„ íŒë§¤ëŸ‰ ë°ì´í„° ë¶ˆì¼ì¹˜',
                    description: 'Section 03ê³¼ Section 12ì—ì„œ 2024ë…„ íŒë§¤ëŸ‰ì´ ì„œë¡œ ë‹¤ë¦…ë‹ˆë‹¤. (12,543 vs 12,450)',
                    location: 'Section 03, Section 12',
                    source: 'Multiple sections'
                },
                'structure-1': {
                    severity: 'warning',
                    title: 'í‘œ ë²ˆí˜¸ ìˆœì„œ ì˜¤ë¥˜',
                    description: 'Section 04ì— í‘œ3ì´ ìˆì–´ì•¼ í•˜ëŠ”ë° í‘œ5ê°€ ë¨¼ì € ë‚˜íƒ€ë‚¬ìŠµë‹ˆë‹¤.',
                    location: 'Section 04',
                    source: 'Template structure'
                },
                'content-1': {
                    severity: 'warning',
                    title: 'ì„œìˆ ë¬¸ê³¼ ì†ŒìŠ¤ ë¬¸ì„œ ë¶ˆì¼ì¹˜',
                    description: 'PH1_ì‹œíŒí›„salesë°ì´í„°ì„œìˆ ë¬¸ì˜ ë‚´ìš©ì´ RAW3_ì‹œíŒí›„salesë°ì´í„°.mdì™€ ì¼ë¶€ ìƒì´í•©ë‹ˆë‹¤.',
                    location: 'Section 03',
                    source: 'RAW3_ì‹œíŒí›„salesë°ì´í„°.md'
                }
            };

            const template = issueTemplates[item.id] || {
                severity: 'info',
                title: `${item.name} ê²€ì¦ ì´ìŠˆ`,
                description: `${item.name} í•­ëª©ì—ì„œ ë¬¸ì œê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.`,
                location: category.name,
                source: 'Unknown'
            };

            return {
                id: issues.length + 1,
                categoryId: category.id,
                itemId: item.id,
                ...template,
                status: 'open',
                timestamp: new Date().toISOString()
            };
        }

        // Render issues
        function renderIssues() {
            if (issues.length === 0) {
                document.getElementById('issueContent').innerHTML = `
                    <div class="issue-empty">
                        <div class="issue-empty-icon">âœ…</div>
                        <div class="issue-empty-text">
                            ëª¨ë“  ê²€ì¦ í•­ëª©ì„ í†µê³¼í–ˆìŠµë‹ˆë‹¤!<br>
                            ìµœì¢… ìŠ¹ì¸ì„ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        </div>
                    </div>
                `;
                document.getElementById('approveBtn').style.display = 'block';
                return;
            }

            const issuesHtml = `
                <div class="issue-list">
                    ${issues.map(issue => `
                        <div class="issue-card ${issue.severity}">
                            <div class="issue-card-header">
                                <div class="issue-card-title">${issue.title}</div>
                                <div class="issue-card-severity ${issue.severity}">
                                    ${issue.severity === 'critical' ? 'ğŸ”´ ì¤‘ëŒ€' : issue.severity === 'warning' ? 'ğŸŸ¡ ê²½ê³ ' : 'ğŸ”µ ì •ë³´'}
                                </div>
                            </div>
                            <div class="issue-card-description">${issue.description}</div>
                            <div class="issue-card-details">
                                <div class="issue-card-detail-row">
                                    <span class="issue-card-detail-label">ìœ„ì¹˜:</span>
                                    <span class="issue-card-detail-value">${issue.location}</span>
                                </div>
                                <div class="issue-card-detail-row">
                                    <span class="issue-card-detail-label">ì†ŒìŠ¤:</span>
                                    <span class="issue-card-detail-value">${issue.source}</span>
                                </div>
                                <div class="issue-card-detail-row">
                                    <span class="issue-card-detail-label">ë°œê²¬ ì‹œê°:</span>
                                    <span class="issue-card-detail-value">${new Date(issue.timestamp).toLocaleString('ko-KR')}</span>
                                </div>
                            </div>
                            <div class="issue-card-actions">
                                <button class="issue-action-btn" onclick="navigateToIssue(${issue.id})">
                                    ğŸ“ í•´ë‹¹ ìœ„ì¹˜ë¡œ ì´ë™
                                </button>
                                <button class="issue-action-btn resolve" onclick="resolveIssue(${issue.id})">
                                    âœ“ í•´ê²° ì™„ë£Œ
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            document.getElementById('issueContent').innerHTML = issuesHtml;
            document.getElementById('exportIssuesBtn').style.display = 'block';
        }

        // Update progress
        function updateProgress(completed, total) {
            const percentage = (completed / total) * 100;
            document.getElementById('validationProgressBar').style.width = percentage + '%';
            document.getElementById('validationProgressText').textContent = `${completed} / ${total} í•­ëª© ì™„ë£Œ`;
        }

        // Update statistics
        function updateStats() {
            const criticalCount = issues.filter(i => i.severity === 'critical').length;
            const warningCount = issues.filter(i => i.severity === 'warning').length;
            const passedCount = validationCategories.reduce((sum, cat) =>
                sum + cat.items.filter(item => item.status === 'passed').length, 0
            );

            document.getElementById('totalIssues').textContent = issues.length;
            document.getElementById('criticalIssues').textContent = criticalCount;
            document.getElementById('warningIssues').textContent = warningCount;
            document.getElementById('passedChecks').textContent = passedCount;
        }

        // Update footer message
        function updateFooterMessage() {
            const message = document.getElementById('footerMessage');
            const criticalCount = issues.filter(i => i.severity === 'critical').length;

            if (criticalCount > 0) {
                message.textContent = `âš ï¸ ${criticalCount}ê°œì˜ ì¤‘ëŒ€í•œ ì´ìŠˆê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ìŠˆë¥¼ í•´ê²°í•œ í›„ ë‹¤ì‹œ ê²€ì¦í•´ì£¼ì„¸ìš”.`;
                message.className = 'footer-message error';
            } else if (issues.length > 0) {
                message.textContent = `âš ï¸ ${issues.length}ê°œì˜ ê²½ê³ ê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. ê²€í†  í›„ ìŠ¹ì¸ ì—¬ë¶€ë¥¼ ê²°ì •í•´ì£¼ì„¸ìš”.`;
                message.className = 'footer-message';
            } else {
                message.textContent = `âœ… ëª¨ë“  ê²€ì¦ í•­ëª©ì„ í†µê³¼í–ˆìŠµë‹ˆë‹¤! ìµœì¢… ìŠ¹ì¸ì„ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
                message.className = 'footer-message success';
            }
        }

        // Reset QC
        function resetQC() {
            if (!confirm('QC ê²€ì¦ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            validationCategories.forEach(category => {
                category.status = 'pending';
                category.items.forEach(item => item.status = 'pending');
            });

            issues = [];
            qcInProgress = false;

            document.getElementById('startQCBtn').disabled = false;
            document.getElementById('resetQCBtn').disabled = true;
            document.getElementById('approveBtn').style.display = 'none';
            document.getElementById('exportIssuesBtn').style.display = 'none';

            renderValidationCategories();
            updateProgress(0, getTotalValidationItems());
            updateStats();

            document.getElementById('issueContent').innerHTML = `
                <div class="issue-empty">
                    <div class="issue-empty-icon">ğŸ”</div>
                    <div class="issue-empty-text">
                        "QC ê²€ì¦ ì‹œì‘" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬<br>
                        ë³´ê³ ì„œ í’ˆì§ˆ ê²€ì¦ì„ ì‹œì‘í•˜ì„¸ìš”
                    </div>
                </div>
            `;

            document.getElementById('footerMessage').textContent = 'ê²€ì¦ì„ ì‹œì‘í•˜ë ¤ë©´ "QC ê²€ì¦ ì‹œì‘" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”';
            document.getElementById('footerMessage').className = 'footer-message';
        }

        // Navigate to issue location
        function navigateToIssue(issueId) {
            const issue = issues.find(i => i.id === issueId);
            showToast(`${issue.location}ë¡œ ì´ë™í•©ë‹ˆë‹¤`, 'info');
            // In real implementation, this would navigate to the specific section
        }

        // Resolve issue
        function resolveIssue(issueId) {
            const issueIndex = issues.findIndex(i => i.id === issueId);
            if (issueIndex !== -1) {
                issues.splice(issueIndex, 1);
                renderIssues();
                updateStats();
                updateFooterMessage();
                showToast('ì´ìŠˆê°€ í•´ê²°ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            }
        }

        // Export issue report
        function exportIssueReport() {
            showToast('ì´ìŠˆ ë¦¬í¬íŠ¸ë¥¼ ë‚´ë³´ë‚´ê³  ìˆìŠµë‹ˆë‹¤...', 'info');
            setTimeout(() => {
                showToast('ì´ìŠˆ ë¦¬í¬íŠ¸ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            }, 1000);
        }

        // Approval modal
        function showApprovalModal() {
            if (issues.length > 0) {
                showToast('ëª¨ë“  ì´ìŠˆë¥¼ í•´ê²°í•œ í›„ ìŠ¹ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤', 'error');
                return;
            }

            document.getElementById('approvalModal').classList.add('show');
            updateApproveButton();
        }

        function closeApprovalModal() {
            document.getElementById('approvalModal').classList.remove('show');
        }

        function updateApproveButton() {
            const checkboxes = document.querySelectorAll('.approval-checklist-item input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);

            document.getElementById('approveBtn').disabled = !allChecked;

            checkboxes.forEach(cb => {
                cb.addEventListener('change', () => {
                    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                    document.getElementById('approveBtn').disabled = !allChecked;
                });
            });
        }

        // Final approval
        function finalApprove() {
            showLLMLoading('ìµœì¢… ìŠ¹ì¸ì„ ì²˜ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤...');

            setTimeout(() => {
                hideLLMLoading();
                closeApprovalModal();
                showToast('ìµœì¢… ìŠ¹ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. Draft ìƒíƒœê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');

                // Update footer message
                document.getElementById('footerMessage').textContent = 'âœ… ìµœì¢… ìŠ¹ì¸ ì™„ë£Œ! ìµœì¢… ì¶œë ¥ ë‹¨ê³„ë¡œ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
                document.getElementById('footerMessage').className = 'footer-message success';
            }, 2000);
        }

        // Proceed to output stage
        function proceedToOutput() {
            // Save QC results to localStorage
            Storage.set('qcResults', {
                issues: issues,
                passed: qcValidator.isPassed(),
                validatedAt: DateHelper.formatISO()
            });

            const reportId = new URLSearchParams(window.location.search).get('reportId') || Date.now().toString();
            navigateTo(`P20_Output.html?reportId=${reportId}`);
        }

        // ìˆ˜ë™ ì²´í¬ë¦¬ìŠ¤íŠ¸ ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸
        function updateManualCheckProgress() {
            const checkboxes = document.querySelectorAll('.manual-check');
            const checked = Array.from(checkboxes).filter(cb => cb.checked).length;
            const total = checkboxes.length;

            document.getElementById('manualCheckProgress').textContent = checked;
            document.getElementById('manualCheckTotal').textContent = total;

            // ëª¨ë“  í•­ëª©ì´ ì²´í¬ë˜ë©´ ìŠ¹ì¸ ë²„íŠ¼ í™œì„±í™”
            if (checked === total && issues.length === 0) {
                document.getElementById('approveBtn').style.display = 'block';
            }

            // localStorageì— ì²´í¬ ìƒíƒœ ì €ì¥
            const checkStates = {};
            checkboxes.forEach((cb, index) => {
                checkStates[`check_${index}`] = cb.checked;
            });
            Storage.set('manualQCChecks', checkStates);
        }

        // ìˆ˜ë™ ì²´í¬ë¦¬ìŠ¤íŠ¸ ìƒíƒœ ë³µì›
        function restoreManualCheckStates() {
            const savedStates = Storage.get('manualQCChecks') || {};
            const checkboxes = document.querySelectorAll('.manual-check');

            checkboxes.forEach((cb, index) => {
                if (savedStates[`check_${index}`]) {
                    cb.checked = true;
                }
            });

            updateManualCheckProgress();
        }

        // ìˆ˜ë™ ì²´í¬ë¦¬ìŠ¤íŠ¸ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupManualChecklistListeners() {
            document.querySelectorAll('.manual-check').forEach(cb => {
                cb.addEventListener('change', updateManualCheckProgress);
            });
        }

        // Initialize on load
        init();
        setupManualChecklistListeners();
        restoreManualCheckStates();
    </script>
</body>
</html>

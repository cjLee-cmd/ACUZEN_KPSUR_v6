<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P-17 Template Writing - KPSUR AGENT</title>
    <link rel="stylesheet" href="../css/styles/globals.css">
    <link rel="stylesheet" href="../css/styles/layout.css">
    <link rel="stylesheet" href="../css/styles/components.css">
    <style>
        /* ë‹¤í¬ëª¨ë“œ ë³€ìˆ˜ */
        :root {
            --page-bg: #F5F7FA;
            --card-bg: white;
            --card-shadow: rgba(0, 0, 0, 0.1);
            --text-primary: #07161D;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --border-color: #e2e8f0;
            --section-bg: #f8fafc;
            --input-bg: white;
            --info-bg: #EBF5FF;
            --info-text: #122E4E;
        }

        [data-theme="dark"] {
            --page-bg: #1e293b;
            --card-bg: #1e293b;
            --card-shadow: none;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: #334155;
            --section-bg: #334155;
            --input-bg: #334155;
            --info-bg: rgba(37, 115, 155, 0.2);
            --info-text: #94a3b8;
        }

        /* ë‹¤í¬ëª¨ë“œ íŒ¨ë„ ìŠ¤íƒ€ì¼ */
        [data-theme="dark"] .section-list-panel,
        [data-theme="dark"] .template-panel,
        [data-theme="dark"] .progress-stats {
            background: transparent !important;
            border-color: #475569;
        }

        [data-theme="dark"] .section-item {
            background: #334155;
        }

        [data-theme="dark"] .section-item:hover {
            background: #475569;
        }

        [data-theme="dark"] .section-item.active {
            background: rgba(37, 115, 155, 0.3);
        }

        [data-theme="dark"] .section-item.completed {
            background: rgba(16, 185, 129, 0.2);
        }

        [data-theme="dark"] .section-status.pending {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        [data-theme="dark"] .section-status.processing {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }

        [data-theme="dark"] .section-status.completed {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
        }

        [data-theme="dark"] .data-placeholder {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        [data-theme="dark"] .data-filled {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
        }

        [data-theme="dark"] .data-mapping-item {
            background: #334155;
            border-color: #475569;
        }

        [data-theme="dark"] .data-mapping-item.filled {
            background: rgba(16, 185, 129, 0.2);
            border-color: #10B981;
        }

        [data-theme="dark"] .data-mapping-item.missing {
            background: rgba(251, 191, 36, 0.2);
            border-color: #fbbf24;
        }

        .template-container {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 16px;
            padding: 16px;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Left Panel - Section List */
        .section-list-panel {
            background: var(--card-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            padding: 16px;
            overflow-y: auto;
        }

        .section-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .section-list-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .section-progress {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .section-item {
            padding: 10px;
            margin-bottom: 6px;
            background: var(--section-bg);
            border-radius: 6px;
            border-left: 3px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }

        .section-item:hover {
            background: #f1f5f9;
        }

        .section-item.active {
            background: var(--info-bg);
            border-left-color: #25739B;
        }

        .section-item.completed {
            background: #ECFDF5;
            border-left-color: #10B981;
        }

        .section-number {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .section-name {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 6px;
        }

        .section-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 10px;
        }

        .section-type {
            color: var(--text-secondary);
        }

        .section-status {
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 500;
        }

        .section-status.pending {
            background: #FEF3C7;
            color: #92400E;
        }

        .section-status.processing {
            background: #DBEAFE;
            color: #1E40AF;
        }

        .section-status.completed {
            background: #D1FAE5;
            color: #065F46;
        }

        /* Main Panel - Template Editor */
        .template-panel {
            background: var(--card-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .template-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            background: var(--section-bg);
        }

        .template-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 8px 0;
        }

        .template-info {
            background: var(--info-bg);
            border-left: 4px solid #25739B;
            padding: 12px;
            margin-bottom: 12px;
            border-radius: 4px;
        }

        .template-info-title {
            font-weight: 600;
            color: var(--info-text);
            font-size: 13px;
            margin-bottom: 4px;
        }

        .template-info-text {
            font-size: 11px;
            color: var(--info-text);
            line-height: 1.4;
        }

        .template-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .template-mode-select {
            padding: 6px 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 12px;
            color: var(--text-primary);
            background: var(--input-bg);
        }

        .template-content {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            padding: 16px;
            overflow-y: auto;
        }

        .template-column {
            display: flex;
            flex-direction: column;
        }

        .column-header {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--border-color);
        }

        .template-editor {
            flex: 1;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--section-bg);
            color: var(--text-primary);
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .data-placeholder {
            background: #FEF3C7;
            color: #92400E;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: 600;
        }

        .data-filled {
            background: #D1FAE5;
            color: #065F46;
            padding: 2px 4px;
            border-radius: 3px;
        }

        .preview-panel {
            flex: 1;
            padding: 16px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--card-bg);
            overflow-y: auto;
            line-height: 1.8;
        }

        .preview-panel h1 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .preview-panel h2 {
            font-size: 16px;
            font-weight: 600;
            color: #25739B;
            margin: 16px 0 8px 0;
        }

        .preview-panel p {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .preview-panel table {
            width: 100%;
            border-collapse: collapse;
            margin: 12px 0;
            font-size: 12px;
        }

        .preview-panel th {
            background: #25739B;
            color: white;
            padding: 8px;
            text-align: left;
            font-weight: 500;
        }

        .preview-panel td {
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .data-mapping-panel {
            background: var(--section-bg);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 12px;
        }

        .data-mapping-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .data-mapping-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }

        .data-mapping-item {
            font-size: 11px;
            padding: 4px 6px;
            background: var(--card-bg);
            border-radius: 3px;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .data-mapping-item.filled {
            border-color: #10B981;
            background: #ECFDF5;
        }

        .data-mapping-item.missing {
            border-color: #fbbf24;
            background: #FEF3C7;
        }

        .action-footer {
            padding: 16px;
            border-top: 1px solid var(--border-color);
            background: var(--section-bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .footer-info {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .footer-actions {
            display: flex;
            gap: 8px;
        }

        /* Progress Stats */
        .progress-stats {
            background: var(--card-bg);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 12px;
            border: 1px solid var(--border-color);
        }

        .progress-stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .progress-stat-item {
            text-align: center;
        }

        .progress-stat-value {
            font-size: 20px;
            font-weight: 600;
            color: #25739B;
        }

        .progress-stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="app-layout" id="app">
        <!-- Header -->
        <header class="app-header">
            <div class="header-left">
                <div class="logo">
                    <span class="logo-text">KPSUR AGENT</span>
                    <span class="logo-subtitle">ACUZEN AI</span>
                </div>
                <span class="deployment-badge test">í…ŒìŠ¤íŠ¸</span>
            </div>

            <div class="header-center">
                <div class="breadcrumb">
                    <span class="breadcrumb-item">ëŒ€ì‹œë³´ë“œ</span>
                    <span class="breadcrumb-separator">/</span>
                    <span class="breadcrumb-item">ë³´ê³ ì„œ</span>
                    <span class="breadcrumb-separator">/</span>
                    <span class="breadcrumb-item active">í…œí”Œë¦¿ ì‘ì„±</span>
                </div>
            </div>

            <div class="header-right">
                <button class="dark-mode-toggle" onclick="toggleDarkMode()" title="ë‹¤í¬ëª¨ë“œ ì „í™˜">
                    <span class="icon-sun">â˜€ï¸</span>
                    <span class="icon-moon">ğŸŒ™</span>
                </button>
                <div class="user-menu">
                    <div class="user-avatar">ì‚¬</div>
                    <div class="user-info">
                        <div class="user-name">ì‚¬ìš©ì</div>
                        <div class="user-role">Author</div>
                    </div>
                </div>
            </div>
        </header>
    </div>

    <!-- ê³µí†µ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ -->
    <script src="../js/config.js"></script>
    <script src="../utils/ui-helpers.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/workflow-manager.js"></script>

    <!-- Dark Mode Script -->
    <script>
        // ë‹¤í¬ëª¨ë“œ ì´ˆê¸°í™” (í˜ì´ì§€ ë¡œë“œ ì¦‰ì‹œ)
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();

        // ë‹¤í¬ëª¨ë“œ í† ê¸€ í•¨ìˆ˜
        function toggleDarkMode() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }
    </script>

    <script>
        // ì „ì—­ ì˜ì¡´ì„± fallback (ê³µí†µ ìŠ¤í¬ë¦½íŠ¸ê°€ ë¡œë“œë˜ì§€ ì•Šì€ ê²½ìš°)
        const CONFIG = window.CONFIG || {
            PAGES: {
                LOGIN: 'P01_Login.html',
                DASHBOARD: 'P10_Dashboard.html',
                SETTINGS: 'P91_Settings.html'
            },
            STORAGE_KEYS: {
                GOOGLE_API_KEY: 'GOOGLE_API_KEY',
                SESSION: 'session',
                CURRENT_REPORT: 'current_report'
            }
        };

        const Storage = window.Storage || {
            get: (key) => { try { return JSON.parse(localStorage.getItem(key)); } catch { return null; } },
            set: (key, value) => { try { localStorage.setItem(key, JSON.stringify(value)); return true; } catch { return false; } },
            remove: (key) => { try { localStorage.removeItem(key); return true; } catch { return false; } }
        };

        const DateHelper = window.DateHelper || {
            now: () => new Date(),
            formatYYMMDD_hhmmss: (date = new Date()) => {
                const yy = String(date.getFullYear()).slice(-2);
                const MM = String(date.getMonth() + 1).padStart(2, '0');
                const DD = String(date.getDate()).padStart(2, '0');
                const hh = String(date.getHours()).padStart(2, '0');
                const mm = String(date.getMinutes()).padStart(2, '0');
                const ss = String(date.getSeconds()).padStart(2, '0');
                return `${yy}${MM}${DD}_${hh}${mm}${ss}`;
            },
            formatISO: (date = new Date()) => date.toISOString()
        };

        // TemplateWriter stub - minimal implementation for page to function
        const templateWriter = {
            async loadTemplate(templatePath) {
                console.log(`ğŸ“„ Loading template: ${templatePath}`);
                // Stub implementation
                return {
                    success: true,
                    content: '# í…œí”Œë¦¿ ë‚´ìš©\n\n{{CS0}} {{CS1}}\n\n{{PH1}}'
                };
            },

            async populateTemplate(templateContent, extractedData, section) {
                console.log(`ğŸ“ Populating template for section: ${section.id}`);
                // Stub implementation - simple variable replacement
                let content = templateContent;

                // Replace CS variables
                if (extractedData.cs) {
                    Object.keys(extractedData.cs).forEach(key => {
                        const value = extractedData.cs[key];
                        content = content.replace(new RegExp(`{{${key}}}`, 'g'), value || '');
                    });
                }

                // Replace PH variables
                if (extractedData.ph) {
                    Object.keys(extractedData.ph).forEach(key => {
                        const value = extractedData.ph[key];
                        content = content.replace(new RegExp(`{{${key}}}`, 'g'), value || '');
                    });
                }

                return {
                    success: true,
                    content: content
                };
            },

            async mergeAllSections(sectionContents) {
                console.log('ğŸ“‘ Merging all sections...');
                // Stub implementation
                const merged = sectionContents.map(s => s.content).join('\n\n---\n\n');
                return {
                    success: true,
                    content: merged,
                    filename: `report_${DateHelper.formatYYMMDD_hhmmss()}.md`
                };
            }
        };

        // AuthManager stub - minimal implementation
        const authManager = {
            getCurrentUser() {
                const session = Storage.get(CONFIG.STORAGE_KEYS.SESSION);
                return session ? session.user : null;
            },

            checkSession() {
                const session = Storage.get(CONFIG.STORAGE_KEYS.SESSION);
                if (!session) {
                    return { authenticated: false };
                }
                return {
                    authenticated: true,
                    user: session.user,
                    session: session
                };
            },

            redirectToLogin() {
                window.location.href = CONFIG.PAGES.LOGIN;
            }
        };

        // AppLayout stub - simple layout wrapper without ES6 modules
        class AppLayout {
            constructor(options = {}) {
                this.currentStage = options.currentStage || 0;
                this.reportName = options.reportName || '';
            }

            render(content) {
                // Simple wrapper that just returns the content
                return content;
            }
        }

        // Section definitions (15 sections: 00-14)
        const sections = [
            { id: 'S00', number: '00', name: 'í‘œì§€', type: 'CS', status: 'pending', csFields: ['CS0', 'CS1', 'CS2', 'CS6', 'CS7', 'CS8'] },
            { id: 'S01', number: '01', name: 'ê°œìš”', type: 'CS', status: 'pending', csFields: ['CS0', 'CS1', 'CS5', 'CS15', 'CS16'] },
            { id: 'S02', number: '02', name: 'êµ­ë‚´ì™¸í—ˆê°€í˜„í™©', type: 'Table', status: 'pending', tableId: 'T1' },
            { id: 'S03', number: '03', name: 'ì‹œíŒí›„salesë°ì´í„°', type: 'CS+PH+Table', status: 'pending', csFields: ['CS10', 'CS11'], phFields: ['PH1'], tableId: 'T2' },
            { id: 'S04', number: '04', name: 'êµ­ë‚´ì‹ ì†ë³´ê³ ë‚´ì—­', type: 'PH+Table', status: 'pending', phFields: ['PH2'], tableId: 'T3' },
            { id: 'S05', number: '05', name: 'êµ­ë‚´ì •ê¸°ë³´ê³ ë‚´ì—­', type: 'PH+Table', status: 'pending', phFields: ['PH3'], tableId: 'T4' },
            { id: 'S06', number: '06', name: 'êµ­ë‚´ì›ì‹œìë£Œ', type: 'PH+Table', status: 'pending', phFields: ['PH4'], tableId: 'T5' },
            { id: 'S07', number: '07', name: 'êµ­ë‚´ì™¸ì•ˆì „ì„±ì¡°ì¹˜í˜„í™©', type: 'PH+Table', status: 'pending', phFields: ['PH5'], tableId: 'T6' },
            { id: 'S08', number: '08', name: 'êµ­ë‚´ì™¸íŒë§¤ì¤‘ì§€í˜„í™©', type: 'PH+Table', status: 'pending', phFields: ['PH6', 'PH7'], tableId: 'T7' },
            { id: 'S09', number: '09', name: 'í•´ì™¸ì‹ ì†ë³´ê³ ë‚´ì—­', type: 'PH', status: 'pending', phFields: ['PH8'] },
            { id: 'S10', number: '10', name: 'í•´ì™¸ì •ê¸°ë³´ê³ ë‚´ì—­', type: 'PH', status: 'pending', phFields: ['PH9'] },
            { id: 'S11', number: '11', name: 'í•´ì™¸ì›ì‹œìë£Œ', type: 'PH', status: 'pending', phFields: ['PH10'] },
            { id: 'S12', number: '12', name: 'ì´ê´„í‰ê°€', type: 'PH', status: 'pending', phFields: ['PH11'] },
            { id: 'S13', number: '13', name: 'ê²°ë¡ ', type: 'PH', status: 'pending', phFields: ['PH12'] },
            { id: 'S14', number: '14', name: 'ì°¸ê³ ë¬¸í—Œ', type: 'Manual', status: 'pending', csFields: [] }
        ];

        // Template paths (stored in ../03_Template/)
        const TEMPLATE_BASE_PATH = '../../../03_Template/';

        let currentSection = sections[0];
        let templateMode = 'auto'; // auto or manual

        // Section templates - basic templates for each section
        const sectionTemplates = {
            'S00': '# 00. í‘œì§€\n\n[CS0] [CS1]\n[CS2]\nì‘ì„±ì: [CS6]\në¶€ì„œ: [CS7]\nì‘ì„±ì¼: [CS8]',
            'S01': '# 01. ê°œìš”\n\nì„±ë¶„ëª…: [CS0]\në¸Œëœë“œëª…: [CS1]\ní—ˆê°€ì¼: [CS5]\níš¨ëŠ¥íš¨ê³¼: [CS15]\nìš©ë²•ìš©ëŸ‰: [CS16]',
            'S02': '# 02. êµ­ë‚´ì™¸í—ˆê°€í˜„í™©\n\n[Table T1]',
            'S03': '# 03. ì‹œíŒí›„salesë°ì´í„°\n\n[CS10] ~ [CS11]\n[PH1]\n[Table T2]',
            'S04': '# 04. êµ­ë‚´ì‹ ì†ë³´ê³ ë‚´ì—­\n\n[PH2]\n[Table T3]',
            'S05': '# 05. êµ­ë‚´ì •ê¸°ë³´ê³ ë‚´ì—­\n\n[PH3]\n[Table T4]',
            'S06': '# 06. êµ­ë‚´ì›ì‹œìë£Œ\n\n[PH4]\n[Table T5]',
            'S07': '# 07. êµ­ë‚´ì™¸ì•ˆì „ì„±ì¡°ì¹˜í˜„í™©\n\n[PH5]\n[Table T6]',
            'S08': '# 08. êµ­ë‚´ì™¸íŒë§¤ì¤‘ì§€í˜„í™©\n\n[PH6]\n[PH7]\n[Table T7]',
            'S09': '# 09. í•´ì™¸ì‹ ì†ë³´ê³ ë‚´ì—­\n\n[PH8]',
            'S10': '# 10. í•´ì™¸ì •ê¸°ë³´ê³ ë‚´ì—­\n\n[PH9]',
            'S11': '# 11. í•´ì™¸ì›ì‹œìë£Œ\n\n[PH10]',
            'S12': '# 12. ì´ê´„í‰ê°€\n\n[PH11]',
            'S13': '# 13. ê²°ë¡ \n\n[PH12]',
            'S14': '# 14. ì°¸ê³ ë¬¸í—Œ\n\nìˆ˜ë™ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.'
        };

        // Load extracted data from P16
        const storedData = Storage.get('extractedData') || {};
        const extractedData = {
            cs: storedData.csData || {},
            ph: storedData.phData || {},
            table: storedData.tableData || {}
        };

        // Initialize the page
        function init() {
            const layout = new AppLayout({
                currentStage: 6,
                reportName: 'testPill_1'
            });

            const content = `
                <div class="app-content">
                <main class="main-content">
                <div class="template-container">
                    <!-- Left Panel - Section List -->
                    <div class="section-list-panel">
                        <div class="section-list-header">
                            <div class="section-list-title">ğŸ“ ë³´ê³ ì„œ ì„¹ì…˜</div>
                            <div class="section-progress">
                                <span id="completedSections">0</span>/${sections.length}
                            </div>
                        </div>

                        <div class="progress-stats">
                            <div class="progress-stats-grid">
                                <div class="progress-stat-item">
                                    <div class="progress-stat-value" id="statPending">${sections.length}</div>
                                    <div class="progress-stat-label">ëŒ€ê¸°</div>
                                </div>
                                <div class="progress-stat-item">
                                    <div class="progress-stat-value" id="statProcessing">0</div>
                                    <div class="progress-stat-label">ì²˜ë¦¬ì¤‘</div>
                                </div>
                                <div class="progress-stat-item">
                                    <div class="progress-stat-value" id="statCompleted">0</div>
                                    <div class="progress-stat-label">ì™„ë£Œ</div>
                                </div>
                            </div>
                        </div>

                        <div id="sectionList"></div>
                    </div>

                    <!-- Main Panel - Template Editor -->
                    <div class="template-panel">
                        <div class="template-header">
                            <h2 class="template-title">ğŸ“„ í…œí”Œë¦¿ ì‘ì„± (Stage 6)</h2>

                            <div class="template-info">
                                <div class="template-info-title">ğŸ’¡ í…œí”Œë¦¿ ì‘ì„± ë°©ì‹</div>
                                <div class="template-info-text">
                                    <strong>CS ë°ì´í„°:</strong> í…œí”Œë¦¿ì˜ [CSë³€ìˆ˜]ë¥¼ ì¶”ì¶œëœ ë°ì´í„°ë¡œ ìë™ ì¹˜í™˜<br>
                                    <strong>PH ë°ì´í„°:</strong> í…œí”Œë¦¿ êµ¬ì¡°ì™€ ê¸¸ì´ì— ë§ì¶° ì„œìˆ ë¬¸ ìë™ ìƒì„± (LLM)<br>
                                    <strong>í‘œ ë°ì´í„°:</strong> ì¶”ì¶œëœ í‘œ ë°ì´í„°ë¥¼ í…œí”Œë¦¿ì— ìë™ ì‚½ì…
                                </div>
                            </div>

                            <div class="data-mapping-panel">
                                <div class="data-mapping-title">ğŸ“Š í˜„ì¬ ì„¹ì…˜ ë°ì´í„° ë§¤í•‘</div>
                                <div class="data-mapping-grid" id="dataMappingGrid"></div>
                            </div>

                            <div class="template-controls">
                                <select class="template-mode-select" id="templateMode" onchange="changeTemplateMode()">
                                    <option value="auto">ìë™ ëª¨ë“œ (LLM)</option>
                                    <option value="manual">ìˆ˜ë™ ëª¨ë“œ</option>
                                </select>
                                <button class="btn btn-primary magic-effect" onclick="populateSection()">
                                    âœ¨ ì„¹ì…˜ ì±„ìš°ê¸°
                                </button>
                                <button class="btn btn-secondary" onclick="resetSection()">
                                    ğŸ”„ ì´ˆê¸°í™”
                                </button>
                            </div>
                        </div>

                        <div class="template-content">
                            <!-- Left Column - Template -->
                            <div class="template-column">
                                <div class="column-header">ğŸ“‹ í…œí”Œë¦¿ (ì›ë³¸)</div>
                                <div class="template-editor" id="templateEditor"></div>
                            </div>

                            <!-- Right Column - Preview -->
                            <div class="template-column">
                                <div class="column-header">ğŸ‘ï¸ ë¯¸ë¦¬ë³´ê¸° (ì‘ì„±ëœ ë‚´ìš©)</div>
                                <div class="preview-panel" id="previewPanel">
                                    <p style="color: #94a3b8; text-align: center; margin-top: 40px;">
                                        "ì„¹ì…˜ ì±„ìš°ê¸°" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ í…œí”Œë¦¿ì„ ì‘ì„±í•˜ì„¸ìš”
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="action-footer">
                            <div class="footer-info">
                                í˜„ì¬ ì„¹ì…˜: <strong id="currentSectionName">-</strong>
                            </div>
                            <div class="footer-actions">
                                <button class="btn btn-secondary" onclick="previousSection()" id="prevBtn">
                                    â† ì´ì „ ì„¹ì…˜
                                </button>
                                <button class="btn btn-primary" onclick="saveAndNext()" id="nextBtn">
                                    ì €ì¥ ë° ë‹¤ìŒ â†’
                                </button>
                                <button class="btn btn-success" onclick="proceedToReview()" id="reviewBtn">
                                    ë¦¬ë·° ë‹¨ê³„ë¡œ â†’
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                </main>
                </div>

                <!-- Footer -->
                <footer class="app-footer">
                    <div class="footer-content">
                        Copyright. Power Solution., Inc. 2026.
                    </div>
                </footer>
            `;

            // í—¤ë” ë’¤ì— ì½˜í…ì¸  ì¶”ê°€ (í—¤ë” ë®ì–´ì“°ê¸° ë°©ì§€)
            const appElement = document.getElementById('app');
            const header = appElement.querySelector('.app-header');
            if (header) {
                header.insertAdjacentHTML('afterend', layout.render(content));
            } else {
                appElement.innerHTML = layout.render(content);
            }

            renderSectionList();
            selectSection(sections[0]);
            updateStats();
        }

        // Render section list
        function renderSectionList() {
            const listHtml = sections.map(section => `
                <div class="section-item ${currentSection.id === section.id ? 'active' : ''} ${section.status === 'completed' ? 'completed' : ''}"
                     onclick="selectSection(sections.find(s => s.id === '${section.id}'))">
                    <div class="section-number">${section.number}</div>
                    <div class="section-name">${section.name}</div>
                    <div class="section-meta">
                        <span class="section-type">${section.type}</span>
                        <span class="section-status ${section.status}">${getStatusLabel(section.status)}</span>
                    </div>
                </div>
            `).join('');

            document.getElementById('sectionList').innerHTML = listHtml;
        }

        function getStatusLabel(status) {
            const labels = {
                'pending': 'ëŒ€ê¸°',
                'processing': 'ì²˜ë¦¬ì¤‘',
                'completed': 'ì™„ë£Œ'
            };
            return labels[status] || status;
        }

        // Select section
        function selectSection(section) {
            currentSection = section;
            renderSectionList();
            loadTemplate();
            updateDataMapping();
            updateFooter();
        }

        // Load template for current section
        function loadTemplate() {
            const template = sectionTemplates[currentSection.id] || `# ${currentSection.number}. ${currentSection.name}\n\ní…œí”Œë¦¿ì´ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤...`;

            // Highlight placeholders
            const highlightedTemplate = template.replace(/\[([^\]]+)\]/g, '<span class="data-placeholder">[$1]</span>');

            document.getElementById('templateEditor').innerHTML = highlightedTemplate;
            document.getElementById('currentSectionName').textContent = `${currentSection.number}. ${currentSection.name}`;

            // Clear preview
            document.getElementById('previewPanel').innerHTML = `
                <p style="color: #94a3b8; text-align: center; margin-top: 40px;">
                    "ì„¹ì…˜ ì±„ìš°ê¸°" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ í…œí”Œë¦¿ì„ ì‘ì„±í•˜ì„¸ìš”
                </p>
            `;
        }

        // Update data mapping
        function updateDataMapping() {
            const fields = [];

            if (currentSection.csFields) {
                currentSection.csFields.forEach(field => {
                    const hasValue = extractedData.cs[field];
                    fields.push({ field, hasValue, type: 'CS' });
                });
            }

            if (currentSection.phFields) {
                currentSection.phFields.forEach(field => {
                    const hasValue = extractedData.ph[field];
                    fields.push({ field, hasValue, type: 'PH' });
                });
            }

            if (currentSection.tableId) {
                fields.push({ field: currentSection.tableId, hasValue: true, type: 'Table' });
            }

            const gridHtml = fields.map(item => `
                <div class="data-mapping-item ${item.hasValue ? 'filled' : 'missing'}">
                    ${item.field} ${item.hasValue ? 'âœ“' : 'âœ—'}
                </div>
            `).join('');

            document.getElementById('dataMappingGrid').innerHTML = gridHtml || '<p style="font-size: 11px; color: #94a3b8;">ë°ì´í„° ë§¤í•‘ ì—†ìŒ</p>';
        }

        // Populate section with data
        async function populateSection() {
            const mode = document.getElementById('templateMode').value;

            showLLMLoading('í…œí”Œë¦¿ì„ ë¡œë“œí•˜ê³  ë°ì´í„°ë¥¼ ì‚½ì…í•˜ê³  ìˆìŠµë‹ˆë‹¤...');
            currentSection.status = 'processing';
            updateStats();
            renderSectionList();

            try {
                // Load template using templateWriter
                const templatePath = `${TEMPLATE_BASE_PATH}Section_${currentSection.number}_${currentSection.name}.md`;
                const templateResult = await templateWriter.loadTemplate(templatePath);

                if (!templateResult.success) {
                    // Fallback to simple template if file not found
                    console.warn(`Template not found for ${currentSection.id}, using simple template`);
                }

                const template = templateResult.template || `# ${currentSection.number}. ${currentSection.name}\n\n[Content for ${currentSection.name}]`;

                // Populate template with extracted data
                const populateResult = await templateWriter.populateTemplate(
                    template,
                    extractedData.cs,
                    extractedData.ph,
                    extractedData.table
                );

                if (!populateResult.success) {
                    throw new Error(populateResult.error || 'Template population failed');
                }

                const populatedContent = populateResult.markdown;

                // Convert markdown to HTML for preview
                const previewHtml = convertMarkdownToHTML(populatedContent);
                document.getElementById('previewPanel').innerHTML = previewHtml;

                currentSection.status = 'completed';
                currentSection.populatedContent = populatedContent;

                // Save section to localStorage
                const sections = Storage.get('generatedSections') || {};
                sections[currentSection.id] = {
                    number: currentSection.number,
                    name: currentSection.name,
                    content: populatedContent,
                    generatedAt: DateHelper.formatISO()
                };
                Storage.set('generatedSections', sections);

                hideLLMLoading();
                updateStats();
                renderSectionList();
                showToast('ì„¹ì…˜ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            } catch (error) {
                console.error('Section population error:', error);
                currentSection.status = 'error';
                hideLLMLoading();
                updateStats();
                renderSectionList();
                showToast('ì„¹ì…˜ ì‘ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            }
        }

        // Simple markdown to HTML converter
        function convertMarkdownToHTML(markdown) {
            let html = markdown;

            // Headers
            html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
            html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
            html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');

            // Bold
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

            // Lists
            html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');

            // Paragraphs
            html = html.split('\n\n').map(para => {
                if (para.startsWith('<h') || para.startsWith('<ul') || para.startsWith('<table')) {
                    return para;
                }
                return `<p>${para}</p>`;
            }).join('\n');

            return html;
        }

        // Reset section
        function resetSection() {
            loadTemplate();
            currentSection.status = 'pending';
            delete currentSection.populatedContent;
            updateStats();
            renderSectionList();
            showToast('ì„¹ì…˜ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
        }

        // Navigation
        function previousSection() {
            const currentIndex = sections.findIndex(s => s.id === currentSection.id);
            if (currentIndex > 0) {
                selectSection(sections[currentIndex - 1]);
            }
        }

        function saveAndNext() {
            if (currentSection.status !== 'completed') {
                showToast('ë¨¼ì € ì„¹ì…˜ì„ ì‘ì„±í•´ì£¼ì„¸ìš”', 'error');
                return;
            }

            const currentIndex = sections.findIndex(s => s.id === currentSection.id);
            if (currentIndex < sections.length - 1) {
                selectSection(sections[currentIndex + 1]);
                showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            }
        }

        function updateFooter() {
            const currentIndex = sections.findIndex(s => s.id === currentSection.id);
            document.getElementById('prevBtn').disabled = currentIndex === 0;
            document.getElementById('nextBtn').disabled = currentIndex === sections.length - 1;

            const allCompleted = sections.every(s => s.status === 'completed');
            document.getElementById('reviewBtn').style.display = allCompleted ? 'block' : 'none';
        }

        // Update statistics
        function updateStats() {
            const pending = sections.filter(s => s.status === 'pending').length;
            const processing = sections.filter(s => s.status === 'processing').length;
            const completed = sections.filter(s => s.status === 'completed').length;

            document.getElementById('statPending').textContent = pending;
            document.getElementById('statProcessing').textContent = processing;
            document.getElementById('statCompleted').textContent = completed;
            document.getElementById('completedSections').textContent = completed;

            updateFooter();
        }

        // Change template mode
        function changeTemplateMode() {
            templateMode = document.getElementById('templateMode').value;
            showToast(`${templateMode === 'auto' ? 'ìë™' : 'ìˆ˜ë™'} ëª¨ë“œë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤`, 'info');
        }

        // Proceed to review stage
        async function proceedToReview() {
            const allCompleted = sections.every(s => s.status === 'completed');
            if (!allCompleted) {
                showToast('ëª¨ë“  ì„¹ì…˜ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”', 'error');
                return;
            }

            showLLMLoading('ì „ì²´ ë³´ê³ ì„œë¥¼ ë³‘í•©í•˜ê³  ìˆìŠµë‹ˆë‹¤...');

            try {
                // Merge all sections into complete report
                const generatedSections = Storage.get('generatedSections') || {};
                const sectionContents = sections.map(section => generatedSections[section.id]?.content || '');

                const mergeResult = await templateWriter.mergeAllSections(sectionContents);

                if (!mergeResult.success) {
                    throw new Error(mergeResult.error || 'Section merge failed');
                }

                // Save complete draft report
                Storage.set('draftReport', {
                    content: mergeResult.fullReport,
                    sections: generatedSections,
                    mergedAt: DateHelper.formatISO()
                });

                hideLLMLoading();

                const reportId = new URLSearchParams(window.location.search).get('reportId') || Date.now().toString();
                showToast('ë³´ê³ ì„œ ë³‘í•©ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë¦¬ë·° ë‹¨ê³„ë¡œ ì´ë™í•©ë‹ˆë‹¤.', 'success');

                setTimeout(() => {
                    window.location.href = `P18_Review.html?reportId=${reportId}`;
                }, 1000);
            } catch (error) {
                console.error('Report merge error:', error);
                hideLLMLoading();
                showToast('ë³´ê³ ì„œ ë³‘í•© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            }
        }

        // Initialize on load
        init();
    </script>
</body>
</html>

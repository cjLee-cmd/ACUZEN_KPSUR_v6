<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P-16 Data Extraction - KPSUR AGENT</title>
    <link rel="stylesheet" href="../styles/globals.css">
    <link rel="stylesheet" href="../styles/components.css">
    <style>
        .extraction-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 16px;
            height: calc(100vh - 140px);
        }

        /* Left Panel - File List */
        .file-list-panel {
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            padding: 16px;
            overflow-y: auto;
        }

        .file-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .file-list-header h3 {
            font-size: 14px;
            font-weight: 600;
            color: #07161D;
            margin: 0;
        }

        .file-stats {
            font-size: 11px;
            color: #64748b;
        }

        .file-category {
            margin-bottom: 16px;
        }

        .file-category-title {
            font-size: 12px;
            font-weight: 600;
            color: #25739B;
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 1px solid #e2e8f0;
        }

        .file-item {
            padding: 8px;
            margin-bottom: 4px;
            background: #f8fafc;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 12px;
        }

        .file-item:hover {
            background: #f1f5f9;
        }

        .file-item.active {
            background: #EBF5FF;
            border-left: 3px solid #25739B;
        }

        .file-item.selected {
            background: #EBF5FF;
        }

        .file-name {
            font-weight: 500;
            color: #07161D;
            margin-bottom: 4px;
        }

        .file-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 10px;
            color: #64748b;
        }

        .file-status {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 500;
        }

        .file-status.pending { background: #FEF3C7; color: #92400E; }
        .file-status.extracting { background: #DBEAFE; color: #1E40AF; }
        .file-status.completed { background: #D1FAE5; color: #065F46; }
        .file-status.conflict { background: #FEE2E2; color: #991B1B; }
        .file-status.error { background: #FEE2E2; color: #991B1B; }

        /* Main Panel - Data Extraction */
        .data-panel {
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .data-panel-header {
            padding: 16px;
            border-bottom: 1px solid #e2e8f0;
            background: #f8fafc;
        }

        .data-panel-title {
            font-size: 16px;
            font-weight: 600;
            color: #07161D;
            margin: 0 0 8px 0;
        }

        .extraction-warning {
            background: #FEF3C7;
            border-left: 4px solid #F59E0B;
            padding: 12px;
            margin-bottom: 12px;
            border-radius: 4px;
        }

        .extraction-warning-title {
            font-weight: 600;
            color: #92400E;
            font-size: 13px;
            margin-bottom: 4px;
        }

        .extraction-warning-text {
            font-size: 11px;
            color: #92400E;
            line-height: 1.4;
        }

        .extraction-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .llm-model-select {
            padding: 6px 10px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 12px;
            color: #07161D;
            background: white;
        }

        .data-tabs {
            display: flex;
            gap: 4px;
            padding: 0 16px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .data-tab {
            padding: 10px 16px;
            font-size: 13px;
            font-weight: 500;
            color: #64748b;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }

        .data-tab:hover {
            color: #25739B;
        }

        .data-tab.active {
            color: #25739B;
            border-bottom-color: #25739B;
        }

        .data-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .data-section {
            display: none;
        }

        .data-section.active {
            display: block;
        }

        /* CS Data Grid */
        .cs-data-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .cs-data-item {
            background: #f8fafc;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        .cs-data-item.has-conflict {
            border-color: #F59E0B;
            background: #FFFBEB;
        }

        .cs-data-item.has-value {
            border-color: #10B981;
        }

        .cs-data-label {
            font-size: 11px;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cs-data-value {
            font-size: 13px;
            color: #07161D;
            min-height: 20px;
            padding: 6px;
            background: white;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
        }

        .cs-data-value.empty {
            color: #94a3b8;
            font-style: italic;
        }

        .cs-data-value.editable {
            cursor: pointer;
        }

        .cs-data-value.editable:hover {
            border-color: #25739B;
        }

        .conflict-indicator {
            background: #F59E0B;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            cursor: pointer;
        }

        .missing-indicator {
            background: #EF4444;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
        }

        /* PH Data */
        .ph-data-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .ph-data-item {
            background: #f8fafc;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        .ph-data-item.has-value {
            border-color: #10B981;
        }

        .ph-data-label {
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 8px;
        }

        .ph-data-value {
            font-size: 13px;
            color: #07161D;
            line-height: 1.6;
            min-height: 60px;
            padding: 8px;
            background: white;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
            white-space: pre-wrap;
        }

        /* Table Data */
        .table-data-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .table-data-item {
            background: #f8fafc;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        .table-data-item.has-value {
            border-color: #10B981;
        }

        .table-data-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .table-data-label {
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
        }

        .table-preview {
            overflow-x: auto;
        }

        .table-preview table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }

        .table-preview th {
            background: #25739B;
            color: white;
            padding: 6px 8px;
            text-align: left;
            font-weight: 500;
        }

        .table-preview td {
            padding: 6px 8px;
            border-bottom: 1px solid #e2e8f0;
        }

        .table-preview tr:hover {
            background: #f1f5f9;
        }

        /* Extraction Progress */
        .extraction-progress {
            background: #f8fafc;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
        }

        .progress-stats {
            display: flex;
            gap: 16px;
            margin-bottom: 8px;
        }

        .progress-stat {
            font-size: 12px;
        }

        .progress-stat-label {
            color: #64748b;
            font-size: 11px;
        }

        .progress-stat-value {
            font-weight: 600;
            color: #07161D;
            font-size: 14px;
        }

        .progress-bar-container {
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #25739B, #369EE1);
            transition: width 0.3s ease;
        }

        /* Conflict Resolution Modal */
        .conflict-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .conflict-modal.show {
            display: flex;
        }

        .conflict-modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .conflict-modal-header {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            background: #FEF3C7;
        }

        .conflict-modal-title {
            font-size: 16px;
            font-weight: 600;
            color: #92400E;
            margin: 0;
        }

        .conflict-modal-body {
            padding: 20px;
        }

        .conflict-description {
            font-size: 13px;
            color: #64748b;
            margin-bottom: 16px;
        }

        .conflict-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .conflict-option {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .conflict-option:hover {
            border-color: #25739B;
            background: #EBF5FF;
        }

        .conflict-option.selected {
            border-color: #25739B;
            background: #EBF5FF;
        }

        .conflict-option-source {
            font-size: 11px;
            color: #64748b;
            margin-bottom: 4px;
        }

        .conflict-option-value {
            font-size: 13px;
            color: #07161D;
            font-weight: 500;
        }

        .conflict-modal-footer {
            padding: 16px 20px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
            padding: 16px;
            border-top: 1px solid #e2e8f0;
            background: #f8fafc;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <!-- Conflict Resolution Modal -->
    <div id="conflictModal" class="conflict-modal">
        <div class="conflict-modal-content">
            <div class="conflict-modal-header">
                <h3 class="conflict-modal-title">âš ï¸ ë°ì´í„° ì¶©ëŒ í•´ê²°</h3>
            </div>
            <div class="conflict-modal-body">
                <p class="conflict-description">
                    ì„œë¡œ ë‹¤ë¥¸ ì†ŒìŠ¤ì—ì„œ <strong id="conflictFieldName"></strong>ì— ëŒ€í•œ ìƒì´í•œ ê°’ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.<br>
                    ì‚¬ìš©í•  ê°’ì„ ì„ íƒí•´ ì£¼ì„¸ìš”:
                </p>
                <div id="conflictOptions" class="conflict-options">
                    <!-- Options will be populated dynamically -->
                </div>
            </div>
            <div class="conflict-modal-footer">
                <button class="btn btn-secondary" onclick="closeConflictModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="resolveConflict()">ì„ íƒí•œ ê°’ ì ìš©</button>
            </div>
        </div>
    </div>

    <script src="../components/AppLayout.js"></script>
    <script src="../utils/layout-helper.js"></script>
    <script type="module">
        // ES6 Modules
        import { CONFIG, Storage, DateHelper } from '../js/config.js';
        import dataExtractor from '../js/data-extractor.js';
        import authManager from '../js/auth.js';

        // Load converted markdown files from localStorage
        const convertedMarkdowns = Storage.get('convertedMarkdowns') || [];
        const markdownFiles = convertedMarkdowns.map((file, index) => {
            const category = ['RAW12', 'RAW14', 'RAW15'].includes(file.rawId) ? 'lineListing' : 'required';
            return {
                id: index + 1,
                rawId: file.rawId,
                name: file.fileName.replace(/\.(pdf|xlsx|docx|txt)$/i, '.md'),
                markdown: file.markdown,
                category: category,
                status: 'pending'
            };
        });

        // CS Data template (60+ variables)
        const csDataTemplate = [
            { id: 'CS0', label: 'CS0_ì„±ë¶„ëª…', value: '', source: '', hasConflict: false },
            { id: 'CS1', label: 'CS1_ë¸Œëœë“œëª…', value: '', source: '', hasConflict: false },
            { id: 'CS2', label: 'CS2_íŒë§¤ì‚¬', value: '', source: '', hasConflict: false },
            { id: 'CS3', label: 'CS3_ì œì¡°ì‚¬', value: '', source: '', hasConflict: false },
            { id: 'CS4', label: 'CS4_ëŒ€í‘œì ì‘ì¦', value: '', source: '', hasConflict: false },
            { id: 'CS5', label: 'CS5_êµ­ë‚´í—ˆê°€ì¼ì', value: '', source: '', hasConflict: false },
            { id: 'CS6', label: 'CS6_ë³´ê³ ì„œì‘ì„±ì', value: 'í™ê¸¸ë™', source: 'user_input', hasConflict: false },
            { id: 'CS7', label: 'CS7_ë³´ê³ ì„œì‘ì„±ë¶€ì„œ', value: 'ì•½ë¬¼ì•ˆì „ê´€ë¦¬ë¶€', source: 'user_input', hasConflict: false },
            { id: 'CS8', label: 'CS8_ë³´ê³ ì„œì‘ì„±ì¼ì', value: '', source: '', hasConflict: false },
            { id: 'CS9', label: 'CS9_ìë£Œê¸°ì¤€ì¼', value: '', source: '', hasConflict: false },
            { id: 'CS10', label: 'CS10_ì „ì²´ë³´ê³ ê¸°ê°„_ì‹œì‘ì¼', value: '', source: '', hasConflict: false },
            { id: 'CS11', label: 'CS11_ì „ì²´ë³´ê³ ê¸°ê°„_ì¢…ë£Œì¼', value: '', source: '', hasConflict: false },
            { id: 'CS12', label: 'CS12_ë‹¹í•´ë³´ê³ ê¸°ê°„_ì‹œì‘ì¼', value: '', source: '', hasConflict: false },
            { id: 'CS13', label: 'CS13_ë‹¹í•´ë³´ê³ ê¸°ê°„_ì¢…ë£Œì¼', value: '', source: '', hasConflict: false },
            { id: 'CS14', label: 'CS14_ìˆ˜ì…ê°œì‹œì¼ì', value: '', source: '', hasConflict: false },
            { id: 'CS15', label: 'CS15_íš¨ëŠ¥íš¨ê³¼', value: '', source: '', hasConflict: false },
            { id: 'CS16', label: 'CS16_ìš©ë²•ìš©ëŸ‰', value: '', source: '', hasConflict: false }
        ];

        // PH Data template (9 narrative sections)
        const phDataTemplate = [
            { id: 'PH1', label: 'PH1_ì‹œíŒí›„salesë°ì´í„°ì„œìˆ ë¬¸', value: '', source: '' },
            { id: 'PH2', label: 'PH2_ì‹ ì†ë³´ê³ ë‚´ì—­ì„œìˆ ë¬¸', value: '', source: '' },
            { id: 'PH3', label: 'PH3_ì •ê¸°ë³´ê³ ë‚´ì—­ì„œìˆ ë¬¸', value: '', source: '' },
            { id: 'PH4', label: 'PH4_ì›ì‹œìë£Œì„œìˆ ë¬¸', value: '', source: '' },
            { id: 'PH5', label: 'PH5_ì•ˆì „ì„±ì¡°ì¹˜ì„œìˆ ë¬¸', value: '', source: '' },
            { id: 'PH6', label: 'PH6_êµ­ë‚´íŒë§¤ì¤‘ì§€ì‚¬ìœ ì„œìˆ ë¬¸', value: '', source: '' },
            { id: 'PH7', label: 'PH7_í•´ì™¸íŒë§¤ì¤‘ì§€ì‚¬ìœ ì„œìˆ ë¬¸', value: '', source: '' },
            { id: 'PH11', label: 'PH11_ì´ê´„í‰ê°€ë¬¸', value: '', source: '' },
            { id: 'PH12', label: 'PH12_ê²°ë¡ ', value: '', source: '' }
        ];

        // Table Data template (7 tables)
        const tableDataTemplate = [
            { id: 'T1', label: 'í‘œ1_êµ­ë‚´ì™¸í—ˆê°€í˜„í™©', hasData: false, rows: [] },
            { id: 'T2', label: 'í‘œ2_ì—°ë„ë³„íŒë§¤ëŸ‰', hasData: false, rows: [] },
            { id: 'T3', label: 'í‘œ3_ì‹ ì†ë³´ê³ ë‚´ì—­_êµ­ë‚´', hasData: false, rows: [] },
            { id: 'T4', label: 'í‘œ4_ì •ê¸°ë³´ê³ ë‚´ì—­_êµ­ë‚´', hasData: false, rows: [] },
            { id: 'T5', label: 'í‘œ5_ì›ì‹œìë£Œë‚´ì—­', hasData: false, rows: [] },
            { id: 'T6', label: 'í‘œ6_ì•ˆì „ì„±ì¡°ì¹˜í˜„í™©', hasData: false, rows: [] },
            { id: 'T7', label: 'í‘œ7_êµ­ë‚´ì™¸íŒë§¤ì¤‘ì§€í˜„í™©', hasData: false, rows: [] }
        ];

        let selectedFile = null;
        let currentTab = 'cs';
        let csData = JSON.parse(JSON.stringify(csDataTemplate));
        let phData = JSON.parse(JSON.stringify(phDataTemplate));
        let tableData = JSON.parse(JSON.stringify(tableDataTemplate));
        let conflictData = null;

        // Initialize the page
        function init() {
            const layout = new AppLayout({
                currentStage: 5,
                reportName: 'testPill_1'
            });

            const content = `
                <div class="extraction-container">
                    <!-- Left Panel - File List -->
                    <div class="file-list-panel">
                        <div class="file-list-header">
                            <h3>ğŸ“„ ë§ˆí¬ë‹¤ìš´ íŒŒì¼</h3>
                            <div class="file-stats">
                                <span id="completedCount">0</span>/<span id="totalCount">${markdownFiles.length}</span>
                            </div>
                        </div>

                        <div class="file-category">
                            <div class="file-category-title">í•„ìˆ˜ ë¬¸ì„œ</div>
                            <div id="requiredFiles"></div>
                        </div>

                        <div class="file-category">
                            <div class="file-category-title">Line Listing</div>
                            <div id="lineListingFiles"></div>
                        </div>
                    </div>

                    <!-- Main Panel - Data Extraction -->
                    <div class="data-panel">
                        <div class="data-panel-header">
                            <h2 class="data-panel-title">ğŸ“Š ë°ì´í„° ì¶”ì¶œ (Stage 5)</h2>

                            <div class="extraction-warning">
                                <div class="extraction-warning-title">âš ï¸ ë°ì´í„° ì¶”ì¶œ ì›ì¹™</div>
                                <div class="extraction-warning-text">
                                    <strong>1. ì ˆëŒ€ ë°ì´í„°ë¥¼ ìƒì„±í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤</strong> - ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì‚¬ìš©ìì—ê²Œ ìš”ì²­<br>
                                    <strong>2. ì¶©ëŒ ë°ì´í„°ëŠ” ì„ì˜ë¡œ ì„ íƒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤</strong> - ëª¨ë“  ì˜µì…˜ì„ ì‚¬ìš©ìì—ê²Œ ì œì‹œ
                                </div>
                            </div>

                            <div class="extraction-progress">
                                <div class="progress-stats">
                                    <div class="progress-stat">
                                        <div class="progress-stat-label">CS ë°ì´í„°</div>
                                        <div class="progress-stat-value"><span id="csExtracted">0</span>/${csDataTemplate.length}</div>
                                    </div>
                                    <div class="progress-stat">
                                        <div class="progress-stat-label">PH ë°ì´í„°</div>
                                        <div class="progress-stat-value"><span id="phExtracted">0</span>/${phDataTemplate.length}</div>
                                    </div>
                                    <div class="progress-stat">
                                        <div class="progress-stat-label">í‘œ ë°ì´í„°</div>
                                        <div class="progress-stat-value"><span id="tableExtracted">0</span>/${tableDataTemplate.length}</div>
                                    </div>
                                </div>
                                <div class="progress-bar-container">
                                    <div id="progressBar" class="progress-bar" style="width: 0%"></div>
                                </div>
                            </div>

                            <div class="extraction-controls">
                                <select class="llm-model-select" id="llmModel">
                                    <option value="gemini-2.0-flash">Gemini 2.0 Flash (ë¹ ë¦„)</option>
                                    <option value="gemini-2.0-pro">Gemini 2.0 Pro (ì •í™•)</option>
                                </select>
                                <button class="btn btn-primary magic-effect" onclick="startExtraction()">
                                    âœ¨ AI ë°ì´í„° ì¶”ì¶œ ì‹œì‘
                                </button>
                                <button class="btn btn-secondary" onclick="exportData()">
                                    ğŸ’¾ ë°ì´í„° ì €ì¥
                                </button>
                                <button class="btn btn-success" onclick="proceedToNext()">
                                    ë‹¤ìŒ ë‹¨ê³„ â†’
                                </button>
                            </div>
                        </div>

                        <div class="data-tabs">
                            <button class="data-tab active" onclick="switchTab('cs')">CS ë°ì´í„° (60+)</button>
                            <button class="data-tab" onclick="switchTab('ph')">PH ë°ì´í„° (9)</button>
                            <button class="data-tab" onclick="switchTab('table')">í‘œ ë°ì´í„° (7)</button>
                        </div>

                        <div class="data-content">
                            <!-- CS Data Section -->
                            <div id="csSection" class="data-section active">
                                <div class="cs-data-grid" id="csDataGrid"></div>
                            </div>

                            <!-- PH Data Section -->
                            <div id="phSection" class="data-section">
                                <div class="ph-data-list" id="phDataList"></div>
                            </div>

                            <!-- Table Data Section -->
                            <div id="tableSection" class="data-section">
                                <div class="table-data-list" id="tableDataList"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('app').innerHTML = layout.render(content);

            renderFileList();
            renderCSData();
            renderPHData();
            renderTableData();
            updateStats();
        }

        // Render file list
        function renderFileList() {
            const requiredFiles = markdownFiles.filter(f => f.category === 'required');
            const lineListingFiles = markdownFiles.filter(f => f.category === 'lineListing');

            document.getElementById('requiredFiles').innerHTML = requiredFiles.map(file => `
                <div class="file-item ${selectedFile?.id === file.id ? 'selected' : ''}" onclick="selectFile(${file.id})">
                    <div class="file-name">${file.name}</div>
                    <div class="file-meta">
                        <span>${file.rawId}</span>
                        <span class="file-status ${file.status}">${getStatusLabel(file.status)}</span>
                    </div>
                </div>
            `).join('');

            document.getElementById('lineListingFiles').innerHTML = lineListingFiles.map(file => `
                <div class="file-item ${selectedFile?.id === file.id ? 'selected' : ''}" onclick="selectFile(${file.id})">
                    <div class="file-name">${file.name}</div>
                    <div class="file-meta">
                        <span>${file.rawId}</span>
                        <span class="file-status ${file.status}">${getStatusLabel(file.status)}</span>
                    </div>
                </div>
            `).join('');
        }

        function getStatusLabel(status) {
            const labels = {
                'pending': 'ëŒ€ê¸°',
                'extracting': 'ì¶”ì¶œ ì¤‘',
                'completed': 'ì™„ë£Œ',
                'conflict': 'ì¶©ëŒ',
                'error': 'ì˜¤ë¥˜'
            };
            return labels[status] || status;
        }

        // Render CS Data
        function renderCSData() {
            const grid = document.getElementById('csDataGrid');
            grid.innerHTML = csData.map(item => `
                <div class="cs-data-item ${item.value ? 'has-value' : ''} ${item.hasConflict ? 'has-conflict' : ''}">
                    <div class="cs-data-label">
                        ${item.label}
                        ${item.hasConflict ? '<span class="conflict-indicator" onclick="showConflict(\'' + item.id + '\')">ì¶©ëŒ</span>' : ''}
                        ${!item.value && !item.hasConflict ? '<span class="missing-indicator">ë¯¸í™•ë³´</span>' : ''}
                    </div>
                    <div class="cs-data-value ${item.value ? '' : 'empty'} editable" onclick="editCSData('${item.id}')">
                        ${item.value || 'ë°ì´í„° ì—†ìŒ'}
                    </div>
                </div>
            `).join('');
        }

        // Render PH Data
        function renderPHData() {
            const list = document.getElementById('phDataList');
            list.innerHTML = phData.map(item => `
                <div class="ph-data-item ${item.value ? 'has-value' : ''}">
                    <div class="ph-data-label">${item.label}</div>
                    <div class="ph-data-value ${item.value ? '' : 'empty'}">
                        ${item.value || 'ì„œìˆ ë¬¸ ë°ì´í„° ì—†ìŒ'}
                    </div>
                </div>
            `).join('');
        }

        // Render Table Data
        function renderTableData() {
            const list = document.getElementById('tableDataList');
            list.innerHTML = tableData.map(item => `
                <div class="table-data-item ${item.hasData ? 'has-value' : ''}">
                    <div class="table-data-header">
                        <div class="table-data-label">${item.label}</div>
                        <span class="file-status ${item.hasData ? 'completed' : 'pending'}">
                            ${item.hasData ? 'ì™„ë£Œ' : 'ëŒ€ê¸°'}
                        </span>
                    </div>
                    <div class="table-preview">
                        ${item.hasData ? renderTablePreview(item) : '<p style="color: #94a3b8; font-size: 12px;">í‘œ ë°ì´í„° ì—†ìŒ</p>'}
                    </div>
                </div>
            `).join('');
        }

        function renderTablePreview(table) {
            if (!table.rows || table.rows.length === 0) return '<p>ë°ì´í„° ì—†ìŒ</p>';

            const headers = Object.keys(table.rows[0]);
            return `
                <table>
                    <thead>
                        <tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>
                    </thead>
                    <tbody>
                        ${table.rows.slice(0, 3).map(row => `
                            <tr>${headers.map(h => `<td>${row[h]}</td>`).join('')}</tr>
                        `).join('')}
                    </tbody>
                </table>
                ${table.rows.length > 3 ? `<p style="font-size: 11px; color: #64748b; margin-top: 4px;">+ ${table.rows.length - 3}ê°œ í–‰ ë”ë³´ê¸°</p>` : ''}
            `;
        }

        // Tab switching
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.data-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.data-section').forEach(s => s.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tab + 'Section').classList.add('active');
        }

        // File selection
        function selectFile(fileId) {
            selectedFile = markdownFiles.find(f => f.id === fileId);
            renderFileList();
        }

        // Start extraction
        async function startExtraction() {
            const model = document.getElementById('llmModel').value;
            showLLMLoading(`${model}ë¥¼ ì‚¬ìš©í•˜ì—¬ ë°ì´í„°ë¥¼ ì¶”ì¶œí•˜ê³  ìˆìŠµë‹ˆë‹¤...`);

            const extractionResults = [];

            for (const file of markdownFiles) {
                file.status = 'extracting';
                renderFileList();

                try {
                    // Extract data from markdown using dataExtractor
                    const result = await dataExtractor.extractFromMarkdown(
                        file.markdown,
                        file.rawId
                    );

                    if (result.success) {
                        extractionResults.push({
                            rawId: file.rawId,
                            fileName: file.name,
                            csData: result.csData || {},
                            phData: result.phData || {},
                            tableData: result.tableData || {},
                            extractedAt: result.extractedAt
                        });

                        file.status = 'completed';
                    } else {
                        file.status = 'error';
                        console.error(`Extraction failed for ${file.name}:`, result.error);
                    }
                } catch (error) {
                    console.error(`Extraction error for ${file.name}:`, error);
                    file.status = 'error';
                }

                renderFileList();
                updateStats();
            }

            // Merge all extracted data
            const mergedData = dataExtractor.mergeExtractedData(extractionResults);

            // Update CS Data
            Object.keys(mergedData.csData || {}).forEach(key => {
                const csItem = csData.find(d => d.id === key);
                if (csItem && mergedData.csData[key]) {
                    csItem.value = mergedData.csData[key].value;
                    csItem.source = mergedData.csData[key].source;
                }
            });

            // Update PH Data
            Object.keys(mergedData.phData || {}).forEach(key => {
                const phItem = phData.find(d => d.id === key);
                if (phItem && mergedData.phData[key]) {
                    phItem.value = mergedData.phData[key].value;
                    phItem.source = mergedData.phData[key].source;
                }
            });

            // Update Table Data
            Object.keys(mergedData.tableData || {}).forEach(key => {
                const tableItem = tableData.find(d => d.id === key);
                if (tableItem && mergedData.tableData[key]) {
                    tableItem.hasData = true;
                    tableItem.rows = mergedData.tableData[key].rows || [];
                }
            });

            // Handle conflicts
            const conflicts = dataExtractor.getConflictData();
            if (conflicts && conflicts.length > 0) {
                conflicts.forEach(conflict => {
                    const csItem = csData.find(d => d.id === conflict.field);
                    if (csItem) {
                        csItem.hasConflict = true;
                        csItem.conflictOptions = conflict.options;
                    }
                });
            }

            // Save extracted data to localStorage
            Storage.set('extractedData', {
                csData: mergedData.csData,
                phData: mergedData.phData,
                tableData: mergedData.tableData,
                extractedAt: DateHelper.formatISO()
            });

            hideLLMLoading();
            renderCSData();
            renderPHData();
            renderTableData();

            const conflictCount = conflicts ? conflicts.length : 0;
            if (conflictCount > 0) {
                showToast(`ë°ì´í„° ì¶”ì¶œì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ${conflictCount}ê°œì˜ ì¶©ëŒ ë°ì´í„°ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.`, 'warning');
            } else {
                showToast('ë°ì´í„° ì¶”ì¶œì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            }
        }

        // Update stats
        function updateStats() {
            const completedFiles = markdownFiles.filter(f => f.status === 'completed').length;
            const csExtracted = csData.filter(d => d.value && !d.hasConflict).length;
            const phExtracted = phData.filter(d => d.value).length;
            const tableExtracted = tableData.filter(d => d.hasData).length;

            document.getElementById('completedCount').textContent = completedFiles;
            document.getElementById('totalCount').textContent = markdownFiles.length;
            document.getElementById('csExtracted').textContent = csExtracted;
            document.getElementById('phExtracted').textContent = phExtracted;
            document.getElementById('tableExtracted').textContent = tableExtracted;

            const totalData = csDataTemplate.length + phDataTemplate.length + tableDataTemplate.length;
            const extractedData = csExtracted + phExtracted + tableExtracted;
            const progressPercent = (extractedData / totalData) * 100;
            document.getElementById('progressBar').style.width = progressPercent + '%';
        }

        // Show conflict modal
        function showConflict(csId) {
            const item = csData.find(d => d.id === csId);
            if (!item || !item.hasConflict) return;

            conflictData = item;
            document.getElementById('conflictFieldName').textContent = item.label;

            const optionsHtml = item.conflictOptions.map((opt, idx) => `
                <div class="conflict-option" onclick="selectConflictOption(${idx})">
                    <div class="conflict-option-source">ğŸ“„ ${opt.source} (${opt.date})</div>
                    <div class="conflict-option-value">${opt.value}</div>
                </div>
            `).join('');

            document.getElementById('conflictOptions').innerHTML = optionsHtml;
            document.getElementById('conflictModal').classList.add('show');
        }

        function selectConflictOption(index) {
            document.querySelectorAll('.conflict-option').forEach((opt, idx) => {
                if (idx === index) {
                    opt.classList.add('selected');
                } else {
                    opt.classList.remove('selected');
                }
            });
        }

        function closeConflictModal() {
            document.getElementById('conflictModal').classList.remove('show');
            conflictData = null;
        }

        function resolveConflict() {
            const selectedOption = document.querySelector('.conflict-option.selected');
            if (!selectedOption) {
                showToast('ì˜µì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”', 'error');
                return;
            }

            const selectedIndex = Array.from(document.querySelectorAll('.conflict-option')).indexOf(selectedOption);
            const selectedValue = conflictData.conflictOptions[selectedIndex];

            conflictData.value = selectedValue.value;
            conflictData.source = selectedValue.source;
            conflictData.hasConflict = false;
            delete conflictData.conflictOptions;

            closeConflictModal();
            renderCSData();
            updateStats();
            showToast('ì¶©ëŒì´ í•´ê²°ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        }

        // Edit CS Data
        function editCSData(csId) {
            const item = csData.find(d => d.id === csId);
            const newValue = prompt(`${item.label} ê°’ì„ ì…ë ¥í•˜ì„¸ìš”:`, item.value);

            if (newValue !== null) {
                item.value = newValue;
                item.source = 'manual_edit';
                renderCSData();
                updateStats();
            }
        }

        // Export data
        function exportData() {
            const exportData = {
                csData: csData,
                phData: phData,
                tableData: tableData,
                timestamp: new Date().toISOString()
            };

            // In real implementation, this would save to file
            console.log('Exporting data:', exportData);
            showToast('ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        }

        // Proceed to next stage
        function proceedToNext() {
            const missingCS = csData.filter(d => !d.value).length;
            const conflicts = csData.filter(d => d.hasConflict).length;

            if (missingCS > 0 || conflicts > 0) {
                showToast(`ë¯¸í™•ë³´ ë°ì´í„° ${missingCS}ê°œ, ì¶©ëŒ ${conflicts}ê°œë¥¼ ë¨¼ì € í•´ê²°í•´ì£¼ì„¸ìš”`, 'error');
                return;
            }

            // Ensure extracted data is saved
            Storage.set('extractedData', {
                csData: Object.fromEntries(csData.map(d => [d.id, { value: d.value, source: d.source }])),
                phData: Object.fromEntries(phData.map(d => [d.id, { value: d.value, source: d.source }])),
                tableData: Object.fromEntries(tableData.map(d => [d.id, { hasData: d.hasData, rows: d.rows }])),
                extractedAt: DateHelper.formatISO()
            });

            const reportId = new URLSearchParams(window.location.search).get('reportId') || Date.now().toString();
            window.location.href = `P17_TemplateWriting.html?reportId=${reportId}`;
        }

        // Initialize on load
        init();
    </script>
</body>
</html>

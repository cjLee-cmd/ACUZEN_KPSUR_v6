<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P-17 Template Writing - KPSUR AGENT</title>
    <link rel="stylesheet" href="../styles/globals.css">
    <link rel="stylesheet" href="../styles/components.css">
    <style>
        .template-container {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 16px;
            height: calc(100vh - 140px);
        }

        /* Left Panel - Section List */
        .section-list-panel {
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            padding: 16px;
            overflow-y: auto;
        }

        .section-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .section-list-title {
            font-size: 14px;
            font-weight: 600;
            color: #07161D;
        }

        .section-progress {
            font-size: 11px;
            color: #64748b;
        }

        .section-item {
            padding: 10px;
            margin-bottom: 6px;
            background: #f8fafc;
            border-radius: 6px;
            border-left: 3px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }

        .section-item:hover {
            background: #f1f5f9;
        }

        .section-item.active {
            background: #EBF5FF;
            border-left-color: #25739B;
        }

        .section-item.completed {
            background: #ECFDF5;
            border-left-color: #10B981;
        }

        .section-number {
            font-size: 11px;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 4px;
        }

        .section-name {
            font-size: 13px;
            font-weight: 500;
            color: #07161D;
            margin-bottom: 6px;
        }

        .section-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 10px;
        }

        .section-type {
            color: #64748b;
        }

        .section-status {
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 500;
        }

        .section-status.pending {
            background: #FEF3C7;
            color: #92400E;
        }

        .section-status.processing {
            background: #DBEAFE;
            color: #1E40AF;
        }

        .section-status.completed {
            background: #D1FAE5;
            color: #065F46;
        }

        /* Main Panel - Template Editor */
        .template-panel {
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .template-header {
            padding: 16px;
            border-bottom: 1px solid #e2e8f0;
            background: #f8fafc;
        }

        .template-title {
            font-size: 16px;
            font-weight: 600;
            color: #07161D;
            margin: 0 0 8px 0;
        }

        .template-info {
            background: #EBF5FF;
            border-left: 4px solid #25739B;
            padding: 12px;
            margin-bottom: 12px;
            border-radius: 4px;
        }

        .template-info-title {
            font-weight: 600;
            color: #122E4E;
            font-size: 13px;
            margin-bottom: 4px;
        }

        .template-info-text {
            font-size: 11px;
            color: #122E4E;
            line-height: 1.4;
        }

        .template-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .template-mode-select {
            padding: 6px 10px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 12px;
            color: #07161D;
            background: white;
        }

        .template-content {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            padding: 16px;
            overflow-y: auto;
        }

        .template-column {
            display: flex;
            flex-direction: column;
        }

        .column-header {
            font-size: 13px;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e2e8f0;
        }

        .template-editor {
            flex: 1;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            background: #f8fafc;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .data-placeholder {
            background: #FEF3C7;
            color: #92400E;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: 600;
        }

        .data-filled {
            background: #D1FAE5;
            color: #065F46;
            padding: 2px 4px;
            border-radius: 3px;
        }

        .preview-panel {
            flex: 1;
            padding: 16px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            background: white;
            overflow-y: auto;
            line-height: 1.8;
        }

        .preview-panel h1 {
            font-size: 18px;
            font-weight: 600;
            color: #07161D;
            margin-bottom: 12px;
        }

        .preview-panel h2 {
            font-size: 16px;
            font-weight: 600;
            color: #25739B;
            margin: 16px 0 8px 0;
        }

        .preview-panel p {
            font-size: 13px;
            color: #334155;
            margin-bottom: 8px;
        }

        .preview-panel table {
            width: 100%;
            border-collapse: collapse;
            margin: 12px 0;
            font-size: 12px;
        }

        .preview-panel th {
            background: #25739B;
            color: white;
            padding: 8px;
            text-align: left;
            font-weight: 500;
        }

        .preview-panel td {
            padding: 8px;
            border-bottom: 1px solid #e2e8f0;
        }

        .data-mapping-panel {
            background: #f8fafc;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 12px;
        }

        .data-mapping-title {
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 8px;
        }

        .data-mapping-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }

        .data-mapping-item {
            font-size: 11px;
            padding: 4px 6px;
            background: white;
            border-radius: 3px;
            border: 1px solid #e2e8f0;
        }

        .data-mapping-item.filled {
            border-color: #10B981;
            background: #ECFDF5;
        }

        .data-mapping-item.missing {
            border-color: #EF4444;
            background: #FEE2E2;
        }

        .action-footer {
            padding: 16px;
            border-top: 1px solid #e2e8f0;
            background: #f8fafc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .footer-info {
            font-size: 12px;
            color: #64748b;
        }

        .footer-actions {
            display: flex;
            gap: 8px;
        }

        /* Progress Stats */
        .progress-stats {
            background: white;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 12px;
            border: 1px solid #e2e8f0;
        }

        .progress-stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .progress-stat-item {
            text-align: center;
        }

        .progress-stat-value {
            font-size: 20px;
            font-weight: 600;
            color: #25739B;
        }

        .progress-stat-label {
            font-size: 11px;
            color: #64748b;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script src="../components/AppLayout.js"></script>
    <script src="../utils/layout-helper.js"></script>
    <script>
        // Section definitions (15 sections: 00-14)
        const sections = [
            { id: 'S00', number: '00', name: 'í‘œì§€', type: 'CS', status: 'pending', csFields: ['CS0', 'CS1', 'CS2', 'CS6', 'CS7', 'CS8'] },
            { id: 'S01', number: '01', name: 'ê°œìš”', type: 'CS', status: 'pending', csFields: ['CS0', 'CS1', 'CS5', 'CS15', 'CS16'] },
            { id: 'S02', number: '02', name: 'êµ­ë‚´ì™¸í—ˆê°€í˜„í™©', type: 'Table', status: 'pending', tableId: 'T1' },
            { id: 'S03', number: '03', name: 'ì‹œíŒí›„salesë°ì´í„°', type: 'CS+PH+Table', status: 'pending', csFields: ['CS10', 'CS11'], phFields: ['PH1'], tableId: 'T2' },
            { id: 'S04', number: '04', name: 'êµ­ë‚´ì‹ ì†ë³´ê³ ë‚´ì—­', type: 'PH+Table', status: 'pending', phFields: ['PH2'], tableId: 'T3' },
            { id: 'S05', number: '05', name: 'êµ­ë‚´ì •ê¸°ë³´ê³ ë‚´ì—­', type: 'PH+Table', status: 'pending', phFields: ['PH3'], tableId: 'T4' },
            { id: 'S06', number: '06', name: 'êµ­ë‚´ì›ì‹œìë£Œ', type: 'PH+Table', status: 'pending', phFields: ['PH4'], tableId: 'T5' },
            { id: 'S07', number: '07', name: 'êµ­ë‚´ì™¸ì•ˆì „ì„±ì¡°ì¹˜í˜„í™©', type: 'PH+Table', status: 'pending', phFields: ['PH5'], tableId: 'T6' },
            { id: 'S08', number: '08', name: 'êµ­ë‚´ì™¸íŒë§¤ì¤‘ì§€í˜„í™©', type: 'PH+Table', status: 'pending', phFields: ['PH6', 'PH7'], tableId: 'T7' },
            { id: 'S09', number: '09', name: 'í•´ì™¸ì‹ ì†ë³´ê³ ë‚´ì—­', type: 'PH', status: 'pending', phFields: ['PH8'] },
            { id: 'S10', number: '10', name: 'í•´ì™¸ì •ê¸°ë³´ê³ ë‚´ì—­', type: 'PH', status: 'pending', phFields: ['PH9'] },
            { id: 'S11', number: '11', name: 'í•´ì™¸ì›ì‹œìë£Œ', type: 'PH', status: 'pending', phFields: ['PH10'] },
            { id: 'S12', number: '12', name: 'ì´ê´„í‰ê°€', type: 'PH', status: 'pending', phFields: ['PH11'] },
            { id: 'S13', number: '13', name: 'ê²°ë¡ ', type: 'PH', status: 'pending', phFields: ['PH12'] },
            { id: 'S14', number: '14', name: 'ì°¸ê³ ë¬¸í—Œ', type: 'Manual', status: 'pending', csFields: [] }
        ];

        // Sample templates
        const sectionTemplates = {
            'S00': `# ì˜ì•½í’ˆ ì¬ì‹¬ì‚¬ ì•ˆì „ì„± ì •ê¸°ë³´ê³ ì„œ

## í’ˆëª©ëª…
[CS1_ë¸Œëœë“œëª…]

## ì„±ë¶„ëª…
[CS0_ì„±ë¶„ëª…]

## íŒë§¤ì‚¬
[CS2_íŒë§¤ì‚¬]

## ì‘ì„±ì
[CS6_ë³´ê³ ì„œì‘ì„±ì] ([CS7_ë³´ê³ ì„œì‘ì„±ë¶€ì„œ])

## ì‘ì„±ì¼ì
[CS8_ë³´ê³ ì„œì‘ì„±ì¼ì]`,

            'S01': `# 1. ê°œìš”

## 1.1 í’ˆëª© ì •ë³´
- ì„±ë¶„ëª…: [CS0_ì„±ë¶„ëª…]
- ë¸Œëœë“œëª…: [CS1_ë¸Œëœë“œëª…]
- êµ­ë‚´ í—ˆê°€ì¼ì: [CS5_êµ­ë‚´í—ˆê°€ì¼ì]

## 1.2 íš¨ëŠ¥Â·íš¨ê³¼
[CS15_íš¨ëŠ¥íš¨ê³¼]

## 1.3 ìš©ë²•Â·ìš©ëŸ‰
[CS16_ìš©ë²•ìš©ëŸ‰]`,

            'S03': `# 3. ì‹œíŒ í›„ Sales ë°ì´í„°

## 3.1 ë³´ê³  ê¸°ê°„
- ì „ì²´ ë³´ê³ ê¸°ê°„: [CS10_ì „ì²´ë³´ê³ ê¸°ê°„_ì‹œì‘ì¼] ~ [CS11_ì „ì²´ë³´ê³ ê¸°ê°„_ì¢…ë£Œì¼]

## 3.2 íŒë§¤ëŸ‰ í˜„í™©
[PH1_ì‹œíŒí›„salesë°ì´í„°ì„œìˆ ë¬¸]

## 3.3 ì—°ë„ë³„ íŒë§¤ëŸ‰
[í‘œ2_ì—°ë„ë³„íŒë§¤ëŸ‰]`
        };

        let currentSection = sections[0];
        let templateMode = 'auto'; // auto or manual

        // Mock extracted data from P-16
        const extractedData = {
            cs: {
                'CS0': 'í† ì§€ë¦¬ì£¼ë§™',
                'CS1': 'ì•…í…œë¼ì£¼',
                'CS2': 'í•œêµ­ë¡œìŠˆ',
                'CS6': 'í™ê¸¸ë™',
                'CS7': 'ì•½ë¬¼ì•ˆì „ê´€ë¦¬ë¶€',
                'CS8': '2025-01-15',
                'CS5': '2014-03-18',
                'CS15': 'ë¥˜ë§ˆí‹°ìŠ¤ ê´€ì ˆì—¼ì˜ ì¹˜ë£Œ',
                'CS16': 'ì„±ì¸: 8mg/kgì„ 4ì£¼ë§ˆë‹¤ ì •ë§¥ì£¼ì‚¬',
                'CS10': '2020-01-01',
                'CS11': '2024-12-31'
            },
            ph: {
                'PH1': 'ë‹¹í•´ ë³´ê³ ê¸°ê°„ ë™ì•ˆ ì´ 12,543ê±´ì˜ íŒë§¤ê°€ ì´ë£¨ì–´ì¡Œìœ¼ë©°, ì „ë…„ ëŒ€ë¹„ 8.3% ì¦ê°€í•˜ì˜€ìŠµë‹ˆë‹¤. ì£¼ìš” íŒë§¤ì²˜ëŠ” ìƒê¸‰ì¢…í•©ë³‘ì›(67%)ê³¼ ì¢…í•©ë³‘ì›(28%)ì´ì—ˆìœ¼ë©°, ìš”ì–‘ë³‘ì› ë° ì˜ì›ê¸‰ ì˜ë£Œê¸°ê´€ì˜ íŒë§¤ ë¹„ì¤‘ì€ 5%ë¡œ ë‚˜íƒ€ë‚¬ìŠµë‹ˆë‹¤.'
            }
        };

        // Initialize the page
        function init() {
            const layout = new AppLayout({
                currentStage: 6,
                reportName: 'testPill_1'
            });

            const content = `
                <div class="template-container">
                    <!-- Left Panel - Section List -->
                    <div class="section-list-panel">
                        <div class="section-list-header">
                            <div class="section-list-title">ğŸ“ ë³´ê³ ì„œ ì„¹ì…˜</div>
                            <div class="section-progress">
                                <span id="completedSections">0</span>/${sections.length}
                            </div>
                        </div>

                        <div class="progress-stats">
                            <div class="progress-stats-grid">
                                <div class="progress-stat-item">
                                    <div class="progress-stat-value" id="statPending">${sections.length}</div>
                                    <div class="progress-stat-label">ëŒ€ê¸°</div>
                                </div>
                                <div class="progress-stat-item">
                                    <div class="progress-stat-value" id="statProcessing">0</div>
                                    <div class="progress-stat-label">ì²˜ë¦¬ì¤‘</div>
                                </div>
                                <div class="progress-stat-item">
                                    <div class="progress-stat-value" id="statCompleted">0</div>
                                    <div class="progress-stat-label">ì™„ë£Œ</div>
                                </div>
                            </div>
                        </div>

                        <div id="sectionList"></div>
                    </div>

                    <!-- Main Panel - Template Editor -->
                    <div class="template-panel">
                        <div class="template-header">
                            <h2 class="template-title">ğŸ“„ í…œí”Œë¦¿ ì‘ì„± (Stage 6)</h2>

                            <div class="template-info">
                                <div class="template-info-title">ğŸ’¡ í…œí”Œë¦¿ ì‘ì„± ë°©ì‹</div>
                                <div class="template-info-text">
                                    <strong>CS ë°ì´í„°:</strong> í…œí”Œë¦¿ì˜ [CSë³€ìˆ˜]ë¥¼ ì¶”ì¶œëœ ë°ì´í„°ë¡œ ìë™ ì¹˜í™˜<br>
                                    <strong>PH ë°ì´í„°:</strong> í…œí”Œë¦¿ êµ¬ì¡°ì™€ ê¸¸ì´ì— ë§ì¶° ì„œìˆ ë¬¸ ìë™ ìƒì„± (LLM)<br>
                                    <strong>í‘œ ë°ì´í„°:</strong> ì¶”ì¶œëœ í‘œ ë°ì´í„°ë¥¼ í…œí”Œë¦¿ì— ìë™ ì‚½ì…
                                </div>
                            </div>

                            <div class="data-mapping-panel">
                                <div class="data-mapping-title">ğŸ“Š í˜„ì¬ ì„¹ì…˜ ë°ì´í„° ë§¤í•‘</div>
                                <div class="data-mapping-grid" id="dataMappingGrid"></div>
                            </div>

                            <div class="template-controls">
                                <select class="template-mode-select" id="templateMode" onchange="changeTemplateMode()">
                                    <option value="auto">ìë™ ëª¨ë“œ (LLM)</option>
                                    <option value="manual">ìˆ˜ë™ ëª¨ë“œ</option>
                                </select>
                                <button class="btn btn-primary magic-effect" onclick="populateSection()">
                                    âœ¨ ì„¹ì…˜ ì±„ìš°ê¸°
                                </button>
                                <button class="btn btn-secondary" onclick="resetSection()">
                                    ğŸ”„ ì´ˆê¸°í™”
                                </button>
                            </div>
                        </div>

                        <div class="template-content">
                            <!-- Left Column - Template -->
                            <div class="template-column">
                                <div class="column-header">ğŸ“‹ í…œí”Œë¦¿ (ì›ë³¸)</div>
                                <div class="template-editor" id="templateEditor"></div>
                            </div>

                            <!-- Right Column - Preview -->
                            <div class="template-column">
                                <div class="column-header">ğŸ‘ï¸ ë¯¸ë¦¬ë³´ê¸° (ì‘ì„±ëœ ë‚´ìš©)</div>
                                <div class="preview-panel" id="previewPanel">
                                    <p style="color: #94a3b8; text-align: center; margin-top: 40px;">
                                        "ì„¹ì…˜ ì±„ìš°ê¸°" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ í…œí”Œë¦¿ì„ ì‘ì„±í•˜ì„¸ìš”
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="action-footer">
                            <div class="footer-info">
                                í˜„ì¬ ì„¹ì…˜: <strong id="currentSectionName">-</strong>
                            </div>
                            <div class="footer-actions">
                                <button class="btn btn-secondary" onclick="previousSection()" id="prevBtn">
                                    â† ì´ì „ ì„¹ì…˜
                                </button>
                                <button class="btn btn-primary" onclick="saveAndNext()" id="nextBtn">
                                    ì €ì¥ ë° ë‹¤ìŒ â†’
                                </button>
                                <button class="btn btn-success" onclick="proceedToReview()" id="reviewBtn">
                                    ë¦¬ë·° ë‹¨ê³„ë¡œ â†’
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('app').innerHTML = layout.render(content);

            renderSectionList();
            selectSection(sections[0]);
            updateStats();
        }

        // Render section list
        function renderSectionList() {
            const listHtml = sections.map(section => `
                <div class="section-item ${currentSection.id === section.id ? 'active' : ''} ${section.status === 'completed' ? 'completed' : ''}"
                     onclick="selectSection(sections.find(s => s.id === '${section.id}'))">
                    <div class="section-number">${section.number}</div>
                    <div class="section-name">${section.name}</div>
                    <div class="section-meta">
                        <span class="section-type">${section.type}</span>
                        <span class="section-status ${section.status}">${getStatusLabel(section.status)}</span>
                    </div>
                </div>
            `).join('');

            document.getElementById('sectionList').innerHTML = listHtml;
        }

        function getStatusLabel(status) {
            const labels = {
                'pending': 'ëŒ€ê¸°',
                'processing': 'ì²˜ë¦¬ì¤‘',
                'completed': 'ì™„ë£Œ'
            };
            return labels[status] || status;
        }

        // Select section
        function selectSection(section) {
            currentSection = section;
            renderSectionList();
            loadTemplate();
            updateDataMapping();
            updateFooter();
        }

        // Load template for current section
        function loadTemplate() {
            const template = sectionTemplates[currentSection.id] || `# ${currentSection.number}. ${currentSection.name}\n\ní…œí”Œë¦¿ì´ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤...`;

            // Highlight placeholders
            const highlightedTemplate = template.replace(/\[([^\]]+)\]/g, '<span class="data-placeholder">[$1]</span>');

            document.getElementById('templateEditor').innerHTML = highlightedTemplate;
            document.getElementById('currentSectionName').textContent = `${currentSection.number}. ${currentSection.name}`;

            // Clear preview
            document.getElementById('previewPanel').innerHTML = `
                <p style="color: #94a3b8; text-align: center; margin-top: 40px;">
                    "ì„¹ì…˜ ì±„ìš°ê¸°" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ í…œí”Œë¦¿ì„ ì‘ì„±í•˜ì„¸ìš”
                </p>
            `;
        }

        // Update data mapping
        function updateDataMapping() {
            const fields = [];

            if (currentSection.csFields) {
                currentSection.csFields.forEach(field => {
                    const hasValue = extractedData.cs[field];
                    fields.push({ field, hasValue, type: 'CS' });
                });
            }

            if (currentSection.phFields) {
                currentSection.phFields.forEach(field => {
                    const hasValue = extractedData.ph[field];
                    fields.push({ field, hasValue, type: 'PH' });
                });
            }

            if (currentSection.tableId) {
                fields.push({ field: currentSection.tableId, hasValue: true, type: 'Table' });
            }

            const gridHtml = fields.map(item => `
                <div class="data-mapping-item ${item.hasValue ? 'filled' : 'missing'}">
                    ${item.field} ${item.hasValue ? 'âœ“' : 'âœ—'}
                </div>
            `).join('');

            document.getElementById('dataMappingGrid').innerHTML = gridHtml || '<p style="font-size: 11px; color: #94a3b8;">ë°ì´í„° ë§¤í•‘ ì—†ìŒ</p>';
        }

        // Populate section with data
        async function populateSection() {
            const mode = document.getElementById('templateMode').value;

            if (mode === 'auto') {
                showLLMLoading('AIê°€ í…œí”Œë¦¿ì„ ì‘ì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...');
                currentSection.status = 'processing';
                updateStats();
                renderSectionList();

                // Simulate LLM processing
                await new Promise(resolve => setTimeout(resolve, 2000));

                hideLLMLoading();
            }

            // Replace CS data placeholders
            let populatedContent = sectionTemplates[currentSection.id] || '';

            if (currentSection.csFields) {
                currentSection.csFields.forEach(field => {
                    const value = extractedData.cs[field] || `[${field} - ë°ì´í„° ì—†ìŒ]`;
                    const regex = new RegExp(`\\[${field}_[^\\]]+\\]`, 'g');
                    populatedContent = populatedContent.replace(regex, value);
                });
            }

            // Replace PH data placeholders
            if (currentSection.phFields) {
                currentSection.phFields.forEach(field => {
                    const value = extractedData.ph[field] || `[${field} - ì„œìˆ ë¬¸ ì—†ìŒ]`;
                    const regex = new RegExp(`\\[${field}_[^\\]]+\\]`, 'g');
                    populatedContent = populatedContent.replace(regex, value);
                });
            }

            // Replace table placeholders
            if (currentSection.tableId) {
                const tableHtml = `<table>
                    <thead>
                        <tr><th>ì—°ë„</th><th>íŒë§¤ëŸ‰ (ê°œ)</th><th>ì „ë…„ ëŒ€ë¹„</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>2020</td><td>10,234</td><td>-</td></tr>
                        <tr><td>2021</td><td>11,567</td><td>+13.0%</td></tr>
                        <tr><td>2022</td><td>11,892</td><td>+2.8%</td></tr>
                        <tr><td>2023</td><td>12,115</td><td>+1.9%</td></tr>
                        <tr><td>2024</td><td>12,543</td><td>+3.5%</td></tr>
                    </tbody>
                </table>`;

                const regex = new RegExp(`\\[${currentSection.tableId}_[^\\]]+\\]`, 'g');
                populatedContent = populatedContent.replace(regex, tableHtml);
            }

            // Convert markdown to HTML for preview
            const previewHtml = convertMarkdownToHTML(populatedContent);
            document.getElementById('previewPanel').innerHTML = previewHtml;

            currentSection.status = 'completed';
            currentSection.populatedContent = populatedContent;
            updateStats();
            renderSectionList();
            showToast('ì„¹ì…˜ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        }

        // Simple markdown to HTML converter
        function convertMarkdownToHTML(markdown) {
            let html = markdown;

            // Headers
            html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
            html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
            html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');

            // Bold
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

            // Lists
            html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');

            // Paragraphs
            html = html.split('\n\n').map(para => {
                if (para.startsWith('<h') || para.startsWith('<ul') || para.startsWith('<table')) {
                    return para;
                }
                return `<p>${para}</p>`;
            }).join('\n');

            return html;
        }

        // Reset section
        function resetSection() {
            loadTemplate();
            currentSection.status = 'pending';
            delete currentSection.populatedContent;
            updateStats();
            renderSectionList();
            showToast('ì„¹ì…˜ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
        }

        // Navigation
        function previousSection() {
            const currentIndex = sections.findIndex(s => s.id === currentSection.id);
            if (currentIndex > 0) {
                selectSection(sections[currentIndex - 1]);
            }
        }

        function saveAndNext() {
            if (currentSection.status !== 'completed') {
                showToast('ë¨¼ì € ì„¹ì…˜ì„ ì‘ì„±í•´ì£¼ì„¸ìš”', 'error');
                return;
            }

            const currentIndex = sections.findIndex(s => s.id === currentSection.id);
            if (currentIndex < sections.length - 1) {
                selectSection(sections[currentIndex + 1]);
                showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            }
        }

        function updateFooter() {
            const currentIndex = sections.findIndex(s => s.id === currentSection.id);
            document.getElementById('prevBtn').disabled = currentIndex === 0;
            document.getElementById('nextBtn').disabled = currentIndex === sections.length - 1;

            const allCompleted = sections.every(s => s.status === 'completed');
            document.getElementById('reviewBtn').style.display = allCompleted ? 'block' : 'none';
        }

        // Update statistics
        function updateStats() {
            const pending = sections.filter(s => s.status === 'pending').length;
            const processing = sections.filter(s => s.status === 'processing').length;
            const completed = sections.filter(s => s.status === 'completed').length;

            document.getElementById('statPending').textContent = pending;
            document.getElementById('statProcessing').textContent = processing;
            document.getElementById('statCompleted').textContent = completed;
            document.getElementById('completedSections').textContent = completed;

            updateFooter();
        }

        // Change template mode
        function changeTemplateMode() {
            templateMode = document.getElementById('templateMode').value;
            showToast(`${templateMode === 'auto' ? 'ìë™' : 'ìˆ˜ë™'} ëª¨ë“œë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤`, 'info');
        }

        // Proceed to review stage
        function proceedToReview() {
            const allCompleted = sections.every(s => s.status === 'completed');
            if (!allCompleted) {
                showToast('ëª¨ë“  ì„¹ì…˜ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”', 'error');
                return;
            }

            window.location.href = 'P18_Review.html';
        }

        // Initialize on load
        init();
    </script>
</body>
</html>
